<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Construtor Descri√ß√£o e Renomea√ß√£o de Arquivos - OAE Support</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.js"></script>
    <style>
      /* Reset e estilos gerais */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%);
        height: 100vh;
        color: #ffffff;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      /* Cabe√ßalho compacto */
      .header {
        text-align: center;
        padding: 0.8rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .header h1 {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 0.3rem;
        background: linear-gradient(45deg, #ffffff, #e3f2fd);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .header p {
        font-size: 0.9rem;
        opacity: 0.8;
        line-height: 1.3;
      }

      /* Container principal */
      .container {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 0.8rem;
        gap: 0.8rem;
        overflow: hidden;
        height: calc(100vh - 120px);
      }

      /* Painel de controles horizontal */
      .controls-panel {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        padding: 0.7rem;
        display: grid;
        grid-template-columns: 200px 250px 1fr 180px;
        gap: 0.7rem;
        align-items: start;
      }

      /* Se√ß√£o de arquivos */
      .file-section {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
      }

      .section-title {
        font-size: 0.75rem;
        font-weight: 600;
        color: #3498db;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.3rem;
      }

      .btn {
        background: linear-gradient(45deg, #3498db, #2ecc71);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 11px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
        min-height: 32px;
      }

      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
      }

      .btn:disabled {
        background: rgba(149, 165, 166, 0.6);
        cursor: not-allowed;
        transform: none;
      }

      .btn-success { background: linear-gradient(45deg, #2ecc71, #27ae60); }
      .btn-csv { background: linear-gradient(45deg, #16a085, #1abc9c); }
      .btn-reset { background: linear-gradient(45deg, #e74c3c, #c0392b); }
      .btn-nav { background: linear-gradient(45deg, #f39c12, #e67e22); }

      .file-input { display: none; }

      .file-counter {
        font-size: 11px;
        text-align: center;
        color: rgba(255,255,255,0.7);
        padding: 0.3rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 6px;
      }

      /* Arquivo atual */
      .current-file {
        background: rgba(52, 152, 219, 0.2);
        border: 1px solid rgba(52, 152, 219, 0.4);
        border-radius: 8px;
        padding: 0.8rem;
        text-align: center;
      }

      .current-file-name {
        font-size: 0.9rem;
        font-weight: 600;
        color: #ffffff;
        margin-bottom: 0.5rem;
        word-break: break-all;
      }

      .navigation-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
      }

      .btn-small {
        padding: 6px 10px;
        font-size: 10px;
        min-height: 28px;
      }

      /* Controles de nomenclatura e descri√ß√£o */
      .name-controls, .description-controls {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
      }

      .description-controls {
        min-width: 0; /* Para permitir que os filhos encolham */
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
      }

      .form-group label {
        font-weight: 600;
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.8rem;
      }

      .form-input {
        padding: 6px 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.1);
        color: #ffffff;
        font-size: 12px;
        transition: all 0.3s ease;
      }

      .form-input:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 8px rgba(52, 152, 219, 0.3);
        background: rgba(255, 255, 255, 0.15);
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        padding: 3px 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        font-size: 10px;
      }

      .select-group {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        padding: 3px 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        font-size: 10px;
      }

      .select-group select {
        background: rgba(255, 255, 255, 0.1);
        color: #ffffff;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        padding: 2px 4px;
        font-size: 10px;
      }

      .checkbox-group input[type="checkbox"] {
        accent-color: #3498db;
      }

      /* Preview inline */
      .preview-boxes {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }

      .preview-box {
        background: rgba(46, 204, 113, 0.2);
        border: 1px solid rgba(46, 204, 113, 0.4);
        border-radius: 6px;
        padding: 0.3rem;
        margin-top: 0.3rem;
      }

      .preview-title {
        font-size: 0.65rem;
        color: #2ecc71;
        font-weight: 600;
        margin-bottom: 0.2rem;
        text-transform: uppercase;
      }

      .preview-text {
        font-size: 10px;
        color: rgba(255, 255, 255, 0.9);
        min-height: 14px;
        word-break: break-word;
      }

      /* Grupos de palavras compactos */
      .word-groups {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 0.3rem;
        margin-bottom: 0.3rem;
      }

      .word-group {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        padding: 0.3rem;
      }

      .word-group-title {
        font-size: 0.6rem;
        font-weight: 600;
        margin-bottom: 0.2rem;
        color: #3498db;
        text-align: center;
        text-transform: uppercase;
      }

      .words-container {
        max-height: 280px;
        overflow-y: auto;
        min-height: 240px;
      }

      .words-grid {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .word-checkbox {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 2px 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 9px;
      }

      .word-checkbox:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .word-checkbox input[type="checkbox"] {
        transform: scale(0.8);
        accent-color: #3498db;
      }

      .word-checkbox label {
        cursor: pointer;
        user-select: none;
        line-height: 1.2;
      }

      /* A√ß√µes */
      .actions-section {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
      }

      /* √Årea da tabela */
      .table-area {
        height: max(0, calc(100vh - 500px));
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }

      .table-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #ffffff;
      }

      .table-actions {
        display: flex;
        gap: 0.5rem;
      }

      /* Tabela edit√°vel */
      .table-container {
        flex: 1;
        overflow: auto;
      }

      .editable-table {
        width: 100%;
        border-collapse: collapse;
        color: #ffffff;
      }

      .editable-table th {
        background: rgba(52, 152, 219, 0.3);
        padding: 8px 12px;
        text-align: center;
        font-weight: 600;
        font-size: 12px;
        color: #ffffff;
        position: sticky;
        top: 0;
        z-index: 10;
        border-bottom: 2px solid rgba(255, 255, 255, 0.3);
      }

      .editable-table td {
        padding: 4px 8px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        vertical-align: middle;
        font-size: 11px;
      }

      .editable-table tr:nth-child(even) {
        background: rgba(255, 255, 255, 0.03);
      }

      .editable-table tr:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .editable-table tr.current-row {
        background: rgba(52, 152, 219, 0.2) !important;
        border: 2px solid #3498db;
      }

      .editable-input {
        width: 100%;
        background: transparent;
        border: 1px solid transparent;
        color: #ffffff;
        padding: 4px 6px;
        border-radius: 4px;
        font-size: 11px;
        transition: all 0.3s ease;
      }

      .editable-input:focus {
        outline: none;
        background: rgba(255, 255, 255, 0.1);
        border-color: #3498db;
        box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
      }

      .original-name {
        font-weight: 500;
        color: rgba(255, 255, 255, 0.9);
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      /* Status do arquivo atual */
      .file-status {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: 8px;
        font-weight: 600;
      }

      .file-status.current {
        background: rgba(52, 152, 219, 0.3);
        color: #3498db;
      }

      .file-status.done {
        background: rgba(46, 204, 113, 0.3);
        color: #2ecc71;
      }

      .file-status.pending {
        background: rgba(241, 196, 15, 0.3);
        color: #f1c40f;
      }

      /* Mensagens */
      .message {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 0.8rem 1.2rem;
        border-radius: 8px;
        font-weight: 500;
        font-size: 12px;
        z-index: 1000;
        display: none;
        max-width: 300px;
      }

      .message.error {
        background: rgba(231, 76, 60, 0.9);
        color: #ffffff;
        border-left: 4px solid #e74c3c;
      }

      .message.success {
        background: rgba(46, 204, 113, 0.9);
        color: #ffffff;
        border-left: 4px solid #2ecc71;
      }

      .message.info {
        background: rgba(52, 152, 219, 0.9);
        color: #ffffff;
        border-left: 4px solid #3498db;
      }

      /* Modal de confirma√ß√£o */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }

      .modal-content {
        background: linear-gradient(135deg, #2c3e50, #34495e);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        padding: 2rem;
        max-width: 400px;
        width: 90%;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      }

      .modal-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #f39c12;
        margin-bottom: 1rem;
      }

      .modal-message {
        font-size: 1rem;
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 2rem;
        line-height: 1.5;
      }

      .modal-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
      }

      .modal-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 100px;
      }

      .modal-btn-confirm {
        background: linear-gradient(45deg, #2ecc71, #27ae60);
        color: white;
      }

      .modal-btn-cancel {
        background: linear-gradient(45deg, #e74c3c, #c0392b);
        color: white;
      }

      .modal-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }

      /* Responsividade */
      @media (max-width: 1200px) {
        .controls-panel {
          grid-template-columns: 180px 220px 1fr 160px;
        }
      }

      @media (max-width: 1000px) {
        .controls-panel {
          grid-template-columns: 1fr 1fr;
          grid-template-rows: auto auto;
          gap: 0.8rem;
        }
        
        .file-section {
          grid-column: 1;
          grid-row: 1;
        }
        
        .name-controls {
          grid-column: 2;
          grid-row: 1;
        }
        
        .description-controls {
          grid-column: 1 / -1;
          grid-row: 2;
        }
        
        .actions-section {
          grid-column: 1 / -1;
          grid-row: 3;
          display: flex;
          flex-direction: row;
          justify-content: center;
          flex-wrap: wrap;
        }
        
        .word-groups {
          grid-template-columns: 1fr 1fr 1fr;
        }
      }

      @media (max-width: 768px) {
        .controls-panel {
          grid-template-columns: 1fr;
          grid-template-rows: auto;
          gap: 0.8rem;
        }
        
        .file-section,
        .name-controls,
        .description-controls,
        .actions-section {
          grid-column: 1;
        }
        
        .word-groups {
          grid-template-columns: 1fr;
        }
        
        .table-header {
          flex-direction: column;
          gap: 0.5rem;
        }
      }

      /* Anima√ß√µes */
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .controls-panel, .table-area {
        animation: fadeIn 0.4s ease-out;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <h1>CONSTRUTOR DESCRI√á√ÉO E RENOMEA√á√ÉO DE ARQUIVOS</h1>
      <p>Fluxo arquivo por arquivo com preview inline e navega√ß√£o tipo Excel</p>
    </header>

    <div class="container">
      <!-- Painel de controles horizontal -->
      <div class="controls-panel">
        <!-- Se√ß√£o de arquivos -->
        <div class="file-section">
          <div class="section-title">üìÅ Arquivos</div>
          <label for="fileInput" class="btn">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
              <polyline points="14,2 14,8 20,8"/>
            </svg>
            Selecionar
          </label>
          <input type="file" id="fileInput" multiple class="file-input" />
          <div id="fileCounter" class="file-counter">0 arquivos</div>
          
          <!-- Arquivo atual -->
          <div id="currentFileSection" class="current-file" style="display: none;">
            <div class="preview-title">Arquivo Atual:</div>
            <div id="currentFileName" class="current-file-name">-</div>
            <div class="navigation-buttons">
              <button id="prevBtn" class="btn btn-nav btn-small">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                Anterior
              </button>
              <button id="nextBtn" class="btn btn-nav btn-small">
                Pr√≥ximo
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- Controles centrais -->
        <div class="name-controls">
          <div class="section-title">üè∑Ô∏è Nomenclatura</div>
          <div class="form-group">
            <label>Prefixo:</label>
            <input type="text" id="prefixInput" class="form-input" placeholder="Ex: P" />
          </div>
          <div class="form-group">
            <label>Sufixo:</label>
            <input type="text" id="suffixInput" class="form-input" placeholder="Ex: 2024" />
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="addNumbering" checked />
            <label>Numerar automaticamente</label>
          </div>
          <div class="select-group">
            <label>Separador:</label>
            <select id="separatorSelect">
              <option value=", " selected>V√≠rgula (,)</option>
              <option value="_">Underline (_)</option>
              <option value=" ">Espa√ßo ( )</option>
              <option value="-">Tra√ßo (-)</option>
            </select>
          </div>
          
          <!-- Preview do nome -->
          <div class="preview-box">
            <div class="preview-title">üëÅÔ∏è Preview Nome:</div>
            <div id="namePreview" class="preview-text">Configurar para ver preview</div>
          </div>
        </div>

        <!-- Descri√ß√£o -->
        <div class="description-controls">
          <div class="section-title">üìù Descri√ß√£o</div>
          <div class="word-groups">
            <div class="word-group">
              <div class="word-group-title">üèóÔ∏è Elementos</div>
              <div class="words-container">
                <div id="elementosGrid" class="words-grid"></div>
              </div>
            </div>
            <div class="word-group">
              <div class="word-group-title">‚ö†Ô∏è Danos</div>
              <div class="words-container">
                <div id="danosGrid" class="words-grid"></div>
              </div>
            </div>
            <div class="word-group">
              <div class="word-group-title">üìç Local</div>
              <div class="words-container">
                <div id="localizacaoGrid" class="words-grid"></div>
              </div>
            </div>
          </div>
          
          <!-- Preview da descri√ß√£o -->
          <div class="preview-box">
            <div class="preview-title">üëÅÔ∏è Preview Descri√ß√£o:</div>
            <div id="descriptionPreview" class="preview-text">Selecionar itens para ver preview</div>
          </div>
        </div>

        <!-- A√ß√µes -->
        <div class="actions-section">
          <div class="section-title">‚ö° A√ß√µes</div>
          <button id="applyCurrentBtn" class="btn" disabled>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 11 12 14 22 4"></polyline>
            </svg>
            Aplicar Atual
          </button>
          <button id="applyAllBtn" class="btn" disabled>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 11 12 14 22 4"></polyline>
              <path d="m21 12c0 5.523-4.477 10-10 10s-10-4.477-10-10 4.477-10 10-10c1.095 0 2.149.176 3.137.507"></path>
            </svg>
            Aplicar Todos
          </button>
          <button id="exportCsvBtn" class="btn btn-csv" disabled>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <line x1="16" y1="13" x2="8" y2="13"/>
            </svg>
            CSV
          </button>
          <button id="downloadBtn" class="btn btn-success" disabled>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
            </svg>
            ZIP
          </button>
          <button id="resetBtn" class="btn btn-reset">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
              <path d="M21 3v5h-5"/>
            </svg>
            Reset
          </button>
        </div>
      </div>

      <!-- √Årea da tabela -->
      <div class="table-area">
        <div class="table-header">
          <div class="table-title">üìã Tabela de Arquivos</div>
          <div class="table-actions">
            <span id="progressInfo" style="font-size: 11px; color: rgba(255,255,255,0.7);">-</span>
          </div>
        </div>

        <div class="table-container">
          <table class="editable-table">
            <thead>
              <tr>
                <th style="width: 20%;">Nome Original</th>
                <th style="width: 20%;">Novo Nome</th>
                <th style="width: 45%;">Descri√ß√£o</th>
                <th style="width: 15%;">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="editableTableBody">
              <tr>
                <td colspan="4" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.6); font-style: italic;">
                  <div style="display: flex; flex-direction: column; align-items: center; gap: 0.8rem;">
                    <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                      <polyline points="14,2 14,8 20,8"/>
                    </svg>
                    <p>Selecione arquivos para come√ßar</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Mensagens -->
    <div id="message" class="message"></div>

    <!-- Modal de confirma√ß√£o -->
    <div id="modalOverlay" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 0.5rem;">
            <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/>
          </svg>
          Aten√ß√£o
        </div>
        <div id="modalMessage" class="modal-message"></div>
        <div class="modal-buttons">
          <button id="modalCancel" class="modal-btn modal-btn-cancel">Cancelar</button>
          <button id="modalConfirm" class="modal-btn modal-btn-confirm">Continuar</button>
        </div>
      </div>
    </div>

    <script>
      // === FLUXO DA APLICA√á√ÉO ===
      // 1. Usu√°rio seleciona arquivos
      // 2. Para cada arquivo: configura nome/descri√ß√£o e clica "Aplicar Atual"
      // 3. Dados s√£o SALVOS permanentemente no fileData[]
      // 4. Previews s√£o RESETADOS para o pr√≥ximo arquivo
      // 5. Tabela mant√©m os dados j√° aplicados
      // 6. Navega√ß√£o entre arquivos preserva dados salvos
      
      // === MELHORIAS IMPLEMENTADAS ===
      // ‚úÖ "Aplicar Todos" preserva descri√ß√µes existentes
      // ‚úÖ Descri√ß√£o √© OPCIONAL - pode baixar ZIP sem descri√ß√£o (com confirma√ß√£o)
      // ‚úÖ Modal customizado para confirma√ß√µes (bonito e profissional)
      // ‚úÖ Suporte a ESC para fechar modal
      // ‚úÖ Bot√£o de copiar descri√ß√£o na tabela
      // ‚úÖ Aplicar texto digitado manualmente ao clicar "Aplicar Atual"
      // ‚úÖ Numera√ß√£o sequencial personalizada (ex: F-20 ‚Üí F-21, F-22...)

      // Dados dos grupos de palavras (compactados para economia de espa√ßo)
      const elementos = [
        "ALA",
        "APOIO",
        "01",
        "02",
        "03",
        "04",
        "05",
        "06",
        "07",
        "08",
        "09",
        "10",
        "11",
        "12",
        "13",
        "14",
        "15",
        "PAREDE FRONTAL",
      ];

      const danos = [
        "01 ANCORAGEM INADEQUADA DA DEFENSA MET√ÅLICA",
        "02 APARELHO DE APOIO COM DISTOR√á√ÉO EXAGERADA",
        "03 APARELHO DE APOIO DANIFICADO",
        "04 APARELHO DE APOIO DESLOCADO DA POSI√á√ÉO",
        "05 ARMADURA SEM COBRIMENTO",
        "06 BER√áO PARA JUNTA DANIFICADO",
        "07 BURACO NA PISTA (ACESSO)",
        "08 BUZINOTE DANIFICADO OU INEFICIENTE",
        "09 CAL√áADA DESTRU√çDA",
        "10 CONCRETO DESAGREGADO COM ARMADURA EXPOSTA E OXIDADA",
        "11 CONCRETO DESAGREGADO SEM ARMADURA EXPOSTA",
        "12 CORROS√ÉOA",
        "13 CORROS√ÉO AVAN√áADA E LIGA√á√ïES ROMPIDAS",
        "14 CRESCIMENTO DE VEGETA√á√ÉO",
        "15 DESAGREGA√á√ÉO",
        "16 DESN√çVEL NA PISTA (ACESSO)",
        "17 DESPLACAMENTO DE CONCRETO COM ARMADURA EXPOSTA",
        "18 DESPLACAMENTO DE CONCRETO SEM ARMADURA EXPOSTA",
        "19 ELEMENTO DE LIGA√á√ÉO DANIFICADO OU INEXISTENTE",
        "20 ELEMENTO MET√ÅLICO ROMPIDO",
        "21 EROS√ÉO DO TALUDE DE ATERRO",
        "22 ESTACA COM SE√á√ÉO REDUZIDA",
        "23 ESTACA DESCONFINADA",
        "24 ESTACA ESBELTA COM DESCONFINAMENTO LATERAL",
        "25 FERRAGEM PRINCIPAL EXPOSTA EM PONTOS LOCALIZADOS",
        "26 FERRAGEM PRINCIPAL MUITO OXIDADA EM PONTOS LOCALIZADOS",
        "27 FISSURA PROFUNDA ABERTA (W > 0,2 MM)",
        "28 FISSURA PROFUNDA ABERTA (W > 0,3 MM)",
        "29 FISSURA PROFUNDA FINA",
        "30 FISSURA SUPERFICIAL",
        "31 FLAMBAGEM",
        "32 FRAGMENTA√á√ÉO POR FOGO",
        "33 GUARDA RODAS OU BARREIRA DESTRU√çDO(A)",
        "34 GUARDA-CORPO DESTRU√çDO",
        "35 INFILTRA√á√ÉO NO CONCRETO",
        "36 JUNTA DANIFICADA OU INEXISTENTE OU EXPELIDA",
        "37 LIXIVIA√á√ÉO E MANCHA DE CARBONATA√á√ÉO",
        "38 MADEIRA DETERIORADA",
        "39 MANCHA DE FOGO",
        "40 MANCHA DE UMIDADE",
        "41 MANCHA DEVIDO A√á√ÉO BIOL√ìGICA",
        "42 NICHO DE CONCRETAGEM",
        "43 PAVIMENTO ASF√ÅLTICO DANIFICADO",
        "44 PAVIMENTO DE CONCRETO DANIFICADO",
        "45 P√äNDULO COM DESAPRUMO EXAGERADO",
        "46 PINGADEIRA DANIFICADA OU INEFICIENTE",
        "47 RACHADURA OU TRINCA MUITO ABERTA",
        "48 RECALQUE DO ATERRO DE APROXIMA√á√ÉO",
        "49 REGI√ÉO COM CONCRETO ESMAGADO OU ROMPIDO",
        "50 VIGA COM LIGEIRA CORROS√ÉO"
      ];

      const localizacao = [
        "INFERIOR",
        "SUPERIOR",
        "LD",
        "LE",
        "TRAMO",
        "APOIO",
        "SUPERESTRUTURA",
        "MESOESTRUTURA",
        "INFRAESTRUTURA",
        "DIAGONAL",
        "TABULEIRO",
        "TRANSI√á√ÉO 01",
        "TRANSI√á√ÉO 02",   
         ];

      // Elementos DOM
      const fileInput = document.getElementById("fileInput");
      const fileCounter = document.getElementById("fileCounter");
      const currentFileSection = document.getElementById("currentFileSection");
      const currentFileName = document.getElementById("currentFileName");
      const prefixInput = document.getElementById("prefixInput");
      const suffixInput = document.getElementById("suffixInput");
      const addNumbering = document.getElementById("addNumbering");
      const separatorSelect = document.getElementById("separatorSelect");
      const namePreview = document.getElementById("namePreview");
      const descriptionPreview = document.getElementById("descriptionPreview");
      const progressInfo = document.getElementById("progressInfo");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");
      const applyCurrentBtn = document.getElementById("applyCurrentBtn");
      const applyAllBtn = document.getElementById("applyAllBtn");
      const exportCsvBtn = document.getElementById("exportCsvBtn");
      const downloadBtn = document.getElementById("downloadBtn");
      const resetBtn = document.getElementById("resetBtn");
      const editableTableBody = document.getElementById("editableTableBody");
      const messageDiv = document.getElementById("message");
      const modalOverlay = document.getElementById("modalOverlay");
      const modalMessage = document.getElementById("modalMessage");
      const modalConfirm = document.getElementById("modalConfirm");
      const modalCancel = document.getElementById("modalCancel");

      // Vari√°veis globais
      let files = [];
      let fileData = [];
      let currentFileIndex = -1;
      let currentCell = { row: 0, col: 1 }; // Para navega√ß√£o Excel
      let selectedOrder = []; // Array para rastrear ordem de sele√ß√£o
      
      // Vari√°veis para numera√ß√£o personalizada
      let customNumberingPattern = null; // Armazena padr√£o detectado: {prefix: "F-", startNumber: 20}

      // Event listeners
      fileInput.addEventListener("change", handleFileSelect);
      prefixInput.addEventListener("input", updatePreviews);
      suffixInput.addEventListener("input", updatePreviews);
      addNumbering.addEventListener("change", updatePreviews);
      separatorSelect.addEventListener("change", updatePreviews);
      prevBtn.addEventListener("click", () => navigateFile(-1));
      nextBtn.addEventListener("click", () => navigateFile(1));
      applyCurrentBtn.addEventListener("click", applyToCurrent);
      applyAllBtn.addEventListener("click", applyToAll);
      exportCsvBtn.addEventListener("click", exportToCsv);
      downloadBtn.addEventListener("click", downloadFiles);
      resetBtn.addEventListener("click", resetAll);

      // Event listeners do modal
      modalCancel.addEventListener("click", closeModal);
      modalOverlay.addEventListener("click", (e) => {
        if (e.target === modalOverlay) closeModal();
      });

      // Teclas de navega√ß√£o
      document.addEventListener("keydown", handleKeyNavigation);

      // Detectar padr√£o de numera√ß√£o personalizada
      function detectAndSetNumberingPattern(manualName) {
        // Remover extens√£o para an√°lise
        const nameWithoutExt = manualName.substring(0, manualName.lastIndexOf('.')) || manualName;
        
        // Regex para detectar padr√µes como: F-20, IMG-001, Photo_15, etc.
        const patterns = [
          /^(.+?)[-_\s](\d+)$/, // F-20, IMG_001, Photo 15
          /^(.+?)(\d+)$/, // F20, IMG001
        ];
        
        for (const pattern of patterns) {
          const match = nameWithoutExt.match(pattern);
          if (match) {
            const prefix = match[1];
            const number = parseInt(match[2]);
            
            if (!isNaN(number)) {
              customNumberingPattern = {
                prefix: prefix,
                startNumber: number,
                separator: match[0].includes('-') ? '-' : 
                          match[0].includes('_') ? '_' : 
                          match[0].includes(' ') ? ' ' : ''
              };
              
              showMessage(`Padr√£o detectado: ${prefix}${customNumberingPattern.separator}${number}+`, "info");
              return;
            }
          }
        }
        
        // Se n√£o detectou padr√£o, manter null
        customNumberingPattern = null;
      }

      // Inicializa√ß√£o
      initializeWordsGrids();
      updatePreviews();

      // Criar grades de palavras
      function initializeWordsGrids() {
        createWordGrid(document.getElementById("elementosGrid"), elementos, "elemento");
        createWordGrid(document.getElementById("danosGrid"), danos, "dano");
        createWordGrid(document.getElementById("localizacaoGrid"), localizacao, "localizacao");
      }

      function createWordGrid(container, words, prefix) {
        container.innerHTML = "";
        words.forEach((palavra) => {
          const div = document.createElement("div");
          div.className = "word-checkbox";
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.id = `${prefix}_${palavra}`;
          checkbox.value = palavra;
          checkbox.addEventListener("change", (e) => {
            handleCheckboxChange(e.target);
            updatePreviews();
          });
          const label = document.createElement("label");
          label.htmlFor = `${prefix}_${palavra}`;
          label.textContent = palavra.replace(/_/g, ' ');
          div.appendChild(checkbox);
          div.appendChild(label);
          container.appendChild(div);
        });
      }

      // Atualizar previews
      function updatePreviews() {
        updateNamePreview();
        updateDescriptionPreview();
      }

      // Manipular mudan√ßas nos checkboxes para rastrear ordem
      function handleCheckboxChange(checkbox) {
        const value = checkbox.value;
        
        if (checkbox.checked) {
          // Adicionar √† ordem se n√£o existir
          if (!selectedOrder.includes(value)) {
            selectedOrder.push(value);
          }
        } else {
          // Remover da ordem
          selectedOrder = selectedOrder.filter(item => item !== value);
        }
      }

      function updateNamePreview() {
        if (currentFileIndex === -1) {
          namePreview.textContent = "Selecione um arquivo";
          return;
        }
        
        const name = generateName(currentFileIndex);
        namePreview.textContent = name;
        
        // IMPORTANTE: N√£o atualizar a tabela automaticamente aqui
        // A tabela s√≥ deve ser atualizada quando o usu√°rio clicar em "Aplicar"
      }

      function updateDescriptionPreview() {
        const description = generateDescription();
        descriptionPreview.textContent = description || "Selecione elementos/danos/localiza√ß√£o";
        
        // Atualizar na tabela tamb√©m  
        if (currentFileIndex !== -1 && fileData[currentFileIndex]) {
          fileData[currentFileIndex].description = description;
          updateTableRow(currentFileIndex);
        }
      }

      // Gerar nome (com suporte a numera√ß√£o personalizada)
      function generateName(index) {
        // Se h√° padr√£o personalizado detectado, usar ele
        if (customNumberingPattern) {
          const currentNumber = customNumberingPattern.startNumber + index;
          const name = customNumberingPattern.prefix + 
                      customNumberingPattern.separator + 
                      String(currentNumber).padStart(String(customNumberingPattern.startNumber).length, "0");
          
          // Adicionar extens√£o original
          const originalFile = files[index];
          const extension = originalFile.name.substring(originalFile.name.lastIndexOf("."));
          return name + extension;
        }
        
        // L√≥gica original se n√£o h√° padr√£o personalizado
        const prefix = prefixInput.value.trim();
        const suffix = suffixInput.value.trim();
        const shouldAddNumber = addNumbering.checked;

        let name = "";
        if (prefix) name += prefix;
        if (shouldAddNumber) name += String(index + 1).padStart(2, "0");
        if (suffix) name += suffix;
        if (!name) name = "arquivo" + String(index + 1).padStart(2, "0");

        // Adicionar extens√£o original (n√£o edit√°vel)
        const originalFile = files[index];
        const extension = originalFile.name.substring(originalFile.name.lastIndexOf("."));
        return name + extension;
      }

      // Gerar descri√ß√£o
      function generateDescription() {
        const separator = separatorSelect.value;
        
        // Usar apenas os itens que ainda est√£o selecionados, na ordem de clique
        const validSelected = selectedOrder.filter(item => {
          const checkbox = document.querySelector(`input[value="${item}"]`);
          return checkbox && checkbox.checked;
        });
        
        return validSelected.join(separator);
      }

      // Manipular sele√ß√£o de arquivos
      function handleFileSelect(e) {
        files = Array.from(e.target.files);
        fileData = files.map((file, index) => ({
          originalName: file.name,
          newName: "",
          description: "",
          file: file
        }));

        fileCounter.textContent = `${files.length} arquivo(s)`;
        
        if (files.length > 0) {
          currentFileIndex = 0;
          currentFileSection.style.display = "block";
          selectCurrentFile();
        }

        updateTable();
        updateButtonStates();
      }

      // Selecionar arquivo atual
      function selectCurrentFile() {
        if (currentFileIndex < 0 || currentFileIndex >= files.length) return;
        
        currentFileName.textContent = files[currentFileIndex].name;
        progressInfo.textContent = `Arquivo ${currentFileIndex + 1} de ${files.length}`;
        
        // Atualizar navega√ß√£o
        prevBtn.disabled = currentFileIndex === 0;
        nextBtn.disabled = currentFileIndex === files.length - 1;
        
        // Destacar linha na tabela
        updateTableHighlight();
        
        // Atualizar previews (mas n√£o sobrescrever dados salvos)
        updatePreviews();
      }

      // Navegar entre arquivos
      function navigateFile(direction) {
        const newIndex = currentFileIndex + direction;
        if (newIndex >= 0 && newIndex < files.length) {
          currentFileIndex = newIndex;
          selectCurrentFile();
        }
      }

      // Aplicar ao arquivo atual
      function applyToCurrent() {
        if (currentFileIndex === -1) return;
        
        // Verificar se h√° texto digitado manualmente na tabela
        const currentRow = document.querySelector(`tr[data-index="${currentFileIndex}"]`);
        let manualName = "";
        let manualDescription = "";
        
        if (currentRow) {
          const nameInput = currentRow.querySelector('input[data-field="newName"]');
          const descInput = currentRow.querySelector('input[data-field="description"]');
          manualName = nameInput ? nameInput.value.trim() : "";
          manualDescription = descInput ? descInput.value.trim() : "";
        }
        
        // Usar texto manual se existir, sen√£o gerar automaticamente
        fileData[currentFileIndex].newName = manualName || generateName(currentFileIndex);
        fileData[currentFileIndex].description = manualDescription || generateDescription();
        
        // Detectar padr√£o de numera√ß√£o se foi digitado manualmente
        if (manualName && currentFileIndex === 0) {
          detectAndSetNumberingPattern(manualName);
        }
        
        // Atualizar a linha da tabela com os dados salvos
        updateTableRow(currentFileIndex);
        updateButtonStates();
        
        showMessage("Aplicado ao arquivo atual!", "success");
        
        // Resetar sele√ß√µes da descri√ß√£o para o pr√≥ximo arquivo (mas manter nome)
        document.querySelectorAll('input[type="checkbox"][id^="elemento_"], input[type="checkbox"][id^="dano_"], input[type="checkbox"][id^="localizacao_"]')
          .forEach(cb => cb.checked = false);
        
        // Limpar ordem de sele√ß√£o para o pr√≥ximo arquivo
        selectedOrder = [];
        
        // Atualizar apenas o preview (n√£o a tabela)
        descriptionPreview.textContent = "Selecionar itens para ver preview";
        
        // Ir para pr√≥ximo arquivo automaticamente
        if (currentFileIndex < files.length - 1) {
          navigateFile(1);
        }
      }

      // Aplicar a todos
      function applyToAll() {
        if (files.length === 0) return;
        
        const currentDescription = generateDescription();
        let appliedCount = 0;
        
        fileData.forEach((item, index) => {
          // Verificar se h√° texto digitado manualmente na tabela para este arquivo
          const row = document.querySelector(`tr[data-index="${index}"]`);
          let manualName = "";
          let manualDescription = "";
          
          if (row) {
            const nameInput = row.querySelector('input[data-field="newName"]');
            const descInput = row.querySelector('input[data-field="description"]');
            manualName = nameInput ? nameInput.value.trim() : "";
            manualDescription = descInput ? descInput.value.trim() : "";
          }
          
          // Para nome: usar manual se existir, sen√£o gerar
          item.newName = manualName || generateName(index);
          
          // Para descri√ß√£o: s√≥ aplicar se n√£o existir ainda OU se houver uma sele√ß√£o atual
          if (!item.description || currentDescription || manualDescription) {
            if (manualDescription) {
              item.description = manualDescription;
              appliedCount++;
            } else if (currentDescription) {
              item.description = currentDescription;
              appliedCount++;
            }
          }
        });
        
        // Atualizar toda a tabela de uma vez
        updateTable();
        updateButtonStates();
        
        if (appliedCount > 0) {
          showMessage(`Nomes aplicados para todos! Descri√ß√£o aplicada para ${appliedCount} arquivo(s).`, "success");
        } else {
          showMessage("Nomes aplicados para todos! Descri√ß√µes existentes preservadas.", "success");
        }
      }

      // Atualizar tabela
      function updateTable() {
        editableTableBody.innerHTML = "";

        if (files.length === 0) {
          const emptyRow = document.createElement("tr");
          emptyRow.innerHTML = `
            <td colspan="4" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.6); font-style: italic;">
              <div style="display: flex; flex-direction: column; align-items: center; gap: 0.8rem;">
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                  <polyline points="14,2 14,8 20,8"/>
                </svg>
                <p>Selecione arquivos para come√ßar</p>
              </div>
            </td>
          `;
          editableTableBody.appendChild(emptyRow);
          return;
        }

        fileData.forEach((item, index) => {
          const row = document.createElement("tr");
          row.dataset.index = index;
          
          // Status do arquivo
          let status = "pending";
          let statusText = "‚óã";
          
          if (index === currentFileIndex) {
            status = "current";
            statusText = "Atual";
          } else if (item.newName && item.description) {
            status = "done";
            statusText = "‚úì";
          }
          
          row.innerHTML = `
            <td>
              <div class="original-name" title="${item.originalName}">
                ${item.originalName}
                <span class="file-status ${status}">
                  ${statusText}
                </span>
              </div>
            </td>
            <td>
              <input 
                type="text" 
                class="editable-input" 
                value="${item.newName}" 
                data-index="${index}" 
                data-field="newName"
                data-row="${index}"
                data-col="1"
                placeholder="Nome do arquivo..."
              />
            </td>
            <td>
              <input 
                type="text" 
                class="editable-input" 
                value="${item.description}" 
                data-index="${index}" 
                data-field="description"
                data-row="${index}"
                data-col="2"
                placeholder="Descri√ß√£o do arquivo..."
              />
            </td>
            <td style="text-align: center;">
              <button 
                class="btn btn-small" 
                onclick="copyDescription(${index})"
                title="Copiar descri√ß√£o"
                style="padding: 4px 8px; font-size: 9px;"
                ${!item.description ? 'disabled' : ''}
              >
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                </svg>
              </button>
            </td>
          `;

          editableTableBody.appendChild(row);
        });

        // Event listeners para inputs
        document.querySelectorAll(".editable-input").forEach(input => {
          input.addEventListener("input", (e) => {
            const index = parseInt(e.target.dataset.index);
            const field = e.target.dataset.field;
            fileData[index][field] = e.target.value;
            updateButtonStates();
            
            // Atualizar estado do bot√£o de copiar quando descri√ß√£o muda
            if (field === "description") {
              const row = e.target.closest('tr');
              const copyBtn = row.querySelector('button[onclick*="copyDescription"]');
              if (copyBtn) {
                copyBtn.disabled = !e.target.value.trim();
              }
            }
          });

          input.addEventListener("focus", (e) => {
            currentCell.row = parseInt(e.target.dataset.row);
            currentCell.col = parseInt(e.target.dataset.col);
          });
        });

        updateTableHighlight();
      }

      // Atualizar linha espec√≠fica da tabela (APENAS quando dados s√£o efetivamente salvos)
      function updateTableRow(index) {
        const row = document.querySelector(`tr[data-index="${index}"]`);
        if (!row) return;
        
        const nameInput = row.querySelector('input[data-field="newName"]');
        const descInput = row.querySelector('input[data-field="description"]');
        const copyBtn = row.querySelector('button[onclick*="copyDescription"]');
        
        // Atualizar com os dados salvos no fileData
        if (nameInput) nameInput.value = fileData[index].newName || "";
        if (descInput) descInput.value = fileData[index].description || "";
        
        // Atualizar estado do bot√£o de copiar
        if (copyBtn) {
          copyBtn.disabled = !fileData[index].description;
        }
      }

      // Destacar linha atual
      function updateTableHighlight() {
        document.querySelectorAll("tr[data-index]").forEach(row => {
          row.classList.remove("current-row");
        });
        
        if (currentFileIndex !== -1) {
          const currentRow = document.querySelector(`tr[data-index="${currentFileIndex}"]`);
          if (currentRow) currentRow.classList.add("current-row");
        }
      }

      // Navega√ß√£o tipo Excel
      function handleKeyNavigation(e) {
        const activeElement = document.activeElement;
        if (!activeElement.classList.contains("editable-input")) return;

        if (e.key === "Tab") {
          e.preventDefault();
          navigateCell(e.shiftKey ? -1 : 1, 0);
        } else if (e.key === "Enter") {
          e.preventDefault();
          navigateCell(0, 1);
        }
      }

      function navigateCell(colDelta, rowDelta) {
        let newRow = currentCell.row + rowDelta;
        let newCol = currentCell.col + colDelta;

        // Ajustar limites
        if (newCol < 1) { newCol = 2; newRow--; }
        if (newCol > 2) { newCol = 1; newRow++; }
        if (newRow < 0) newRow = fileData.length - 1;
        if (newRow >= fileData.length) newRow = 0;

        // Focar nova c√©lula
        const newInput = document.querySelector(`input[data-row="${newRow}"][data-col="${newCol}"]`);
        if (newInput) {
          newInput.focus();
          currentCell = { row: newRow, col: newCol };
        }
      }

      // Estados dos bot√µes
      function updateButtonStates() {
        const hasFiles = files.length > 0;
        const hasAllNames = fileData.length > 0 && fileData.every(item => 
          item.newName.trim() !== ""
        );

        applyCurrentBtn.disabled = currentFileIndex === -1;
        applyAllBtn.disabled = !hasFiles;
        exportCsvBtn.disabled = !hasFiles;
        downloadBtn.disabled = !hasAllNames; // S√≥ precisa de nomes, descri√ß√£o √© opcional
      }

      // Copiar descri√ß√£o
      function copyDescription(index) {
        const description = fileData[index].description;
        if (!description) {
          showMessage("N√£o h√° descri√ß√£o para copiar.", "error");
          return;
        }

        navigator.clipboard.writeText(description).then(() => {
          showMessage("Descri√ß√£o copiada para a √°rea de transfer√™ncia!", "success");
        }).catch(() => {
          // Fallback para navegadores mais antigos
          const textArea = document.createElement("textarea");
          textArea.value = description;
          document.body.appendChild(textArea);
          textArea.select();
          try {
            document.execCommand('copy');
            showMessage("Descri√ß√£o copiada para a √°rea de transfer√™ncia!", "success");
          } catch (err) {
            showMessage("Erro ao copiar descri√ß√£o.", "error");
          }
          document.body.removeChild(textArea);
        });
      }

      // Exportar CSV
      function exportToCsv() {
        if (files.length === 0) {
          showMessage("N√£o h√° arquivos para exportar.", "error");
          return;
        }

        let csvContent = "Nome Original\tNovo Nome\tDescri√ß√£o\n";
        fileData.forEach(item => {
          csvContent += `${item.originalName}\t${item.newName}\t${item.description}\n`;
        });

        const blob = new Blob([csvContent], { type: 'text/plain;charset=utf-8' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "lista_arquivos_renomeados.csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showMessage("CSV exportado com sucesso!", "success");
      }

      // Download ZIP
      function downloadFiles() {
        const hasAllNames = fileData.every(item => 
          item.newName.trim() !== ""
        );

        if (!hasAllNames) {
          showMessage("Todos os arquivos precisam ter um nome definido.", "error");
          return;
        }

        // Verificar arquivos sem descri√ß√£o
        const filesWithoutDescription = fileData.filter(item => !item.description.trim());
        
        if (filesWithoutDescription.length > 0) {
          const plural = filesWithoutDescription.length > 1 ? 's' : '';
          const message = `${filesWithoutDescription.length} arquivo${plural} sem descri√ß√£o.\n\nDeseja continuar mesmo assim?`;
          
          showModal(message, () => {
            proceedWithDownload();
          });
          return;
        }

        // Prosseguir diretamente se todos t√™m descri√ß√£o
        proceedWithDownload();
      }

      // Fun√ß√£o separada para fazer o download
      function proceedWithDownload() {
        loadJSZip(() => {
          const zip = new JSZip();
          const promises = fileData.map((item) => {
            return new Promise((resolve) => {
              if (!item.newName.trim()) { resolve(); return; }
              const reader = new FileReader();
              reader.onload = (e) => {
                zip.file(item.newName, e.target.result);
                resolve();
              };
              reader.readAsArrayBuffer(item.file);
            });
          });

          Promise.all(promises)
            .then(() => zip.generateAsync({ type: "blob" }))
            .then((blob) => {
              const link = document.createElement("a");
              link.href = URL.createObjectURL(blob);
              link.download = "arquivos_renomeados.zip";
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              showMessage("ZIP baixado com sucesso!", "success");
            })
            .catch((error) => {
              showMessage("Erro ao criar ZIP: " + error.message, "error");
            });
        });
      }

      // Mostrar modal de confirma√ß√£o
      function showModal(message, onConfirm) {
        modalMessage.textContent = message;
        modalOverlay.style.display = "flex";
        
        // Atualizar refer√™ncia para o bot√£o de confirma√ß√£o
        const confirmBtn = document.getElementById("modalConfirm");
        
        // Remover listeners anteriores e adicionar novo
        confirmBtn.onclick = () => {
          closeModal();
          onConfirm();
        };
      }

      // Fechar modal
      function closeModal() {
        modalOverlay.style.display = "none";
      }

      // Carregar JSZip
      function loadJSZip(callback) {
        if (window.JSZip) { callback(); return; }
        const script = document.createElement("script");
        script.src = "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js";
        script.onload = callback;
        script.onerror = () => showMessage("Erro ao carregar JSZip.", "error");
        document.head.appendChild(script);
      }

      // Reset
      function resetAll() {
        files = [];
        fileData = [];
        currentFileIndex = -1;
        customNumberingPattern = null; // Resetar padr√£o personalizado
        fileInput.value = "";
        prefixInput.value = "";
        suffixInput.value = "";
        addNumbering.checked = true;
        separatorSelect.value = ",";

        document.querySelectorAll('input[type="checkbox"][id^="elemento_"], input[type="checkbox"][id^="dano_"], input[type="checkbox"][id^="localizacao_"]')
          .forEach(cb => cb.checked = false);

        fileCounter.textContent = "0 arquivos";
        currentFileSection.style.display = "none";
        progressInfo.textContent = "-";
        
        updateTable();
        updatePreviews();
        updateButtonStates();
        showMessage("Sistema resetado!", "success");
      }

      // Mostrar mensagens
      function showMessage(text, type) {
        messageDiv.textContent = text;
        messageDiv.className = `message ${type}`;
        messageDiv.style.display = "block";
        setTimeout(() => messageDiv.style.display = "none", 3000);
      }
    </script>
  </body>
</html>