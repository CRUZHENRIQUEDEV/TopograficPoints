<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste P2P Connection - OAE Revisor</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 { color: #333; margin-top: 0; }
        h2 { color: #555; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .status.success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .status.error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .status.warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .status.info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry { margin: 2px 0; padding: 2px; }
        .log-entry.error { color: #dc3545; }
        .log-entry.success { color: #28a745; }
        .log-entry.info { color: #17a2b8; }
        input, select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #007bff;
            color: white;
        }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        .badge.online { background: #28a745; color: white; }
        .badge.offline { background: #6c757d; color: white; }
    </style>
</head>
<body>
    <h1>üîç Diagn√≥stico de Conex√£o P2P - OAE Revisor</h1>

    <div class="container">
        <h2>üìä Status do Sistema</h2>
        <div id="systemStatus"></div>
    </div>

    <div class="container">
        <h2>üë• Usu√°rios Locais (localStorage)</h2>
        <div id="localUsers"></div>
    </div>

    <div class="container">
        <h2>üåê Peers Conhecidos</h2>
        <div id="knownPeers"></div>
    </div>

    <div class="container">
        <h2>üîó Conex√µes Ativas</h2>
        <div id="activeConnections"></div>
    </div>

    <div class="container">
        <h2>üîß A√ß√µes de Diagn√≥stico</h2>
        <button onclick="testAutoDiscovery()">üîç Testar Auto-Discovery</button>
        <button onclick="manualConnect()">üîó Conectar Manualmente a Outro Peer</button>
        <button onclick="checkPeerJS()">üì° Verificar PeerJS Status</button>
        <button onclick="clearAndReconnect()">üîÑ Limpar e Reconectar</button>
        <button onclick="showLocalStorage()">üíæ Ver LocalStorage Completo</button>
        <div style="margin-top: 10px;">
            <input type="text" id="manualPeerId" placeholder="oae-xxxxxxxxxxxxx" style="width: 300px;">
            <button onclick="connectToSpecific()">Conectar a este Peer ID</button>
        </div>
    </div>

    <div class="container">
        <h2>üìù Log de Eventos</h2>
        <button onclick="clearLog()">üóëÔ∏è Limpar Log</button>
        <div id="log" class="log"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script>
        // Global log function
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('Log limpo', 'info');
        }

        // Check system status
        function checkSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            let html = '';

            // Check if PeerJS is loaded
            if (typeof Peer !== 'undefined') {
                html += '<div class="status success">‚úÖ PeerJS carregado corretamente</div>';
            } else {
                html += '<div class="status error">‚ùå PeerJS N√ÉO est√° carregado!</div>';
                log('PeerJS n√£o encontrado!', 'error');
            }

            // Check localStorage
            const userId = localStorage.getItem('oae-user-id');
            const userEmail = localStorage.getItem('oae-user-email');
            const userName = localStorage.getItem('oae-user-name');

            if (userId && userEmail) {
                html += `<div class="status success">‚úÖ Usu√°rio logado: ${userName} (${userEmail})</div>`;
                html += `<div class="status info">‚ÑπÔ∏è User ID: ${userId}</div>`;
                html += `<div class="status info">‚ÑπÔ∏è Peer ID: oae-${userId}</div>`;
                log(`Usu√°rio identificado: ${userName} (oae-${userId})`, 'success');
            } else {
                html += '<div class="status warning">‚ö†Ô∏è Nenhum usu√°rio logado no localStorage</div>';
                log('Usu√°rio n√£o identificado', 'warning');
            }

            statusDiv.innerHTML = html;
        }

        // Show local users
        function showLocalUsers() {
            const usersDiv = document.getElementById('localUsers');
            const users = JSON.parse(localStorage.getItem('oae-users') || '[]');

            if (users.length === 0) {
                usersDiv.innerHTML = '<div class="status warning">‚ö†Ô∏è Nenhum usu√°rio cadastrado no sistema</div>';
                log('Lista de usu√°rios vazia', 'warning');
                return;
            }

            let html = `<div class="status info">üìã Total de ${users.length} usu√°rio(s) cadastrado(s)</div>`;
            html += '<table><tr><th>Nome</th><th>Email</th><th>Peer ID</th><th>Role</th></tr>';

            users.forEach(user => {
                const peerId = generateUserId(user.email);
                html += `<tr>
                    <td>${user.name || 'N/A'}</td>
                    <td>${user.email}</td>
                    <td><code>oae-${peerId}</code></td>
                    <td>${user.role || 'N/A'}</td>
                </tr>`;
            });

            html += '</table>';
            usersDiv.innerHTML = html;
            log(`${users.length} usu√°rios encontrados no localStorage`, 'info');
        }

        // Generate user ID (same logic as multiPeerSync.js)
        function generateUserId(email) {
            const hash = btoa(email.toLowerCase())
                .replace(/[^a-zA-Z0-9]/g, '')
                .substring(0, 12);
            return hash;
        }

        // Show known peers
        function showKnownPeers() {
            const peersDiv = document.getElementById('knownPeers');
            const knownPeers = JSON.parse(localStorage.getItem('oae-known-peers') || '[]');

            if (knownPeers.length === 0) {
                peersDiv.innerHTML = '<div class="status warning">‚ö†Ô∏è Nenhum peer conhecido registrado</div>';
                log('Nenhum peer conhecido', 'warning');
                return;
            }

            let html = `<div class="status info">üì° Total de ${knownPeers.length} peer(s) conhecido(s)</div>`;
            html += '<table><tr><th>Peer ID</th><th>Status</th><th>Info</th></tr>';

            knownPeers.forEach(peerId => {
                const peerInfo = localStorage.getItem(`oae-peer-${peerId}`);
                let info = 'N/A';
                if (peerInfo) {
                    try {
                        const parsed = JSON.parse(peerInfo);
                        info = parsed.displayName || 'N/A';
                    } catch (e) {}
                }

                html += `<tr>
                    <td><code>${peerId}</code></td>
                    <td><span class="badge offline">offline</span></td>
                    <td>${info}</td>
                </tr>`;
            });

            html += '</table>';
            peersDiv.innerHTML = html;
            log(`${knownPeers.length} peers conhecidos`, 'info');
        }

        // Show active connections (placeholder - would need actual peer connection)
        function showActiveConnections() {
            const connDiv = document.getElementById('activeConnections');
            connDiv.innerHTML = '<div class="status info">‚ÑπÔ∏è Para ver conex√µes ativas, √© necess√°rio inicializar o MultiPeerSync no app principal</div>';
        }

        // Test auto-discovery
        function testAutoDiscovery() {
            log('=== TESTE DE AUTO-DISCOVERY ===', 'info');

            const users = JSON.parse(localStorage.getItem('oae-users') || '[]');
            const currentUserId = localStorage.getItem('oae-user-id');
            const currentPeerId = `oae-${currentUserId}`;

            log(`Peer ID atual: ${currentPeerId}`, 'info');
            log(`Total de usu√°rios na lista: ${users.length}`, 'info');

            if (users.length === 0) {
                log('‚ùå PROBLEMA: Nenhum usu√°rio cadastrado!', 'error');
                log('SOLU√á√ÉO: Fa√ßa login e adicione usu√°rios atrav√©s do sistema de gerenciamento', 'info');
                return;
            }

            const potentialPeers = [];
            users.forEach(user => {
                const peerId = `oae-${generateUserId(user.email)}`;
                if (peerId !== currentPeerId) {
                    potentialPeers.push({ peerId, name: user.name, email: user.email });
                    log(`‚úì Peer potencial encontrado: ${user.name} (${peerId})`, 'success');
                } else {
                    log(`‚ÑπÔ∏è Ignorando peer pr√≥prio: ${peerId}`, 'info');
                }
            });

            if (potentialPeers.length === 0) {
                log('‚ö†Ô∏è Nenhum peer dispon√≠vel para conex√£o (voc√™ √© o √∫nico usu√°rio)', 'warning');
            } else {
                log(`‚úÖ ${potentialPeers.length} peer(s) dispon√≠vel(is) para conex√£o`, 'success');
                log('üí° Para conectar, esses peers devem estar online simultaneamente', 'info');
            }
        }

        // Manual connect simulation
        function manualConnect() {
            log('Para conectar manualmente, insira o Peer ID completo no campo acima', 'info');
        }

        // Connect to specific peer
        function connectToSpecific() {
            const peerId = document.getElementById('manualPeerId').value.trim();
            if (!peerId) {
                log('‚ùå Digite um Peer ID v√°lido', 'error');
                return;
            }

            if (!peerId.startsWith('oae-')) {
                log('‚ö†Ô∏è Peer ID deve come√ßar com "oae-"', 'warning');
                return;
            }

            log(`Tentando adicionar peer: ${peerId}`, 'info');

            // Add to known peers
            const knownPeers = JSON.parse(localStorage.getItem('oae-known-peers') || '[]');
            if (!knownPeers.includes(peerId)) {
                knownPeers.push(peerId);
                localStorage.setItem('oae-known-peers', JSON.stringify(knownPeers));
                log(`‚úÖ Peer ${peerId} adicionado √† lista de peers conhecidos`, 'success');
                log('üîÑ Recarregue a p√°gina principal do OAE Revisor para tentar conex√£o', 'info');
                showKnownPeers();
            } else {
                log(`‚ÑπÔ∏è Peer ${peerId} j√° est√° na lista de conhecidos`, 'info');
            }
        }

        // Check PeerJS status
        function checkPeerJS() {
            log('=== VERIFICA√á√ÉO DO PEERJS ===', 'info');

            if (typeof Peer === 'undefined') {
                log('‚ùå PeerJS n√£o est√° carregado!', 'error');
                log('SOLU√á√ÉO: Verifique a conex√£o com internet e se o CDN est√° acess√≠vel', 'info');
                return;
            }

            log('‚úÖ PeerJS est√° carregado', 'success');
            log(`Vers√£o do PeerJS: ${Peer.version || 'desconhecida'}`, 'info');

            // Try to create a test peer
            const testId = `test-${Date.now()}`;
            log(`Tentando criar peer de teste com ID: ${testId}`, 'info');

            try {
                const testPeer = new Peer(testId, {
                    debug: 2,
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' }
                        ]
                    }
                });

                testPeer.on('open', (id) => {
                    log(`‚úÖ Peer de teste criado com sucesso! ID: ${id}`, 'success');
                    log('‚úÖ PeerJS est√° funcionando corretamente', 'success');
                    setTimeout(() => {
                        testPeer.destroy();
                        log('Peer de teste destru√≠do', 'info');
                    }, 2000);
                });

                testPeer.on('error', (err) => {
                    log(`‚ùå Erro no peer de teste: ${err.type} - ${err.message}`, 'error');
                    if (err.type === 'network') {
                        log('PROBLEMA: Erro de rede - verifique firewall ou bloqueadores', 'error');
                    }
                });
            } catch (error) {
                log(`‚ùå Erro ao criar peer de teste: ${error.message}`, 'error');
            }
        }

        // Clear and reconnect
        function clearAndReconnect() {
            if (!confirm('Isso vai limpar todos os peers conhecidos. Continuar?')) {
                return;
            }

            log('üóëÔ∏è Limpando peers conhecidos...', 'info');
            localStorage.setItem('oae-known-peers', '[]');

            // Remove all peer info
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('oae-peer-')) {
                    localStorage.removeItem(key);
                }
            }

            log('‚úÖ Peers limpos', 'success');
            log('üîÑ Execute o auto-discovery novamente', 'info');

            showKnownPeers();
        }

        // Show localStorage
        function showLocalStorage() {
            log('=== LOCALSTORAGE COMPLETO ===', 'info');

            const relevant = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('oae-')) {
                    const value = localStorage.getItem(key);
                    relevant[key] = value;
                    log(`${key}: ${value.substring(0, 100)}${value.length > 100 ? '...' : ''}`, 'info');
                }
            }

            console.log('localStorage completo:', relevant);
        }

        // Initialize on load
        window.onload = function() {
            log('üöÄ Iniciando diagn√≥stico...', 'info');
            checkSystemStatus();
            showLocalUsers();
            showKnownPeers();
            showActiveConnections();
            log('‚úÖ Diagn√≥stico inicial conclu√≠do', 'success');
            log('üí° Use os bot√µes acima para executar testes espec√≠ficos', 'info');
        };
    </script>
</body>
</html>
