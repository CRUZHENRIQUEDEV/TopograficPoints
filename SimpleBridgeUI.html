<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OAE - Interface de Preenchimento</title>
    <style>
      :root {
        --dark-bg: #2c3e50;
        --light-text: #ecf0f1;
        --accent: #3498db;
        --light-bg: #f5f5f5;
        --border-color: #bdc3c7;
        --section-bg: #34495e;
        --header-bg: #e67e22;
        --success: #27ae60;
        --danger: #e74c3c;
        --warning: #f39c12;
        --required: #e74c3c;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: var(--light-bg);
        color: #333;
        line-height: 1.6;
      }

      .container {
        width: 90%;
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      header {
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      h1,
      h2,
      h3 {
        color: var(--dark-bg);
      }

      h1 {
        font-size: 24px;
        margin-bottom: 10px;
      }

      h2 {
        font-size: 20px;
        margin: 20px 0 10px;
        background: var(--dark-bg);
        color: var(--light-text);
        padding: 10px;
        border-radius: 4px;
      }

      h3 {
        font-size: 18px;
        margin: 15px 0 10px;
        padding-bottom: 5px;
        border-bottom: 1px solid var(--border-color);
      }

      .tabs {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
      }

      .tab {
        padding: 10px 20px;
        cursor: pointer;
        background-color: #f1f1f1;
        margin-right: 2px;
        margin-bottom: 5px;
        border-radius: 4px 4px 0 0;
      }

      .tab.active {
        background-color: var(--dark-bg);
        color: var(--light-text);
      }

      .tab-content {
        display: none;
        padding: 20px;
        background-color: white;
        border: 1px solid var(--border-color);
        border-top: none;
      }

      .tab-content.active {
        display: block;
      }

      .form-row {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 10px;
      }

      .form-group {
        margin-right: 15px;
        margin-bottom: 15px;
        flex: 1 0 calc(33.333% - 15px);
        min-width: 200px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }

      /* Indicador de campo obrigat√≥rio */
      label.required::after {
        content: " *";
        color: var(--required);
        font-weight: bold;
      }

      input[type="text"],
      input[type="number"],
      input[type="date"],
      select {
        width: 100%;
        padding: 8px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 14px;
        background-color: white;
      }

      /* Estilo para campos com erro */
      input.error,
      select.error {
        border: 2px solid var(--danger);
        background-color: rgba(231, 76, 60, 0.1);
      }

      /* Mensagem de erro */
      .error-message {
        color: var(--danger);
        font-size: 12px;
        margin-top: 4px;
        display: none;
      }

      .error-message.visible {
        display: block;
      }

      select {
        cursor: pointer;
      }

      input[type="checkbox"] {
        margin-right: 5px;
      }

      button {
        background-color: var(--accent);
        color: white;
        border: none;
        padding: 10px 15px;
        margin: 5px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
      }

      button:hover {
        background-color: #2980b9;
      }

      button:disabled {
        background-color: #95a5a6;
        cursor: not-allowed;
      }

      .add-btn {
        background-color: #27ae60;
      }

      .add-btn:hover {
        background-color: #219653;
      }

      .copy-btn {
        background-color: #8e44ad;
      }

      .copy-btn:hover {
        background-color: #7d3c98;
      }

      .delete-btn {
        background-color: var(--danger);
      }

      .delete-btn:hover {
        background-color: #c0392b;
      }

      .dynamic-container {
        border: 1px solid var(--border-color);
        padding: 15px;
        margin: 10px 0;
        border-radius: 4px;
        background: var(--light-bg);
      }

      .dynamic-fields {
        display: flex;
        flex-direction: column;
      }

      .actions {
        margin-top: 20px;
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .section-header {
        background: var(--header-bg);
        color: white;
        padding: 8px 12px;
        margin: 15px 0 10px;
        border-radius: 4px;
        font-weight: bold;
        font-size: 16px;
      }

      .new-field-form {
        margin-top: 20px;
        padding: 15px;
        border: 1px dashed var(--border-color);
        border-radius: 4px;
        background: #f9f9f9;
      }

      .field-type-selector {
        display: flex;
        margin-bottom: 15px;
        gap: 10px;
      }

      @media (max-width: 768px) {
        .form-group {
          flex: 1 0 100%;
        }

        .actions {
          justify-content: center;
        }
      }

      #dynamic-tramos,
      #dynamic-apoios {
        background-color: rgba(52, 152, 219, 0.05);
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 20px;
      }

      .dynamic-field {
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        width: 100%;
      }

      .dynamic-field label {
        width: 100px;
        margin-right: 10px;
        margin-bottom: 0;
        flex-shrink: 0;
      }

      .dynamic-field input {
        flex-grow: 1;
      }

      pre.csv-output {
        background: #f1f1f1;
        padding: 15px;
        border-radius: 4px;
        overflow-x: auto;
        margin: 20px 0;
        display: none;
      }

      #csv-line {
        margin: 10px 0;
        padding: 15px;
        background: #f1f1f1;
        border-radius: 4px;
        border: 1px solid #ddd;
        font-family: monospace;
        white-space: pre-wrap;
        word-break: break-all;
        display: none;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 20px;
        border-radius: 8px;
        width: 80%;
        max-width: 800px;
        max-height: 80%;
        overflow-y: auto;
      }

      .summary-modal .modal-content {
        width: 90%;
        max-width: 1000px;
      }

      .close-modal {
        float: right;
        cursor: pointer;
        font-size: 24px;
        font-weight: bold;
      }

      .close-modal:hover {
        color: var(--accent);
      }

      .works-panel {
        margin-bottom: 20px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 15px;
      }

      .works-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        margin: 10px 0;
        padding: 10px;
        background-color: #f9f9f9;
      }

      .work-item {
        padding: 8px;
        margin-bottom: 5px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
      }

      .work-item:hover {
        background-color: #e3f2fd;
      }

      .work-item.selected {
        background-color: #e3f2fd;
        font-weight: bold;
      }

      .filter-container {
        display: flex;
        margin-bottom: 10px;
        gap: 10px;
      }

      .filter-container input {
        flex-grow: 1;
        padding: 8px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
      }

      .notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--dark-bg);
        color: white;
        padding: 10px 15px;
        border-radius: 4px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        display: none;
        z-index: 1000;
      }

      .toggle-panel {
        cursor: pointer;
        background-color: var(--accent);
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 14px;
        border: none;
        margin-left: 10px;
      }

      /* Estilos para o resumo */
      .summary-section {
        margin-bottom: 20px;
        border-bottom: 1px solid #ddd;
        padding-bottom: 15px;
      }

      .summary-section h3 {
        background-color: var(--dark-bg);
        color: white;
        padding: 8px;
        border-radius: 4px;
      }

      .summary-row {
        display: flex;
        margin: 8px 0;
        padding: 4px 0;
        border-bottom: 1px solid #eee;
      }

      .summary-label {
        flex: 0 0 40%;
        font-weight: bold;
      }

      .summary-value {
        flex: 0 0 60%;
      }

      .missing-field {
        color: var(--danger);
        font-weight: bold;
      }

      .missing-fields-list {
        background-color: rgba(231, 76, 60, 0.1);
        padding: 10px;
        border-radius: 4px;
        border-left: 4px solid var(--danger);
        margin-bottom: 15px;
      }

      /* Estilos para o resumo */
      .summary-section {
        margin-bottom: 20px;
        border-bottom: 1px solid #ddd;
        padding-bottom: 15px;
      }

      .summary-section h3 {
        background-color: var(--dark-bg);
        color: white;
        padding: 8px;
        border-radius: 4px;
      }

      .summary-row {
        display: flex;
        margin: 8px 0;
        padding: 4px 0;
        border-bottom: 1px solid #eee;
      }

      .summary-label {
        flex: 0 0 40%;
        font-weight: bold;
      }

      .summary-value {
        flex: 0 0 60%;
      }

      .missing-field {
        color: var(--danger);
        font-weight: bold;
      }

      .missing-fields-list {
        background-color: rgba(231, 76, 60, 0.1);
        padding: 10px;
        border-radius: 4px;
        border-left: 4px solid var(--danger);
        margin-bottom: 15px;
      }
    </style>
  </head>
  <body>
    <div class="notification" id="save-reminder">
      Lembrete: Salve seus dados para n√£o perder o trabalho!
      <button onclick="exportToCSV()">Salvar agora</button>
    </div>

    <div class="container">
      <header>
        <h1>Interface de Preenchimento de Obras de Arte Especiais (OAE)</h1>
        <button id="toggle-works-panel" class="toggle-panel">
          Mostrar Obras
        </button>
      </header>

      <div class="works-panel" id="works-panel" style="display: none">
        <h2>Gerenciamento de Obras</h2>
        <div class="filter-container">
          <input
            type="text"
            id="filter-works"
            placeholder="Filtrar por c√≥digo..."
          />
          <button onclick="filterWorks()">Filtrar</button>
        </div>
        <div class="works-list" id="works-list">
          <!-- Lista de obras aqui -->
          <div class="work-item">Nenhuma obra cadastrada</div>
        </div>
        <div class="actions">
          <button type="button" onclick="createNewWork()">Nova Obra</button>
          <button type="button" onclick="importMultipleWorks()">
            Importar M√∫ltiplas Obras
          </button>
          <button type="button" onclick="exportAllWorks()">
            Exportar Todas Obras
          </button>
          <button type="button" class="delete-btn" onclick="clearDatabase()">
            Limpar Banco de Dados
          </button>
        </div>
      </div>

      <div class="tabs">
        <div class="tab active" data-tab="info">Informa√ß√µes Gerais</div>
        <div class="tab" data-tab="configuracao">Configura√ß√µes Gerais</div>
        <div class="tab" data-tab="transicao">Transi√ß√£o</div>
        <div class="tab" data-tab="superestrutura">Superestrutura</div>
        <div class="tab" data-tab="apoio">Apoio</div>
        <div class="tab" data-tab="complementares">
          Elementos Complementares
        </div>
      </div>

      <form id="oae-form">
        <!-- Informa√ß√µes Gerais -->
        <div class="tab-content active" id="info-content">
          <h2>Informa√ß√µes Gerais da Obra</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="modelado">Modelado:</label>
              <input type="checkbox" id="modelado" name="MODELADO" />
            </div>
            <div class="form-group">
              <label for="codigo">C√≥digo:</label>
              <input type="text" id="codigo" name="CODIGO" required />
            </div>
            <div class="form-group">
              <label for="nome">Nome:</label>
              <input type="text" id="nome" name="NOME" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="uf">UF:</label>
              <input type="text" id="uf" name="UF" />
            </div>
            <div class="form-group">
              <label for="rodovia">Rodovia:</label>
              <input type="text" id="rodovia" name="RODOVIA" />
            </div>
            <div class="form-group">
              <label for="km">KM:</label>
              <input type="number" id="km" name="KM" step="0.01" min="0" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="data">Data:</label>
              <input
                type="text"
                id="data"
                name="DATA"
                placeholder="dd/mm/aaaa"
              />
            </div>
            <div class="form-group">
              <label for="engenheiro">Engenheiro:</label>
              <input type="text" id="engenheiro" name="ENGENHEIRO" />
            </div>
            <div class="form-group">
              <label for="tecnico">T√©cnico:</label>
              <input type="text" id="tecnico" name="TECNICO" />
            </div>
          </div>
          <div id="info-custom-fields"></div>
          <button
            type="button"
            class="add-btn"
            onclick="showAddField('info-custom-fields')"
          >
            + Adicionar Campo
          </button>
        </div>

        <!-- Configura√ß√µes Gerais -->
        <div class="tab-content" id="configuracao-content">
          <h2>Configura√ß√µes Gerais</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="comprimento" class="required">Comprimento (m):</label>
              <input
                type="number"
                id="comprimento"
                name="COMPRIMENTO"
                step="0.01"
                min="0"
                required
              />
              <div class="error-message" id="comprimento-error">
                Este campo √© obrigat√≥rio
              </div>
            </div>
            <div class="form-group">
              <label for="largura" class="required">Largura (m):</label>
              <input
                type="number"
                id="largura"
                name="LARGURA"
                step="0.01"
                min="0"
                required
              />
              <div class="error-message" id="largura-error">
                Este campo √© obrigat√≥rio
              </div>
            </div>
            <div class="form-group">
              <label for="altura" class="required">Altura (m):</label>
              <input
                type="number"
                id="altura"
                name="ALTURA"
                step="0.01"
                min="0"
                required
              />
              <div class="error-message" id="altura-error">
                Este campo √© obrigat√≥rio
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="qtd-tramos" class="required"
                >Quantidade de Tramos:</label
              >
              <input
                type="number"
                id="qtd-tramos"
                name="QTD TRAMOS"
                min="1"
                value="1"
                required
                onchange="generateTramosFields()"
              />
              <div class="error-message" id="qtd-tramos-error">
                Este campo √© obrigat√≥rio e deve ser no m√≠nimo 1
              </div>
            </div>
          </div>

          <div id="dynamic-tramos" class="dynamic-container">
            <h3>Comprimento dos Tramos</h3>
            <div id="tramos-fields" class="dynamic-fields">
              <!-- Campos gerados dinamicamente para tramos -->
            </div>
            <div class="error-message" id="tramos-error">
              Todos os tramos devem ter comprimento m√≠nimo de 0.5m
            </div>
          </div>

          <div id="config-custom-fields"></div>
          <button
            type="button"
            class="add-btn"
            onclick="showAddField('config-custom-fields')"
          >
            + Adicionar Campo
          </button>
        </div>

        <!-- Transi√ß√£o -->
        <div class="tab-content" id="transicao-content">
          <h2>Transi√ß√£o</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="cortina-altura" class="required"
                >Cortina Altura (m):</label
              >
              <input
                type="number"
                id="cortina-altura"
                name="CORTINA ALTURA"
                step="0.01"
                min="0"
                required
              />
              <div class="error-message" id="cortina-altura-error">
                Este campo √© obrigat√≥rio
              </div>
            </div>
            <div class="form-group">
              <label for="ala-paralela">Ala Paralela:</label>
              <select id="ala-paralela" name="ALA PARALELA">
                <option value="">Selecione</option>
                <option value="ALA DE CONCRETO ARMADO">
                  ALA DE CONCRETO ARMADO
                </option>
                <option value="Nenhum">Nenhum</option>
              </select>
            </div>
            <div class="form-group">
              <label for="ala-perpendicular">Ala Perpendicular:</label>
              <select id="ala-perpendicular" name="ALA PERPENDICULAR">
                <option value="">Selecione</option>
                <option value="ALA DE CONCRETO ARMADO">
                  ALA DE CONCRETO ARMADO
                </option>
                <option value="Nenhum">Nenhum</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="comprimento-ala" class="required"
                >Comprimento Ala (m):</label
              >
              <input
                type="number"
                id="comprimento-ala"
                name="COMPRIMENTO ALA"
                step="0.01"
                min="0"
                required
              />
              <div class="error-message" id="comprimento-ala-error">
                Este campo √© obrigat√≥rio se alguma ala estiver selecionada
              </div>
            </div>
            <div class="form-group">
              <label for="espessura-ala">Espessura Ala (m):</label>
              <input
                type="number"
                id="espessura-ala"
                name="ESPESSURA ALA"
                step="0.01"
                min="0"
              />
            </div>
            <div class="form-group">
              <label for="encontro">Encontro:</label>
              <select id="encontro" name="ENCONTRO">
                <option value="">Selecione</option>
                <option value="Nenhum">Nenhum</option>
                <option value="ENCONTRO - PAREDE FRONTAL PORTANTE">
                  ENCONTRO - PAREDE FRONTAL PORTANTE
                </option>
                <option value="ENCONTRO LAJE">ENCONTRO LAJE</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="deslocamento-esquerdo-encontro-laje"
                >Deslocamento Esquerdo Encontro Laje (m):</label
              >
              <input
                type="number"
                id="deslocamento-esquerdo-encontro-laje"
                name="DESLOCAMENTO ESQUERDO ENCONTRO LAJE"
                step="0.01"
                min="0"
              />
            </div>
            <div class="form-group">
              <label for="deslocamento-direito-encontro-laje"
                >Deslocamento Direito Encontro Laje (m):</label
              >
              <input
                type="number"
                id="deslocamento-direito-encontro-laje"
                name="DESLOCAMENTO DIREITO ENCONTRO LAJE"
                step="0.01"
                min="0"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="comprimento-encontro-laje"
                >Comprimento Encontro Laje (m):</label
              >
              <input
                type="number"
                id="comprimento-encontro-laje"
                name="COMPRIMENTO ENCONTRO LAJE"
                step="0.01"
                min="0"
              />
            </div>
            <div class="form-group">
              <label for="laje-transicao">Laje de Transi√ß√£o:</label>
              <select id="laje-transicao" name="LAJE DE TRANSI√á√ÉO">
                <option value="">Selecione</option>
                <option value="Nenhum">Nenhum</option>
                <option value="LAJE DE TRANSI√á√ÉO">LAJE DE TRANSI√á√ÉO</option>
              </select>
            </div>
          </div>

          <div id="transicao-custom-fields"></div>
          <button
            type="button"
            class="add-btn"
            onclick="showAddField('transicao-custom-fields')"
          >
            + Adicionar Campo
          </button>
        </div>

        <!-- Superestrutura -->
        <div class="tab-content" id="superestrutura-content">
          <h2>Superestrutura</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="altura-longarina" class="required"
                >Altura Longarina (m):</label
              >
              <input
                type="number"
                id="altura-longarina"
                name="ALTURA LONGARINA"
                step="0.01"
                min="0"
                required
              />
              <div class="error-message" id="altura-longarina-error">
                Este campo √© obrigat√≥rio
              </div>
            </div>
            <div class="form-group">
              <label for="deslocamento-esquerdo" class="required"
                >Deslocamento Esquerdo (m):</label
              >
              <input
                type="number"
                id="deslocamento-esquerdo"
                name="DESLOCAMENTO ESQUERDO"
                step="0.01"
                min="0"
                required
              />
              <div class="error-message" id="deslocamento-esquerdo-error">
                Este campo √© obrigat√≥rio
              </div>
            </div>
            <div class="form-group">
              <label for="deslocamento-direito" class="required"
                >Deslocamento Direito (m):</label
              >
              <input
                type="number"
                id="deslocamento-direito"
                name="DESLOCAMENTO DIREITO"
                step="0.01"
                min="0"
                required
              />
              <div class="error-message" id="deslocamento-direito-error">
                Este campo √© obrigat√≥rio
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="qtd-longarinas" class="required"
                >Quantidade de Longarinas:</label
              >
              <input
                type="number"
                id="qtd-longarinas"
                name="QTD LONGARINAS"
                min="0"
                required
              />
              <div class="error-message" id="qtd-longarinas-error">
                Este campo √© obrigat√≥rio
              </div>
            </div>
            <div class="form-group">
              <label for="qtd-transversinas"
                >Quantidade de Transversinas:</label
              >
              <input
                type="number"
                id="qtd-transversinas"
                name="QTD TRANSVERSINAS"
                min="0"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="espessura-longarina" class="required"
                >Espessura Longarina (m):</label
              >
              <input
                type="number"
                id="espessura-longarina"
                name="ESPESSURA LONGARINA"
                step="0.01"
                min="0"
                required
              />
              <div class="error-message" id="espessura-longarina-error">
                Este campo √© obrigat√≥rio
              </div>
            </div>
            <div class="form-group">
              <label for="espessura-transversina"
                >Espessura Transversina (m):</label
              >
              <input
                type="number"
                id="espessura-transversina"
                name="ESPESSURA TRANSVERSINA"
                step="0.01"
                min="0"
              />
            </div>
            <div class="form-group">
              <label for="espessura-laje" class="required"
                >Espessura Laje (m):</label
              >
              <input
                type="number"
                id="espessura-laje"
                name="ESPESSURA LAJE"
                step="0.01"
                min="0"
                required
              />
              <div class="error-message" id="espessura-laje-error">
                Este campo √© obrigat√≥rio
              </div>
            </div>
          </div>

          <div id="superestrutura-custom-fields"></div>
          <button
            type="button"
            class="add-btn"
            onclick="showAddField('superestrutura-custom-fields')"
          >
            + Adicionar Campo
          </button>
        </div>

        <!-- Apoio -->
        <div class="tab-content" id="apoio-content">
          <h2>Apoio</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="qtd-pilares" class="required"
                >Quantidade de Pilares:</label
              >
              <input
                type="number"
                id="qtd-pilares"
                name="QTD PILARES"
                min="0"
                required
              />
              <div class="error-message" id="qtd-pilares-error">
                Este campo √© obrigat√≥rio
              </div>
            </div>
            <div class="form-group">
              <label for="pilar-descentralizado">Pilar Descentralizado:</label>
              <select id="pilar-descentralizado" name="PILAR DESCENTRALIZADO">
                <option value="">Selecione</option>
                <option value="Sim">Sim</option>
                <option value="N√£o">N√£o</option>
              </select>
            </div>
            <div class="form-group">
              <label for="largura-pilar">Largura do Pilar (m):</label>
              <input
                type="number"
                id="largura-pilar"
                name="LARGURA PILAR"
                step="0.01"
                min="0"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="comprimento-pilares">Comprimento Pilares (m):</label>
              <input
                type="number"
                id="comprimento-pilares"
                name="COMPRIMENTO PILARES"
                step="0.01"
                min="0"
              />
            </div>
            <div class="form-group">
              <label for="tipo-aparelho-apoio"
                >Tipo de Aparelho de Apoio:</label
              >
              <select id="tipo-aparelho-apoio" name="TIPO DE APARELHO DE APOIO">
                <option value="">Selecione</option>
                <option value="APARELHO DE APOIO DE NEOPRENE FRETADO">
                  APARELHO DE APOIO DE NEOPRENE FRETADO
                </option>
                <option value="Nenhum">Nenhum</option>
              </select>
            </div>
          </div>

          <div id="dynamic-apoios" class="dynamic-container">
            <h3>Altura dos Apoios</h3>
            <div id="apoios-fields" class="dynamic-fields">
              <!-- Campos gerados dinamicamente para apoios -->
            </div>
            <div class="error-message" id="apoios-error">
              Todos os apoios precisam ser preenchidos
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="tipo-travessa">Tipo de Travessa:</label>
              <select id="tipo-travessa" name="TIPO DE TRAVESSA">
                <option value="">Selecione</option>
                <option value="TRAVESSA DE APOIO DE CONCRETO ARMADO">
                  TRAVESSA DE APOIO DE CONCRETO ARMADO
                </option>
                <option value="Nenhum">Nenhum</option>
              </select>
            </div>
            <div class="form-group">
              <label for="altura-travessa">Altura Travessa (m):</label>
              <input
                type="number"
                id="altura-travessa"
                name="ALTURA TRAVESSA"
                step="0.01"
                min="0"
              />
              <div class="error-message" id="altura-travessa-error">
                Este campo √© obrigat√≥rio se uma travessa estiver selecionada
              </div>
            </div>
            <div class="form-group">
              <label for="tipo-encamisamento">Tipo de Encamisamento:</label>
              <select id="tipo-encamisamento" name="TIPO DE ENCAMISAMENTO">
                <option value="">Selecione</option>
                <option value="ENCAMISAMENTO DE PILAR">
                  ENCAMISAMENTO DE PILAR
                </option>
                <option value="Nenhum">Nenhum</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="tipo-bloco-sapata">Tipo de Bloco ou Sapata:</label>
              <select id="tipo-bloco-sapata" name="TIPO DE BLOCO OU SAPATA">
                <option value="">Selecione</option>
                <option value="BLOCO OU SAPATA DE CONCRETO ARMADO">
                  BLOCO OU SAPATA DE CONCRETO ARMADO
                </option>
                <option value="Nenhum">Nenhum</option>
              </select>
            </div>
            <div class="form-group">
              <label for="altura-bloco-sapata"
                >Altura Bloco ou Sapata (m):</label
              >
              <input
                type="number"
                id="altura-bloco-sapata"
                name="ALTURA BLOCO OU SAPATA"
                step="0.01"
                min="0"
              />
            </div>
            <div class="form-group">
              <label for="largura-bloco-sapata"
                >Largura Bloco ou Sapata (m):</label
              >
              <input
                type="number"
                id="largura-bloco-sapata"
                name="LARGURA BLOCO OU SAPATA"
                step="0.01"
                min="0"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="viga-contraventamento-pilar"
                >Viga de Contraventamento de Pilar:</label
              >
              <select
                id="viga-contraventamento-pilar"
                name="VIGA DE CONTRAVENTAMENTO DE PILAR"
              >
                <option value="">Selecione</option>
                <option value="VIGA DE CONTRAVENTAMENTO DE PILAR">
                  VIGA DE CONTRAVENTAMENTO DE PILAR
                </option>
                <option value="Nenhum">Nenhum</option>
              </select>
            </div>
            <div class="form-group">
              <label for="viga-ligacao-fundacoes"
                >Viga de Liga√ß√£o de Funda√ß√µes:</label
              >
              <select
                id="viga-ligacao-fundacoes"
                name="VIGA DE LIGA√á√ÉO DE FUNDA√á√ïES"
              >
                <option value="">Selecione</option>
                <option value="VIGA DE LIGA√á√ÉO DE FUNDA√á√ïES">
                  VIGA DE LIGA√á√ÉO DE FUNDA√á√ïES
                </option>
                <option value="Nenhum">Nenhum</option>
              </select>
            </div>
          </div>

          <div id="apoio-custom-fields"></div>
          <button
            type="button"
            class="add-btn"
            onclick="showAddField('apoio-custom-fields')"
          >
            + Adicionar Campo
          </button>
        </div>

        <!-- Elementos Complementares -->
        <div class="tab-content" id="complementares-content">
          <h2>Elementos Complementares</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="barreira-esquerda">Barreira Esquerda:</label>
              <select id="barreira-esquerda" name="BARREIRA ESQUERDA">
                <option value="">Selecione</option>
                <option value="BARREIRA NEW JERSEY">BARREIRA NEW JERSEY</option>
                <option value="Nenhum">Nenhum</option>
              </select>
            </div>
            <div class="form-group">
              <label for="largura-barreira-esquerda"
                >Largura Barreira Esquerda (m):</label
              >
              <input
                type="number"
                id="largura-barreira-esquerda"
                name="LARGURA BARREIRA ESQUERDA"
                step="0.01"
                min="0"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="barreira-direita">Barreira Direita:</label>
              <select id="barreira-direita" name="BARREIRA DIREITA">
                <option value="">Selecione</option>
                <option value="BARREIRA NEW JERSEY">BARREIRA NEW JERSEY</option>
                <option value="Nenhum">Nenhum</option>
              </select>
            </div>
            <div class="form-group">
              <label for="largura-barreira-direita"
                >Largura Barreira Direita (m):</label
              >
              <input
                type="number"
                id="largura-barreira-direita"
                name="LARGURA BARREIRA DIREITA"
                step="0.01"
                min="0"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="calcada-esquerda">Cal√ßada Esquerda:</label>
              <select id="calcada-esquerda" name="CAL√áADA ESQUERDA">
                <option value="">Selecione</option>
                <option value="CAL√áADA PARA PEDESTRES DE CONCRETO ARMADO">
                  CAL√áADA PARA PEDESTRES DE CONCRETO ARMADO
                </option>
                <option value="Nenhum">Nenhum</option>
              </select>
            </div>
            <div class="form-group">
              <label for="largura-calcada-esquerda"
                >Largura Cal√ßada Esquerda (m):</label
              >
              <input
                type="number"
                id="largura-calcada-esquerda"
                name="LARGURA CAL√áADA ESQUERDA"
                step="0.01"
                min="0"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="calcada-direita">Cal√ßada Direita:</label>
              <select id="calcada-direita" name="CAL√áADA DIREITA">
                <option value="">Selecione</option>
                <option value="CAL√áADA PARA PEDESTRES DE CONCRETO ARMADO">
                  CAL√áADA PARA PEDESTRES DE CONCRETO ARMADO
                </option>
                <option value="Nenhum">Nenhum</option>
              </select>
            </div>
            <div class="form-group">
              <label for="largura-calcada-direita"
                >Largura Cal√ßada Direita (m):</label
              >
              <input
                type="number"
                id="largura-calcada-direita"
                name="LARGURA CAL√áADA DIREITA"
                step="0.01"
                min="0"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="guarda-rodas-esquerda">Guarda Rodas Esquerda:</label>
              <select id="guarda-rodas-esquerda" name="GUARDA RODAS ESQUERDA">
                <option value="">Selecione</option>
                <option value="GUARDA-RODAS ANTIGO DO DNER">
                  GUARDA-RODAS ANTIGO DO DNER
                </option>
                <option value="Nenhum">Nenhum</option>
              </select>
            </div>
            <div class="form-group">
              <label for="largura-guarda-rodas-esquerda"
                >Largura Guarda Rodas Esquerda (m):</label
              >
              <input
                type="number"
                id="largura-guarda-rodas-esquerda"
                name="LARGURA GUARDA RODAS ESQUERDA"
                step="0.01"
                min="0"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="guarda-rodas-direita">Guarda Rodas Direita:</label>
              <select id="guarda-rodas-direita" name="GUARDA RODAS DIREITA">
                <option value="">Selecione</option>
                <option value="GUARDA-RODAS ANTIGO DO DNER">
                  GUARDA-RODAS ANTIGO DO DNER
                </option>
                <option value="Nenhum">Nenhum</option>
              </select>
            </div>
            <div class="form-group">
              <label for="largura-guarda-rodas-direita"
                >Largura Guarda Rodas Direita (m):</label
              >
              <input
                type="number"
                id="largura-guarda-rodas-direita"
                name="LARGURA GUARDA RODAS DIREITA"
                step="0.01"
                min="0"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="pavimento" class="required">Pavimento:</label>
              <select id="pavimento" name="PAVIMENTO" required>
                <option value="">Selecione</option>
                <option value="PAVIMENTO ASF√ÅLTICO">PAVIMENTO ASF√ÅLTICO</option>
                <option value="Nenhum">Nenhum</option>
              </select>
              <div class="error-message" id="pavimento-error">
                Este campo √© obrigat√≥rio
              </div>
            </div>
            <div class="form-group">
              <label for="qtd-buzinotes">Quantidade de Buzinotes:</label>
              <input
                type="number"
                id="qtd-buzinotes"
                name="QTD BUZINOTES"
                min="0"
              />
            </div>
          </div>

          <div
            class="alert-message"
            id="lateral-protection-error"
            style="
              display: none;
              color: var(--danger);
              background-color: rgba(231, 76, 60, 0.1);
              padding: 10px;
              border-radius: 4px;
              margin: 10px 0;
            "
          >
            <strong>Aten√ß√£o:</strong> Toda obra deve ter pelo menos um tipo de
            prote√ß√£o lateral (barreira, guarda-rodas ou cal√ßada) em AMBOS os
            lados.
          </div>

          <div id="complementares-custom-fields"></div>
          <button
            type="button"
            class="add-btn"
            onclick="showAddField('complementares-custom-fields')"
          >
            + Adicionar Campo
          </button>
        </div>
      </form>

      <div id="csv-line"></div>

      <!-- Bot√µes de A√ß√£o -->
      <div class="actions">
        <button type="button" id="import-btn" onclick="showImportModal()">
          Importar CSV
        </button>
        <button type="button" id="export-btn" onclick="exportToCSV()">
          Exportar para CSV
        </button>
        <button
          type="button"
          class="copy-btn"
          onclick="generateAndShowCSVLine()"
        >
          Copiar Linha para Excel
        </button>
        <button type="button" id="save-btn" onclick="showSummaryBeforeSave()">
          Salvar Obra
        </button>
        <button type="button" id="clear-btn" onclick="clearForm()">
          Limpar Formul√°rio
        </button>
      </div>

      <!-- Input para importa√ß√£o de arquivos oculto -->
      <input type="file" id="import-file" style="display: none" accept=".csv" />
    </div>

    <!-- Modal para adicionar campo -->
    <div id="add-field-modal" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <h3>Adicionar Novo Campo</h3>
        <div class="form-row">
          <div class="form-group">
            <label for="new-field-name">Nome do Campo:</label>
            <input
              type="text"
              id="new-field-name"
              placeholder="Ex: Peso Estrutura"
            />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Tipo de Campo:</label>
            <div class="field-type-selector">
              <label>
                <input
                  type="radio"
                  name="field-type"
                  value="number-int"
                  checked
                />
                N√∫mero Inteiro
              </label>
              <label>
                <input type="radio" name="field-type" value="number-double" />
                N√∫mero Decimal
              </label>
              <label>
                <input type="radio" name="field-type" value="select" /> Sele√ß√£o
              </label>
            </div>
          </div>
        </div>

        <div id="select-options" style="display: none">
          <div class="form-row">
            <div class="form-group">
              <label for="select-options-input">Op√ß√µes (uma por linha):</label>
              <textarea
                id="select-options-input"
                rows="5"
                placeholder="Nenhum&#10;Op√ß√£o 1&#10;Op√ß√£o 2"
              ></textarea>
            </div>
          </div>
        </div>

        <input type="hidden" id="target-container" />
        <div class="actions">
          <button type="button" onclick="addCustomField()">
            Adicionar Campo
          </button>
          <button type="button" onclick="closeModal()">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal para importa√ß√£o -->
    <div id="import-modal" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeImportModal()">&times;</span>
        <h3>Importar Arquivo CSV</h3>
        <p>Selecione um arquivo CSV para importar:</p>
        <input type="file" id="csv-file-input" accept=".csv" />
        <div class="actions">
          <button type="button" onclick="processImportFile()">Importar</button>
          <button type="button" onclick="closeImportModal()">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal para resumo antes de salvar -->
    <div id="summary-modal" class="modal summary-modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeSummaryModal()">&times;</span>
        <h3>Resumo da Obra</h3>

        <div
          id="missing-fields-container"
          class="missing-fields-list"
          style="display: none"
        >
          <h4>Campos Obrigat√≥rios N√£o Preenchidos:</h4>
          <ul id="missing-fields-list"></ul>
          <p>Por favor, preencha os campos obrigat√≥rios antes de salvar.</p>
        </div>

        <div id="summary-content"></div>

        <div class="actions">
          <button
            type="button"
            id="confirm-save-btn"
            onclick="saveCurrentWork()"
          >
            Confirmar Salvamento
          </button>
          <button type="button" onclick="closeSummaryModal()">
            Voltar e Revisar
          </button>
        </div>
      </div>
    </div>

    <script>
      // Vers√£o: 4.0

      // Declarando vari√°veis globais uma √∫nica vez
      var db;
      var saveReminderInterval;
      var currentWorkCode = null;

      // Lista de campos obrigat√≥rios e seus requisitos condicionais
      const requiredFields = {
        lote: { type: "text", min: null, required: true },
        codigo: { type: "text", min: null, required: true },
        comprimento: { type: "number", min: 0, required: true },
        largura: { type: "number", min: 0, required: true },
        altura: { type: "number", min: 0, required: true },
        "qtd-tramos": { type: "number", min: 1, required: true },
        "cortina-altura": { type: "number", min: 0, required: true },
        "comprimento-ala": {
          type: "number",
          min: 0,
          required: function () {
            return (
              (document.getElementById("ala-paralela").value !== "" &&
                document.getElementById("ala-paralela").value !== "Nenhum") ||
              (document.getElementById("ala-perpendicular").value !== "" &&
                document.getElementById("ala-perpendicular").value !== "Nenhum")
            );
          },
        },
        "espessura-ala": {
          type: "number",
          min: 0,
          required: function () {
            return (
              (document.getElementById("ala-paralela").value !== "" &&
                document.getElementById("ala-paralela").value !== "Nenhum") ||
              (document.getElementById("ala-perpendicular").value !== "" &&
                document.getElementById("ala-perpendicular").value !== "Nenhum")
            );
          },
        },
        "deslocamento-esquerdo-encontro-laje": {
          type: "number",
          min: 0,
          required: function () {
            return (
              document.getElementById("encontro").value === "ENCONTRO LAJE"
            );
          },
        },
        "deslocamento-direito-encontro-laje": {
          type: "number",
          min: 0,
          required: function () {
            return (
              document.getElementById("encontro").value === "ENCONTRO LAJE"
            );
          },
        },
        "comprimento-encontro-laje": {
          type: "number",
          min: 0,
          required: function () {
            return (
              document.getElementById("encontro").value === "ENCONTRO LAJE"
            );
          },
        },
        "altura-longarina": { type: "number", min: 0, required: true },
        "deslocamento-esquerdo": { type: "number", min: 0, required: true },
        "deslocamento-direito": { type: "number", min: 0, required: true },
        "qtd-longarinas": { type: "number", min: 0, required: true },
        "espessura-longarina": { type: "number", min: 0, required: true },
        "espessura-transversina": {
          type: "number",
          min: 0,
          required: function () {
            const qtdTransversinas =
              parseInt(document.getElementById("qtd-transversinas").value) || 0;
            return qtdTransversinas > 0;
          },
        },
        "espessura-laje": { type: "number", min: 0, required: true },
        "qtd-pilares": { type: "number", min: 0, required: true },
        "largura-pilar": { type: "number", min: 0, required: true },
        "comprimento-pilares": { type: "number", min: 0, required: true },
        "altura-travessa": {
          type: "number",
          min: 0,
          required: function () {
            return (
              document.getElementById("tipo-travessa").value !== "" &&
              document.getElementById("tipo-travessa").value !== "Nenhum"
            );
          },
        },
        "altura-bloco-sapata": {
          type: "number",
          min: 0,
          required: function () {
            return (
              document.getElementById("tipo-bloco-sapata").value !== "" &&
              document.getElementById("tipo-bloco-sapata").value !== "Nenhum"
            );
          },
        },
        "largura-bloco-sapata": {
          type: "number",
          min: 0,
          required: function () {
            return (
              document.getElementById("tipo-bloco-sapata").value !== "" &&
              document.getElementById("tipo-bloco-sapata").value !== "Nenhum"
            );
          },
        },
        pavimento: { type: "text", required: true },
      };

      // Inicializa√ß√£o do IndexedDB
      function initDB() {
        try {
          const request = window.indexedDB.open("OAEDatabase", 1);

          request.onerror = function (event) {
            console.error(
              "Erro ao abrir o banco de dados:",
              event.target.errorCode
            );
            alert(
              "Erro ao inicializar o banco de dados. Algumas funcionalidades podem n√£o estar dispon√≠veis."
            );
          };

          request.onupgradeneeded = function (event) {
            const database = event.target.result;
            // Criar object store para as obras
            if (!database.objectStoreNames.contains("obras")) {
              const objectStore = database.createObjectStore("obras", {
                keyPath: "CODIGO",
              });
              objectStore.createIndex("CODIGO", "CODIGO", { unique: true });
            }
          };

          request.onsuccess = function (event) {
            db = event.target.result;
            console.log("Banco de dados inicializado com sucesso");
            loadWorksList(); // Carregar lista de obras

            // Iniciar lembretes de salvamento
            startSaveReminders();
          };
        } catch (error) {
          console.error("Erro na inicializa√ß√£o do banco de dados:", error);
          alert("Erro ao inicializar o banco de dados: " + error.message);
        }
      }

      // Ativa√ß√£o das abas
      document.addEventListener("DOMContentLoaded", function () {
        // Inicializar banco de dados
        initDB();

        // Configurar sistema de abas
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.addEventListener("click", function () {
            // Desativar todas as abas e conte√∫dos
            document
              .querySelectorAll(".tab")
              .forEach((t) => t.classList.remove("active"));
            document
              .querySelectorAll(".tab-content")
              .forEach((c) => c.classList.remove("active"));

            // Ativar a aba clicada
            this.classList.add("active");

            // Ativar o conte√∫do correspondente
            const contentId = this.getAttribute("data-tab") + "-content";
            const content = document.getElementById(contentId);
            if (content) {
              content.classList.add("active");
            } else {
              console.error("Conte√∫do n√£o encontrado:", contentId);
            }
          });
        });

        // Configurar abas iniciais
        const activeTab = document.querySelector(".tab.active");
        if (activeTab) {
          const contentId = activeTab.getAttribute("data-tab") + "-content";
          const content = document.getElementById(contentId);
          if (content) {
            content.classList.add("active");
          }
        }

        // Inicializar campos din√¢micos
        generateTramosFields();

        // Configurar evento para mostrar/esconder op√ß√µes de select
        document
          .querySelectorAll('input[name="field-type"]')
          .forEach((radio) => {
            radio.addEventListener("change", function () {
              if (this.value === "select") {
                document.getElementById("select-options").style.display =
                  "block";
              } else {
                document.getElementById("select-options").style.display =
                  "none";
              }
            });
          });

        // Configurar mostrar/ocultar painel de obras
        document
          .getElementById("toggle-works-panel")
          .addEventListener("click", function () {
            const panel = document.getElementById("works-panel");
            if (panel.style.display === "none") {
              panel.style.display = "block";
              this.textContent = "Ocultar Obras";
            } else {
              panel.style.display = "none";
              this.textContent = "Mostrar Obras";
            }
            loadWorksList(); // Recarregar lista de obras ao abrir o painel
          });

        // Adicionar evento ao campo de filtro para permitir filtrar com Enter
        document
          .getElementById("filter-works")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              filterWorks();
            }
          });

        // Configurar mascaras e valida√ß√µes
        setupMasks();
        setupValidations();

        // Debug - verificar se todos os elementos de conte√∫do existem
        console.log("Verificando elementos de conte√∫do das abas:");
        document.querySelectorAll(".tab").forEach((tab) => {
          const tabId = tab.getAttribute("data-tab");
          const contentElement = document.getElementById(`${tabId}-content`);
          console.log(
            `Aba ${tabId}: ${contentElement ? "OK" : "N√ÉO ENCONTRADO"}`
          );
        });
      });

      // Configurar m√°scara de data
      function setupMasks() {
        const dataInput = document.getElementById("data");
        dataInput.addEventListener("input", function (e) {
          let value = e.target.value.replace(/\D/g, "");

          if (value.length > 0) {
            // Formatar como dd/mm/aaaa
            if (value.length <= 2) {
              value = value;
            } else if (value.length <= 4) {
              value = value.substring(0, 2) + "/" + value.substring(2);
            } else {
              value =
                value.substring(0, 2) +
                "/" +
                value.substring(2, 4) +
                "/" +
                value.substring(4, 8);
            }
          }

          e.target.value = value;
        });
      }

      // Configurar valida√ß√µes de campos
      function setupValidations() {
        // Adicionar valida√ß√£o para campos num√©ricos (m√≠nimo 0)
        document.querySelectorAll('input[type="number"]').forEach((input) => {
          // Garantir que o valor n√£o seja negativo
          input.addEventListener("change", function () {
            const min = parseFloat(this.getAttribute("min") || 0);
            const value = parseFloat(this.value) || 0;

            if (value < min) {
              this.value = min;
            }
          });

          // Valida√ß√£o ao sair do campo
          input.addEventListener("blur", function () {
            validateField(this.id);
          });
        });

        // Valida√ß√£o para campos de texto obrigat√≥rios
        document
          .querySelectorAll('input[type="text"][required], select[required]')
          .forEach((input) => {
            input.addEventListener("blur", function () {
              validateField(this.id);
            });
          });

        // Valida√ß√µes espec√≠ficas para campos condicionais
        document
          .getElementById("ala-paralela")
          .addEventListener("change", function () {
            validateField("comprimento-ala");
            validateField("espessura-ala");
          });

        document
          .getElementById("ala-perpendicular")
          .addEventListener("change", function () {
            validateField("comprimento-ala");
            validateField("espessura-ala");
          });

        document
          .getElementById("encontro")
          .addEventListener("change", function () {
            validateField("deslocamento-esquerdo-encontro-laje");
            validateField("deslocamento-direito-encontro-laje");
            validateField("comprimento-encontro-laje");
          });

        document
          .getElementById("qtd-transversinas")
          .addEventListener("change", function () {
            validateField("espessura-transversina");
          });

        document
          .getElementById("tipo-travessa")
          .addEventListener("change", function () {
            validateField("altura-travessa");
          });

        document
          .getElementById("tipo-bloco-sapata")
          .addEventListener("change", function () {
            validateField("altura-bloco-sapata");
            validateField("largura-bloco-sapata");
          });

        // Valida√ß√µes para prote√ß√£o lateral
        const lateralProtectionFields = [
          "barreira-esquerda",
          "barreira-direita",
          "guarda-rodas-esquerda",
          "guarda-rodas-direita",
          "calcada-esquerda",
          "calcada-direita",
        ];

        lateralProtectionFields.forEach((fieldId) => {
          document
            .getElementById(fieldId)
            .addEventListener("change", validateLateralProtection);
        });
      }

      // Validar um campo espec√≠fico
      function validateField(fieldId) {
        const field = document.getElementById(fieldId);
        const errorElement = document.getElementById(`${fieldId}-error`);

        if (!field) return true;

        // Remover classe de erro
        field.classList.remove("error");
        if (errorElement) errorElement.classList.remove("visible");

        // Verificar se o campo est√° nas valida√ß√µes obrigat√≥rias
        if (requiredFields[fieldId]) {
          const config = requiredFields[fieldId];

          // Verificar se √© realmente obrigat√≥rio (pode ser fun√ß√£o condicional)
          const isRequired =
            typeof config.required === "function"
              ? config.required()
              : config.required;

          if (isRequired) {
            // Validar conforme o tipo
            if (config.type === "number") {
              const value = parseFloat(field.value) || 0;
              if (
                field.value === "" ||
                (config.min !== null && value < config.min)
              ) {
                field.classList.add("error");
                if (errorElement) {
                  errorElement.classList.add("visible");
                }
                return false;
              }
            } else if (config.type === "text") {
              if (!field.value.trim()) {
                field.classList.add("error");
                if (errorElement) {
                  errorElement.classList.add("visible");
                }
                return false;
              }
            }
          }
        }

        return true;
      }

      // Validar tramos
      function validateTramos() {
        const tramosFields = document.querySelectorAll(".tramo-field");
        const errorElement = document.getElementById("tramos-error");
        let valid = true;

        tramosFields.forEach((field) => {
          field.classList.remove("error");
          const value = parseFloat(field.value) || 0;
          if (value < 0.5) {
            field.classList.add("error");
            valid = false;
          }
        });

        if (!valid && errorElement) {
          errorElement.classList.add("visible");
        } else if (errorElement) {
          errorElement.classList.remove("visible");
        }

        return valid;
      }

      // Validar apoios
      function validateApoios() {
        const apoiosFields = document.querySelectorAll(".apoio-field");
        const errorElement = document.getElementById("apoios-error");
        let valid = true;

        apoiosFields.forEach((field) => {
          field.classList.remove("error");
          if (!field.value.trim()) {
            field.classList.add("error");
            valid = false;
          }
        });

        if (!valid && errorElement) {
          errorElement.classList.add("visible");
        } else if (errorElement) {
          errorElement.classList.remove("visible");
        }

        return valid;
      }

      // Validar todo o formul√°rio
      function validateForm() {
        let isValid = true;
        const missingFields = [];

        // Validar campos obrigat√≥rios
        for (const fieldId in requiredFields) {
          const isFieldValid = validateField(fieldId);

          if (!isFieldValid) {
            isValid = false;
            const field = document.getElementById(fieldId);
            const label = document.querySelector(`label[for="${fieldId}"]`);
            missingFields.push(
              label ? label.textContent.replace(":", "") : fieldId
            );

            // Se n√£o estiver vis√≠vel, mostrar a aba correspondente
            const tabContent = field.closest(".tab-content");
            if (tabContent && !tabContent.classList.contains("active")) {
              const tabId = tabContent.id.replace("-content", "");
              document.querySelector(`.tab[data-tab="${tabId}"]`).click();
            }
          }
        }

        // Validar tramos
        const tramosValid = validateTramos();
        if (!tramosValid) {
          isValid = false;
          missingFields.push("Comprimento dos Tramos (m√≠nimo 0.5m)");
        }

        // Validar apoios
        const apoiosValid = validateApoios();
        if (!apoiosValid) {
          isValid = false;
          missingFields.push("Altura dos Apoios");
        }

        // Validar prote√ß√£o lateral (deve ter pelo menos um tipo em cada lado)
        const lateralProtectionValid = validateLateralProtection();
        if (!lateralProtectionValid) {
          isValid = false;
          missingFields.push(
            "Prote√ß√£o Lateral (barreira, guarda-rodas ou cal√ßada) em ambos os lados"
          );
        }

        return { isValid, missingFields };
      }

      // Validar prote√ß√£o lateral
      function validateLateralProtection() {
        // Verificar lado esquerdo
        const hasLeftProtection =
          (document.getElementById("barreira-esquerda").value !== "" &&
            document.getElementById("barreira-esquerda").value !== "Nenhum") ||
          (document.getElementById("guarda-rodas-esquerda").value !== "" &&
            document.getElementById("guarda-rodas-esquerda").value !==
              "Nenhum") ||
          (document.getElementById("calcada-esquerda").value !== "" &&
            document.getElementById("calcada-esquerda").value !== "Nenhum");

        // Verificar lado direito
        const hasRightProtection =
          (document.getElementById("barreira-direita").value !== "" &&
            document.getElementById("barreira-direita").value !== "Nenhum") ||
          (document.getElementById("guarda-rodas-direita").value !== "" &&
            document.getElementById("guarda-rodas-direita").value !==
              "Nenhum") ||
          (document.getElementById("calcada-direita").value !== "" &&
            document.getElementById("calcada-direita").value !== "Nenhum");

        // Destacar campos com erro se n√£o houver prote√ß√£o
        if (!hasLeftProtection) {
          document.getElementById("barreira-esquerda").classList.add("error");
          document
            .getElementById("guarda-rodas-esquerda")
            .classList.add("error");
          document.getElementById("calcada-esquerda").classList.add("error");
        } else {
          document
            .getElementById("barreira-esquerda")
            .classList.remove("error");
          document
            .getElementById("guarda-rodas-esquerda")
            .classList.remove("error");
          document.getElementById("calcada-esquerda").classList.remove("error");
        }

        if (!hasRightProtection) {
          document.getElementById("barreira-direita").classList.add("error");
          document
            .getElementById("guarda-rodas-direita")
            .classList.add("error");
          document.getElementById("calcada-direita").classList.add("error");
        } else {
          document.getElementById("barreira-direita").classList.remove("error");
          document
            .getElementById("guarda-rodas-direita")
            .classList.remove("error");
          document.getElementById("calcada-direita").classList.remove("error");
        }

        // Mostrar/ocultar mensagem de erro
        const errorMessage = document.getElementById(
          "lateral-protection-error"
        );
        if (!hasLeftProtection || !hasRightProtection) {
          errorMessage.style.display = "block";
        } else {
          errorMessage.style.display = "none";
        }

        return hasLeftProtection && hasRightProtection;
      }

      // Mostrar resumo antes de salvar
      function showSummaryBeforeSave() {
        // Validar o formul√°rio
        const { isValid, missingFields } = validateForm();

        // Preparar o modal
        const summaryContent = document.getElementById("summary-content");
        const missingFieldsContainer = document.getElementById(
          "missing-fields-container"
        );
        const missingFieldsList = document.getElementById(
          "missing-fields-list"
        );
        const confirmSaveBtn = document.getElementById("confirm-save-btn");

        // Limpar conte√∫do anterior
        summaryContent.innerHTML = "";
        missingFieldsList.innerHTML = "";

        // Coletar dados do formul√°rio
        const formData = collectFormData();

        // Tratar campos obrigat√≥rios n√£o preenchidos
        if (!isValid) {
          missingFieldsContainer.style.display = "block";
          missingFields.forEach((field) => {
            const li = document.createElement("li");
            li.className = "missing-field";
            li.textContent = field;
            missingFieldsList.appendChild(li);
          });

          // Desabilitar bot√£o de confirmar
          confirmSaveBtn.disabled = true;
        } else {
          missingFieldsContainer.style.display = "none";
          confirmSaveBtn.disabled = false;
        }

        // Gerar o resumo
        generateSummary(formData, summaryContent);

        // Exibir o modal
        document.getElementById("summary-modal").style.display = "block";
      }

      // Gerar resumo da obra
      function generateSummary(data, container) {
        // Agrupar dados por se√ß√£o
        const sections = [
          {
            title: "Informa√ß√µes Gerais",
            fields: [
              "CODIGO",
              "NOME",
              "UF",
              "RODOVIA",
              "KM",
              "DATA",
              "ENGENHEIRO",
              "TECNICO",
              "MODELADO",
            ],
          },
          {
            title: "Configura√ß√µes Gerais",
            fields: [
              "COMPRIMENTO",
              "LARGURA",
              "ALTURA",
              "QTD TRAMOS",
              "COMPRIMENTO TRAMOS",
            ],
          },
          {
            title: "Transi√ß√£o",
            fields: [
              "CORTINA ALTURA",
              "ALA PARALELA",
              "ALA PERPENDICULAR",
              "COMPRIMENTO ALA",
              "ESPESSURA ALA",
              "ENCONTRO",
              "DESLOCAMENTO ESQUERDO ENCONTRO LAJE",
              "DESLOCAMENTO DIREITO ENCONTRO LAJE",
              "COMPRIMENTO ENCONTRO LAJE",
              "LAJE DE TRANSI√á√ÉO",
            ],
          },
          {
            title: "Superestrutura",
            fields: [
              "ALTURA LONGARINA",
              "DESLOCAMENTO ESQUERDO",
              "DESLOCAMENTO DIREITO",
              "QTD LONGARINAS",
              "QTD TRANSVERSINAS",
              "ESPESSURA LONGARINA",
              "ESPESSURA TRANSVERSINA",
              "ESPESSURA LAJE",
            ],
          },
          {
            title: "Apoio",
            fields: [
              "QTD PILARES",
              "PILAR DESCENTRALIZADO",
              "LARGURA PILAR",
              "COMPRIMENTO PILARES",
              "ALTURA DO APOIO",
              "TIPO DE APARELHO DE APOIO",
              "TIPO DE TRAVESSA",
              "ALTURA TRAVESSA",
              "TIPO DE ENCAMISAMENTO",
              "TIPO DE BLOCO OU SAPATA",
              "ALTURA BLOCO OU SAPATA",
              "LARGURA BLOCO OU SAPATA",
              "VIGA DE CONTRAVENTAMENTO DE PILAR",
              "VIGA DE LIGA√á√ÉO DE FUNDA√á√ïES",
            ],
          },
          {
            title: "Elementos Complementares",
            fields: [
              "BARREIRA ESQUERDA",
              "LARGURA BARREIRA ESQUERDA",
              "BARREIRA DIREITA",
              "LARGURA BARREIRA DIREITA",
              "CAL√áADA ESQUERDA",
              "LARGURA CAL√áADA ESQUERDA",
              "CAL√áADA DIREITA",
              "LARGURA CAL√áADA DIREITA",
              "GUARDA RODAS ESQUERDA",
              "LARGURA GUARDA RODAS ESQUERDA",
              "GUARDA RODAS DIREITA",
              "LARGURA GUARDA RODAS DIREITA",
              "PAVIMENTO",
              "QTD BUZINOTES",
            ],
          },
        ];

        // Para cada se√ß√£o, criar um container
        sections.forEach((section) => {
          const sectionDiv = document.createElement("div");
          sectionDiv.className = "summary-section";

          const sectionTitle = document.createElement("h3");
          sectionTitle.textContent = section.title;
          sectionDiv.appendChild(sectionTitle);

          // Para cada campo na se√ß√£o
          section.fields.forEach((field) => {
            if (data[field] !== undefined) {
              const rowDiv = document.createElement("div");
              rowDiv.className = "summary-row";

              const labelDiv = document.createElement("div");
              labelDiv.className = "summary-label";
              labelDiv.textContent = field;

              const valueDiv = document.createElement("div");
              valueDiv.className = "summary-value";
              valueDiv.textContent = data[field] || "-";

              rowDiv.appendChild(labelDiv);
              rowDiv.appendChild(valueDiv);
              sectionDiv.appendChild(rowDiv);
            }
          });

          container.appendChild(sectionDiv);
        });

        // Adicionar campos personalizados
        const customFields = Object.keys(data).filter(
          (key) => !sections.some((section) => section.fields.includes(key))
        );

        if (customFields.length > 0) {
          const customSection = document.createElement("div");
          customSection.className = "summary-section";

          const customTitle = document.createElement("h3");
          customTitle.textContent = "Campos Personalizados";
          customSection.appendChild(customTitle);

          customFields.forEach((field) => {
            const rowDiv = document.createElement("div");
            rowDiv.className = "summary-row";

            const labelDiv = document.createElement("div");
            labelDiv.className = "summary-label";
            labelDiv.textContent = field;

            const valueDiv = document.createElement("div");
            valueDiv.className = "summary-value";
            valueDiv.textContent = data[field] || "-";

            rowDiv.appendChild(labelDiv);
            rowDiv.appendChild(valueDiv);
            customSection.appendChild(rowDiv);
          });

          container.appendChild(customSection);
        }
      }

      // Fechar modal de resumo
      function closeSummaryModal() {
        document.getElementById("summary-modal").style.display = "none";
      }

      // Gerar campos din√¢micos para tramos (em pilha)
      function generateTramosFields() {
        const qtdTramos =
          parseInt(document.getElementById("qtd-tramos").value) || 1;
        const tramosContainer = document.getElementById("tramos-fields");
        tramosContainer.innerHTML = "";

        // Garantir m√≠nimo de 1 tramo
        if (qtdTramos < 1) {
          document.getElementById("qtd-tramos").value = 1;
          return generateTramosFields();
        }

        // Gerar campos para tramos em pilha
        for (let i = 1; i <= qtdTramos; i++) {
          const div = document.createElement("div");
          div.className = "dynamic-field";
          div.innerHTML = `
                    <label for="tramo-${i}">Tramo ${i}:</label>
                    <input type="number" id="tramo-${i}" name="tramo-${i}" step="0.01" min="0.5" class="tramo-field">
                `;
          tramosContainer.appendChild(div);

          // Adicionar valida√ß√£o
          const input = div.querySelector("input");
          input.addEventListener("blur", validateTramos);
        }

        // Atualizar tamb√©m os campos de apoios
        generateApoiosFields(qtdTramos);
      }

      // Gerar campos din√¢micos para apoios (qtdTramos - 1)
      function generateApoiosFields(qtdTramos) {
        const qtdApoios = qtdTramos > 1 ? qtdTramos - 1 : 0;
        const apoiosContainer = document.getElementById("apoios-fields");
        apoiosContainer.innerHTML = "";

        for (let i = 1; i <= qtdApoios; i++) {
          const div = document.createElement("div");
          div.className = "dynamic-field";
          div.innerHTML = `
                    <label for="apoio-${i}">Apoio ${i}:</label>
                    <input type="number" id="apoio-${i}" name="apoio-${i}" step="0.01" min="0" class="apoio-field">
                `;
          apoiosContainer.appendChild(div);

          // Adicionar valida√ß√£o
          const input = div.querySelector("input");
          input.addEventListener("blur", validateApoios);
        }
      }

      // Mostrar modal para adicionar campo
      function showAddField(targetContainer) {
        document.getElementById("target-container").value = targetContainer;
        document.getElementById("new-field-name").value = "";
        document.getElementById("select-options-input").value = "Nenhum";
        document.getElementById("add-field-modal").style.display = "block";
        document.querySelectorAll('input[name="field-type"]')[0].checked = true;
        document.getElementById("select-options").style.display = "none";
      }

      // Fechar modal
      function closeModal() {
        document.getElementById("add-field-modal").style.display = "none";
      }

      // Adicionar campo personalizado
      function addCustomField() {
        const fieldName = document
          .getElementById("new-field-name")
          .value.trim();
        if (!fieldName) {
          alert("Por favor, digite um nome para o campo.");
          return;
        }

        const targetContainer =
          document.getElementById("target-container").value;
        const container = document.getElementById(targetContainer);
        const fieldType = document.querySelector(
          'input[name="field-type"]:checked'
        ).value;

        // Criar div para o campo personalizado
        const customFieldDiv = document.createElement("div");
        customFieldDiv.className = "form-row";

        // Criar o campo baseado no tipo selecionado
        let fieldHtml = "";
        const fieldId =
          "custom-" + fieldName.replace(/\s+/g, "-").toLowerCase();
        const fieldNameAttr = fieldName.toUpperCase();

        if (fieldType === "select") {
          const optionsText = document.getElementById(
            "select-options-input"
          ).value;
          const options = optionsText
            .split("\n")
            .map((opt) => opt.trim())
            .filter((opt) => opt);

          const optionsHtml = options
            .map((opt) => `<option value="${opt}">${opt}</option>`)
            .join("");

          fieldHtml = `
                    <div class="form-group">
                        <label for="${fieldId}">${fieldName}:</label>
                        <select id="${fieldId}" name="${fieldNameAttr}" class="custom-field">
                            <option value="">Selecione</option>
                            ${optionsHtml}
                        </select>
                    </div>
                `;
        } else if (fieldType === "number-int") {
          fieldHtml = `
                    <div class="form-group">
                        <label for="${fieldId}">${fieldName}:</label>
                        <input type="number" id="${fieldId}" name="${fieldNameAttr}" min="0" class="custom-field">
                    </div>
                `;
        } else if (fieldType === "number-double") {
          fieldHtml = `
                    <div class="form-group">
                        <label for="${fieldId}">${fieldName}:</label>
                        <input type="number" id="${fieldId}" name="${fieldNameAttr}" step="0.01" min="0" class="custom-field">
                    </div>
                `;
        }

        customFieldDiv.innerHTML = fieldHtml;
        container.appendChild(customFieldDiv);

        // Adicionar valida√ß√£o para campos num√©ricos
        const newField = customFieldDiv.querySelector('input[type="number"]');
        if (newField) {
          newField.addEventListener("change", function () {
            const min = parseFloat(this.getAttribute("min") || 0);
            const value = parseFloat(this.value) || 0;

            if (value < min) {
              this.value = min;
            }
          });
        }

        closeModal();
      }

      // Gerar e mostrar linha CSV para copiar para Excel
      function generateAndShowCSVLine() {
        try {
          // Validar primeiro
          const { isValid, missingFields } = validateForm();
          if (!isValid) {
            alert(
              "Por favor, preencha todos os campos obrigat√≥rios antes de gerar a linha CSV."
            );
            return;
          }

          // Validar dimens√µes
          if (
            !validateTramosLength() ||
            !validateHeights() ||
            !validateDisplacements()
          ) {
            return; // Interrompe a execu√ß√£o se qualquer valida√ß√£o falhar
          }

          const form = document.getElementById("oae-form");
          const formData = new FormData(form);

          // Obter colunas definidas
          const csvColumns = getCsvColumns();

          // Coletar campos personalizados
          document.querySelectorAll(".custom-field").forEach((field) => {
            const name = field.getAttribute("name");
            if (!csvColumns.includes(name)) {
              csvColumns.push(name);
            }
          });

          // Dados para a linha CSV
          const data = {};

          // Preencher com valores vazios para garantir que todos os campos existam
          csvColumns.forEach((column) => {
            data[column] = "";
          });

          // Preencher com os valores do formul√°rio
          for (let [key, value] of formData.entries()) {
            // Ignorar campos dos tramos/apoios din√¢micos (eles s√£o tratados separadamente)
            if (!key.startsWith("tramo-") && !key.startsWith("apoio-")) {
              data[key] = value;
            }
          }

          // Checkbox - verificar se est√° marcado
          if (document.getElementById("modelado").checked) {
            data["MODELADO"] = "TRUE";
          } else {
            data["MODELADO"] = "FALSE";
          }

          // Coletar valores dos tramos
          const tramosValues = [];
          const tramosFields = document.querySelectorAll(".tramo-field");
          tramosFields.forEach((field) => {
            tramosValues.push(field.value || "0.50");
          });
          data["COMPRIMENTO TRAMOS"] = tramosValues.join(";");

          // Coletar valores dos apoios
          const apoiosValues = [];
          const apoiosFields = document.querySelectorAll(".apoio-field");
          apoiosFields.forEach((field) => {
            apoiosValues.push(field.value || "0.00");
          });
          data["ALTURA DO APOIO"] = apoiosValues.join(";");

          // Gerar a linha CSV
          const csvLine = csvColumns
            .map((column) => data[column] || "")
            .join("\t");

          // Mostrar a linha para copiar
          const csvLineElement = document.getElementById("csv-line");
          csvLineElement.style.display = "block";
          csvLineElement.textContent = csvLine;

          // Selecionar o texto para facilitar a c√≥pia
          const range = document.createRange();
          range.selectNode(csvLineElement);
          window.getSelection().removeAllRanges();
          window.getSelection().addRange(range);

          try {
            // Copiar para o clipboard
            document.execCommand("copy");
            window.getSelection().removeAllRanges();
            alert("Linha copiada para a √°rea de transfer√™ncia!");
          } catch (err) {
            console.error("N√£o foi poss√≠vel copiar automaticamente:", err);
            alert("Selecione o texto e use Ctrl+C para copiar.");
          }
        } catch (error) {
          console.error("Erro ao gerar linha CSV:", error);
          alert("Erro ao gerar linha CSV: " + error.message);
        }
      }

      // Exportar para CSV
      function exportToCSV() {
        try {
          // Validar primeiro
          const { isValid, missingFields } = validateForm();
          if (!isValid) {
            alert(
              "Por favor, preencha todos os campos obrigat√≥rios antes de exportar para CSV."
            );
            return;
          }

          // Validar dimens√µes
          if (
            !validateTramosLength() ||
            !validateHeights() ||
            !validateDisplacements()
          ) {
            return; // Interrompe a execu√ß√£o se qualquer valida√ß√£o falhar
          }
          const form = document.getElementById("oae-form");
          const formData = new FormData(form);

          // Obter colunas definidas
          const csvColumns = getCsvColumns();

          // Coletar campos personalizados
          document.querySelectorAll(".custom-field").forEach((field) => {
            const name = field.getAttribute("name");
            if (!csvColumns.includes(name)) {
              csvColumns.push(name);
            }
          });

          // Coletar todos os campos padr√£o
          const data = {};
          // Inicializar com valores vazios
          csvColumns.forEach((column) => {
            data[column] = "";
          });

          for (let [key, value] of formData.entries()) {
            // Ignorar campos dos tramos/apoios din√¢micos (eles s√£o tratados separadamente)
            if (!key.startsWith("tramo-") && !key.startsWith("apoio-")) {
              data[key] = value;
            }
          }

          // Checkbox - verificar se est√° marcado
          if (document.getElementById("modelado").checked) {
            data["MODELADO"] = "TRUE";
          } else {
            data["MODELADO"] = "FALSE";
          }

          // Coletar valores dos tramos
          const tramosValues = [];
          const tramosFields = document.querySelectorAll(".tramo-field");
          tramosFields.forEach((field) => {
            tramosValues.push(field.value || "0.50");
          });
          data["COMPRIMENTO TRAMOS"] = tramosValues.join(";");

          // Coletar valores dos apoios
          const apoiosValues = [];
          const apoiosFields = document.querySelectorAll(".apoio-field");
          apoiosFields.forEach((field) => {
            apoiosValues.push(field.value || "0.00");
          });
          data["ALTURA DO APOIO"] = apoiosValues.join(";");

          // Construir cabe√ßalhos e linha de dados
          const csvContent =
            csvColumns.join(",") +
            "\n" +
            csvColumns
              .map((column) => {
                // Valores com v√≠rgula devem ser envolvidos em aspas duplas
                const value = data[column] || "";
                return value && value.includes(",") ? `"${value}"` : value;
              })
              .join(",");

          // Criar e baixar o arquivo CSV
          const blob = new Blob([csvContent], {
            type: "text/csv;charset=utf-8;",
          });
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.setAttribute("href", url);
          link.setAttribute(
            "download",
            `OAE_${data["CODIGO"] || "nova"}_${
              new Date().toISOString().split("T")[0]
            }.csv`
          );
          link.style.display = "none";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        } catch (error) {
          console.error("Erro ao exportar CSV:", error);
          alert("Erro ao exportar CSV: " + error.message);
        }
      }

      // Mostrar modal de importa√ß√£o
      function showImportModal() {
        document.getElementById("import-modal").style.display = "block";
      }

      // Fechar modal de importa√ß√£o
      function closeImportModal() {
        document.getElementById("import-modal").style.display = "none";
      }

      // Processar arquivo de importa√ß√£o
      function processImportFile() {
        try {
          const fileInput = document.getElementById("csv-file-input");
          const file = fileInput.files[0];

          if (!file) {
            alert("Por favor, selecione um arquivo CSV para importar.");
            return;
          }

          const reader = new FileReader();
          reader.readAsText(file);

          reader.onload = function (event) {
            const csvData = event.target.result;
            const lines = csvData.split("\n");

            if (lines.length < 2) {
              alert("O arquivo CSV n√£o cont√©m dados v√°lidos.");
              return;
            }

            // Primeira linha cont√©m os cabe√ßalhos
            const headers = lines[0].split(",").map((header) => header.trim());

            // Verificar se o arquivo tem v√°rias obras (mais de uma linha de dados)
            if (lines.length > 2) {
              const works = [];

              // Processar cada linha (exceto a primeira que s√£o os cabe√ßalhos)
              for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === "") continue; // Pular linhas vazias

                const values = parseCSVLine(lines[i]);
                if (values.length !== headers.length) {
                  console.warn(
                    `Linha ${i + 1} tem n√∫mero incorreto de campos (${
                      values.length
                    } vs ${headers.length}). Tentando importar mesmo assim.`
                  );
                }

                const workData = {};

                // Mapear valores para cabe√ßalhos
                for (let j = 0; j < headers.length; j++) {
                  if (j < values.length) {
                    workData[headers[j]] = values[j];
                  }
                }

                // Verificar se h√° um c√≥digo v√°lido
                if (workData["CODIGO"] && workData["CODIGO"].trim() !== "") {
                  works.push(workData);
                }
              }

              if (works.length > 0) {
                // Perguntar se o usu√°rio quer salvar todas as obras no banco de dados
                if (
                  confirm(
                    `O arquivo cont√©m ${works.length} obras. Deseja importar todas para o banco de dados?`
                  )
                ) {
                  saveMultipleWorks(works);
                }
              } else {
                alert("Nenhuma obra v√°lida encontrada no arquivo CSV.");
              }
            } else {
              // Apenas uma obra, carregar no formul√°rio atual
              const values = parseCSVLine(lines[1]);
              loadCSVDataToForm(headers, values);
            }

            closeImportModal();
          };

          reader.onerror = function () {
            alert("Erro ao ler o arquivo.");
          };
        } catch (error) {
          console.error("Erro ao processar arquivo:", error);
          alert("Erro ao processar arquivo: " + error.message);
        }
      }

      // Fun√ß√£o auxiliar para analisar uma linha CSV (lidando com valores entre aspas)
      function parseCSVLine(line) {
        const values = [];
        let currentValue = "";
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
          const char = line[i];

          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === "," && !inQuotes) {
            values.push(currentValue);
            currentValue = "";
          } else {
            currentValue += char;
          }
        }

        // N√£o esquecer do √∫ltimo valor
        values.push(currentValue);

        return values;
      }

      // Carregar dados do CSV para o formul√°rio
      function loadCSVDataToForm(headers, values) {
        try {
          clearForm(); // Limpar o formul√°rio antes

          // Mapear valores para os campos do formul√°rio
          for (let i = 0; i < headers.length; i++) {
            const header = headers[i];
            if (i < values.length) {
              const value = values[i];

              // Tratar campos especiais
              if (header === "MODELADO") {
                document.getElementById("modelado").checked =
                  value.toLowerCase() === "true";
              } else if (header === "COMPRIMENTO TRAMOS") {
                const tramos = value.split(";");
                document.getElementById("qtd-tramos").value = tramos.length;
                generateTramosFields(); // Regenerar campos de tramos

                // Preencher valores dos tramos
                const tramosFields = document.querySelectorAll(".tramo-field");
                for (let j = 0; j < tramosFields.length; j++) {
                  if (j < tramos.length) {
                    tramosFields[j].value = tramos[j];
                  }
                }
              } else if (header === "ALTURA DO APOIO") {
                const apoios = value.split(";");
                // N√£o precisamos definir o n√∫mero de apoios, pois isso √© calculado com base nos tramos

                // Preencher valores dos apoios
                const apoiosFields = document.querySelectorAll(".apoio-field");
                for (let j = 0; j < apoiosFields.length; j++) {
                  if (j < apoios.length) {
                    apoiosFields[j].value = apoios[j];
                  }
                }
              } else {
                // Outros campos
                const field = document.querySelector(`[name="${header}"]`);
                if (field) {
                  field.value = value;
                }
              }
            }
          }

          // Definir o c√≥digo atual
          const codigoField = document.getElementById("codigo");
          if (codigoField.value) {
            currentWorkCode = codigoField.value;
          }

          // Executar valida√ß√£o ap√≥s carregar
          validateForm();
        } catch (error) {
          console.error("Erro ao carregar dados do CSV:", error);
          alert("Erro ao carregar dados do CSV: " + error.message);
        }
      }

      // Salvar a obra atual no banco de dados
      function saveCurrentWork() {
        try {
          // Validar o formul√°rio
          const { isValid, missingFields } = validateForm();
          if (!isValid) {
            alert(
              "Por favor, preencha todos os campos obrigat√≥rios antes de salvar."
            );
            return;
          }

          // Validar dimens√µes
          if (
            !validateTramosLength() ||
            !validateHeights() ||
            !validateDisplacements()
          ) {
            return; // Interrompe a execu√ß√£o se qualquer valida√ß√£o falhar
          }
          const codigo = document.getElementById("codigo").value.trim();

          if (!codigo) {
            alert("Por favor, preencha o campo C√≥digo antes de salvar.");
            return;
          }

          const formData = collectFormData();

          if (db) {
            const transaction = db.transaction(["obras"], "readwrite");
            const objectStore = transaction.objectStore("obras");

            const request = objectStore.put(formData);

            request.onsuccess = function (event) {
              alert(`Obra ${codigo} salva com sucesso!`);
              currentWorkCode = codigo;
              loadWorksList(); // Recarregar a lista de obras
              closeSummaryModal(); // Fechar o modal de resumo se estiver aberto
            };

            request.onerror = function (event) {
              console.error("Erro ao salvar a obra:", event.target.error);
              alert(`Erro ao salvar a obra: ${event.target.error}`);
            };
          } else {
            alert("Banco de dados n√£o est√° dispon√≠vel.");
          }
        } catch (error) {
          console.error("Erro ao salvar obra:", error);
          alert("Erro ao salvar obra: " + error.message);
        }
      }

      // Salvar m√∫ltiplas obras no banco de dados
      function saveMultipleWorks(works) {
        try {
          if (!db) {
            alert("Banco de dados n√£o est√° dispon√≠vel.");
            return;
          }

          const transaction = db.transaction(["obras"], "readwrite");
          const objectStore = transaction.objectStore("obras");

          let countSuccess = 0;
          let countError = 0;

          works.forEach((work) => {
            const request = objectStore.put(work);

            request.onsuccess = function () {
              countSuccess++;
              if (countSuccess + countError === works.length) {
                alert(
                  `Importa√ß√£o conclu√≠da: ${countSuccess} obras importadas com sucesso, ${countError} erros.`
                );
                loadWorksList(); // Recarregar a lista de obras
              }
            };

            request.onerror = function (event) {
              countError++;
              console.error(
                `Erro ao salvar a obra ${work.CODIGO}:`,
                event.target.error
              );
              if (countSuccess + countError === works.length) {
                alert(
                  `Importa√ß√£o conclu√≠da: ${countSuccess} obras importadas com sucesso, ${countError} erros.`
                );
                loadWorksList(); // Recarregar a lista de obras
              }
            };
          });
        } catch (error) {
          console.error("Erro ao salvar m√∫ltiplas obras:", error);
          alert("Erro ao salvar m√∫ltiplas obras: " + error.message);
        }
      }

      // Coletar todos os dados do formul√°rio
      function collectFormData() {
        try {
          const form = document.getElementById("oae-form");
          const formData = new FormData(form);

          // Objeto para armazenar os dados
          const data = {};

          // Processar campos comuns
          for (let [key, value] of formData.entries()) {
            // Ignorar campos dos tramos/apoios din√¢micos (eles s√£o tratados separadamente)
            if (!key.startsWith("tramo-") && !key.startsWith("apoio-")) {
              data[key] = value;
            }
          }

          // Verificar se o modelado est√° marcado
          if (document.getElementById("modelado").checked) {
            data["MODELADO"] = "TRUE";
          } else {
            data["MODELADO"] = "FALSE";
          }

          // Coletar valores dos tramos
          const tramosValues = [];
          const tramosFields = document.querySelectorAll(".tramo-field");
          tramosFields.forEach((field) => {
            // Garantir valor m√≠nimo de 0.5
            const value = parseFloat(field.value) || 0;
            tramosValues.push(value < 0.5 ? "0.50" : field.value);
          });
          data["COMPRIMENTO TRAMOS"] = tramosValues.join(";");

          // Coletar valores dos apoios
          const apoiosValues = [];
          const apoiosFields = document.querySelectorAll(".apoio-field");
          apoiosFields.forEach((field) => {
            apoiosValues.push(field.value || "0.00");
          });
          data["ALTURA DO APOIO"] = apoiosValues.join(";");

          return data;
        } catch (error) {
          console.error("Erro ao coletar dados do formul√°rio:", error);
          alert("Erro ao coletar dados do formul√°rio: " + error.message);
          return {};
        }
      }

      // Carregar obra espec√≠fica do banco de dados
      function loadWork(codigo) {
        try {
          if (!db) {
            alert("Banco de dados n√£o est√° dispon√≠vel.");
            return;
          }

          const transaction = db.transaction(["obras"], "readonly");
          const objectStore = transaction.objectStore("obras");
          const request = objectStore.get(codigo);

          request.onsuccess = function (event) {
            const work = event.target.result;

            if (work) {
              loadWorkToForm(work);
              currentWorkCode = codigo;

              // Marcar a obra como selecionada na lista
              const workItems = document.querySelectorAll(".work-item");
              workItems.forEach((item) => {
                if (item.getAttribute("data-code") === codigo) {
                  item.classList.add("selected");
                } else {
                  item.classList.remove("selected");
                }
              });
            } else {
              alert(`Obra com c√≥digo ${codigo} n√£o encontrada.`);
            }
          };

          request.onerror = function (event) {
            console.error("Erro ao carregar a obra:", event.target.error);
            alert(`Erro ao carregar a obra: ${event.target.error}`);
          };
        } catch (error) {
          console.error("Erro ao carregar obra:", error);
          alert("Erro ao carregar obra: " + error.message);
        }
      }

      // Carregar dados de uma obra para o formul√°rio
      function loadWorkToForm(work) {
        try {
          clearForm(); // Limpar o formul√°rio antes

          // Processar campos especiais
          if (work["MODELADO"] === "TRUE") {
            document.getElementById("modelado").checked = true;
          } else {
            document.getElementById("modelado").checked = false;
          }

          if (work["COMPRIMENTO TRAMOS"]) {
            const tramos = work["COMPRIMENTO TRAMOS"].split(";");
            document.getElementById("qtd-tramos").value = tramos.length;
            generateTramosFields(); // Regenerar campos de tramos

            // Preencher valores dos tramos
            const tramosFields = document.querySelectorAll(".tramo-field");
            for (let i = 0; i < tramosFields.length; i++) {
              if (i < tramos.length) {
                tramosFields[i].value = tramos[i];
              }
            }
          }

          if (work["ALTURA DO APOIO"]) {
            const apoios = work["ALTURA DO APOIO"].split(";");

            // Preencher valores dos apoios
            const apoiosFields = document.querySelectorAll(".apoio-field");
            for (let i = 0; i < apoiosFields.length; i++) {
              if (i < apoios.length) {
                apoiosFields[i].value = apoios[i];
              }
            }
          }

          // Processar outros campos
          for (const [key, value] of Object.entries(work)) {
            if (
              key !== "MODELADO" &&
              key !== "COMPRIMENTO TRAMOS" &&
              key !== "ALTURA DO APOIO"
            ) {
              const field = document.querySelector(`[name="${key}"]`);
              if (field) {
                field.value = value;
              }
            }
          }

          // Executar valida√ß√£o ap√≥s carregar
          validateForm();
        } catch (error) {
          console.error("Erro ao carregar dados no formul√°rio:", error);
          alert("Erro ao carregar dados no formul√°rio: " + error.message);
        }
      }

      // Carregar lista de obras do banco de dados
      function loadWorksList() {
        try {
          if (!db) {
            console.warn("Banco de dados n√£o est√° dispon√≠vel.");
            return;
          }

          const worksList = document.getElementById("works-list");
          worksList.innerHTML = '<div class="work-item">Carregando...</div>';

          const transaction = db.transaction(["obras"], "readonly");
          const objectStore = transaction.objectStore("obras");
          const request = objectStore.getAll();

          request.onsuccess = function (event) {
            const works = event.target.result;

            if (works.length === 0) {
              worksList.innerHTML =
                '<div class="work-item">Nenhuma obra cadastrada</div>';
            } else {
              worksList.innerHTML = "";

              works.forEach((work) => {
                const workItem = document.createElement("div");
                workItem.className = "work-item";
                if (work.CODIGO === currentWorkCode) {
                  workItem.classList.add("selected");
                }
                workItem.setAttribute("data-code", work.CODIGO);

                workItem.innerHTML = `
                                <span>${work.CODIGO} - ${
                  work.NOME || "Sem nome"
                }</span>
                                <button type="button" class="delete-btn" onclick="deleteWork('${
                                  work.CODIGO
                                }', event)">Excluir</button>
                            `;

                workItem.addEventListener("click", function (e) {
                  if (!e.target.classList.contains("delete-btn")) {
                    loadWork(work.CODIGO);
                  }
                });

                worksList.appendChild(workItem);
              });
            }
          };

          request.onerror = function (event) {
            console.error(
              "Erro ao carregar a lista de obras:",
              event.target.error
            );
            worksList.innerHTML =
              '<div class="work-item">Erro ao carregar obras</div>';
          };
        } catch (error) {
          console.error("Erro ao carregar lista de obras:", error);
          alert("Erro ao carregar lista de obras: " + error.message);
        }
      }

      // Filtrar obras por c√≥digo
      function filterWorks() {
        try {
          const filterText = document
            .getElementById("filter-works")
            .value.trim()
            .toLowerCase();

          if (!db) {
            alert("Banco de dados n√£o est√° dispon√≠vel.");
            return;
          }

          const worksList = document.getElementById("works-list");
          worksList.innerHTML = '<div class="work-item">Filtrando...</div>';

          const transaction = db.transaction(["obras"], "readonly");
          const objectStore = transaction.objectStore("obras");
          const request = objectStore.getAll();

          request.onsuccess = function (event) {
            const works = event.target.result;
            const filteredWorks = filterText
              ? works.filter(
                  (work) =>
                    work.CODIGO.toLowerCase().includes(filterText) ||
                    (work.NOME && work.NOME.toLowerCase().includes(filterText))
                )
              : works;

            if (filteredWorks.length === 0) {
              worksList.innerHTML =
                '<div class="work-item">Nenhuma obra encontrada</div>';
            } else {
              worksList.innerHTML = "";

              filteredWorks.forEach((work) => {
                const workItem = document.createElement("div");
                workItem.className = "work-item";
                if (work.CODIGO === currentWorkCode) {
                  workItem.classList.add("selected");
                }
                workItem.setAttribute("data-code", work.CODIGO);

                workItem.innerHTML = `
                                <span>${work.CODIGO} - ${
                  work.NOME || "Sem nome"
                }</span>
                                <button type="button" class="delete-btn" onclick="deleteWork('${
                                  work.CODIGO
                                }', event)">Excluir</button>
                            `;

                workItem.addEventListener("click", function (e) {
                  if (!e.target.classList.contains("delete-btn")) {
                    loadWork(work.CODIGO);
                  }
                });

                worksList.appendChild(workItem);
              });
            }
          };

          request.onerror = function (event) {
            console.error("Erro ao filtrar obras:", event.target.error);
            worksList.innerHTML =
              '<div class="work-item">Erro ao filtrar obras</div>';
          };
        } catch (error) {
          console.error("Erro ao filtrar obras:", error);
          alert("Erro ao filtrar obras: " + error.message);
        }
      }

      // Exportar todas as obras para CSV
      function exportAllWorks() {
        try {
          if (!db) {
            alert("Banco de dados n√£o est√° dispon√≠vel.");
            return;
          }

          const transaction = db.transaction(["obras"], "readonly");
          const objectStore = transaction.objectStore("obras");
          const request = objectStore.getAll();

          request.onsuccess = function (event) {
            const works = event.target.result;

            if (works.length === 0) {
              alert("N√£o h√° obras para exportar.");
              return;
            }

            // Obter colunas definidas
            const csvColumns = getCsvColumns();

            // Verificar campos personalizados em todas as obras
            works.forEach((work) => {
              Object.keys(work).forEach((field) => {
                if (!csvColumns.includes(field)) {
                  csvColumns.push(field);
                }
              });
            });

            // Construir o conte√∫do do CSV
            let csvContent = csvColumns.join(",") + "\n";

            works.forEach((work) => {
              const row = csvColumns.map((column) => {
                const value = work[column] || "";
                // Valores com v√≠rgula devem ser envolvidos em aspas duplas
                return value && value.includes(",") ? `"${value}"` : value;
              });

              csvContent += row.join(",") + "\n";
            });

            // Criar e baixar o arquivo CSV
            const blob = new Blob([csvContent], {
              type: "text/csv;charset=utf-8;",
            });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute(
              "download",
              `Todas_OAEs_${new Date().toISOString().split("T")[0]}.csv`
            );
            link.style.display = "none";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          };

          request.onerror = function (event) {
            console.error("Erro ao exportar obras:", event.target.error);
            alert(`Erro ao exportar obras: ${event.target.error}`);
          };
        } catch (error) {
          console.error("Erro ao exportar todas as obras:", error);
          alert("Erro ao exportar todas as obras: " + error.message);
        }
      }

      // Excluir uma obra do banco de dados
      function deleteWork(codigo, event) {
        try {
          event.stopPropagation(); // Evitar que o clique propague para o elemento pai

          if (confirm(`Tem certeza que deseja excluir a obra ${codigo}?`)) {
            if (!db) {
              alert("Banco de dados n√£o est√° dispon√≠vel.");
              return;
            }

            const transaction = db.transaction(["obras"], "readwrite");
            const objectStore = transaction.objectStore("obras");
            const request = objectStore.delete(codigo);

            request.onsuccess = function () {
              alert(`Obra ${codigo} exclu√≠da com sucesso.`);

              // Se a obra exclu√≠da for a atual, limpar o formul√°rio
              if (codigo === currentWorkCode) {
                clearForm();
                currentWorkCode = null;
              }

              loadWorksList(); // Recarregar a lista de obras
            };

            request.onerror = function (event) {
              console.error("Erro ao excluir a obra:", event.target.error);
              alert(`Erro ao excluir a obra: ${event.target.error}`);
            };
          }
        } catch (error) {
          console.error("Erro ao excluir obra:", error);
          alert("Erro ao excluir obra: " + error.message);
        }
      }

      // Limpar todo o banco de dados
      function clearDatabase() {
        try {
          if (
            confirm(
              "Tem certeza que deseja limpar todas as obras do banco de dados? Esta a√ß√£o n√£o pode ser desfeita!"
            )
          ) {
            if (!db) {
              alert("Banco de dados n√£o est√° dispon√≠vel.");
              return;
            }

            const transaction = db.transaction(["obras"], "readwrite");
            const objectStore = transaction.objectStore("obras");
            const request = objectStore.clear();

            request.onsuccess = function () {
              alert("Banco de dados limpo com sucesso.");
              clearForm();
              currentWorkCode = null;
              loadWorksList(); // Recarregar a lista de obras
            };

            request.onerror = function (event) {
              console.error(
                "Erro ao limpar o banco de dados:",
                event.target.error
              );
              alert(`Erro ao limpar o banco de dados: ${event.target.error}`);
            };
          }
        } catch (error) {
          console.error("Erro ao limpar banco de dados:", error);
          alert("Erro ao limpar banco de dados: " + error.message);
        }
      }

      // Criar nova obra
      function createNewWork() {
        clearForm();
        currentWorkCode = null;

        // Remover a sele√ß√£o de todas as obras na lista
        const workItems = document.querySelectorAll(".work-item");
        workItems.forEach((item) => {
          item.classList.remove("selected");
        });
      }

      // Mostrar lembrete para salvar dados
      function showSaveReminder() {
        try {
          const reminder = document.getElementById("save-reminder");
          reminder.style.display = "block";

          // Ocultar o lembrete ap√≥s 5 segundos
          setTimeout(function () {
            reminder.style.display = "none";
          }, 5000);
        } catch (error) {
          console.error("Erro ao mostrar lembrete:", error);
        }
      }

      // Iniciar lembretes peri√≥dicos para salvar dados
      function startSaveReminders() {
        try {
          // Mostrar lembrete a cada 5 minutos
          saveReminderInterval = setInterval(showSaveReminder, 5 * 60 * 1000);
        } catch (error) {
          console.error("Erro ao iniciar lembretes:", error);
        }
      }

      // Limpar formul√°rio
      function clearForm() {
        try {
          document.getElementById("oae-form").reset();
          document.getElementById("csv-line").style.display = "none";

          // Limpar mensagens de erro
          document.querySelectorAll(".error").forEach((el) => {
            el.classList.remove("error");
          });

          document.querySelectorAll(".error-message").forEach((el) => {
            el.classList.remove("visible");
          });

          // Ocultar mensagem de erro de prote√ß√£o lateral
          document.getElementById("lateral-protection-error").style.display =
            "none";

          generateTramosFields(); // Regenerar os campos din√¢micos
        } catch (error) {
          console.error("Erro ao limpar formul√°rio:", error);
          alert("Erro ao limpar formul√°rio: " + error.message);
        }
      }

      // Importar m√∫ltiplas obras (processar arquivo)
      function importMultipleWorks() {
        document.getElementById("csv-file-input").click();
      }

      // Mostrar o modal de importa√ß√£o de m√∫ltiplas obras
      function showImportModal() {
        document.getElementById("csv-file-input").value = "";
        document.getElementById("import-modal").style.display = "block";
      }

      // Validar comprimento dos tramos em rela√ß√£o ao comprimento total
      function validateTramosLength() {
        const comprimentoTotal =
          parseFloat(document.getElementById("comprimento").value) || 0;

        // Somar comprimentos dos tramos
        let somaTramos = 0;
        const tramosFields = document.querySelectorAll(".tramo-field");
        tramosFields.forEach((field) => {
          somaTramos += parseFloat(field.value) || 0;
        });

        // Verificar se a soma dos tramos excede o comprimento total
        if (somaTramos > comprimentoTotal) {
          // Destacar os campos com problema
          document.getElementById("comprimento").classList.add("error");
          tramosFields.forEach((field) => field.classList.add("error"));

          // Mostrar mensagem de erro
          alert(
            `O comprimento total dos tramos (${somaTramos.toFixed(
              2
            )}m) n√£o pode exceder o comprimento da estrutura (${comprimentoTotal.toFixed(
              2
            )}m).`
          );
          return false;
        }

        // Remover destaque de erro se estiver tudo certo
        document.getElementById("comprimento").classList.remove("error");
        tramosFields.forEach((field) => field.classList.remove("error"));
        return true;
      }

      // Atualizar evento do input de arquivo
      document.addEventListener("DOMContentLoaded", function () {
        const fileInput = document.getElementById("csv-file-input");
        if (fileInput) {
          fileInput.addEventListener("change", function () {
            if (this.files.length > 0) {
              processImportFile();
            }
          });
        }
      });

      // Validar rela√ß√£o entre altura da longarina e altura do apoio
      function validateHeights() {
        const alturaTotal =
          parseFloat(document.getElementById("altura").value) || 0;
        const alturaLongarina =
          parseFloat(document.getElementById("altura-longarina").value) || 0;

        // Obter as alturas dos apoios (pode haver m√∫ltiplos)
        const apoiosFields = document.querySelectorAll(".apoio-field");
        let alturaMaxApoio = 0;

        // Encontrar a altura m√°xima dos apoios
        apoiosFields.forEach((field) => {
          const alturaApoio = parseFloat(field.value) || 0;
          if (alturaApoio > alturaMaxApoio) {
            alturaMaxApoio = alturaApoio;
          }
        });

        // Calcular soma
        const somaAlturas = alturaLongarina + alturaMaxApoio;

        // Verificar se a soma excede a altura total
        if (somaAlturas > alturaTotal) {
          // Destacar campos com problema
          document.getElementById("altura").classList.add("error");
          document.getElementById("altura-longarina").classList.add("error");
          apoiosFields.forEach((field) => field.classList.add("error"));

          // Mostrar mensagem de erro
          alert(
            `A soma da altura da longarina (${alturaLongarina.toFixed(
              2
            )}m) e do apoio (${alturaMaxApoio.toFixed(
              2
            )}m) n√£o pode exceder a altura total da estrutura (${alturaTotal.toFixed(
              2
            )}m).`
          );
          return false;
        }

        // Remover destaque de erro se estiver tudo certo
        document.getElementById("altura").classList.remove("error");
        document.getElementById("altura-longarina").classList.remove("error");
        apoiosFields.forEach((field) => field.classList.remove("error"));
        return true;
      }

      // Validar rela√ß√£o entre deslocamentos e largura
      function validateDisplacements() {
        const larguraTotal =
          parseFloat(document.getElementById("largura").value) || 0;
        const deslocamentoEsquerdo =
          parseFloat(document.getElementById("deslocamento-esquerdo").value) ||
          0;
        const deslocamentoDireito =
          parseFloat(document.getElementById("deslocamento-direito").value) ||
          0;

        // Calcular soma dos deslocamentos
        const somaDeslocamentos = deslocamentoEsquerdo + deslocamentoDireito;

        // Verificar se a soma excede a largura total
        if (somaDeslocamentos >= larguraTotal) {
          // Destacar campos com problema
          document.getElementById("largura").classList.add("error");
          document
            .getElementById("deslocamento-esquerdo")
            .classList.add("error");
          document
            .getElementById("deslocamento-direito")
            .classList.add("error");

          // Mostrar mensagem de erro
          alert(
            `A soma do deslocamento esquerdo (${deslocamentoEsquerdo.toFixed(
              2
            )}m) e do deslocamento direito (${deslocamentoDireito.toFixed(
              2
            )}m) deve ser menor que a largura total (${larguraTotal.toFixed(
              2
            )}m).`
          );
          return false;
        }

        // Remover destaque de erro se estiver tudo certo
        document.getElementById("largura").classList.remove("error");
        document
          .getElementById("deslocamento-esquerdo")
          .classList.remove("error");
        document
          .getElementById("deslocamento-direito")
          .classList.remove("error");
        return true;
      }
    </script>
  </body>
</html>
