<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OAE - Interface de Preenchimento</title>

    <style>
      /* Base de estilo do novo design */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(
          135deg,
          #2c3e50 0%,
          #34495e 50%,
          #2c3e50 100%
        );
        min-height: 100vh;
        color: #ffffff;
        overflow-x: hidden;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
      }

      header {
        text-align: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      h1 {
        font-size: 2rem;
        font-weight: 700;
        background: linear-gradient(45deg, #ffffff, #e3f2fd);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      }

      h2 {
        font-size: 1.5rem;
        margin: 20px 0 10px;
        background: rgba(52, 152, 219, 0.2);
        color: white;
        padding: 10px;
        border-radius: 10px;
        backdrop-filter: blur(5px);
      }

      h3 {
        font-size: 1.2rem;
        margin: 15px 0 10px;
        padding-bottom: 5px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        color: #e3f2fd;
      }

      /* Sistemas de abas */
      .tabs {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        gap: 5px;
      }

      .tab {
        padding: 10px 20px;
        cursor: pointer;
        background: rgba(52, 152, 219, 0.1);
        border-radius: 10px 10px 0 0;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-bottom: none;
        margin-bottom: -1px;
      }

      .tab:hover {
        background: rgba(52, 152, 219, 0.3);
      }

      .tab.active {
        background: linear-gradient(
          to bottom,
          rgba(52, 152, 219, 0.6),
          rgba(52, 152, 219, 0.3)
        );
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-bottom: none;
        position: relative;
      }

      .tab-content {
        display: none;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(5px);
        border-radius: 0 10px 10px 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        animation: fadeIn 0.3s ease-out;
      }

      .tab-content.active {
        display: block;
      }

      /* Formulários */
      .form-row {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 15px;
        gap: 15px;
      }

      .form-group {
        flex: 1 0 calc(33.333% - 15px);
        min-width: 200px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #e3f2fd;
      }

      label.required::after {
        content: " *";
        color: #e74c3c;
        font-weight: bold;
      }

      input[type="text"],
      input[type="number"],
      input[type="date"],
      select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        font-size: 14px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        transition: all 0.3s ease;
      }

      input[type="text"]:focus,
      input[type="number"]:focus,
      input[type="date"]:focus,
      select:focus {
        border-color: rgba(52, 152, 219, 0.8);
        outline: none;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.3);
      }

      input.error,
      select.error {
        border: 2px solid #e74c3c;
        background-color: rgba(231, 76, 60, 0.1);
      }

      select {
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 16px;
        padding-right: 30px;
      }

      /* Opções do select */
      select option {
        background-color: #34495e;
        color: white;
      }

      input[type="checkbox"] {
        width: 18px;
        height: 18px;
        margin-right: 5px;
        vertical-align: middle;
        accent-color: #3498db;
      }

      /* Botões */
      button {
        background: linear-gradient(45deg, #3498db, #2980b9);
        color: white;
        border: none;
        padding: 12px 18px;
        margin: 5px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
      }

      button:hover {
        background: linear-gradient(45deg, #2980b9, #3498db);
        transform: translateY(-2px);
        box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
      }

      button:active {
        transform: translateY(0);
        box-shadow: 0 2px 3px rgba(0, 0, 0, 0.1);
      }

      button::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s ease;
      }

      button:hover::before {
        left: 100%;
      }

      .add-btn {
        background: linear-gradient(45deg, #27ae60, #2ecc71);
      }

      .add-btn:hover {
        background: linear-gradient(45deg, #2ecc71, #27ae60);
      }

      .copy-btn {
        background: linear-gradient(45deg, #8e44ad, #9b59b6);
      }

      .copy-btn:hover {
        background: linear-gradient(45deg, #9b59b6, #8e44ad);
      }

      .delete-btn {
        background: linear-gradient(45deg, #e74c3c, #c0392b);
      }

      .delete-btn:hover {
        background: linear-gradient(45deg, #c0392b, #e74c3c);
      }

      /* Containers dinâmicos */
      .dynamic-container {
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 20px;
        margin: 15px 0;
        border-radius: 10px;
        background: rgba(52, 152, 219, 0.1);
        backdrop-filter: blur(5px);
      }

      .dynamic-fields {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .actions {
        margin-top: 20px;
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-end;
        gap: 10px;
      }

      .dynamic-field {
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        width: 100%;
        gap: 10px;
      }

      .dynamic-field label {
        width: 100px;
        margin-right: 10px;
        margin-bottom: 0;
        flex-shrink: 0;
      }

      .dynamic-field input {
        flex-grow: 1;
      }

      /* Modais */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
      }

      .modal-content {
        background: linear-gradient(135deg, #34495e, #2c3e50);
        margin: 5% auto;
        padding: 25px;
        border-radius: 15px;
        width: 80%;
        max-width: 800px;
        max-height: 80%;
        overflow-y: auto;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        animation: fadeInUp 0.3s ease-out;
      }

      .close-modal {
        float: right;
        cursor: pointer;
        font-size: 24px;
        font-weight: bold;
        color: rgba(255, 255, 255, 0.7);
        transition: color 0.3s;
      }

      .close-modal:hover {
        color: #fff;
      }

      /* Painel de obras */
      .works-panel {
        margin-bottom: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 20px;
        background: rgba(52, 73, 94, 0.4);
        backdrop-filter: blur(10px);
      }

      .works-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        margin: 15px 0;
        padding: 10px;
        background-color: rgba(255, 255, 255, 0.05);
      }

      .work-item {
        padding: 10px 15px;
        margin-bottom: 8px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 6px;
        transition: all 0.3s ease;
      }

      .work-item:hover {
        background-color: rgba(52, 152, 219, 0.2);
      }

      .work-item.selected {
        background-color: rgba(52, 152, 219, 0.3);
        font-weight: bold;
        border-left: 3px solid #3498db;
      }

      .filter-container {
        display: flex;
        margin-bottom: 15px;
        gap: 10px;
      }

      .filter-container input {
        flex-grow: 1;
        padding: 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }

      /* Notificações e mensagens */
      .notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: linear-gradient(45deg, #3498db, #2980b9);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        display: none;
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
      }

      .toggle-panel {
        cursor: pointer;
        background: linear-gradient(45deg, #3498db, #2980b9);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        font-size: 14px;
        border: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .toggle-panel:hover {
        background: linear-gradient(45deg, #2980b9, #3498db);
        transform: translateY(-2px);
        box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
      }

      /* CSV e resultados */
      #csv-line {
        margin: 15px 0;
        padding: 15px;
        background: rgba(52, 73, 94, 0.5);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        font-family: monospace;
        white-space: pre-wrap;
        word-break: break-all;
        display: none;
        color: #e3f2fd;
      }

      /* Mantenha o posicionamento absoluto */
      .form-group {
        position: relative;
      }

      .error-message {
        display: none; /* Esconde por padrão */
        position: absolute;
        top: 100%;
        left: 0;
        color: #e74c3c;
        font-size: 12px;
        background: rgba(231, 76, 60, 0.1);
        padding: 2px 8px;
        border-radius: 4px;
        z-index: 10;
        width: 100%;
      }

      /* Exibe apenas quando tem a classe visible */
      .error-message.visible {
        display: block;
      }
      .error-message.visible {
        display: block;
        animation: fadeIn 0.3s ease;
      }

      .alert-message {
        color: #e74c3c;
        background-color: rgba(231, 76, 60, 0.1);
        padding: 10px 15px;
        border-radius: 8px;
        margin: 10px 0;
        border-left: 4px solid #e74c3c;
      }

      /* Alerta de pendências - estilo original adaptado */
      .missing-fields-list {
        background-color: #f9f9f9;
        border: 1px solid #bdc3c7;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 15px;
        color: #333;
      }

      .missing-field {
        color: #e74c3c;
        font-weight: normal;
        margin-bottom: 5px;
      }

      /* Estilo para o modal de resumo */
      .summary-modal .modal-content {
        background: white;
        color: #333;
        border: 1px solid #bdc3c7;
      }

      .summary-section {
        margin-bottom: 20px;
        border-bottom: 1px solid #ddd;
        padding-bottom: 15px;
      }

      .summary-section h3 {
        background-color: #2c3e50;
        color: white;
        padding: 8px;
        border-radius: 4px;
      }

      .summary-row {
        display: flex;
        margin: 8px 0;
        padding: 4px 0;
        border-bottom: 1px solid #eee;
      }

      .summary-label {
        flex: 0 0 40%;
        font-weight: bold;
        color: #333;
      }

      .summary-value {
        flex: 0 0 60%;
        color: #333;
      }

      /* Animações */
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes slideIn {
        from {
          transform: translateX(100px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* Responsividade */
      @media (max-width: 768px) {
        .container {
          padding: 1rem;
          width: 95%;
        }

        .form-group {
          flex: 1 0 100%;
        }

        .actions {
          justify-content: center;
        }

        .tab {
          padding: 8px 12px;
          font-size: 14px;
        }

        .modal-content {
          width: 95%;
          margin: 10% auto;
        }
      }
    </style>
  </head>
  <body>
    <div class="notification" id="save-reminder">
      Lembrete: Salve seus dados para não perder o trabalho!
      <button onclick="exportToCSV()">Salvar agora</button>
    </div>

    <div class="container">
      <header>
        <h1>Interface de Preenchimento de Obras de Arte Especiais (OAE)</h1>
        <button id="toggle-works-panel" class="toggle-panel">
          Mostrar Obras
        </button>
      </header>

      <div class="works-panel" id="works-panel" style="display: none">
        <h2>Gerenciamento de Obras</h2>
        <div class="filter-container">
        <input 
        type="text" 
        id="filter-works" 
         placeholder="Filtrar por código..."
          />
          <button onclick="filterWorks()">Filtrar</button>
        </div>
        <div class="works-list" id="works-list">
          <!-- Lista de obras aqui -->
          <div class="work-item">Nenhuma obra cadastrada</div>
        </div>
       
       
   
<div class="actions">
  <button type="button" onclick="createNewWork()">Nova Obra</button>
  <button type="button" onclick="importMultipleWorks()">Importar Múltiplas Obras</button>
  <button type="button" onclick="importPontesReferenceCSV()">Importar CSV de Pontes</button>
  <button type="button" onclick="exportAllWorks()">Exportar Todas Obras</button>
  <button type="button" class="delete-btn" onclick="clearDatabase()">Limpar Banco de Dados</button>
</div>




      </div>

      <div class="tabs">
        <div class="tab active" data-tab="info">Informações Gerais</div>
        <div class="tab" data-tab="configuracao">Configurações Gerais</div>
        <div class="tab" data-tab="transicao">Transição</div>
        <div class="tab" data-tab="superestrutura">Superestrutura</div>
        <div class="tab" data-tab="apoio">Apoio</div>
        <div class="tab" data-tab="complementares">
          Elementos Complementares
        </div>
      </div>

      <form id="oae-form">
        <!-- Informações Gerais -->
        <div class="tab-content active" id="info-content">
          <h2>Informações Gerais da Obra</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="modelado">Modelado:</label>
              <input type="checkbox" id="modelado" name="MODELADO" />
            </div>
            <div class="form-group">
              <label for="gps">GPS:</label>
              <input type="checkbox" id="gps" name="GPS" />
            </div>
            <div class="form-group">
              <label for="lote" class="required">Lote:</label>
              <input type="text" id="lote" name="LOTE" required />
              <div class="error-message" id="lote-error">
                Este campo é obrigatório
              </div>
            </div>
          </div>        

          <!-- Adicione também um botão para buscar pontes no formulário principal, próximo ao campo código -->
          <div class="form-group">
            <label for="codigo">Código:</label>
            <div style="display: flex; gap: 5px;">
              <input type="text" id="codigo" name="CODIGO" required style="flex-grow: 1;" />
              <button type="button" onclick="showSearchPontesModal()" title="Buscar ponte de referência">
                Buscar
              </button>
            </div>
            <div class="form-group">
              <label for="fotos-superiores">Fotos Superiores:</label>
              <input
                type="number"
                id="fotos-superiores"
                name="FOTOS SUPERIORES"
                min="0"
                step="1"
              />
            </div>
            <div class="form-group">
              <label for="fotos-inferiores">Fotos Inferiores:</label>
              <input
                type="number"
                id="fotos-inferiores"
                name="FOTOS INFERIORES"
                min="0"
                step="1"
              />
            </div>

            <div class="form-group">
              <label for="nome">Nome:</label>
              <input type="text" id="nome" name="NOME" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="uf">UF:</label>
              <input type="text" id="uf" name="UF" />
            </div>


            <div class="form-group">
              <label for="rodovia">Rodovia:</label>
              <input type="text" id="rodovia" name="RODOVIA" />
            </div>
            <div class="form-group">
              <label for="km">KM:</label>
              <input type="number" id="km" name="KM" step="0.01" min="0" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="data">Data:</label>
              <input
                type="text"
                id="data"
                name="DATA"
                placeholder="dd/mm/aaaa"
              />
            </div>
            <div class="form-group">
              <label for="engenheiro">Engenheiro:</label>
              <input type="text" id="engenheiro" name="ENGENHEIRO" />
            </div>
            <div class="form-group">
              <label for="tecnico">Técnico:</label>
              <input type="text" id="tecnico" name="TECNICO" />
            </div>
          </div>

          <div id="info-custom-fields"></div>
          <button
            type="button"
            class="add-btn"
            onclick="showAddField('info-custom-fields')"
          >
            + Adicionar Campo
          </button>
        </div>

        <!-- Configurações Gerais -->
        <div class="tab-content" id="configuracao-content">
          <h2>Configurações Gerais</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="comprimento" class="required">Comprimento (m):</label>
              <input
                type="number"
                id="comprimento"
                name="COMPRIMENTO"
                step="0.01"
                min="0"
                required
              />
              <div class="error-message" id="comprimento-error">
                Este campo é obrigatório
              </div>
            </div>
            <div class="form-group">
              <label for="largura" class="required">Largura (m):</label>
              <input
                type="number"
                id="largura"
                name="LARGURA"
                step="0.01"
                min="0"
                required
              />
              <div class="error-message" id="largura-error">
                Este campo é obrigatório
              </div>
            </div>
            <div class="form-group">
              <label for="altura" class="required">Altura (m):</label>
              <input
                type="number"
                id="altura"
                name="ALTURA"
                step="0.01"
                min="0"
                required
              />
              <div class="error-message" id="altura-error">
                Este campo é obrigatório
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="qtd-tramos" class="required"
                >Quantidade de Tramos:</label
              >
              <input
                type="number"
                id="qtd-tramos"
                name="QTD TRAMOS"
                min="1"
                value="1"
                required
                onchange="generateTramosFields()"
              />
              <div class="error-message" id="qtd-tramos-error">
                Este campo é obrigatório e deve ser no mínimo 1
              </div>
            </div>
          </div>

          <div id="dynamic-tramos" class="dynamic-container">
            <h3>Comprimento dos Tramos</h3>
            <div id="tramos-fields" class="dynamic-fields">
              <!-- Campos gerados dinamicamente para tramos -->
            </div>
            <div class="error-message" id="tramos-error">
              Todos os tramos devem ter comprimento mínimo de 0.5m
            </div>
          </div>

          <div id="config-custom-fields"></div>
          <button
            type="button"
            class="add-btn"
            onclick="showAddField('config-custom-fields')"
          >
            + Adicionar Campo
          </button>
        </div>

        <!-- Transição -->
        <div class="tab-content" id="transicao-content">
          <h2>Transição</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="cortina-altura" class="required"
                >Cortina Altura (m):</label
              >
              <input
                type="number"
                id="cortina-altura"
                name="CORTINA ALTURA"
                step="0.01"
                min="0"
                required
              />
              <div class="error-message" id="cortina-altura-error">
                Este campo é obrigatório
              </div>
            </div>
            <div class="form-group">
              <label for="ala-paralela">Ala Paralela:</label>
              <select id="ala-paralela" name="ALA PARALELA">
                <!-- Adicionar após o campo ala-paralela -->
                <div class="error-message" id="ala-paralela-error">
                  Este campo é obrigatório quando o encontro é Parede Frontal
                  Portante
                </div>

                <option value="">Selecione</option>
                <option value="ALA DE CONCRETO ARMADO">
                  ALA DE CONCRETO ARMADO
                </option>
                <option value="Nenhum">Nenhum</option>
              </select>
            </div>
            <div class="form-group">
              <label for="ala-perpendicular">Ala Perpendicular:</label>

              <!-- Adicionar após o campo ala-perpendicular -->
              <div class="error-message" id="ala-perpendicular-error">
                Este campo é obrigatório quando o encontro é Parede Frontal
                Portante
              </div>

              <select id="ala-perpendicular" name="ALA PERPENDICULAR">
                <option value="">Selecione</option>
                <option value="ALA DE CONCRETO ARMADO">
                  ALA DE CONCRETO ARMADO
                </option>
                <option value="Nenhum">Nenhum</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="comprimento-ala">Comprimento Ala (m):</label>
              <input
                type="number"
                id="comprimento-ala"
                name="COMPRIMENTO ALA"
                step="0.01"
                min="0"
                required
              />
              <div class="error-message" id="comprimento-ala-error">
                Este campo é obrigatório se alguma ala estiver selecionada
              </div>
            </div>
            <div class="form-group">
              <label for="espessura-ala">Espessura Ala (m):</label>
              <input
                type="number"
                id="espessura-ala"
                name="ESPESSURA ALA"
                step="0.01"
                min="0"
              />
            </div>
            <div class="form-group">
              <label for="encontro">Encontro:</label>
              <select id="encontro" name="ENCONTRO">
                <option value="">Selecione</option>
                <option value="Nenhum">Nenhum</option>
                <option value="ENCONTRO - PAREDE FRONTAL PORTANTE">
                  ENCONTRO - PAREDE FRONTAL PORTANTE
                </option>
                <option value="ENCONTRO LAJE">ENCONTRO LAJE</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="deslocamento-esquerdo-encontro-laje"
                >Deslocamento Esquerdo Encontro Laje (m):</label
              >
              <input
                type="number"
                id="deslocamento-esquerdo-encontro-laje"
                name="DESLOCAMENTO ESQUERDO ENCONTRO LAJE"
                step="0.01"
                min="0"
              />
            </div>
            <div class="form-group">
              <label for="deslocamento-direito-encontro-laje"
                >Deslocamento Direito Encontro Laje (m):</label
              >
              <input
                type="number"
                id="deslocamento-direito-encontro-laje"
                name="DESLOCAMENTO DIREITO ENCONTRO LAJE"
                step="0.01"
                min="0"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="comprimento-encontro-laje"
                >Comprimento Encontro Laje (m):</label
              >
              <input
                type="number"
                id="comprimento-encontro-laje"
                name="COMPRIMENTO ENCONTRO LAJE"
                step="0.01"
                min="0"
              />
            </div>
            <div class="form-group">
              <label for="laje-transicao">Laje de Transição:</label>
              <select id="laje-transicao" name="LAJE DE TRANSIÇÃO">
                <option value="">Selecione</option>
                <option value="Nenhum">Nenhum</option>
                <option value="LAJE DE TRANSIÇÃO">LAJE DE TRANSIÇÃO</option>
              </select>
            </div>
          </div>

          <div id="transicao-custom-fields"></div>
          <button
            type="button"
            class="add-btn"
            onclick="showAddField('transicao-custom-fields')"
          >
            + Adicionar Campo
          </button>
        </div>

        <!-- Superestrutura -->
        <div class="tab-content" id="superestrutura-content">
          <h2>Superestrutura</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="altura-longarina" class="required"
                >Altura Longarina (m):</label
              >
              <input
                type="number"
                id="altura-longarina"
                name="ALTURA LONGARINA"
                step="0.01"
                min="0"
                required
              />
              <div class="error-message" id="altura-longarina-error">
                Este campo é obrigatório
              </div>
            </div>
            <div class="form-group">
              <label for="deslocamento-esquerdo" class="required"
                >Deslocamento Esquerdo (m):</label
              >
              <input
                type="number"
                id="deslocamento-esquerdo"
                name="DESLOCAMENTO ESQUERDO"
                step="0.01"
                min="0"
                required
              />
              <div class="error-message" id="deslocamento-esquerdo-error">
                Este campo é obrigatório
              </div>
            </div>
            <div class="form-group">
              <label for="deslocamento-direito" class="required"
                >Deslocamento Direito (m):</label
              >
              <input
                type="number"
                id="deslocamento-direito"
                name="DESLOCAMENTO DIREITO"
                step="0.01"
                min="0"
                required
              />
              <div class="error-message" id="deslocamento-direito-error">
                Este campo é obrigatório
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="qtd-longarinas" class="required"
                >Quantidade de Longarinas:</label
              >
              <input
                type="number"
                id="qtd-longarinas"
                name="QTD LONGARINAS"
                min="0"
                required
              />
              <div class="error-message" id="qtd-longarinas-error">
                Este campo é obrigatório
              </div>
            </div>
            <div class="form-group">
              <label for="qtd-transversinas"
                >Quantidade de Transversinas:</label
              >
              <input
                type="number"
                id="qtd-transversinas"
                name="QTD TRANSVERSINAS"
                min="0"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="espessura-longarina" class="required"
                >Espessura Longarina (m):</label
              >
              <input
                type="number"
                id="espessura-longarina"
                name="ESPESSURA LONGARINA"
                step="0.01"
                min="0"
                required
              />
              <div class="error-message" id="espessura-longarina-error">
                Este campo é obrigatório
              </div>
            </div>
            <div class="form-group">
              <label for="espessura-transversina"
                >Espessura Transversina (m):</label
              >
              <input
                type="number"
                id="espessura-transversina"
                name="ESPESSURA TRANSVERSINA"
                step="0.01"
                min="0"
              />
            </div>
            <div class="form-group">
              <label for="espessura-laje" class="required"
                >Espessura Laje (m):</label
              >
              <input
                type="number"
                id="espessura-laje"
                name="ESPESSURA LAJE"
                step="0.01"
                min="0"
                required
              />
              <div class="error-message" id="espessura-laje-error">
                Este campo é obrigatório
              </div>
            </div>
          </div>

          <div id="superestrutura-custom-fields"></div>
          <button
            type="button"
            class="add-btn"
            onclick="showAddField('superestrutura-custom-fields')"
          >
            + Adicionar Campo
          </button>
        </div>

        <!-- Apoio -->
        <div class="tab-content" id="apoio-content">
          <h2>Apoio</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="qtd-pilares" class="required"
                >Quantidade de Pilares:</label
              >
              <input
                type="number"
                id="qtd-pilares"
                name="QTD PILARES"
                min="0"
                required
              />
              <div class="error-message" id="qtd-pilares-error">
                Este campo é obrigatório
              </div>
            </div>
            <div class="form-group">
              <label for="pilar-descentralizado">Pilar Descentralizado:</label>
              <select id="pilar-descentralizado" name="PILAR DESCENTRALIZADO">
                <option value="">Selecione</option>
                <option value="Sim">Sim</option>
                <option value="Não">Não</option>
              </select>
            </div>
            <div class="form-group">
              <label for="largura-pilar">Largura do Pilar (m):</label>
              <input
                type="number"
                id="largura-pilar"
                name="LARGURA PILAR"
                step="0.01"
                min="0"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="comprimento-pilares">Comprimento Pilares (m):</label>
              <input
                type="number"
                id="comprimento-pilares"
                name="COMPRIMENTO PILARES"
                step="0.01"
                min="0"
              />
            </div>
            <div class="form-group">
              <label for="tipo-aparelho-apoio"
                >Tipo de Aparelho de Apoio:</label
              >
              <select id="tipo-aparelho-apoio" name="TIPO DE APARELHO DE APOIO">
                <option value="">Selecione</option>
                <option value="APARELHO DE APOIO DE NEOPRENE FRETADO">
                  APARELHO DE APOIO DE NEOPRENE FRETADO
                </option>
                <option value="Nenhum">Nenhum</option>
              </select>
            </div>
          </div>

          <div id="dynamic-apoios" class="dynamic-container">
            <h3>Altura dos Apoios</h3>
            <div id="apoios-fields" class="dynamic-fields">
              <!-- Campos gerados dinamicamente para apoios -->
            </div>
            <div class="error-message" id="apoios-error">
              Todos os apoios precisam ser preenchidos
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="tipo-travessa">Tipo de Travessa:</label>
              <select id="tipo-travessa" name="TIPO DE TRAVESSA">
                <option value="">Selecione</option>
                <option value="TRAVESSA DE APOIO DE CONCRETO ARMADO">
                  TRAVESSA DE APOIO DE CONCRETO ARMADO
                </option>
                <option value="Nenhum">Nenhum</option>
              </select>
            </div>
            <div class="form-group">
              <label for="altura-travessa">Altura Travessa (m):</label>
              <input
                type="number"
                id="altura-travessa"
                name="ALTURA TRAVESSA"
                step="0.01"
                min="0"
              />
              <div class="error-message" id="altura-travessa-error">
                Este campo é obrigatório se uma travessa estiver selecionada
              </div>
            </div>
            <div class="form-group">
              <label for="tipo-encamisamento">Tipo de Encamisamento:</label>
              <select id="tipo-encamisamento" name="TIPO DE ENCAMISAMENTO">
                <option value="">Selecione</option>
                <option value="ENCAMISAMENTO DE PILAR">
                  ENCAMISAMENTO DE PILAR
                </option>
                <option value="Nenhum">Nenhum</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="tipo-bloco-sapata">Tipo de Bloco ou Sapata:</label>
              <select id="tipo-bloco-sapata" name="TIPO DE BLOCO OU SAPATA">
                <option value="">Selecione</option>
                <option value="BLOCO OU SAPATA DE CONCRETO ARMADO">
                  BLOCO OU SAPATA DE CONCRETO ARMADO
                </option>
                <option value="Nenhum">Nenhum</option>
              </select>
            </div>
            <div class="form-group">
              <label for="altura-bloco-sapata"
                >Altura Bloco ou Sapata (m):</label
              >
              <input
                type="number"
                id="altura-bloco-sapata"
                name="ALTURA BLOCO OU SAPATA"
                step="0.01"
                min="0"
              />
            </div>
            <div class="form-group">
              <label for="largura-bloco-sapata"
                >Largura Bloco ou Sapata (m):</label
              >
              <input
                type="number"
                id="largura-bloco-sapata"
                name="LARGURA BLOCO OU SAPATA"
                step="0.01"
                min="0"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="viga-contraventamento-pilar"
                >Viga de Contraventamento de Pilar:</label
              >
              <select
                id="viga-contraventamento-pilar"
                name="VIGA DE CONTRAVENTAMENTO DE PILAR"
              >
                <option value="">Selecione</option>
                <option value="VIGA DE CONTRAVENTAMENTO DE PILAR">
                  VIGA DE CONTRAVENTAMENTO DE PILAR
                </option>
                <option value="Nenhum">Nenhum</option>
              </select>
            </div>
            <div class="form-group">
              <label for="viga-ligacao-fundacoes"
                >Viga de Ligação de Fundações:</label
              >
              <select
                id="viga-ligacao-fundacoes"
                name="VIGA DE LIGAÇÃO DE FUNDAÇÕES"
              >
                <option value="">Selecione</option>
                <option value="VIGA DE LIGAÇÃO DE FUNDAÇÕES">
                  VIGA DE LIGAÇÃO DE FUNDAÇÕES
                </option>
                <option value="Nenhum">Nenhum</option>
              </select>
            </div>
          </div>

          <div id="apoio-custom-fields"></div>
          <button
            type="button"
            class="add-btn"
            onclick="showAddField('apoio-custom-fields')"
          >
            + Adicionar Campo
          </button>
        </div>

        <!-- Elementos Complementares -->
        <div class="tab-content" id="complementares-content">
          <h2>Elementos Complementares</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="barreira-esquerda">Barreira Esquerda:</label>
              <select id="barreira-esquerda" name="BARREIRA ESQUERDA">
                <option value="">Selecione</option>
                <option value="BARREIRA NEW JERSEY">BARREIRA NEW JERSEY</option>
                <option value="Nenhum">Nenhum</option>
              </select>
            </div>
            <div class="form-group">
              <label for="largura-barreira-esquerda"
                >Largura Barreira Esquerda (m):</label
              >
              <input
                type="number"
                id="largura-barreira-esquerda"
                name="LARGURA BARREIRA ESQUERDA"
                step="0.01"
                min="0"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="barreira-direita">Barreira Direita:</label>
              <select id="barreira-direita" name="BARREIRA DIREITA">
                <option value="">Selecione</option>
                <option value="BARREIRA NEW JERSEY">BARREIRA NEW JERSEY</option>
                <option value="Nenhum">Nenhum</option>
              </select>
            </div>
            <div class="form-group">
              <label for="largura-barreira-direita"
                >Largura Barreira Direita (m):</label
              >
              <input
                type="number"
                id="largura-barreira-direita"
                name="LARGURA BARREIRA DIREITA"
                step="0.01"
                min="0"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="calcada-esquerda">Calçada Esquerda:</label>
              <select id="calcada-esquerda" name="CALÇADA ESQUERDA">
                <option value="">Selecione</option>
                <option value="CALÇADA PARA PEDESTRES DE CONCRETO ARMADO">
                  CALÇADA PARA PEDESTRES DE CONCRETO ARMADO
                </option>
                <option value="Nenhum">Nenhum</option>
              </select>
            </div>
            <div class="form-group">
              <label for="largura-calcada-esquerda"
                >Largura Calçada Esquerda (m):</label
              >
              <input
                type="number"
                id="largura-calcada-esquerda"
                name="LARGURA CALÇADA ESQUERDA"
                step="0.01"
                min="0"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="calcada-direita">Calçada Direita:</label>
              <select id="calcada-direita" name="CALÇADA DIREITA">
                <option value="">Selecione</option>
                <option value="CALÇADA PARA PEDESTRES DE CONCRETO ARMADO">
                  CALÇADA PARA PEDESTRES DE CONCRETO ARMADO
                </option>
                <option value="Nenhum">Nenhum</option>
              </select>
            </div>
            <div class="form-group">
              <label for="largura-calcada-direita"
                >Largura Calçada Direita (m):</label
              >
              <input
                type="number"
                id="largura-calcada-direita"
                name="LARGURA CALÇADA DIREITA"
                step="0.01"
                min="0"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="guarda-rodas-esquerda">Guarda Rodas Esquerda:</label>
              <select id="guarda-rodas-esquerda" name="GUARDA RODAS ESQUERDA">
                <option value="">Selecione</option>
                <option value="GUARDA-RODAS ANTIGO DO DNER">
                  GUARDA-RODAS ANTIGO DO DNER
                </option>
                <option value="Nenhum">Nenhum</option>
              </select>
            </div>
            <div class="form-group">
              <label for="largura-guarda-rodas-esquerda"
                >Largura Guarda Rodas Esquerda (m):</label
              >
              <input
                type="number"
                id="largura-guarda-rodas-esquerda"
                name="LARGURA GUARDA RODAS ESQUERDA"
                step="0.01"
                min="0"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="guarda-rodas-direita">Guarda Rodas Direita:</label>
              <select id="guarda-rodas-direita" name="GUARDA RODAS DIREITA">
                <option value="">Selecione</option>
                <option value="GUARDA-RODAS ANTIGO DO DNER">
                  GUARDA-RODAS ANTIGO DO DNER
                </option>
                <option value="Nenhum">Nenhum</option>
              </select>
            </div>
            <div class="form-group">
              <label for="largura-guarda-rodas-direita"
                >Largura Guarda Rodas Direita (m):</label
              >
              <input
                type="number"
                id="largura-guarda-rodas-direita"
                name="LARGURA GUARDA RODAS DIREITA"
                step="0.01"
                min="0"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="pavimento" class="required">Pavimento:</label>
              <select id="pavimento" name="PAVIMENTO" required>
                <option value="">Selecione</option>
                <option value="PAVIMENTO ASFÁLTICO">PAVIMENTO ASFÁLTICO</option>
                <option value="Nenhum">Nenhum</option>
              </select>
              <div class="error-message" id="pavimento-error">
                Este campo é obrigatório
              </div>
            </div>
            <div class="form-group">
              <label for="qtd-buzinotes">Quantidade de Buzinotes:</label>
              <input
                type="number"
                id="qtd-buzinotes"
                name="QTD BUZINOTES"
                min="0"
              />
            </div>
          </div>

          <div
            class="alert-message"
            id="lateral-protection-error"
            style="
              display: none;
              color: var(--danger);
              background-color: rgba(231, 76, 60, 0.1);
              padding: 10px;
              border-radius: 4px;
              margin: 10px 0;
            "
          >
            <strong>Atenção:</strong> Toda obra deve ter pelo menos um tipo de
            proteção lateral (barreira, guarda-rodas ou calçada) em AMBOS os
            lados.
          </div>

          <div id="complementares-custom-fields"></div>
          <button
            type="button"
            class="add-btn"
            onclick="showAddField('complementares-custom-fields')"
          >
            + Adicionar Campo
          </button>
        </div>
      </form>

      <div id="csv-line"></div>

      <!-- Botões de Ação -->
      <div class="actions">
        <button type="button" id="import-btn" onclick="showImportModal()">
          Importar CSV
        </button>
        <button type="button" id="export-btn" onclick="exportToCSV()">
          Exportar para CSV
        </button>
        <button
          type="button"
          class="copy-btn"
          onclick="generateAndShowCSVLine()"
        >
          Copiar Linha para Excel
        </button>
        <button type="button" id="save-btn" onclick="showSummaryBeforeSave()">
          Salvar Obra
        </button>
        <button type="button" id="clear-btn" onclick="clearForm()">
          Limpar Formulário
        </button>
      </div>

      <!-- Input para importação de arquivos oculto -->
      <input type="file" id="import-file" style="display: none" accept=".csv" />
    </div>

    <!-- Modal para adicionar campo -->
    <div id="add-field-modal" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <h3>Adicionar Novo Campo</h3>
        <div class="form-row">
          <div class="form-group">
            <label for="new-field-name">Nome do Campo:</label>
            <input
              type="text"
              id="new-field-name"
              placeholder="Ex: Peso Estrutura"
            />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Tipo de Campo:</label>
            <div class="field-type-selector">
              <label>
                <input
                  type="radio"
                  name="field-type"
                  value="number-int"
                  checked
                />
                Número Inteiro
              </label>
              <label>
                <input type="radio" name="field-type" value="number-double" />
                Número Decimal
              </label>
              <label>
                <input type="radio" name="field-type" value="select" /> Seleção
              </label>
            </div>
          </div>
        </div>

        <div id="select-options" style="display: none">
          <div class="form-row">
            <div class="form-group">
              <label for="select-options-input">Opções (uma por linha):</label>
              <textarea
                id="select-options-input"
                rows="5"
                placeholder="Nenhum&#10;Opção 1&#10;Opção 2"
              ></textarea>
            </div>
          </div>
        </div>

        <input type="hidden" id="target-container" />
        <div class="actions">
          <button type="button" onclick="addCustomField()">
            Adicionar Campo
          </button>
          <button type="button" onclick="closeModal()">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal para importação -->
    <div id="import-modal" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeImportModal()">&times;</span>
        <h3>Importar Arquivo CSV</h3>
        <p>Selecione um arquivo CSV para importar:</p>
        <input type="file" id="csv-file-input" accept=".csv" />
        <div class="actions">
          <button type="button" onclick="processImportFile()">Importar</button>
          <button type="button" onclick="closeImportModal()">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal para resumo antes de salvar -->
    <div id="summary-modal" class="modal summary-modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeSummaryModal()">&times;</span>
        <h3>Resumo da Obra</h3>

        <div
          id="missing-fields-container"
          class="missing-fields-list"
          style="display: none"
        >
          <h4>Campos Obrigatórios Não Preenchidos:</h4>
          <ul id="missing-fields-list"></ul>
          <p>Por favor, preencha os campos obrigatórios antes de salvar.</p>
        </div>

        <div id="summary-content"></div>

        <div class="actions">
          <button
            type="button"
            id="confirm-save-btn"
            onclick="saveCurrentWork()"
          >
            Confirmar Salvamento
          </button>
          <button type="button" onclick="closeSummaryModal()">
            Voltar e Revisar
          </button>
        </div>
      </div>


        <button type="button" onclick="showExportLoteModal()">Exportar por Lote</button>

        <!-- Modal para exportar por lote -->
        <div id="export-lote-modal" class="modal">
          <div class="modal-content">
            <span class="close-modal" onclick="closeExportLoteModal()">&times;</span>
            <h3>Exportar Obras por Lote</h3>
            <div class="form-group">
              <label for="export-lote-select">Selecione o Lote:</label>
              <select id="export-lote-select">
                <!-- Opções serão preenchidas dinamicamente -->
              </select>
            </div>
            <div class="actions">
              <button type="button" onclick="exportLoteWorks()">Exportar</button>
              <button type="button" onclick="closeExportLoteModal()">Cancelar</button>
            </div>
          </div>
        </div>

    <script>

      var db;
      var saveReminderInterval;
      var currentWorkCode = null;


      // Versão: 1.0
// CORREÇÕES PARA ERROS DE REFERÊNCIA

// 1. Correção para validateAlaWithEncountro
// Função que estava faltando e causando erro
function validateAlaWithEncountro() {
  // Obter o valor do campo encontro
  const encontroValue = document.getElementById("encontro").value;

  // Obter os campos de ala
  const alaParalelaField = document.getElementById("ala-paralela");
  const alaPerpendicularField = document.getElementById("ala-perpendicular");

  // Obter os elementos de erro
  const alaParalelaError = document.getElementById("ala-paralela-error");
  const alaPerpendicularError = document.getElementById("ala-perpendicular-error");

  // Inicialmente remover classes de erro
  if (alaParalelaField) alaParalelaField.classList.remove("error");
  if (alaPerpendicularField) alaPerpendicularField.classList.remove("error");

  if (alaParalelaError) alaParalelaError.classList.remove("visible");
  if (alaPerpendicularError) alaPerpendicularError.classList.remove("visible");

  // Se o encontro for PAREDE FRONTAL PORTANTE, pelo menos uma ala deve estar selecionada
  if (encontroValue === "ENCONTRO - PAREDE FRONTAL PORTANTE") {
    const alaParalelaValue = alaParalelaField ? alaParalelaField.value : "";
    const alaPerpendicularValue = alaPerpendicularField ? alaPerpendicularField.value : "";

    // Verificar se pelo menos uma ala está selecionada e não é "Nenhum"
    const temAlaValida =
      (alaParalelaValue && alaParalelaValue !== "Nenhum") ||
      (alaPerpendicularValue && alaPerpendicularValue !== "Nenhum");

    if (!temAlaValida) {
      // Adicionar classe de erro a ambos os campos
      if (alaParalelaField) alaParalelaField.classList.add("error");
      if (alaPerpendicularField) alaPerpendicularField.classList.add("error");

      // Exibir mensagens de erro
      if (alaParalelaError) {
        alaParalelaError.textContent =
          "É necessário selecionar pelo menos uma ala quando o encontro é Parede Frontal Portante";
        alaParalelaError.classList.add("visible");
      }

      if (alaPerpendicularError) {
        alaPerpendicularError.textContent =
          "É necessário selecionar pelo menos uma ala quando o encontro é Parede Frontal Portante";
        alaPerpendicularError.classList.add("visible");
      }

      return false;
    }
  }

  return true;
}

// 2. Adicionar função debugLog que estava ausente (usada na consultarRodoviasDNIT)
function debugLog(message) {
  if (window.console && window.console.log) {
    console.log(message);
  }
}

// 3. Verificar se o objeto requiredFields existe antes de usá-lo no validateForm
function checkAndCreateRequiredFields() {
  // Se o objeto já existir, não fazer nada
  if (window.requiredFields) {
    return;
  }
  
  // Criar o objeto requiredFields caso ele não exista
  window.requiredFields = {
    lote: { type: "text", min: null, required: true },
    codigo: { type: "text", min: null, required: true },
    comprimento: { type: "number", min: 0, required: true },
    largura: { type: "number", min: 0, required: true },
    altura: { type: "number", min: 0, required: true },
    "qtd-tramos": { type: "number", min: 1, required: true },
    "cortina-altura": { type: "number", min: 0, required: true },
    "ala-paralela": {
      type: "text",
      required: function () {
        const encontroField = document.getElementById("encontro");
        const alaPerpendicularField = document.getElementById("ala-perpendicular");
        
        if (!encontroField || !alaPerpendicularField) return false;
        
        // Se o encontro é parede frontal portante e não tem ala perpendicular, então a paralela é obrigatória
        return (
          encontroField.value === "ENCONTRO - PAREDE FRONTAL PORTANTE" &&
          (alaPerpendicularField.value === "" || alaPerpendicularField.value === "Nenhum")
        );
      },
    },
    "ala-perpendicular": {
      type: "text",
      required: function () {
        const encontroField = document.getElementById("encontro");
        const alaParalelaField = document.getElementById("ala-paralela");
        
        if (!encontroField || !alaParalelaField) return false;
        
        // Se o encontro é parede frontal portante e não tem ala paralela, então a perpendicular é obrigatória
        return (
          encontroField.value === "ENCONTRO - PAREDE FRONTAL PORTANTE" &&
          (alaParalelaField.value === "" || alaParalelaField.value === "Nenhum")
        );
      },
    },
    "comprimento-ala": {
      type: "number",
      min: 0,
      required: function () {
        const alaParalelaField = document.getElementById("ala-paralela");
        const alaPerpendicularField = document.getElementById("ala-perpendicular");
        
        if (!alaParalelaField || !alaPerpendicularField) return false;
        
        return (
          (alaParalelaField.value !== "" && alaParalelaField.value !== "Nenhum") ||
          (alaPerpendicularField.value !== "" && alaPerpendicularField.value !== "Nenhum")
        );
      },
    },
    "espessura-ala": {
      type: "number",
      min: 0,
      required: function () {
        const alaParalelaField = document.getElementById("ala-paralela");
        const alaPerpendicularField = document.getElementById("ala-perpendicular");
        
        if (!alaParalelaField || !alaPerpendicularField) return false;
        
        return (
          (alaParalelaField.value !== "" && alaParalelaField.value !== "Nenhum") ||
          (alaPerpendicularField.value !== "" && alaPerpendicularField.value !== "Nenhum")
        );
      },
    },
    "deslocamento-esquerdo-encontro-laje": {
      type: "number",
      min: 0,
      required: function () {
        const encontroField = document.getElementById("encontro");
        return encontroField && encontroField.value === "ENCONTRO LAJE";
      },
    },
    "deslocamento-direito-encontro-laje": {
      type: "number",
      min: 0,
      required: function () {
        const encontroField = document.getElementById("encontro");
        return encontroField && encontroField.value === "ENCONTRO LAJE";
      },
    },
    "comprimento-encontro-laje": {
      type: "number",
      min: 0,
      required: function () {
        const encontroField = document.getElementById("encontro");
        return encontroField && encontroField.value === "ENCONTRO LAJE";
      },
    },
    "altura-longarina": { type: "number", min: 0, required: true },
    "deslocamento-esquerdo": { type: "number", min: 0, required: true },
    "deslocamento-direito": { type: "number", min: 0, required: true },
    "qtd-longarinas": { type: "number", min: 0, required: true },
    "espessura-longarina": { type: "number", min: 0, required: true },
    "espessura-transversina": {
      type: "number",
      min: 0,
      required: function () {
        const qtdTransversinasField = document.getElementById("qtd-transversinas");
        const qtdTransversinas = parseInt(qtdTransversinasField ? qtdTransversinasField.value : 0) || 0;
        return qtdTransversinas > 0;
      },
    },
    "espessura-laje": { type: "number", min: 0, required: true },
    "qtd-pilares": { type: "number", min: 0, required: true },
    "largura-pilar": { 
      type: "number", 
      min: 0, 
      required: function() {
        const qtdPilaresField = document.getElementById("qtd-pilares");
        const qtdPilares = parseInt(qtdPilaresField ? qtdPilaresField.value : 0) || 0;
        return qtdPilares > 0;
      } 
    },
    "comprimento-pilares": { 
      type: "number", 
      min: 0, 
      required: function() {
        const qtdPilaresField = document.getElementById("qtd-pilares");
        const qtdPilares = parseInt(qtdPilaresField ? qtdPilaresField.value : 0) || 0;
        return qtdPilares > 0;
      } 
    },
    "altura-travessa": {
      type: "number",
      min: 0,
      required: function () {
        const tipoTravessaField = document.getElementById("tipo-travessa");
        return tipoTravessaField && 
               tipoTravessaField.value !== "" && 
               tipoTravessaField.value !== "Nenhum";
      },
    },
    "altura-bloco-sapata": {
      type: "number",
      min: 0,
      required: function () {
        const tipoBlocoSapataField = document.getElementById("tipo-bloco-sapata");
        return tipoBlocoSapataField && 
               tipoBlocoSapataField.value !== "" && 
               tipoBlocoSapataField.value !== "Nenhum";
      },
    },
    "largura-bloco-sapata": {
      type: "number",
      min: 0,
      required: function () {
        const tipoBlocoSapataField = document.getElementById("tipo-bloco-sapata");
        return tipoBlocoSapataField && 
               tipoBlocoSapataField.value !== "" && 
               tipoBlocoSapataField.value !== "Nenhum";
      },
    },
    pavimento: { type: "text", required: true },
  };
  
  console.log("Objeto requiredFields criado com sucesso.");
}

// 4. Função para consultar a API do DNIT corrigida (sem a referência a debugLog)
async function consultarRodoviasDNIT(lat, lng) {
  try {
    if (!lat || !lng) {
      throw new Error("Latitude e longitude são necessárias para consulta");
    }
    
    const dataRef = new Date().toISOString().split('T')[0];
    const url = `https://servicos.dnit.gov.br/sgplan/apigeo/rotas/localizarkm?lng=${lng}&lat=${lat}&r=250&data=${dataRef}`;
    
    console.log(`Consultando DNIT: ${url}`);
    
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
      },
      mode: 'cors'
    });
    
    if (!response.ok) {
      throw new Error(`Erro na API DNIT: ${response.status}`);
    }
    
    const data = await response.json();
    console.log(`Resposta DNIT:`, data);
    
    return data;
  } catch (error) {
    console.error(`Erro ao consultar DNIT: ${error.message}`);
    return null;
  }
}

// 5. Atualização da função consultarKmDnit para usar a versão corrigida de consultarRodoviasDNIT
async function consultarKmDnit() {
  try {
    // Verificar se temos os campos de latitude e longitude
    const latInput = document.getElementById('latitude');
    const lngInput = document.getElementById('longitude');
    const kmInput = document.getElementById('km');
    const updateButton = document.getElementById('update-km-button');
    
    // Verificar se temos coordenadas para usar
    if (!latInput || !lngInput || !latInput.value || !lngInput.value) {
      alert("É necessário ter coordenadas GPS válidas para consultar o KM. Por favor, preencha os campos de Latitude e Longitude.");
      return;
    }
    
    // Obter valores das coordenadas
    const lat = parseFloat(latInput.value);
    const lng = parseFloat(lngInput.value);
    
    if (isNaN(lat) || isNaN(lng)) {
      alert("Coordenadas GPS inválidas. Por favor, verifique os valores.");
      return;
    }
    
    // Atualizar estado do botão para indicar carregamento
    const originalText = updateButton.textContent;
    updateButton.disabled = true;
    updateButton.innerHTML = 'Consultando... <span class="km-loading"></span>';
    
    // Criar ou atualizar o elemento de status
    let statusElement = document.getElementById('km-status');
    if (!statusElement) {
      statusElement = document.createElement('div');
      statusElement.id = 'km-status';
      statusElement.className = 'km-status';
      kmInput.parentNode.appendChild(statusElement);
    }
    statusElement.textContent = '';
    
    // Realizar a consulta com a função corrigida
    const resultado = await consultarRodoviasDNIT(lat, lng);
    
    // Restaurar o botão
    updateButton.disabled = false;
    updateButton.textContent = originalText;
    

  // Processar a resposta que está vindo como JSON já parseado
  const dados = resultado;
  
  if (dados && Array.isArray(dados) && dados.length > 0) {
    console.log("Dados da API DNIT recebidos:", dados);
    
    // Verificar qual BR atual está no formulário
    const rodoviaInput = document.getElementById('rodovia');
    const rodoviaAtual = rodoviaInput ? rodoviaInput.value.trim() : '';
    const brAtualMatch = rodoviaAtual.match(/BR-(\d+)/i);
    const brAtual = brAtualMatch ? brAtualMatch[1] : '';
    
    // Encontrar a melhor correspondência
    let melhorResultado = null;
    
    if (brAtual) {
      melhorResultado = dados.find(item => item.br === brAtual);
    }
    
    if (!melhorResultado) {
      melhorResultado = dados[0]; // Usar o primeiro resultado se não houver correspondência
    }
    
    // Atualizar os campos
    if (melhorResultado) {
      const km = melhorResultado.km;
      const rodovia = `BR-${melhorResultado.br}`;
      
      console.log("Atualizando UI com:", { km, rodovia });
      
      // Atualizar o campo de KM
      if (kmInput) {
        kmInput.value = parseFloat(km).toFixed(2);
        kmInput.style.borderColor = '#27ae60';
      }
      
      // Atualizar rodovia se necessário
      if (rodoviaInput && (!rodoviaAtual || confirm(`Deseja atualizar a rodovia para ${rodovia}?`))) {
        rodoviaInput.value = rodovia;
        rodoviaInput.style.borderColor = '#27ae60';
      }
      
      // Mostrar mensagem de sucesso
      statusElement.textContent = `KM atualizado para ${parseFloat(km).toFixed(2)} (${rodovia})`;
      statusElement.style.color = '#27ae60';
      
      setTimeout(() => {
        kmInput.style.borderColor = '';
        if (rodoviaInput) rodoviaInput.style.borderColor = '';
      }, 5000);
      
      return true;
    }
  } else {
    statusElement.textContent = 'Nenhum resultado encontrado na API do DNIT.';
    statusElement.style.color = '#e74c3c';
  }


  } catch (error) {
    console.error("Erro ao consultar API do DNIT:", error);
    
    // Restaurar botão
    const updateButton = document.getElementById('update-km-button');
    if (updateButton) {
      updateButton.disabled = false;
      updateButton.textContent = 'Atualizar KM via DNIT';
    }
    
    // Mostrar mensagem de erro
    let statusElement = document.getElementById('km-status');
    if (statusElement) {
      statusElement.textContent = `Erro: ${error.message}`;
      statusElement.style.color = '#e74c3c';
    } else {
      alert(`Erro ao consultar API do DNIT: ${error.message}`);
    }
    
    return false;
  }
}

// 6. Corrigir a função validateForm para verificar o objeto requiredFields
function safeValidateForm() {
  // Verificar se o objeto requiredFields existe
  if (typeof requiredFields === 'undefined' || !requiredFields) {
    checkAndCreateRequiredFields();
  }
  
  // Resto da função validateForm original
  let isValid = true;
  const missingFields = [];

  // Validar campos obrigatórios
  for (const fieldId in requiredFields) {
    const isFieldValid = validateField(fieldId);

    if (!isFieldValid) {
      isValid = false;
      const field = document.getElementById(fieldId);
      const label = document.querySelector(`label[for="${fieldId}"]`);
      missingFields.push(
        label ? label.textContent.replace(":", "") : fieldId
      );

      // Se não estiver visível, mostrar a aba correspondente
      const tabContent = field.closest(".tab-content");
      if (tabContent && !tabContent.classList.contains("active")) {
        const tabId = tabContent.id.replace("-content", "");
        document.querySelector(`.tab[data-tab="${tabId}"]`).click();
      }
    }
  }

  // Validar tramos
  const tramosValid = validateTramos();
  if (!tramosValid) {
    isValid = false;
    missingFields.push("Comprimento dos Tramos (mínimo 0.5m)");
  }

  // Validar apoios
  const apoiosValid = validateApoios();
  if (!apoiosValid) {
    isValid = false;
    missingFields.push("Altura dos Apoios");
  }

  // Validar proteção lateral (deve ter pelo menos um tipo em cada lado)
  const lateralProtectionValid = validateLateralProtection();
  if (!lateralProtectionValid) {
    isValid = false;
    missingFields.push(
      "Proteção Lateral (barreira, guarda-rodas ou calçada) em ambos os lados"
    );
  }

  // Adicionar validação das alas com o encontro
  const alaWithEncontroValid = validateAlaWithEncountro();
  if (!alaWithEncontroValid) {
    isValid = false;
    missingFields.push(
      "Ala obrigatória quando o encontro é Parede Frontal Portante"
    );
  }

  return { isValid, missingFields };
}

// 7. Inicialização e verificação de erros
(function() {
  // Verificar e criar o objeto requiredFields
  checkAndCreateRequiredFields();
  
  // Substituir a função validateForm globalmente
  if (typeof validateForm !== 'undefined') {
    window.originalValidateForm = validateForm;
    window.validateForm = safeValidateForm;
  } else {
    window.validateForm = safeValidateForm;
  }
  
  // Substituir a função consultarRodoviasDNIT globalmente
  window.consultarRodoviasDNIT = consultarRodoviasDNIT;
  
  // Garantir que validateAlaWithEncountro esteja disponível globalmente
  window.validateAlaWithEncountro = validateAlaWithEncountro;
  
  // Adicionar debugLog como função global
  window.debugLog = debugLog;
  
  console.log("Correções aplicadas com sucesso!");
})();


// Versão: 1.0


// Versão: 1.0
// ATUALIZAÇÃO DO CAMPO KM COM CONSULTA DIRETA À API DNIT

// Função para adicionar botão de atualização do KM
function addKmUpdateButton() {
  // Verificar se o campo KM existe
  const kmInput = document.getElementById('km');
  if (!kmInput) return;
  
  // Verificar se já existe um botão de atualização
  if (document.getElementById('update-km-button')) return;
  
  // Criar o contêiner para o botão
  const buttonContainer = document.createElement('div');
  buttonContainer.style.display = 'flex';
  buttonContainer.style.alignItems = 'center';
  buttonContainer.style.gap = '5px';
  
  // Criar o botão de atualização
  const updateButton = document.createElement('button');
  updateButton.id = 'update-km-button';
  updateButton.type = 'button';
  updateButton.className = 'update-km-btn';
  updateButton.textContent = 'Atualizar KM via DNIT';
  updateButton.style.fontSize = '0.8rem';
  updateButton.style.padding = '4px 8px';
  updateButton.style.backgroundColor = '#f39c12';
  updateButton.style.color = 'white';
  updateButton.style.border = 'none';
  updateButton.style.borderRadius = '4px';
  updateButton.style.cursor = 'pointer';
  updateButton.title = 'Consultar API do DNIT para atualizar o KM baseado nas coordenadas GPS';
  
  // Adicionar evento de clique
  updateButton.addEventListener('click', consultarKmDnit);
  
  // Criar um wrapper para o campo de input
  const kmWrapper = document.createElement('div');
  kmWrapper.style.flex = '1';
  
  // Mover o campo KM para o novo wrapper
  const kmParent = kmInput.parentNode;
  kmParent.removeChild(kmInput);
  kmWrapper.appendChild(kmInput);
  
  // Adicionar o wrapper e o botão ao contêiner
  buttonContainer.appendChild(kmWrapper);
  buttonContainer.appendChild(updateButton);
  
  // Adicionar o contêiner ao pai original do campo KM
  kmParent.appendChild(buttonContainer);
  
  // Adicionar estilos adicionais
  const style = document.createElement('style');
  style.textContent = `
    .update-km-btn:hover {
      background-color: #f1c40f !important;
      transform: translateY(-1px);
    }
    .km-loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: km-spin 1s ease-in-out infinite;
      margin-left: 4px;
    }
    @keyframes km-spin {
      to { transform: rotate(360deg); }
    }
    .km-status {
      font-size: 0.75rem;
      margin-top: 2px;
      color: #27ae60;
    }
  `;
  document.head.appendChild(style);
}

// Função para consultar KM no DNIT
async function consultarKmDnit() {
  try {
    // Verificar se temos os campos de latitude e longitude
    const latInput = document.getElementById('latitude');
    const lngInput = document.getElementById('longitude');
    const kmInput = document.getElementById('km');
    const updateButton = document.getElementById('update-km-button');
    
    // Verificar se temos coordenadas para usar
    if (!latInput || !lngInput || !latInput.value || !lngInput.value) {
      alert("É necessário ter coordenadas GPS válidas para consultar o KM. Por favor, preencha os campos de Latitude e Longitude.");
      return;
    }
    
    // Obter valores das coordenadas
    const lat = parseFloat(latInput.value);
    const lng = parseFloat(lngInput.value);
    
    if (isNaN(lat) || isNaN(lng)) {
      alert("Coordenadas GPS inválidas. Por favor, verifique os valores.");
      return;
    }
    
    // Atualizar estado do botão para indicar carregamento
    const originalText = updateButton.textContent;
    updateButton.disabled = true;
    updateButton.innerHTML = 'Consultando... <span class="km-loading"></span>';
    
    // Criar ou atualizar o elemento de status
    let statusElement = document.getElementById('km-status');
    if (!statusElement) {
      statusElement = document.createElement('div');
      statusElement.id = 'km-status';
      statusElement.className = 'km-status';
      kmInput.parentNode.appendChild(statusElement);
    }
    statusElement.textContent = '';
    
    // Realizar a consulta
    const resultado = await consultarRodoviasDNIT(lat, lng);
    
    // Restaurar o botão
    updateButton.disabled = false;
    updateButton.textContent = originalText;
    
    // Processar resultados
    if (resultado && resultado.features && resultado.features.length > 0) {
      // Filtrar apenas rodovias federais (BRs)
      const rodoviasFederais = resultado.features.filter(feature => 
        feature.properties.sigla_rodov && feature.properties.sigla_rodov.startsWith('BR')
      );
      
      if (rodoviasFederais.length > 0) {
        // Ordenar pelo mais próximo (menor distância)
        rodoviasFederais.sort((a, b) => 
          a.properties.distancia_m - b.properties.distancia_m
        );
        
        // Pegar o resultado mais próximo
        const melhorResultado = rodoviasFederais[0];
        const km = melhorResultado.properties.km;
        const rodovia = melhorResultado.properties.sigla_rodov;
        const distancia = melhorResultado.properties.distancia_m;
        
        // Atualizar o campo de KM
        if (kmInput) {
          kmInput.value = parseFloat(km).toFixed(2);
          kmInput.style.borderColor = '#27ae60';
          
          // Atualizar o campo de rodovia se existir
          const rodoviaInput = document.getElementById('rodovia');
          if (rodoviaInput) {
            rodoviaInput.value = rodovia;
            rodoviaInput.style.borderColor = '#27ae60';
          }
          
          // Mostrar mensagem de sucesso
          statusElement.textContent = `KM atualizado via DNIT (${distancia.toFixed(0)}m de distância)`;
          
          // Restaurar o estilo após alguns segundos
          setTimeout(() => {
            kmInput.style.borderColor = '';
            if (rodoviaInput) rodoviaInput.style.borderColor = '';
          }, 5000);
          
          return true;
        }
      } else {
        statusElement.textContent = 'Nenhuma rodovia federal encontrada próxima às coordenadas.';
        statusElement.style.color = '#e74c3c';
      }
    } else {
      statusElement.textContent = 'Nenhum resultado encontrado na API do DNIT.';
      statusElement.style.color = '#e74c3c';
    }
  } catch (error) {
    console.error("Erro ao consultar API do DNIT:", error);
    
    // Restaurar botão
    const updateButton = document.getElementById('update-km-button');
    if (updateButton) {
      updateButton.disabled = false;
      updateButton.textContent = 'Atualizar KM via DNIT';
    }
    
    // Mostrar mensagem de erro
    let statusElement = document.getElementById('km-status');
    if (statusElement) {
      statusElement.textContent = `Erro: ${error.message}`;
      statusElement.style.color = '#e74c3c';
    } else {
      alert(`Erro ao consultar API do DNIT: ${error.message}`);
    }
    
    return false;
  }
}

// Inicializar o botão quando o documento estiver pronto
document.addEventListener('DOMContentLoaded', function() {
  addKmUpdateButton();
});

// Se o documento já estiver carregado, adicionar o botão imediatamente
if (document.readyState !== 'loading') {
  addKmUpdateButton();
}



const ponteModalStyles = document.createElement('style');
ponteModalStyles.id = 'ponte-details-modal-styles';
ponteModalStyles.textContent = `
/* Estilos para o modal de detalhes da ponte */
.ponte-details-container {
  margin: 15px 0;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 10px;
  overflow: hidden;
  background: rgba(44, 62, 80, 0.7);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.ponte-header {
  background: linear-gradient(to right, rgba(52, 152, 219, 0.7), rgba(52, 73, 94, 0.7));
  padding: 12px 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.ponte-header strong {
  font-size: 1.1rem;
  color: #ffffff;
}

.ponte-header button {
  background: rgba(255, 255, 255, 0.1);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.3);
  padding: 5px 10px;
  margin-left: 8px;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 12px;
}

.ponte-header button:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: translateY(-1px);
}

.ponte-fields {
  max-height: 400px;
  overflow-y: auto;
  padding: 10px;
}

.ponte-field-row {
  display: flex;
  padding: 10px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  align-items: center;
  transition: background 0.2s ease;
}

.ponte-field-row:last-child {
  border-bottom: none;
}

.ponte-field-row:hover {
  background: rgba(255, 255, 255, 0.05);
}

.ponte-field-checkbox {
  flex: 0 0 220px;
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  font-weight: 500;
  color: #e3f2fd;
}

.ponte-field-checkbox input[type="checkbox"] {
  width: 18px;
  height: 18px;
  accent-color: #3498db;
}

.ponte-field-checkbox input[type="checkbox"]:disabled + span {
  color: rgba(255, 255, 255, 0.4);
}

.ponte-field-value {
  flex: 1;
  padding-left: 20px;
  word-break: break-word;
  font-family: monospace;
  font-size: 0.9rem;
  color: #ffffff;
  background: rgba(0, 0, 0, 0.1);
  padding: 5px 10px;
  border-radius: 4px;
  border-left: 3px solid rgba(52, 152, 219, 0.7);
}

.ponte-field-actions {
  flex: 0 0 auto;
  margin-left: 10px;
}

.ponte-field-actions button {
  background: rgba(52, 152, 219, 0.3);
  color: white;
  border: none;
  padding: 4px 8px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.8rem;
  transition: all 0.2s ease;
}

.ponte-field-actions button:hover {
  background: rgba(52, 152, 219, 0.6);
}

.work-item-actions {
  display: flex;
  gap: 5px;
}

.work-item-actions button {
  background: rgba(52, 152, 219, 0.3);
  color: white;
  border: none;
  padding: 5px 10px;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.work-item-actions button:hover {
  background: rgba(52, 152, 219, 0.6);
}

.coords-group {
  display: flex;
  gap: 10px;
  margin-top: 10px;
  padding: 10px;
  background: rgba(0, 0, 0, 0.1);
  border-radius: 8px;
}

.coords-group button {
  background: #27ae60;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.coords-group button:hover {
  background: #2ecc71;
}

.update-km-btn {
  background: #f39c12 !important;
}

.update-km-btn:hover {
  background: #f1c40f !important;
}

/* Status de carregamento */
.loading-indicator {
  display: inline-block;
  width: 18px;
  height: 18px;
  border: 3px solid rgba(255,255,255,.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s ease-in-out infinite;
  margin-left: 5px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
`;

// Adicionar os estilos ao documento apenas se ainda não existirem
if (!document.getElementById('ponte-details-modal-styles')) {
  document.head.appendChild(ponteModalStyles);
}

// PARTE 2: FUNÇÕES DO MODAL DE DETALHES DA PONTE

// Função para consultar API do DNIT para atualizar o KM
async function consultarDnitApi(latitude, longitude) {
  try {
    if (!latitude || !longitude) {
      throw new Error("Latitude e longitude são necessárias para consultar a API do DNIT");
    }
    
    // Desativar botão e mostrar carregamento
    const button = document.querySelector('.update-km-btn');
    if (button) {
      button.disabled = true;
      button.innerHTML = 'Consultando API <span class="loading-indicator"></span>';
    }
    
    const dataRef = new Date().toISOString().split('T')[0];
    const url = `https://servicos.dnit.gov.br/sgplan/apigeo/rotas/localizarkm?lng=${longitude}&lat=${latitude}&r=250&data=${dataRef}`;
    
    console.log(`Consultando API DNIT: ${url}`);
    
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Accept': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error(`Erro na API DNIT: ${response.status}`);
    }
    
    const data = await response.json();
    console.log("Resposta da API DNIT:", data);
    
    // Restaurar botão
    if (button) {
      button.disabled = false;
      button.textContent = 'Consultar DNIT';
    }
    
    // Processar resultados
    if (data && data.features && data.features.length > 0) {
      // Filtrar apenas rodovias federais (BRs)
      const rodoviasFederais = data.features.filter(feature => 
        feature.properties.sigla_rodov && feature.properties.sigla_rodov.startsWith('BR')
      );
      
      if (rodoviasFederais.length > 0) {
        // Ordenar pelo mais próximo (menor distância)
        rodoviasFederais.sort((a, b) => 
          a.properties.distancia_m - b.properties.distancia_m
        );
        
        // Pegar o resultado mais próximo
        const melhorResultado = rodoviasFederais[0];
        const km = melhorResultado.properties.km;
        const rodovia = melhorResultado.properties.sigla_rodov;
        const distancia = melhorResultado.properties.distancia_m;
        
        // Atualizar os campos no modal
        const kmField = document.querySelector('input[data-field-from="Km"]');
        if (kmField) {
          kmField.checked = true;
          const kmValueElement = kmField.closest('.ponte-field-row').querySelector('.ponte-field-value');
          if (kmValueElement) {
            kmValueElement.innerHTML = `${parseFloat(km).toFixed(2)} <small>(atualizado via DNIT)</small>`;
            kmValueElement.style.borderLeft = '3px solid #27ae60';
          }
        }
        
        // Atualizar o valor do rodovia se for BR
        const brField = document.querySelector('input[data-field-from="Br"]');
        if (brField && rodovia.startsWith('BR-')) {
          const brValueElement = brField.closest('.ponte-field-row').querySelector('.ponte-field-value');
          if (brValueElement) {
            const brNumber = rodovia.replace('BR-', '');
            brValueElement.innerHTML = `${brNumber} <small>(atualizado via DNIT)</small>`;
            brValueElement.style.borderLeft = '3px solid #27ae60';
          }
        }
        
        return {
          success: true,
          km: km,
          rodovia: rodovia,
          distancia: distancia
        };
      } else {
        alert("Nenhuma rodovia federal encontrada próxima às coordenadas informadas.");
        return { success: false };
      }
    } else {
      alert("Nenhum resultado encontrado na API do DNIT para as coordenadas informadas.");
      return { success: false };
    }
  } catch (error) {
    console.error("Erro ao consultar API do DNIT:", error);
    
    // Restaurar botão
    const button = document.querySelector('.update-km-btn');
    if (button) {
      button.disabled = false;
      button.textContent = 'Consultar DNIT';
    }
    
    alert(`Erro ao consultar API do DNIT: ${error.message}`);
    return { success: false, error: error.message };
  }
}

// Função para mostrar o modal de detalhes da ponte antes de importar
function showPonteDetailsModal(ponteId) {
  try {
    if (!db) {
      alert("Banco de dados não está disponível.");
      return;
    }
    
    const transaction = db.transaction(["pontes"], "readonly");
    const objectStore = transaction.objectStore("pontes");
    const request = objectStore.get(ponteId);
    
    request.onsuccess = function(event) {
      const ponte = event.target.result;
      
      if (!ponte) {
        alert("Ponte não encontrada.");
        return;
      }
      
      // Verificar se o modal já existe
      let modal = document.getElementById("ponte-details-modal");
      
      if (!modal) {
        // Criar o modal
        modal = document.createElement("div");
        modal.id = "ponte-details-modal";
        modal.className = "modal";
        
        document.body.appendChild(modal);
      }
      
      // Mapeamento entre campos da ponte e campos do formulário
      const fieldMappings = [
        { from: "CodigoSgo", to: "codigo", label: "Código SGO", type: "text" },
        { from: "Identificacao", to: "nome", label: "Nome da Ponte", type: "text" },
        { from: "Uf", to: "uf", label: "UF", type: "text" },
        { from: "Br", to: "rodovia", label: "Rodovia", type: "text", transform: (value) => `BR-${value}` },
        { from: "Km", to: "km", label: "Quilômetro", type: "number" },
        { from: "Comprimento", to: "comprimento", label: "Comprimento (m)", type: "number" },
        { from: "Largura", to: "largura", label: "Largura (m)", type: "number" },
        { from: "AnoConstrucao", to: null, label: "Ano de Construção", type: "text" },
        { from: "Municipio", to: null, label: "Município", type: "text" },
        { from: "Latitude", to: null, label: "Latitude", type: "number" },
        { from: "Longitude", to: null, label: "Longitude", type: "number" }
      ];
      
      // Construir conteúdo do modal
      let modalContent = `
        <div class="modal-content">
          <span class="close-modal" onclick="closePonteDetailsModal()">&times;</span>
          <h3>Confirmar importação de dados da ponte</h3>
          <p>Selecione os dados que deseja importar para o formulário:</p>
          
          <div class="ponte-details-container">
            <div class="ponte-header">
              <strong>${ponte.CodigoSgo || ""} - ${ponte.Identificacao || ""}</strong>
              <div>
                <button type="button" onclick="toggleAllFields(true)">Marcar Todos</button>
                <button type="button" onclick="toggleAllFields(false)">Desmarcar Todos</button>
              </div>
            </div>
            
            <div class="ponte-fields">`;
      
      // Adicionar cada campo com checkbox
      fieldMappings.forEach(field => {
        const value = ponte[field.from] !== undefined ? ponte[field.from] : "";
        const isDisabled = value === ""; // Desabilitar se não houver valor
        const displayValue = field.from === "Br" && value ? `${value}` : value;
        
        modalContent += `
          <div class="ponte-field-row">
            <label class="ponte-field-checkbox">
              <input type="checkbox" name="import_${field.from}" ${isDisabled ? "disabled" : "checked"} 
                data-field-from="${field.from}" data-field-to="${field.to || ""}" 
                data-field-type="${field.type}" data-has-transform="${field.transform ? 'true' : 'false'}">
              <span>${field.label}</span>
            </label>
            <div class="ponte-field-value">${displayValue}</div>`;
        
        // Adicionar botão para coordenadas
        if (field.from === "Latitude" || field.from === "Longitude") {
          modalContent += `
            <div class="ponte-field-actions">
              <button type="button" onclick="copyToClipboard('${displayValue}')">Copiar</button>
            </div>`;
        }
        
        modalContent += `</div>`;
      });
      
      // Adicionar seção para coordenadas GPS e consulta DNIT
      const hasCoords = ponte.Latitude && ponte.Longitude;
      modalContent += `
        <div class="coords-group">
          <div>
            <strong>Coordenadas GPS:</strong>
            <div>${hasCoords ? `${ponte.Latitude}, ${ponte.Longitude}` : "Não disponíveis"}</div>
          </div>`;
      
      // Adicionar botão para consultar DNIT apenas se tiver coordenadas
      if (hasCoords) {
        modalContent += `
          <div>
            <button type="button" class="update-km-btn" 
              onclick="consultarDnitApi(${ponte.Latitude}, ${ponte.Longitude})">
              Atualizar KM via DNIT
            </button>
          </div>`;
      }
      
      modalContent += `</div>`;
      
      // Adicionar campos para latitude e longitude no formulário, se não existirem
      const formFieldsNeeded = checkAndAddGeoFields();
      
      // Verificar se os campos de latitude e longitude estão disponíveis no formulário
      if (formFieldsNeeded && hasCoords) {
        modalContent += `
          <div class="ponte-field-row">
            <label class="ponte-field-checkbox">
              <input type="checkbox" name="import_coords" checked>
              <span>Importar Coordenadas GPS para o Formulário</span>
            </label>
          </div>`;
      }
      
      // Fechar containers e adicionar botões de ação
      modalContent += `
            </div>
          </div>
          
          <div class="actions">
            <button type="button" onclick="confirmImportPonte('${ponteId}')">Importar Selecionados</button>
            <button type="button" onclick="closePonteDetailsModal()">Cancelar</button>
          </div>
        </div>
      `;
      
      modal.innerHTML = modalContent;
      
      // Exibir o modal
      modal.style.display = "block";
    };
    
    request.onerror = function(event) {
      console.error("Erro ao obter ponte:", event.target.error);
      alert("Erro ao obter dados da ponte.");
    };
  } catch (error) {
    console.error("Erro ao mostrar detalhes da ponte:", error);
    alert("Erro ao mostrar detalhes da ponte: " + error.message);
  }
}

// Verificar e adicionar campos de latitude e longitude ao formulário, se necessário
function checkAndAddGeoFields() {
  const formContainer = document.getElementById("info-custom-fields");
  if (!formContainer) return false;
  
  const latField = document.getElementById("latitude");
  const lngField = document.getElementById("longitude");
  
  // Se ambos os campos já existem, não precisamos fazer nada
  if (latField && lngField) return false;
  
  // Se precisamos criar os campos de GPS
  let fieldsAdded = false;
  
  if (!latField) {
    const latFieldDiv = document.createElement("div");
    latFieldDiv.className = "form-row";
    latFieldDiv.innerHTML = `
      <div class="form-group">
        <label for="latitude">Latitude:</label>
        <input type="number" id="latitude" name="LATITUDE" step="0.000001">
      </div>
    `;
    formContainer.appendChild(latFieldDiv);
    fieldsAdded = true;
  }
  
  if (!lngField) {
    const lngFieldDiv = document.createElement("div");
    lngFieldDiv.className = "form-row";
    lngFieldDiv.innerHTML = `
      <div class="form-group">
        <label for="longitude">Longitude:</label>
        <input type="number" id="longitude" name="LONGITUDE" step="0.000001">
      </div>
    `;
    formContainer.appendChild(lngFieldDiv);
    fieldsAdded = true;
  }
  
  return fieldsAdded;
}

// Copiar valor para a área de transferência
function copyToClipboard(text) {
  navigator.clipboard.writeText(text)
    .then(() => {
      alert("Valor copiado para a área de transferência!");
    })
    .catch(err => {
      console.error('Erro ao copiar texto: ', err);
      alert("Não foi possível copiar o texto. Por favor, copie manualmente.");
    });
}

// Fechar modal de detalhes da ponte
function closePonteDetailsModal() {
  const modal = document.getElementById("ponte-details-modal");
  if (modal) {
    modal.style.display = "none";
  }
}

// Marcar/desmarcar todos os campos
function toggleAllFields(checked) {
  const checkboxes = document.querySelectorAll('#ponte-details-modal input[type="checkbox"]:not([disabled])');
  checkboxes.forEach(checkbox => {
    checkbox.checked = checked;
  });
}

// Confirmar a importação dos campos selecionados
function confirmImportPonte(ponteId) {
  try {
    if (!db) {
      alert("Banco de dados não está disponível.");
      return;
    }
    
    const transaction = db.transaction(["pontes"], "readonly");
    const objectStore = transaction.objectStore("pontes");
    const request = objectStore.get(ponteId);
    
    request.onsuccess = function(event) {
      const ponte = event.target.result;
      
      if (!ponte) {
        alert("Ponte não encontrada.");
        return;
      }
      
      // Coletar campos selecionados
      const selectedFields = document.querySelectorAll('#ponte-details-modal input[type="checkbox"]:checked');
      
      if (selectedFields.length === 0) {
        alert("Nenhum campo selecionado para importação.");
        return;
      }
      
      // Preencher os campos do formulário
      selectedFields.forEach(checkbox => {
        const fieldName = checkbox.getAttribute("name");
        
        // Tratamento especial para coordenadas GPS
        if (fieldName === "import_coords") {
          // Importar coordenadas para os campos apropriados
          const latField = document.getElementById("latitude");
          const lngField = document.getElementById("longitude");
          
          if (latField && ponte.Latitude !== undefined) {
            latField.value = ponte.Latitude;
          }
          
          if (lngField && ponte.Longitude !== undefined) {
            lngField.value = ponte.Longitude;
          }
          
          // Marcar o checkbox GPS se existir
          const gpsCheckbox = document.getElementById("gps");
          if (gpsCheckbox) {
            gpsCheckbox.checked = true;
          }
          
          return;
        }
        
        // Importação normal de campos
        const fieldFrom = checkbox.getAttribute("data-field-from");
        const fieldTo = checkbox.getAttribute("data-field-to");
        const fieldType = checkbox.getAttribute("data-field-type");
        const hasTransform = checkbox.getAttribute("data-has-transform") === "true";
        
        if (fieldTo && ponte[fieldFrom] !== undefined) {
          const field = document.getElementById(fieldTo);
          
          if (field) {
            let value = ponte[fieldFrom];
            
            // Aplicar transformação se necessário
            if (hasTransform && fieldFrom === "Br") {
              value = `BR-${value}`;
            }
            
            // Formatar de acordo com o tipo de campo
            if (fieldType === "number" && value !== "") {
              value = parseFloat(value) || 0;
            }
            
            field.value = value;
          }
        }
      });
      
      alert("Dados da ponte importados com sucesso!");
      closePonteDetailsModal();
      closeSearchPontesModal(); // Fechar também o modal de busca
    };
    
    request.onerror = function(event) {
      console.error("Erro ao obter ponte:", event.target.error);
      alert("Erro ao obter dados da ponte.");
    };
  } catch (error) {
    console.error("Erro ao importar dados da ponte:", error);
    alert("Erro ao importar dados da ponte: " + error.message);
  }
}

// PARTE 3: ATUALIZAÇÃO DA FUNÇÃO DE BUSCA DE PONTES

// Realizar busca de pontes com opção de visualizar detalhes
function performPontesSearch(isAutoBusca = false) {
  const searchTerm = document.getElementById("filter-pontes").value.trim();
  const resultsContainer = document.getElementById("pontes-results");
  const codigoAtual = isAutoBusca ? searchTerm : document.getElementById("codigo").value.trim();
  
  if (!searchTerm) {
    resultsContainer.innerHTML = '<div class="work-item">Digite um termo para buscar pontes</div>';
    return;
  }
  
  resultsContainer.innerHTML = '<div class="work-item">Buscando...</div>';
  
  searchPontesReference(searchTerm, function(results) {
    if (results.length === 0) {
      resultsContainer.innerHTML = '<div class="work-item">Nenhuma ponte encontrada</div>';
      return;
    }
    
    resultsContainer.innerHTML = '';
    
    // Verificar se alguma ponte corresponde exatamente ao código atual
    const codigoExato = results.find(ponte => ponte.CodigoSgo === codigoAtual);
    
    results.forEach(ponte => {
      const ponteItem = document.createElement("div");
      ponteItem.className = "work-item";
      
      // Destacar a ponte que corresponde ao código atual, se houver
      if (codigoAtual && ponte.CodigoSgo === codigoAtual) {
        ponteItem.classList.add("selected");
      }
      
      ponteItem.setAttribute("data-id", ponte.Id);
      
      // Adicionar mais informações úteis na exibição
      const km = ponte.Km ? parseFloat(ponte.Km).toFixed(2) : "N/A";
      const comprimento = ponte.Comprimento ? parseFloat(ponte.Comprimento).toFixed(2) + "m" : "N/A";
      const largura = ponte.Largura ? parseFloat(ponte.Largura).toFixed(2) + "m" : "N/A";
      
      ponteItem.innerHTML = `
        <div class="work-item-info">
          <div><strong>${ponte.CodigoSgo || ""}</strong> - ${ponte.Identificacao || ""}</div>
          <div class="work-item-details">
            ${ponte.Uf || ""} | BR-${ponte.Br || ""} | KM ${km} | ${comprimento} x ${largura}
          </div>
        </div>
        <div class="work-item-actions">
          <button type="button" onclick="showPonteDetailsModal('${ponte.Id}')">Usar Dados</button>
        </div>
      `;
      
      resultsContainer.appendChild(ponteItem);
    });
    
    // Se for auto-busca e encontrou uma correspondência exata, sugerir usar
    if (isAutoBusca && codigoExato) {
      if (confirm(`Encontramos a ponte "${codigoExato.Identificacao}" correspondente ao código ${codigoAtual}. Deseja ver seus detalhes?`)) {
        showPonteDetailsModal(codigoExato.Id);
      }
    }
  });
}

// PARTE 4: INICIALIZAÇÃO E CONFIGURAÇÃO 

// Função para inicializar o sistema de pontes quando o documento carregar
function initPonteSystem() {
  // Adicionar os estilos CSS
  if (!document.getElementById('ponte-details-modal-styles')) {
    document.head.appendChild(ponteModalStyles);
  }
  
  // Substituir a função usePonteData
  window.usePonteData = function(ponteId) {
    showPonteDetailsModal(ponteId);
  };
  
  console.log("Sistema de detalhes de pontes inicializado com sucesso!");
}

// Inicializar quando o documento estiver pronto
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", initPonteSystem);
} else {
  initPonteSystem();
}

      // Inicialização do IndexedDB
function initDB() {
  try {
    // Incrementar versão para 3 para adicionar a nova object store
    const request = window.indexedDB.open("OAEDatabase", 3);

    request.onerror = function (event) {
      console.error("Erro ao abrir o banco de dados:", event.target.errorCode);
      alert("Erro ao inicializar o banco de dados. Algumas funcionalidades podem não estar disponíveis.");
    };

    request.onupgradeneeded = function (event) {
      const database = event.target.result;
      const oldVersion = event.oldVersion;
      
      // Para novas instalações (banco não existe)
      if (oldVersion < 1) {
        // Criar object store para as obras
        const objectStore = database.createObjectStore("obras", {
          keyPath: "CODIGO",
        });
        objectStore.createIndex("CODIGO", "CODIGO", { unique: true });
        objectStore.createIndex("LOTE", "LOTE", { unique: false });
      } 
      // Para usuários atualizando de v1 para v2
      else if (oldVersion === 1) {
        // Adicionar o novo índice ao objectStore existente
        const objectStore = event.target.transaction.objectStore("obras");
        if (!objectStore.indexNames.contains("LOTE")) {
          objectStore.createIndex("LOTE", "LOTE", { unique: false });
        }
      }
      
      // Para usuários atualizando para v3 (adicionar pontes)
      if (oldVersion < 3) {
        // Verificar se a object store já existe
        if (!database.objectStoreNames.contains("pontes")) {
          // Criar object store para as pontes
          const pontesStore = database.createObjectStore("pontes", {
            keyPath: "Id"
          });
          // Criar índices úteis para busca
          pontesStore.createIndex("CodigoSgo", "CodigoSgo", { unique: true });
          pontesStore.createIndex("Uf", "Uf", { unique: false });
          pontesStore.createIndex("Br", "Br", { unique: false });
          pontesStore.createIndex("Identificacao", "Identificacao", { unique: false });
        }
      }
    };

    request.onsuccess = function (event) {
      db = event.target.result;
      console.log("Banco de dados inicializado com sucesso");
      loadWorksList(); // Carregar lista de obras

      // Iniciar lembretes de salvamento
      startSaveReminders();
    };
  } catch (error) {
    console.error("Erro na inicialização do banco de dados:", error);
    alert("Erro ao inicializar o banco de dados: " + error.message);
  }
}

// Função para importar CSV de pontes para referência
function importPontesReferenceCSV() {
  try {
    // Criar um input de arquivo oculto
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.csv';
    fileInput.style.display = 'none';
    document.body.appendChild(fileInput);
    
    fileInput.addEventListener('change', function() {
      if (this.files && this.files[0]) {
        const file = this.files[0];
        const reader = new FileReader();
        
        reader.onload = function(event) {
          const csvData = event.target.result;
          processPontesReferenceCSV(csvData);
        };
        
        reader.onerror = function() {
          alert("Erro ao ler o arquivo.");
        };
        
        reader.readAsText(file);
      }
      
      // Remover o input após uso
      document.body.removeChild(fileInput);
    });
    
    // Acionar o clique para abrir o seletor de arquivos
    fileInput.click();
  } catch (error) {
    console.error("Erro ao importar referência de pontes:", error);
    alert("Erro ao importar referência de pontes: " + error.message);
  }
}

// Função para processar o conteúdo do CSV de pontes para referência
function processPontesReferenceCSV(csvData) {
  try {
    // Dividir as linhas do CSV
    const lines = csvData.split('\n');
    if (lines.length < 2) {
      alert("O arquivo CSV não contém dados válidos.");
      return;
    }
    
    // Verificar o separador correto (pode ser ; ou ,)
    const separator = lines[0].includes(';') ? ';' : ',';
    
    // Obter os cabeçalhos (primeira linha)
    const headers = lines[0].split(separator).map(header => header.trim());
    
    // Verificar se os cabeçalhos esperados existem
    const requiredHeaders = ["Id", "CodigoSgo", "Identificacao", "Uf", "Br", "Km"];
    const missingHeaders = requiredHeaders.filter(header => !headers.includes(header));
    
    if (missingHeaders.length > 0) {
      alert("O arquivo CSV não contém os cabeçalhos esperados: " + missingHeaders.join(", "));
      return;
    }
    
    // Array para armazenar as pontes de referência
    const pontes = [];
    
    // Processar cada linha de dados (exceto a primeira que são os cabeçalhos)
    for (let i = 1; i < lines.length; i++) {
      if (lines[i].trim() === "") continue; // Pular linhas vazias
      
      const values = lines[i].split(separator);
      if (values.length !== headers.length) {
        console.warn(`Linha ${i + 1} tem número incorreto de campos. Tentando processar mesmo assim.`);
        continue; // Pular linhas com formato incorreto
      }
      
      // Criar um objeto para mapear os valores para os índices de cabeçalho
      const ponte = {};
      headers.forEach((header, index) => {
        if (index < values.length) {
          // Converter Km para número se possível
          if (header === "Km") {
            ponte[header] = parseFloat(values[index].replace(',', '.')) || 0;
          } else {
            ponte[header] = values[index].trim();
          }
        }
      });
      
      // Se houver um Id válido, adicionar à lista
      if (ponte.Id && ponte.Id.trim() !== "") {
        pontes.push(ponte);
      }
    }
    
    if (pontes.length > 0) {
      // Salvar as pontes no banco de dados
      savePontesReference(pontes);
    } else {
      alert("Nenhuma ponte válida encontrada no arquivo CSV.");
    }
  } catch (error) {
    console.error("Erro ao processar arquivo CSV de pontes:", error);
    alert("Erro ao processar arquivo CSV de pontes: " + error.message);
  }
}

// Função para salvar as pontes de referência no banco de dados
function savePontesReference(pontes) {
  try {
    if (!db) {
      alert("Banco de dados não está disponível.");
      return;
    }
    
    const transaction = db.transaction(["pontes"], "readwrite");
    const objectStore = transaction.objectStore("pontes");
    
    let countSuccess = 0;
    let countError = 0;
    let processed = 0;
    
    // Limpar store antes de inserir novos dados
    objectStore.clear().onsuccess = function() {
      pontes.forEach((ponte) => {
        const request = objectStore.add(ponte);
        
        request.onsuccess = function() {
          countSuccess++;
          processed++;
          checkComplete();
        };
        
        request.onerror = function(event) {
          countError++;
          processed++;
          console.error(`Erro ao salvar a ponte ${ponte.CodigoSgo}:`, event.target.error);
          checkComplete();
        };
      });
    };
    
    function checkComplete() {
      if (processed === pontes.length) {
        alert(`Importação concluída: ${countSuccess} pontes de referência importadas com sucesso, ${countError} erros.`);
      }
    }
    
    transaction.oncomplete = function() {
      console.log("Transação de importação de pontes de referência concluída.");
    };
    
    transaction.onerror = function(event) {
      console.error("Erro na transação de importação de pontes:", event.target.error);
    };
  } catch (error) {
    console.error("Erro ao salvar pontes de referência:", error);
    alert("Erro ao salvar pontes de referência: " + error.message);
  }
}

// Função para buscar pontes de referência
function searchPontesReference(searchTerm, callback) {
  try {
    if (!db) {
      alert("Banco de dados não está disponível.");
      return;
    }
    
    const transaction = db.transaction(["pontes"], "readonly");
    const objectStore = transaction.objectStore("pontes");
    const request = objectStore.getAll();
    
    request.onsuccess = function(event) {
      const pontes = event.target.result;
      
      // Filtrar pontes com base no termo de busca
      const filteredPontes = pontes.filter(ponte => 
        ponte.CodigoSgo.toLowerCase().includes(searchTerm.toLowerCase()) ||
        ponte.Identificacao.toLowerCase().includes(searchTerm.toLowerCase()) ||
        ponte.Uf.toLowerCase().includes(searchTerm.toLowerCase()) ||
        ponte.Br.toString().includes(searchTerm)
      );
      
      callback(filteredPontes);
    };
    
    request.onerror = function(event) {
      console.error("Erro ao buscar pontes:", event.target.error);
      callback([]);
    };
  } catch (error) {
    console.error("Erro ao buscar pontes de referência:", error);
    callback([]);
  }
}

// Função para mostrar modal de busca de pontes

// Função para mostrar modal de busca de pontes
function showSearchPontesModal() {
  // Verificar se já existe o modal, se não, criar
  let modal = document.getElementById("search-pontes-modal");
  
  if (!modal) {
    // Criar o modal
    modal = document.createElement("div");
    modal.id = "search-pontes-modal";
    modal.className = "modal";
    
    modal.innerHTML = `
      <div class="modal-content">
        <span class="close-modal" onclick="closeSearchPontesModal()">&times;</span>
        <h3>Buscar Pontes de Referência</h3>
        <div class="filter-container">
          <input type="text" id="filter-pontes" placeholder="Buscar ponte por código, nome, UF ou BR..." />
          <button onclick="performPontesSearch()">Buscar</button>
        </div>
        <div id="pontes-results" class="works-list" style="max-height:400px;">
          <!-- Resultados da busca serão exibidos aqui -->
          <div class="work-item">Digite um termo para buscar pontes</div>
        </div>
        <div class="actions">
          <button type="button" onclick="closeSearchPontesModal()">Fechar</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Adicionar evento para tecla Enter no campo de busca
    const searchInput = document.getElementById("filter-pontes");
    searchInput.addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        performPontesSearch();
      }
    });
  }
  
  // Exibir o modal
  modal.style.display = "block";
  
  // Verificar se já existe um código digitado
  const codigoAtual = document.getElementById("codigo").value.trim();
  if (codigoAtual) {
    // Preencher o campo de busca com o código atual
    document.getElementById("filter-pontes").value = codigoAtual;
    
    // Realizar a busca automaticamente
    performPontesSearch(true);
  }
}

// Realizar busca de pontes
function performPontesSearch(isAutoBusca = false) {
  const searchTerm = document.getElementById("filter-pontes").value.trim();
  const resultsContainer = document.getElementById("pontes-results");
  const codigoAtual = isAutoBusca ? searchTerm : document.getElementById("codigo").value.trim();
  
  if (!searchTerm) {
    resultsContainer.innerHTML = '<div class="work-item">Digite um termo para buscar pontes</div>';
    return;
  }
  
  resultsContainer.innerHTML = '<div class="work-item">Buscando...</div>';
  
  searchPontesReference(searchTerm, function(results) {
    if (results.length === 0) {
      resultsContainer.innerHTML = '<div class="work-item">Nenhuma ponte encontrada</div>';
      return;
    }
    
    resultsContainer.innerHTML = '';
    
    // Verificar se alguma ponte corresponde exatamente ao código atual
    const codigoExato = results.find(ponte => ponte.CodigoSgo === codigoAtual);
    
    results.forEach(ponte => {
      const ponteItem = document.createElement("div");
      ponteItem.className = "work-item";
      
      // Destacar a ponte que corresponde ao código atual, se houver
      if (codigoAtual && ponte.CodigoSgo === codigoAtual) {
        ponteItem.classList.add("selected");
      }
      
      ponteItem.setAttribute("data-id", ponte.Id);
      
      ponteItem.innerHTML = `
        <span>${ponte.CodigoSgo} - ${ponte.Identificacao} (${ponte.Uf} BR-${ponte.Br} KM ${ponte.Km})</span>
        <button type="button" onclick="usePonteData('${ponte.Id}')">Usar</button>
      `;
      
      resultsContainer.appendChild(ponteItem);
    });
    
    // Se for auto-busca e encontrou uma correspondência exata, sugerir usar
    if (isAutoBusca && codigoExato) {
      if (confirm(`Encontramos a ponte "${codigoExato.Identificacao}" correspondente ao código ${codigoAtual}. Deseja usar esses dados?`)) {
        usePonteData(codigoExato.Id);
      }
    }
  });
}

// Usar os dados da ponte selecionada
function usePonteData(ponteId) {
  try {
    if (!db) {
      alert("Banco de dados não está disponível.");
      return;
    }
    
    const transaction = db.transaction(["pontes"], "readonly");
    const objectStore = transaction.objectStore("pontes");
    const request = objectStore.get(ponteId);
    
    request.onsuccess = function(event) {
      const ponte = event.target.result;
      
      if (ponte) {
        // Preencher os campos do formulário com os dados da ponte
        document.getElementById("codigo").value = ponte.CodigoSgo || "";
        document.getElementById("nome").value = ponte.Identificacao || "";
        document.getElementById("uf").value = ponte.Uf || "";
        document.getElementById("rodovia").value = ponte.Br ? `BR-${ponte.Br}` : "";
        document.getElementById("km").value = ponte.Km || 0;
        // Não preencher o lote automaticamente
        
        alert("Dados da ponte importados com sucesso!");
        closeSearchPontesModal();
      } else {
        alert("Ponte não encontrada.");
      }
    };
    
    request.onerror = function(event) {
      console.error("Erro ao obter ponte:", event.target.error);
      alert("Erro ao obter dados da ponte.");
    };
  } catch (error) {
    console.error("Erro ao usar dados da ponte:", error);
    alert("Erro ao usar dados da ponte: " + error.message);
  }
}


// Fechar modal de busca de pontes
function closeSearchPontesModal() {
  const modal = document.getElementById("search-pontes-modal");
  if (modal) {
    modal.style.display = "none";
  }
}

// Realizar busca de pontes
function performPontesSearch() {
  const searchTerm = document.getElementById("filter-pontes").value.trim();
  const resultsContainer = document.getElementById("pontes-results");
  
  if (!searchTerm) {
    resultsContainer.innerHTML = '<div class="work-item">Digite um termo para buscar pontes</div>';
    return;
  }
  
  resultsContainer.innerHTML = '<div class="work-item">Buscando...</div>';
  
  searchPontesReference(searchTerm, function(results) {
    if (results.length === 0) {
      resultsContainer.innerHTML = '<div class="work-item">Nenhuma ponte encontrada</div>';
      return;
    }
    
    resultsContainer.innerHTML = '';
    
    results.forEach(ponte => {
      const ponteItem = document.createElement("div");
      ponteItem.className = "work-item";
      ponteItem.setAttribute("data-id", ponte.Id);
      
      ponteItem.innerHTML = `
        <span>${ponte.CodigoSgo} - ${ponte.Identificacao} (${ponte.Uf} BR-${ponte.Br} KM ${ponte.Km})</span>
        <button type="button" onclick="usePonteData('${ponte.Id}')">Usar</button>
      `;
      
      resultsContainer.appendChild(ponteItem);
    });
  });
}


// Função para consultar API do DNIT
async function consultarRodoviasDNIT(lat, lng) {
  try {
    const dataRef = new Date().toISOString().split('T')[0];
    const url = `https://servicos.dnit.gov.br/sgplan/apigeo/rotas/localizarkm?lng=${lng}&lat=${lat}&r=250&data=${dataRef}`;
    
    debugLog(`Consultando DNIT: ${url}`);
    
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
      },
      mode: 'cors'
    });
    
    if (!response.ok) {
      throw new Error(`Erro na API DNIT: ${response.status}`);
    }
    
    const data = await response.json();
    debugLog(`Resposta DNIT: ${JSON.stringify(data)}`);
    
    return data;
  } catch (error) {
    debugLog(`Erro ao consultar DNIT: ${error.message}`);
    return [];
  }
}


// Usar os dados da ponte selecionada
function usePonteData(ponteId) {
  try {
    if (!db) {
      alert("Banco de dados não está disponível.");
      return;
    }
    
    const transaction = db.transaction(["pontes"], "readonly");
    const objectStore = transaction.objectStore("pontes");
    const request = objectStore.get(ponteId);
    
    request.onsuccess = function(event) {
      const ponte = event.target.result;
      
      if (ponte) {
        // Preencher os campos do formulário com os dados da ponte
        document.getElementById("codigo").value = ponte.CodigoSgo || "";
        document.getElementById("nome").value = ponte.Identificacao || "";
        document.getElementById("uf").value = ponte.Uf || "";
        document.getElementById("rodovia").value = ponte.Br ? `BR-${ponte.Br}` : "";
        document.getElementById("km").value = ponte.Km || 0;
        
        alert("Dados da ponte importados com sucesso!");
        closeSearchPontesModal();
      } else {
        alert("Ponte não encontrada.");
      }
    };
    
    request.onerror = function(event) {
      console.error("Erro ao obter ponte:", event.target.error);
      alert("Erro ao obter dados da ponte.");
    };
  } catch (error) {
    console.error("Erro ao usar dados da ponte:", error);
    alert("Erro ao usar dados da ponte: " + error.message);
  }
}




      // Ativação das abas
      document.addEventListener("DOMContentLoaded", function () {
        // Inicializar banco de dados
        initDB();

        // Configurar sistema de abas
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.addEventListener("click", function () {
            // Desativar todas as abas e conteúdos
            document
              .querySelectorAll(".tab")
              .forEach((t) => t.classList.remove("active"));
            document
              .querySelectorAll(".tab-content")
              .forEach((c) => c.classList.remove("active"));

            // Ativar a aba clicada
            this.classList.add("active");

            // Ativar o conteúdo correspondente
            const contentId = this.getAttribute("data-tab") + "-content";
            const content = document.getElementById(contentId);
            if (content) {
              content.classList.add("active");
            } else {
              console.error("Conteúdo não encontrado:", contentId);
            }
          });
        });

        // Configurar abas iniciais
        const activeTab = document.querySelector(".tab.active");
        if (activeTab) {
          const contentId = activeTab.getAttribute("data-tab") + "-content";
          const content = document.getElementById(contentId);
          if (content) {
            content.classList.add("active");
          }
        }

        // Inicializar campos dinâmicos
        generateTramosFields();

        // Configurar evento para mostrar/esconder opções de select
        document
          .querySelectorAll('input[name="field-type"]')
          .forEach((radio) => {
            radio.addEventListener("change", function () {
              if (this.value === "select") {
                document.getElementById("select-options").style.display =
                  "block";
              } else {
                document.getElementById("select-options").style.display =
                  "none";
              }
            });
          });

        // Configurar mostrar/ocultar painel de obras
        document
          .getElementById("toggle-works-panel")
          .addEventListener("click", function () {
            const panel = document.getElementById("works-panel");
            if (panel.style.display === "none") {
              panel.style.display = "block";
              this.textContent = "Ocultar Obras";
            } else {
              panel.style.display = "none";
              this.textContent = "Mostrar Obras";
            }
            loadWorksList(); // Recarregar lista de obras ao abrir o painel
          });

        // Adicionar evento ao campo de filtro para permitir filtrar com Enter
        document
          .getElementById("filter-works")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              filterWorks();
            }
          });

        // Configurar mascaras e validações
        setupMasks();
        setupValidations();

        // Debug - verificar se todos os elementos de conteúdo existem
        console.log("Verificando elementos de conteúdo das abas:");
        document.querySelectorAll(".tab").forEach((tab) => {
          const tabId = tab.getAttribute("data-tab");
          const contentElement = document.getElementById(`${tabId}-content`);
          console.log(
            `Aba ${tabId}: ${contentElement ? "OK" : "NÃO ENCONTRADO"}`
          );
        });
      });

      // Configurar máscara de data
      function setupMasks() {
        const dataInput = document.getElementById("data");
        dataInput.addEventListener("input", function (e) {
          let value = e.target.value.replace(/\D/g, "");

          if (value.length > 0) {
            // Formatar como dd/mm/aaaa
            if (value.length <= 2) {
              value = value;
            } else if (value.length <= 4) {
              value = value.substring(0, 2) + "/" + value.substring(2);
            } else {
              value =
                value.substring(0, 2) +
                "/" +
                value.substring(2, 4) +
                "/" +
                value.substring(4, 8);
            }
          }

          e.target.value = value;
        });
      }



      // Configurar validações de campos
function setupValidations() {
  // Adicionar validação para campos numéricos (mínimo 0)
  document.querySelectorAll('input[type="number"]').forEach((input) => {
    // Garantir que o valor não seja negativo
    input.addEventListener("change", function () {
      const min = parseFloat(this.getAttribute("min") || 0);
      const value = parseFloat(this.value) || 0;

      if (value < min) {
        this.value = min;
      }
    });

    // Validação ao sair do campo
    input.addEventListener("blur", function () {
      validateField(this.id);
    });
  });

  // Validação para campos de texto obrigatórios
  document
    .querySelectorAll('input[type="text"][required], select[required]')
    .forEach((input) => {
      input.addEventListener("blur", function () {
        validateField(this.id);
      });
    });

  // Validações específicas para campos condicionais
  document
    .getElementById("ala-paralela")
    .addEventListener("change", function () {
      validateField("comprimento-ala");
      validateField("espessura-ala");
    });

  document
    .getElementById("ala-perpendicular")
    .addEventListener("change", function () {
      validateField("comprimento-ala");
      validateField("espessura-ala");
    });

  document
    .getElementById("encontro")
    .addEventListener("change", function () {
      validateField("deslocamento-esquerdo-encontro-laje");
      validateField("deslocamento-direito-encontro-laje");
      validateField("comprimento-encontro-laje");
    });

  document
    .getElementById("qtd-transversinas")
    .addEventListener("change", function () {
      validateField("espessura-transversina");
    });

  document
    .getElementById("tipo-travessa")
    .addEventListener("change", function () {
      validateField("altura-travessa");
    });

  document
    .getElementById("tipo-bloco-sapata")
    .addEventListener("change", function () {
      validateField("altura-bloco-sapata");
      validateField("largura-bloco-sapata");
    });

  // Validações para proteção lateral
  const lateralProtectionFields = [
    "barreira-esquerda",
    "barreira-direita",
    "guarda-rodas-esquerda",
    "guarda-rodas-direita",
    "calcada-esquerda",
    "calcada-direita",
  ];

  lateralProtectionFields.forEach((fieldId) => {
    document
      .getElementById(fieldId)
      .addEventListener("change", validateLateralProtection);
  });

  // Validação para campos dependentes da quantidade de pilares
  document.getElementById("qtd-pilares").addEventListener("change", function() {
    const qtdPilares = parseInt(this.value) || 0;
    const campoLarguraPilar = document.getElementById("largura-pilar");
    const campoComprimentoPilares = document.getElementById("comprimento-pilares");
    
    // Se não houver pilares (qtdPilares = 0)
    if (qtdPilares === 0) {
      // Desabilitar campos
      campoLarguraPilar.disabled = true;
      campoComprimentoPilares.disabled = true;
      
      // Limpar valores
      campoLarguraPilar.value = "";
      campoComprimentoPilares.value = "";
      
      // Remover validações de erro
      campoLarguraPilar.classList.remove("error");
      campoComprimentoPilares.classList.remove("error");
      
      // Remover mensagens de erro se existirem
      const larguraErro = document.getElementById("largura-pilar-error");
      const comprimentoErro = document.getElementById("comprimento-pilares-error");
      
      if (larguraErro) larguraErro.classList.remove("visible");
      if (comprimentoErro) comprimentoErro.classList.remove("visible");
    } else {
      // Habilitar campos quando houver pilares
      campoLarguraPilar.disabled = false;
      campoComprimentoPilares.disabled = false;
    }
  });
}

// Adicionar esta verificação na função document.addEventListener("DOMContentLoaded", function() {
// após a chamada para setupValidations():

// Verificar estado inicial dos campos de pilares
const qtdPilaresInicial = parseInt(document.getElementById("qtd-pilares").value) || 0;
if (qtdPilaresInicial === 0) {
  document.getElementById("largura-pilar").disabled = true;
  document.getElementById("comprimento-pilares").disabled = true;
}


        // Adicionar na função setupValidations()
        document
          .getElementById("encontro")
          .addEventListener("change", validateAlaWithEncountro);
        document
          .getElementById("ala-paralela")
          .addEventListener("change", validateAlaWithEncountro);
        document
          .getElementById("ala-perpendicular")
          .addEventListener("change", validateAlaWithEncountro);

        // Adicionar validação para campos numéricos (mínimo 0)
        document.querySelectorAll('input[type="number"]').forEach((input) => {
          // Garantir que o valor não seja negativo
          input.addEventListener("change", function () {
            const min = parseFloat(this.getAttribute("min") || 0);
            const value = parseFloat(this.value) || 0;

            if (value < min) {
              this.value = min;
            }
          });

          // Validação ao sair do campo
          input.addEventListener("blur", function () {
            validateField(this.id);
          });
        });

        // Validação para campos de texto obrigatórios
        document
          .querySelectorAll('input[type="text"][required], select[required]')
          .forEach((input) => {
            input.addEventListener("blur", function () {
              validateField(this.id);
            });
          });

        // Validações específicas para campos condicionais
        document
          .getElementById("ala-paralela")
          .addEventListener("change", function () {
            validateField("comprimento-ala");
            validateField("espessura-ala");
          });

        document
          .getElementById("ala-perpendicular")
          .addEventListener("change", function () {
            validateField("comprimento-ala");
            validateField("espessura-ala");
          });

        document
          .getElementById("encontro")
          .addEventListener("change", function () {
            validateField("deslocamento-esquerdo-encontro-laje");
            validateField("deslocamento-direito-encontro-laje");
            validateField("comprimento-encontro-laje");
          });

        document
          .getElementById("qtd-transversinas")
          .addEventListener("change", function () {
            validateField("espessura-transversina");
          });

        document
          .getElementById("tipo-travessa")
          .addEventListener("change", function () {
            validateField("altura-travessa");
          });

        document
          .getElementById("tipo-bloco-sapata")
          .addEventListener("change", function () {
            validateField("altura-bloco-sapata");
            validateField("largura-bloco-sapata");
          });

        // Validações para proteção lateral
        const lateralProtectionFields = [
          "barreira-esquerda",
          "barreira-direita",
          "guarda-rodas-esquerda",
          "guarda-rodas-direita",
          "calcada-esquerda",
          "calcada-direita",
        ];

        lateralProtectionFields.forEach((fieldId) => {
          document
            .getElementById(fieldId)
            .addEventListener("change", validateLateralProtection);
        });
      



      // Validar um campo específico
      function validateField(fieldId) {
        const field = document.getElementById(fieldId);
        const errorElement = document.getElementById(`${fieldId}-error`);

        if (!field) return true;

        // Remover classe de erro
        field.classList.remove("error");
        if (errorElement) errorElement.classList.remove("visible");

        // Verificar se o campo está nas validações obrigatórias
        if (requiredFields[fieldId]) {
          const config = requiredFields[fieldId];

          // Verificar se é realmente obrigatório (pode ser função condicional)
          const isRequired =
            typeof config.required === "function"
              ? config.required()
              : config.required;

          if (isRequired) {
            // Validar conforme o tipo
            if (config.type === "number") {
              const value = parseFloat(field.value) || 0;
              if (
                field.value === "" ||
                (config.min !== null && value < config.min)
              ) {
                field.classList.add("error");
                if (errorElement) {
                  errorElement.classList.add("visible");
                }
                return false;
              }
            } else if (config.type === "text") {
              if (!field.value.trim()) {
                field.classList.add("error");
                if (errorElement) {
                  errorElement.classList.add("visible");
                }
                return false;
              }
            }
          }
        }

        return true;
      }

      // Validar tramos
      function validateTramos() {
        const tramosFields = document.querySelectorAll(".tramo-field");
        const errorElement = document.getElementById("tramos-error");
        let valid = true;

        tramosFields.forEach((field) => {
          field.classList.remove("error");
          const value = parseFloat(field.value) || 0;
          if (value < 0.5) {
            field.classList.add("error");
            valid = false;
          }
        });

        if (!valid && errorElement) {
          errorElement.classList.add("visible");
        } else if (errorElement) {
          errorElement.classList.remove("visible");
        }

        return valid;
      }

      // Validar apoios
      function validateApoios() {
        const apoiosFields = document.querySelectorAll(".apoio-field");
        const errorElement = document.getElementById("apoios-error");
        let valid = true;

        apoiosFields.forEach((field) => {
          field.classList.remove("error");
          if (!field.value.trim()) {
            field.classList.add("error");
            valid = false;
          }
        });

        if (!valid && errorElement) {
          errorElement.classList.add("visible");
        } else if (errorElement) {
          errorElement.classList.remove("visible");
        }

        return valid;
      }

      // Modificar a função validateForm() para adicionar nova validação
      function validateForm() {
        let isValid = true;
        const missingFields = [];

        // Validar campos obrigatórios
        for (const fieldId in requiredFields) {
          const isFieldValid = validateField(fieldId);

          if (!isFieldValid) {
            isValid = false;
            const field = document.getElementById(fieldId);
            const label = document.querySelector(`label[for="${fieldId}"]`);
            missingFields.push(
              label ? label.textContent.replace(":", "") : fieldId
            );

            // Se não estiver visível, mostrar a aba correspondente
            const tabContent = field.closest(".tab-content");
            if (tabContent && !tabContent.classList.contains("active")) {
              const tabId = tabContent.id.replace("-content", "");
              document.querySelector(`.tab[data-tab="${tabId}"]`).click();
            }
          }
        }

        // Validar tramos
        const tramosValid = validateTramos();
        if (!tramosValid) {
          isValid = false;
          missingFields.push("Comprimento dos Tramos (mínimo 0.5m)");
        }

        // Validar apoios
        const apoiosValid = validateApoios();
        if (!apoiosValid) {
          isValid = false;
          missingFields.push("Altura dos Apoios");
        }

        // Validar proteção lateral (deve ter pelo menos um tipo em cada lado)
        const lateralProtectionValid = validateLateralProtection();
        if (!lateralProtectionValid) {
          isValid = false;
          missingFields.push(
            "Proteção Lateral (barreira, guarda-rodas ou calçada) em ambos os lados"
          );
        }

        // Adicionar validação das alas com o encontro
        const alaWithEncontroValid = validateAlaWithEncountro();
        if (!alaWithEncontroValid) {
          isValid = false;
          missingFields.push(
            "Ala obrigatória quando o encontro é Parede Frontal Portante"
          );
        }

        return { isValid, missingFields };
      }

      // Validar proteção lateral
      function validateLateralProtection() {
        // Verificar lado esquerdo
        const hasLeftProtection =
          (document.getElementById("barreira-esquerda").value !== "" &&
            document.getElementById("barreira-esquerda").value !== "Nenhum") ||
          (document.getElementById("guarda-rodas-esquerda").value !== "" &&
            document.getElementById("guarda-rodas-esquerda").value !==
              "Nenhum") ||
          (document.getElementById("calcada-esquerda").value !== "" &&
            document.getElementById("calcada-esquerda").value !== "Nenhum");

        // Verificar lado direito
        const hasRightProtection =
          (document.getElementById("barreira-direita").value !== "" &&
            document.getElementById("barreira-direita").value !== "Nenhum") ||
          (document.getElementById("guarda-rodas-direita").value !== "" &&
            document.getElementById("guarda-rodas-direita").value !==
              "Nenhum") ||
          (document.getElementById("calcada-direita").value !== "" &&
            document.getElementById("calcada-direita").value !== "Nenhum");

        // Destacar campos com erro se não houver proteção
        if (!hasLeftProtection) {
          document.getElementById("barreira-esquerda").classList.add("error");
          document
            .getElementById("guarda-rodas-esquerda")
            .classList.add("error");
          document.getElementById("calcada-esquerda").classList.add("error");
        } else {
          document
            .getElementById("barreira-esquerda")
            .classList.remove("error");
          document
            .getElementById("guarda-rodas-esquerda")
            .classList.remove("error");
          document.getElementById("calcada-esquerda").classList.remove("error");
        }

        if (!hasRightProtection) {
          document.getElementById("barreira-direita").classList.add("error");
          document
            .getElementById("guarda-rodas-direita")
            .classList.add("error");
          document.getElementById("calcada-direita").classList.add("error");
        } else {
          document.getElementById("barreira-direita").classList.remove("error");
          document
            .getElementById("guarda-rodas-direita")
            .classList.remove("error");
          document.getElementById("calcada-direita").classList.remove("error");
        }

        // Mostrar/ocultar mensagem de erro
        const errorMessage = document.getElementById(
          "lateral-protection-error"
        );
        if (!hasLeftProtection || !hasRightProtection) {
          errorMessage.style.display = "block";
        } else {
          errorMessage.style.display = "none";
        }

        return hasLeftProtection && hasRightProtection;
      }

      // Mostrar resumo antes de salvar
      function showSummaryBeforeSave() {
        // Validar o formulário
        const { isValid, missingFields } = validateForm();

        // Preparar o modal
        const summaryContent = document.getElementById("summary-content");
        const missingFieldsContainer = document.getElementById(
          "missing-fields-container"
        );
        const missingFieldsList = document.getElementById(
          "missing-fields-list"
        );
        const confirmSaveBtn = document.getElementById("confirm-save-btn");

        // Limpar conteúdo anterior
        summaryContent.innerHTML = "";
        missingFieldsList.innerHTML = "";

        // Coletar dados do formulário
        const formData = collectFormData();

        // Tratar campos obrigatórios não preenchidos
        if (!isValid) {
          missingFieldsContainer.style.display = "block";
          missingFields.forEach((field) => {
            const li = document.createElement("li");
            li.className = "missing-field";
            li.textContent = field;
            missingFieldsList.appendChild(li);
          });

          // Desabilitar botão de confirmar
          confirmSaveBtn.disabled = true;
        } else {
          missingFieldsContainer.style.display = "none";
          confirmSaveBtn.disabled = false;
        }

        // Gerar o resumo
        generateSummary(formData, summaryContent);

        // Exibir o modal
        document.getElementById("summary-modal").style.display = "block";
      }

      // Gerar resumo da obra
      function generateSummary(data, container) {
        // Agrupar dados por seção
        const sections = [
          {
            title: "Informações Gerais",
            fields: [
              "CODIGO",
              "NOME",
              "UF",
              "RODOVIA",
              "KM",
              "DATA",
              "ENGENHEIRO",
              "TECNICO",
              "MODELADO",
            ],
          },
          {
            title: "Configurações Gerais",
            fields: [
              "COMPRIMENTO",
              "LARGURA",
              "ALTURA",
              "QTD TRAMOS",
              "COMPRIMENTO TRAMOS",
            ],
          },
          {
            title: "Transição",
            fields: [
              "CORTINA ALTURA",
              "ALA PARALELA",
              "ALA PERPENDICULAR",
              "COMPRIMENTO ALA",
              "ESPESSURA ALA",
              "ENCONTRO",
              "DESLOCAMENTO ESQUERDO ENCONTRO LAJE",
              "DESLOCAMENTO DIREITO ENCONTRO LAJE",
              "COMPRIMENTO ENCONTRO LAJE",
              "LAJE DE TRANSIÇÃO",
            ],
          },
          {
            title: "Superestrutura",
            fields: [
              "ALTURA LONGARINA",
              "DESLOCAMENTO ESQUERDO",
              "DESLOCAMENTO DIREITO",
              "QTD LONGARINAS",
              "QTD TRANSVERSINAS",
              "ESPESSURA LONGARINA",
              "ESPESSURA TRANSVERSINA",
              "ESPESSURA LAJE",
            ],
          },
          {
            title: "Apoio",
            fields: [
              "QTD PILARES",
              "PILAR DESCENTRALIZADO",
              "LARGURA PILAR",
              "COMPRIMENTO PILARES",
              "ALTURA DO APOIO",
              "TIPO DE APARELHO DE APOIO",
              "TIPO DE TRAVESSA",
              "ALTURA TRAVESSA",
              "TIPO DE ENCAMISAMENTO",
              "TIPO DE BLOCO OU SAPATA",
              "ALTURA BLOCO OU SAPATA",
              "LARGURA BLOCO OU SAPATA",
              "VIGA DE CONTRAVENTAMENTO DE PILAR",
              "VIGA DE LIGAÇÃO DE FUNDAÇÕES",
            ],
          },
          {
            title: "Elementos Complementares",
            fields: [
              "BARREIRA ESQUERDA",
              "LARGURA BARREIRA ESQUERDA",
              "BARREIRA DIREITA",
              "LARGURA BARREIRA DIREITA",
              "CALÇADA ESQUERDA",
              "LARGURA CALÇADA ESQUERDA",
              "CALÇADA DIREITA",
              "LARGURA CALÇADA DIREITA",
              "GUARDA RODAS ESQUERDA",
              "LARGURA GUARDA RODAS ESQUERDA",
              "GUARDA RODAS DIREITA",
              "LARGURA GUARDA RODAS DIREITA",
              "PAVIMENTO",
              "QTD BUZINOTES",
            ],
          },
        ];

        // Para cada seção, criar um container
        sections.forEach((section) => {
          const sectionDiv = document.createElement("div");
          sectionDiv.className = "summary-section";

          const sectionTitle = document.createElement("h3");
          sectionTitle.textContent = section.title;
          sectionDiv.appendChild(sectionTitle);

          // Para cada campo na seção
          section.fields.forEach((field) => {
            if (data[field] !== undefined) {
              const rowDiv = document.createElement("div");
              rowDiv.className = "summary-row";

              const labelDiv = document.createElement("div");
              labelDiv.className = "summary-label";
              labelDiv.textContent = field;

              const valueDiv = document.createElement("div");
              valueDiv.className = "summary-value";
              valueDiv.textContent = data[field] || "-";

              rowDiv.appendChild(labelDiv);
              rowDiv.appendChild(valueDiv);
              sectionDiv.appendChild(rowDiv);
            }
          });

          container.appendChild(sectionDiv);
        });

        // Adicionar campos personalizados
        const customFields = Object.keys(data).filter(
          (key) => !sections.some((section) => section.fields.includes(key))
        );

        if (customFields.length > 0) {
          const customSection = document.createElement("div");
          customSection.className = "summary-section";

          const customTitle = document.createElement("h3");
          customTitle.textContent = "Campos Personalizados";
          customSection.appendChild(customTitle);

          customFields.forEach((field) => {
            const rowDiv = document.createElement("div");
            rowDiv.className = "summary-row";

            const labelDiv = document.createElement("div");
            labelDiv.className = "summary-label";
            labelDiv.textContent = field;

            const valueDiv = document.createElement("div");
            valueDiv.className = "summary-value";
            valueDiv.textContent = data[field] || "-";

            rowDiv.appendChild(labelDiv);
            rowDiv.appendChild(valueDiv);
            customSection.appendChild(rowDiv);
          });

          container.appendChild(customSection);
        }
      }

      // Fechar modal de resumo
      function closeSummaryModal() {
        document.getElementById("summary-modal").style.display = "none";
      }

      // Gerar campos dinâmicos para tramos (em pilha)
      function generateTramosFields() {
        const qtdTramos =
          parseInt(document.getElementById("qtd-tramos").value) || 1;
        const tramosContainer = document.getElementById("tramos-fields");
        tramosContainer.innerHTML = "";

        // Garantir mínimo de 1 tramo
        if (qtdTramos < 1) {
          document.getElementById("qtd-tramos").value = 1;
          return generateTramosFields();
        }

        // Gerar campos para tramos em pilha
        for (let i = 1; i <= qtdTramos; i++) {
          const div = document.createElement("div");
          div.className = "dynamic-field";
          div.innerHTML = `
                    <label for="tramo-${i}">Tramo ${i}:</label>
                    <input type="number" id="tramo-${i}" name="tramo-${i}" step="0.01" min="0.5" class="tramo-field">
                `;
          tramosContainer.appendChild(div);

          // Adicionar validação
          const input = div.querySelector("input");
          input.addEventListener("blur", validateTramos);
        }

        // Atualizar também os campos de apoios
        generateApoiosFields(qtdTramos);
      }

      // Gerar campos dinâmicos para apoios (qtdTramos - 1)
      function generateApoiosFields(qtdTramos) {
        const qtdApoios = qtdTramos > 1 ? qtdTramos - 1 : 0;
        const apoiosContainer = document.getElementById("apoios-fields");
        apoiosContainer.innerHTML = "";

        for (let i = 1; i <= qtdApoios; i++) {
          const div = document.createElement("div");
          div.className = "dynamic-field";
          div.innerHTML = `
                    <label for="apoio-${i}">Apoio ${i}:</label>
                    <input type="number" id="apoio-${i}" name="apoio-${i}" step="0.01" min="0" class="apoio-field">
                `;
          apoiosContainer.appendChild(div);

          // Adicionar validação
          const input = div.querySelector("input");
          input.addEventListener("blur", validateApoios);
        }
      }

      // Mostrar modal para adicionar campo
      function showAddField(targetContainer) {
        document.getElementById("target-container").value = targetContainer;
        document.getElementById("new-field-name").value = "";
        document.getElementById("select-options-input").value = "Nenhum";
        document.getElementById("add-field-modal").style.display = "block";
        document.querySelectorAll('input[name="field-type"]')[0].checked = true;
        document.getElementById("select-options").style.display = "none";
      }

      // Fechar modal
      function closeModal() {
        document.getElementById("add-field-modal").style.display = "none";
      }

      // Adicionar campo personalizado
      function addCustomField() {
        const fieldName = document
          .getElementById("new-field-name")
          .value.trim();
        if (!fieldName) {
          alert("Por favor, digite um nome para o campo.");
          return;
        }

        const targetContainer =
          document.getElementById("target-container").value;
        const container = document.getElementById(targetContainer);
        const fieldType = document.querySelector(
          'input[name="field-type"]:checked'
        ).value;

        // Criar div para o campo personalizado
        const customFieldDiv = document.createElement("div");
        customFieldDiv.className = "form-row";

        // Criar o campo baseado no tipo selecionado
        let fieldHtml = "";
        const fieldId =
          "custom-" + fieldName.replace(/\s+/g, "-").toLowerCase();
        const fieldNameAttr = fieldName.toUpperCase();

        if (fieldType === "select") {
          const optionsText = document.getElementById(
            "select-options-input"
          ).value;
          const options = optionsText
            .split("\n")
            .map((opt) => opt.trim())
            .filter((opt) => opt);

          const optionsHtml = options
            .map((opt) => `<option value="${opt}">${opt}</option>`)
            .join("");

          fieldHtml = `
                    <div class="form-group">
                        <label for="${fieldId}">${fieldName}:</label>
                        <select id="${fieldId}" name="${fieldNameAttr}" class="custom-field">
                            <option value="">Selecione</option>
                            ${optionsHtml}
                        </select>
                    </div>
                `;
        } else if (fieldType === "number-int") {
          fieldHtml = `
                    <div class="form-group">
                        <label for="${fieldId}">${fieldName}:</label>
                        <input type="number" id="${fieldId}" name="${fieldNameAttr}" min="0" class="custom-field">
                    </div>
                `;
        } else if (fieldType === "number-double") {
          fieldHtml = `
                    <div class="form-group">
                        <label for="${fieldId}">${fieldName}:</label>
                        <input type="number" id="${fieldId}" name="${fieldNameAttr}" step="0.01" min="0" class="custom-field">
                    </div>
                `;
        }

        customFieldDiv.innerHTML = fieldHtml;
        container.appendChild(customFieldDiv);

        // Adicionar validação para campos numéricos
        const newField = customFieldDiv.querySelector('input[type="number"]');
        if (newField) {
          newField.addEventListener("change", function () {
            const min = parseFloat(this.getAttribute("min") || 0);
            const value = parseFloat(this.value) || 0;

            if (value < min) {
              this.value = min;
            }
          });
        }

        closeModal();
      }

      // Gerar e mostrar linha CSV para copiar para Excel
      function generateAndShowCSVLine() {
        try {
          // Validar primeiro
          const { isValid, missingFields } = validateForm();
          if (!isValid) {
            alert(
              "Por favor, preencha todos os campos obrigatórios antes de gerar a linha CSV."
            );
            return;
          }

          // Validar dimensões
          if (
            !validateTramosLength() ||
            !validateHeights() ||
            !validateDisplacements()
          ) {
            return; // Interrompe a execução se qualquer validação falhar
          }

          const form = document.getElementById("oae-form");
          const formData = new FormData(form);

          // Obter colunas definidas
          const csvColumns = getCsvColumns();

          // Coletar campos personalizados
          document.querySelectorAll(".custom-field").forEach((field) => {
            const name = field.getAttribute("name");
            if (!csvColumns.includes(name)) {
              csvColumns.push(name);
            }
          });

          // Dados para a linha CSV
          const data = {};

          // Preencher com valores vazios para garantir que todos os campos existam
          csvColumns.forEach((column) => {
            data[column] = "";
          });

          // Preencher com os valores do formulário
          for (let [key, value] of formData.entries()) {
            // Ignorar campos dos tramos/apoios dinâmicos (eles são tratados separadamente)
            if (!key.startsWith("tramo-") && !key.startsWith("apoio-")) {
              data[key] = value;
            }
          }

          // Checkbox - verificar se está marcado
          if (document.getElementById("modelado").checked) {
            data["MODELADO"] = "TRUE";
          } else {
            data["MODELADO"] = "FALSE";
          }

          // Coletar valores dos tramos
          const tramosValues = [];
          const tramosFields = document.querySelectorAll(".tramo-field");
          tramosFields.forEach((field) => {
            tramosValues.push(field.value || "0.50");
          });
          data["COMPRIMENTO TRAMOS"] = tramosValues.join(";");

          // Coletar valores dos apoios
          const apoiosValues = [];
          const apoiosFields = document.querySelectorAll(".apoio-field");
          apoiosFields.forEach((field) => {
            apoiosValues.push(field.value || "0.00");
          });
          data["ALTURA DO APOIO"] = apoiosValues.join(";");

          // Gerar a linha CSV
          const csvLine = csvColumns
            .map((column) => data[column] || "")
            .join("\t");

          // Mostrar a linha para copiar
          const csvLineElement = document.getElementById("csv-line");
          csvLineElement.style.display = "block";
          csvLineElement.textContent = csvLine;

          // Selecionar o texto para facilitar a cópia
          const range = document.createRange();
          range.selectNode(csvLineElement);
          window.getSelection().removeAllRanges();
          window.getSelection().addRange(range);

          try {
            // Copiar para o clipboard
            document.execCommand("copy");
            window.getSelection().removeAllRanges();
            alert("Linha copiada para a área de transferência!");
          } catch (err) {
            console.error("Não foi possível copiar automaticamente:", err);
            alert("Selecione o texto e use Ctrl+C para copiar.");
          }
        } catch (error) {
          console.error("Erro ao gerar linha CSV:", error);
          alert("Erro ao gerar linha CSV: " + error.message);
        }
      }

      // Exportar para CSV
      function exportToCSV() {
        try {
          // Validar primeiro
          const { isValid, missingFields } = validateForm();
          if (!isValid) {
            alert(
              "Por favor, preencha todos os campos obrigatórios antes de exportar para CSV."
            );
            return;
          }

          // Validar dimensões
          if (
            !validateTramosLength() ||
            !validateHeights() ||
            !validateDisplacements()
          ) {
            return; // Interrompe a execução se qualquer validação falhar
          }
          const form = document.getElementById("oae-form");
          const formData = new FormData(form);

          // Obter colunas definidas
          const csvColumns = getCsvColumns();

          // Coletar campos personalizados
          document.querySelectorAll(".custom-field").forEach((field) => {
            const name = field.getAttribute("name");
            if (!csvColumns.includes(name)) {
              csvColumns.push(name);
            }
          });

          // Coletar todos os campos padrão
          const data = {};
          // Inicializar com valores vazios
          csvColumns.forEach((column) => {
            data[column] = "";
          });

          for (let [key, value] of formData.entries()) {
            // Ignorar campos dos tramos/apoios dinâmicos (eles são tratados separadamente)
            if (!key.startsWith("tramo-") && !key.startsWith("apoio-")) {
              data[key] = value;
            }
          }

          // Checkbox - verificar se está marcado
          if (document.getElementById("modelado").checked) {
            data["MODELADO"] = "TRUE";
          } else {
            data["MODELADO"] = "FALSE";
          }

          // Coletar valores dos tramos
          const tramosValues = [];
          const tramosFields = document.querySelectorAll(".tramo-field");
          tramosFields.forEach((field) => {
            tramosValues.push(field.value || "0.50");
          });
          data["COMPRIMENTO TRAMOS"] = tramosValues.join(";");

          // Coletar valores dos apoios
          const apoiosValues = [];
          const apoiosFields = document.querySelectorAll(".apoio-field");
          apoiosFields.forEach((field) => {
            apoiosValues.push(field.value || "0.00");
          });
          data["ALTURA DO APOIO"] = apoiosValues.join(";");

          // Construir cabeçalhos e linha de dados
          const csvContent =
            csvColumns.join(",") +
            "\n" +
            csvColumns
              .map((column) => {
                // Valores com vírgula devem ser envolvidos em aspas duplas
                const value = data[column] || "";
                return value && value.includes(",") ? `"${value}"` : value;
              })
              .join(",");

          // Criar e baixar o arquivo CSV
          const blob = new Blob([csvContent], {
            type: "text/csv;charset=utf-8;",
          });
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.setAttribute("href", url);
          link.setAttribute(
            "download",
            `OAE_${data["CODIGO"] || "nova"}_${
              new Date().toISOString().split("T")[0]
            }.csv`
          );
          link.style.display = "none";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        } catch (error) {
          console.error("Erro ao exportar CSV:", error);
          alert("Erro ao exportar CSV: " + error.message);
        }
      }

      // Mostrar modal de importação
      function showImportModal() {
        document.getElementById("import-modal").style.display = "block";
      }

      // Fechar modal de importação
      function closeImportModal() {
        document.getElementById("import-modal").style.display = "none";
      }

      // Processar arquivo de importação
      function processImportFile() {
        try {
          const fileInput = document.getElementById("csv-file-input");
          const file = fileInput.files[0];

          if (!file) {
            alert("Por favor, selecione um arquivo CSV para importar.");
            return;
          }

          const reader = new FileReader();
          reader.readAsText(file);

          reader.onload = function (event) {
            const csvData = event.target.result;
            const lines = csvData.split("\n");

            if (lines.length < 2) {
              alert("O arquivo CSV não contém dados válidos.");
              return;
            }

            // Primeira linha contém os cabeçalhos
            const headers = lines[0].split(",").map((header) => header.trim());

            // Verificar se o arquivo tem várias obras (mais de uma linha de dados)
            if (lines.length > 2) {
              const works = [];

              // Processar cada linha (exceto a primeira que são os cabeçalhos)
              for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === "") continue; // Pular linhas vazias

                const values = parseCSVLine(lines[i]);
                if (values.length !== headers.length) {
                  console.warn(
                    `Linha ${i + 1} tem número incorreto de campos (${
                      values.length
                    } vs ${headers.length}). Tentando importar mesmo assim.`
                  );
                }

                const workData = {};

                // Mapear valores para cabeçalhos
                for (let j = 0; j < headers.length; j++) {
                  if (j < values.length) {
                    workData[headers[j]] = values[j];
                  }
                }

                // Verificar se há um código válido
                if (workData["CODIGO"] && workData["CODIGO"].trim() !== "") {
                  works.push(workData);
                }
              }

              if (works.length > 0) {
                // Perguntar se o usuário quer salvar todas as obras no banco de dados
                if (
                  confirm(
                    `O arquivo contém ${works.length} obras. Deseja importar todas para o banco de dados?`
                  )
                ) {
                  saveMultipleWorks(works);
                }
              } else {
                alert("Nenhuma obra válida encontrada no arquivo CSV.");
              }
            } else {
              // Apenas uma obra, carregar no formulário atual
              const values = parseCSVLine(lines[1]);
              loadCSVDataToForm(headers, values);
            }

            closeImportModal();
          };

          reader.onerror = function () {
            alert("Erro ao ler o arquivo.");
          };
        } catch (error) {
          console.error("Erro ao processar arquivo:", error);
          alert("Erro ao processar arquivo: " + error.message);
        }
      }

      // Função auxiliar para analisar uma linha CSV (lidando com valores entre aspas)
      function parseCSVLine(line) {
        const values = [];
        let currentValue = "";
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
          const char = line[i];

          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === "," && !inQuotes) {
            values.push(currentValue);
            currentValue = "";
          } else {
            currentValue += char;
          }
        }

        // Não esquecer do último valor
        values.push(currentValue);

        return values;
      }

      // Carregar dados do CSV para o formulário
      function loadCSVDataToForm(headers, values) {
        try {
          clearForm(); // Limpar o formulário antes

          // Mapear valores para os campos do formulário
          for (let i = 0; i < headers.length; i++) {
            const header = headers[i];
            if (i < values.length) {
              const value = values[i];

              // Tratar campos especiais
              if (header === "MODELADO") {
                document.getElementById("modelado").checked =
                  value.toLowerCase() === "true";
              } else if (header === "COMPRIMENTO TRAMOS") {
                const tramos = value.split(";");
                document.getElementById("qtd-tramos").value = tramos.length;
                generateTramosFields(); // Regenerar campos de tramos

                // Preencher valores dos tramos
                const tramosFields = document.querySelectorAll(".tramo-field");
                for (let j = 0; j < tramosFields.length; j++) {
                  if (j < tramos.length) {
                    tramosFields[j].value = tramos[j];
                  }
                }
              } else if (header === "ALTURA DO APOIO") {
                const apoios = value.split(";");
                // Não precisamos definir o número de apoios, pois isso é calculado com base nos tramos

                // Preencher valores dos apoios
                const apoiosFields = document.querySelectorAll(".apoio-field");
                for (let j = 0; j < apoiosFields.length; j++) {
                  if (j < apoios.length) {
                    apoiosFields[j].value = apoios[j];
                  }
                }
              } else {
                // Outros campos
                const field = document.querySelector(`[name="${header}"]`);
                if (field) {
                  field.value = value;
                }
              }
            }
          }

          // Definir o código atual
          const codigoField = document.getElementById("codigo");
          if (codigoField.value) {
            currentWorkCode = codigoField.value;
          }

          // Executar validação após carregar
          validateForm();
        } catch (error) {
          console.error("Erro ao carregar dados do CSV:", error);
          alert("Erro ao carregar dados do CSV: " + error.message);
        }
      }

      // Salvar a obra atual no banco de dados
      function saveCurrentWork() {
        try {
          // Validar o formulário
          const { isValid, missingFields } = validateForm();
          if (!isValid) {
            alert(
              "Por favor, preencha todos os campos obrigatórios antes de salvar."
            );
            return;
          }

          // Validar dimensões
          if (
            !validateTramosLength() ||
            !validateHeights() ||
            !validateDisplacements()
          ) {
            return; // Interrompe a execução se qualquer validação falhar
          }
          const codigo = document.getElementById("codigo").value.trim();

          if (!codigo) {
            alert("Por favor, preencha o campo Código antes de salvar.");
            return;
          }

          const formData = collectFormData();

          if (db) {
            const transaction = db.transaction(["obras"], "readwrite");
            const objectStore = transaction.objectStore("obras");

            const request = objectStore.put(formData);

            request.onsuccess = function (event) {
              alert(`Obra ${codigo} salva com sucesso!`);
              currentWorkCode = codigo;
              loadWorksList(); // Recarregar a lista de obras
              closeSummaryModal(); // Fechar o modal de resumo se estiver aberto
            };

            request.onerror = function (event) {
              console.error("Erro ao salvar a obra:", event.target.error);
              alert(`Erro ao salvar a obra: ${event.target.error}`);
            };
          } else {
            alert("Banco de dados não está disponível.");
          }
        } catch (error) {
          console.error("Erro ao salvar obra:", error);
          alert("Erro ao salvar obra: " + error.message);
        }
      }

      // Salvar múltiplas obras no banco de dados
      function saveMultipleWorks(works) {
        try {
          if (!db) {
            alert("Banco de dados não está disponível.");
            return;
          }

          const transaction = db.transaction(["obras"], "readwrite");
          const objectStore = transaction.objectStore("obras");

          let countSuccess = 0;
          let countError = 0;

          works.forEach((work) => {
            const request = objectStore.put(work);

            request.onsuccess = function () {
              countSuccess++;
              if (countSuccess + countError === works.length) {
                alert(
                  `Importação concluída: ${countSuccess} obras importadas com sucesso, ${countError} erros.`
                );
                loadWorksList(); // Recarregar a lista de obras
              }
            };

            request.onerror = function (event) {
              countError++;
              console.error(
                `Erro ao salvar a obra ${work.CODIGO}:`,
                event.target.error
              );
              if (countSuccess + countError === works.length) {
                alert(
                  `Importação concluída: ${countSuccess} obras importadas com sucesso, ${countError} erros.`
                );
                loadWorksList(); // Recarregar a lista de obras
              }
            };
          });
        } catch (error) {
          console.error("Erro ao salvar múltiplas obras:", error);
          alert("Erro ao salvar múltiplas obras: " + error.message);
        }
      }

      // Coletar todos os dados do formulário
      function collectFormData() {
        try {
          const form = document.getElementById("oae-form");
          const formData = new FormData(form);

          // Objeto para armazenar os dados
          const data = {};

          // Processar campos comuns
          for (let [key, value] of formData.entries()) {
            // Ignorar campos dos tramos/apoios dinâmicos (eles são tratados separadamente)
            if (!key.startsWith("tramo-") && !key.startsWith("apoio-")) {
              data[key] = value;
            }
          }

          // Verificar se o modelado está marcado
          if (document.getElementById("modelado").checked) {
            data["MODELADO"] = "TRUE";
          } else {
            data["MODELADO"] = "FALSE";
          }


          if (document.getElementById("gps").checked) {
  data["GPS"] = "TRUE";
} else {
  data["GPS"] = "FALSE";
}


          // Coletar valores dos tramos
          const tramosValues = [];
          const tramosFields = document.querySelectorAll(".tramo-field");
          tramosFields.forEach((field) => {
            // Garantir valor mínimo de 0.5
            const value = parseFloat(field.value) || 0;
            tramosValues.push(value < 0.5 ? "0.50" : field.value);
          });
          data["COMPRIMENTO TRAMOS"] = tramosValues.join(";");

          // Coletar valores dos apoios
          const apoiosValues = [];
          const apoiosFields = document.querySelectorAll(".apoio-field");
          apoiosFields.forEach((field) => {
            apoiosValues.push(field.value || "0.00");
          });
          data["ALTURA DO APOIO"] = apoiosValues.join(";");

          return data;
        } catch (error) {
          console.error("Erro ao coletar dados do formulário:", error);
          alert("Erro ao coletar dados do formulário: " + error.message);
          return {};
        }
      }

      // Carregar obra específica do banco de dados
      function loadWork(codigo) {
        try {
          if (!db) {
            alert("Banco de dados não está disponível.");
            return;
          }

          const transaction = db.transaction(["obras"], "readonly");
          const objectStore = transaction.objectStore("obras");
          const request = objectStore.get(codigo);

          request.onsuccess = function (event) {
            const work = event.target.result;

            if (work) {
              loadWorkToForm(work);
              currentWorkCode = codigo;

              // Marcar a obra como selecionada na lista
              const workItems = document.querySelectorAll(".work-item");
              workItems.forEach((item) => {
                if (item.getAttribute("data-code") === codigo) {
                  item.classList.add("selected");
                } else {
                  item.classList.remove("selected");
                }
              });
            } else {
              alert(`Obra com código ${codigo} não encontrada.`);
            }
          };

          request.onerror = function (event) {
            console.error("Erro ao carregar a obra:", event.target.error);
            alert(`Erro ao carregar a obra: ${event.target.error}`);
          };
        } catch (error) {
          console.error("Erro ao carregar obra:", error);
          alert("Erro ao carregar obra: " + error.message);
        }
      }

      // Carregar dados de uma obra para o formulário
      function loadWorkToForm(work) {
        try {
          clearForm(); // Limpar o formulário antes

          // Processar campos especiais
          if (work["MODELADO"] === "TRUE") {
            document.getElementById("modelado").checked = true;
          } else {
            document.getElementById("modelado").checked = false;
          }

          if (work["COMPRIMENTO TRAMOS"]) {
            const tramos = work["COMPRIMENTO TRAMOS"].split(";");
            document.getElementById("qtd-tramos").value = tramos.length;
            generateTramosFields(); // Regenerar campos de tramos

            // Preencher valores dos tramos
            const tramosFields = document.querySelectorAll(".tramo-field");
            for (let i = 0; i < tramosFields.length; i++) {
              if (i < tramos.length) {
                tramosFields[i].value = tramos[i];
              }
            }
          }

          if (work["ALTURA DO APOIO"]) {
            const apoios = work["ALTURA DO APOIO"].split(";");

            // Preencher valores dos apoios
            const apoiosFields = document.querySelectorAll(".apoio-field");
            for (let i = 0; i < apoiosFields.length; i++) {
              if (i < apoios.length) {
                apoiosFields[i].value = apoios[i];
              }
            }
          }

          // Processar outros campos
          for (const [key, value] of Object.entries(work)) {
            if (
              key !== "MODELADO" &&
              key !== "COMPRIMENTO TRAMOS" &&
              key !== "ALTURA DO APOIO"
            ) {
              const field = document.querySelector(`[name="${key}"]`);
              if (field) {
                field.value = value;
              }
            }
          }

          // Executar validação após carregar
          validateForm();
        } catch (error) {
          console.error("Erro ao carregar dados no formulário:", error);
          alert("Erro ao carregar dados no formulário: " + error.message);
        }
      }

      // Carregar lista de obras do banco de dados
function loadWorksList() {
  try {
    if (!db) {
      console.warn("Banco de dados não está disponível.");
      return;
    }

    const worksList = document.getElementById("works-list");
    worksList.innerHTML = '<div class="work-item">Carregando...</div>';

    const transaction = db.transaction(["obras"], "readonly");
    const objectStore = transaction.objectStore("obras");
    const request = objectStore.getAll();

    request.onsuccess = function (event) {
      const works = event.target.result;

      if (works.length === 0) {
              worksList.innerHTML =
                '<div class="work-item">Nenhuma obra cadastrada</div>';
      } else {
        worksList.innerHTML = "";

        works.forEach((work) => {
          const workItem = document.createElement("div");
          workItem.className = "work-item";
          if (work.CODIGO === currentWorkCode) {
            workItem.classList.add("selected");
          }
          workItem.setAttribute("data-code", work.CODIGO);
          workItem.setAttribute("data-lote", work.LOTE || "");

          workItem.innerHTML = `
            <span>${work.CODIGO} - Lote: ${work.LOTE || "N/A"} - ${
              work.NOME || "Sem nome"
            }</span>
            <button type="button" class="delete-btn" onclick="deleteWork('${
            work.CODIGO
            }', event)">Excluir</button>
          `;

          workItem.addEventListener("click", function (e) {
            if (!e.target.classList.contains("delete-btn")) {
              loadWork(work.CODIGO);
            }
          });

          worksList.appendChild(workItem);
        });
      }
    };

    request.onerror = function (event) {
      console.error(
        "Erro ao carregar a lista de obras:", 
        event.target.error
        );
      worksList.innerHTML = 
      '<div class="work-item">Erro ao carregar obras</div>';
    };
  } catch (error) {
    console.error("Erro ao carregar lista de obras:", error);
    alert("Erro ao carregar lista de obras: " + error.message);
  }
}

      // Filtrar obras por código
     // Filtrar obras por código e/ou lote
function filterWorks() {
  try {
    const filterText = document.getElementById("filter-works").value.trim().toLowerCase();
    const filterLote = document.getElementById("filter-lote").value.trim().toLowerCase();

    if (!db) {
      alert("Banco de dados não está disponível.");
      return;
    }

    const worksList = document.getElementById("works-list");
    worksList.innerHTML = '<div class="work-item">Filtrando...</div>';

    const transaction = db.transaction(["obras"], "readonly");
    const objectStore = transaction.objectStore("obras");
    const request = objectStore.getAll();

    request.onsuccess = function (event) {
      const works = event.target.result;
      let filteredWorks = works;
      
      // Filtrar por código e nome
      if (filterText) {
        filteredWorks = filteredWorks.filter(
          (work) =>
            (work.CODIGO && work.CODIGO.toLowerCase().includes(filterText)) ||
            (work.NOME && work.NOME.toLowerCase().includes(filterText))
        );
      }
      
      // Filtrar por lote
      if (filterLote) {
        filteredWorks = filteredWorks.filter(
          (work) => 
            work.LOTE && work.LOTE.toLowerCase().includes(filterLote)
        );
      }

      if (filteredWorks.length === 0) {
        worksList.innerHTML = '<div class="work-item">Nenhuma obra encontrada</div>';
      } else {
        worksList.innerHTML = "";

        filteredWorks.forEach((work) => {
          const workItem = document.createElement("div");
          workItem.className = "work-item";
          if (work.CODIGO === currentWorkCode) {
            workItem.classList.add("selected");
          }
          workItem.setAttribute("data-code", work.CODIGO);
          workItem.setAttribute("data-lote", work.LOTE || "");

          workItem.innerHTML = `
            <span>${work.CODIGO} - Lote: ${work.LOTE || "N/A"} - ${work.NOME || "Sem nome"}</span>
            <button type="button" class="delete-btn" onclick="deleteWork('${work.CODIGO}', event)">Excluir</button>
          `;

          workItem.addEventListener("click", function (e) {
            if (!e.target.classList.contains("delete-btn")) {
              loadWork(work.CODIGO);
            }
          });

          worksList.appendChild(workItem);
        });
      }
    };

    request.onerror = function (event) {
      console.error("Erro ao filtrar obras:", event.target.error);
      worksList.innerHTML = '<div class="work-item">Erro ao filtrar obras</div>';
    };
  } catch (error) {
    console.error("Erro ao filtrar obras:", error);
    alert("Erro ao filtrar obras: " + error.message);
  }
}
    

      // Exportar todas as obras para CSV
function exportAllWorks() {
  try {
    if (!db) {
      alert("Banco de dados não está disponível.");
      return;
    }

    const transaction = db.transaction(["obras"], "readonly");
    const objectStore = transaction.objectStore("obras");
    const request = objectStore.getAll();

    request.onsuccess = function (event) {
      const works = event.target.result;

      if (works.length === 0) {
        alert("Não há obras para exportar.");
        return;
      }

      // Obter colunas definidas
      const csvColumns = getCsvColumns();

      // Verificar campos personalizados em todas as obras
      works.forEach((work) => {
        Object.keys(work).forEach((field) => {
          if (!csvColumns.includes(field)) {
            csvColumns.push(field);
          }
        });
      });

      // Correção: Inicializar a variável csvContent
      let csvContent = csvColumns.join("\t") + "\n";

      works.forEach((work) => {
        const row = csvColumns.map((column) => {
          const value = work[column] || "";
          // Valores com tabs devem ser envolvidos em aspas duplas
          return value && value.includes("\t") ? `"${value}"` : value;
        });

        csvContent += row.join("\t") + "\n";
      });

      // Criar e baixar o arquivo CSV
      const blob = new Blob([csvContent], {
        type: "text/csv;charset=utf-8;",
      });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute(
        "download",
        `Todas_OAEs_${new Date().toISOString().split("T")[0]}.csv`
      );
      link.style.display = "none";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    request.onerror = function (event) {
      console.error("Erro ao exportar obras:", event.target.error);
      alert(`Erro ao exportar obras: ${event.target.error}`);
    };
  } catch (error) {
    console.error("Erro ao exportar todas as obras:", error);
    alert("Erro ao exportar todas as obras: " + error.message);
  }
}

      // Excluir uma obra do banco de dados
      function deleteWork(codigo, event) {
        try {
          event.stopPropagation(); // Evitar que o clique propague para o elemento pai

          if (confirm(`Tem certeza que deseja excluir a obra ${codigo}?`)) {
            if (!db) {
              alert("Banco de dados não está disponível.");
              return;
            }

            const transaction = db.transaction(["obras"], "readwrite");
            const objectStore = transaction.objectStore("obras");
            const request = objectStore.delete(codigo);

            request.onsuccess = function () {
              alert(`Obra ${codigo} excluída com sucesso.`);

              // Se a obra excluída for a atual, limpar o formulário
              if (codigo === currentWorkCode) {
                clearForm();
                currentWorkCode = null;
              }

              loadWorksList(); // Recarregar a lista de obras
            };

            request.onerror = function (event) {
              console.error("Erro ao excluir a obra:", event.target.error);
              alert(`Erro ao excluir a obra: ${event.target.error}`);
            };
          }
        } catch (error) {
          console.error("Erro ao excluir obra:", error);
          alert("Erro ao excluir obra: " + error.message);
        }
      }

      // Limpar todo o banco de dados
      function clearDatabase() {
        try {
          if (
            confirm(
              "Tem certeza que deseja limpar todas as obras do banco de dados? Esta ação não pode ser desfeita!"
            )
          ) {
            if (!db) {
              alert("Banco de dados não está disponível.");
              return;
            }

            const transaction = db.transaction(["obras"], "readwrite");
            const objectStore = transaction.objectStore("obras");
            const request = objectStore.clear();

            request.onsuccess = function () {
              alert("Banco de dados limpo com sucesso.");
              clearForm();
              currentWorkCode = null;
              loadWorksList(); // Recarregar a lista de obras
            };

            request.onerror = function (event) {
              console.error(
                "Erro ao limpar o banco de dados:",
                event.target.error
              );
              alert(`Erro ao limpar o banco de dados: ${event.target.error}`);
            };
          }
        } catch (error) {
          console.error("Erro ao limpar banco de dados:", error);
          alert("Erro ao limpar banco de dados: " + error.message);
        }
      }

      // Criar nova obra
      function createNewWork() {
        clearForm();
        currentWorkCode = null;

        // Remover a seleção de todas as obras na lista
        const workItems = document.querySelectorAll(".work-item");
        workItems.forEach((item) => {
          item.classList.remove("selected");
        });
      }

      // Mostrar lembrete para salvar dados
      function showSaveReminder() {
        try {
          const reminder = document.getElementById("save-reminder");
          reminder.style.display = "block";

          // Ocultar o lembrete após 5 segundos
          setTimeout(function () {
            reminder.style.display = "none";
          }, 5000);
        } catch (error) {
          console.error("Erro ao mostrar lembrete:", error);
        }
      }

      // Iniciar lembretes periódicos para salvar dados
      function startSaveReminders() {
        try {
          // Mostrar lembrete a cada 5 minutos
          saveReminderInterval = setInterval(showSaveReminder, 5 * 60 * 1000);
        } catch (error) {
          console.error("Erro ao iniciar lembretes:", error);
        }
      }

      // Limpar formulário
      function clearForm() {
        try {
          document.getElementById("oae-form").reset();
          document.getElementById("csv-line").style.display = "none";

          // Limpar mensagens de erro
          document.querySelectorAll(".error").forEach((el) => {
            el.classList.remove("error");
          });

          document.querySelectorAll(".error-message").forEach((el) => {
            el.classList.remove("visible");
          });

          // Ocultar mensagem de erro de proteção lateral
          document.getElementById("lateral-protection-error").style.display =
            "none";

          generateTramosFields(); // Regenerar os campos dinâmicos
        } catch (error) {
          console.error("Erro ao limpar formulário:", error);
          alert("Erro ao limpar formulário: " + error.message);
        }
      }

      // Importar múltiplas obras (processar arquivo)
      function importMultipleWorks() {
        document.getElementById("csv-file-input").click();
      }

      // Mostrar o modal de importação de múltiplas obras
      function showImportModal() {
        document.getElementById("csv-file-input").value = "";
        document.getElementById("import-modal").style.display = "block";
      }

      // Validar comprimento dos tramos em relação ao comprimento total
      function validateTramosLength() {
        const comprimentoTotal =
          parseFloat(document.getElementById("comprimento").value) || 0;

        // Somar comprimentos dos tramos
        let somaTramos = 0;
        const tramosFields = document.querySelectorAll(".tramo-field");
        tramosFields.forEach((field) => {
          somaTramos += parseFloat(field.value) || 0;
        });

        // Verificar se a soma dos tramos excede o comprimento total
        if (somaTramos > comprimentoTotal) {
          // Destacar os campos com problema
          document.getElementById("comprimento").classList.add("error");
          tramosFields.forEach((field) => field.classList.add("error"));

          // Mostrar mensagem de erro
          alert(
            `O comprimento total dos tramos (${somaTramos.toFixed(
              2
            )}m) não pode exceder o comprimento da estrutura (${comprimentoTotal.toFixed(
              2
            )}m).`
          );
          return false;
        }

        // Remover destaque de erro se estiver tudo certo
        document.getElementById("comprimento").classList.remove("error");
        tramosFields.forEach((field) => field.classList.remove("error"));
        return true;
      }

      // Atualizar evento do input de arquivo
      document.addEventListener("DOMContentLoaded", function () {
        const fileInput = document.getElementById("csv-file-input");
        if (fileInput) {
          fileInput.addEventListener("change", function () {
            if (this.files.length > 0) {
              processImportFile();
            }
          });
        }
      });

      // Validar relação entre altura da longarina e altura do apoio
      function validateHeights() {
        const alturaTotal =
          parseFloat(document.getElementById("altura").value) || 0;
        const alturaLongarina =
          parseFloat(document.getElementById("altura-longarina").value) || 0;

        // Obter as alturas dos apoios (pode haver múltiplos)
        const apoiosFields = document.querySelectorAll(".apoio-field");
        let alturaMaxApoio = 0;

        // Encontrar a altura máxima dos apoios
        apoiosFields.forEach((field) => {
          const alturaApoio = parseFloat(field.value) || 0;
          if (alturaApoio > alturaMaxApoio) {
            alturaMaxApoio = alturaApoio;
          }
        });

        // Calcular soma
        const somaAlturas = alturaLongarina + alturaMaxApoio;

        // Verificar se a soma excede a altura total
        if (somaAlturas > alturaTotal) {
          // Destacar campos com problema
          document.getElementById("altura").classList.add("error");
          document.getElementById("altura-longarina").classList.add("error");
          apoiosFields.forEach((field) => field.classList.add("error"));

          // Mostrar mensagem de erro
          alert(
            `A soma da altura da longarina (${alturaLongarina.toFixed(
              2
            )}m) e do apoio (${alturaMaxApoio.toFixed(
              2
            )}m) não pode exceder a altura total da estrutura (${alturaTotal.toFixed(
              2
            )}m).`
          );
          return false;
        }

        // Remover destaque de erro se estiver tudo certo
        document.getElementById("altura").classList.remove("error");
        document.getElementById("altura-longarina").classList.remove("error");
        apoiosFields.forEach((field) => field.classList.remove("error"));
        return true;
      }

      // Validar relação entre deslocamentos e largura
      function validateDisplacements() {
        const larguraTotal =
          parseFloat(document.getElementById("largura").value) || 0;
        const deslocamentoEsquerdo =
          parseFloat(document.getElementById("deslocamento-esquerdo").value) ||
          0;
        const deslocamentoDireito =
          parseFloat(document.getElementById("deslocamento-direito").value) ||
          0;

        // Calcular soma dos deslocamentos
        const somaDeslocamentos = deslocamentoEsquerdo + deslocamentoDireito;

        // Verificar se a soma excede a largura total
        if (somaDeslocamentos >= larguraTotal) {
          // Destacar campos com problema
          document.getElementById("largura").classList.add("error");
          document
            .getElementById("deslocamento-esquerdo")
            .classList.add("error");
          document
            .getElementById("deslocamento-direito")
            .classList.add("error");

          // Mostrar mensagem de erro
          alert(
            `A soma do deslocamento esquerdo (${deslocamentoEsquerdo.toFixed(
              2
            )}m) e do deslocamento direito (${deslocamentoDireito.toFixed(
              2
            )}m) deve ser menor que a largura total (${larguraTotal.toFixed(
              2
            )}m).`
          );
          return false;
        }

        // Remover destaque de erro se estiver tudo certo
        document.getElementById("largura").classList.remove("error");
        document
          .getElementById("deslocamento-esquerdo")
          .classList.remove("error");
        document
          .getElementById("deslocamento-direito")
          .classList.remove("error");
        return true;
      }

      // Função para obter colunas padrão para exportação CSV
      function getCsvColumns() {
        // Array com todas as colunas padrão em ordem lógica por seção
        return [
          // Informações Gerais
          "MODELADO",
          "CODIGO",
          "LOTE", //STRING
          "GPS", //BOOL
          "FOTOS SUPERIORES", //INT
          "FOTOS INFERIORES", // INT
          "NOME",
          "UF",
          "RODOVIA",
          "KM",
          "DATA",
          "ENGENHEIRO",
          "TECNICO",

          // Configurações Gerais
          "COMPRIMENTO",
          "LARGURA",
          "ALTURA",
          "QTD TRAMOS",
          "COMPRIMENTO TRAMOS",

          // Transição
          "CORTINA ALTURA",
          "ALA PARALELA",
          "ALA PERPENDICULAR",
          "COMPRIMENTO ALA",
          "ESPESSURA ALA",
          "ENCONTRO",
          "DESLOCAMENTO ESQUERDO ENCONTRO LAJE",
          "DESLOCAMENTO DIREITO ENCONTRO LAJE",
          "COMPRIMENTO ENCONTRO LAJE",
          "LAJE DE TRANSIÇÃO",

          // Superestrutura
          "ALTURA LONGARINA",
          "DESLOCAMENTO ESQUERDO",
          "DESLOCAMENTO DIREITO",
          "QTD LONGARINAS",
          "QTD TRANSVERSINAS",
          "ESPESSURA LONGARINA",
          "ESPESSURA TRANSVERSINA",
          "ESPESSURA LAJE",

          // Apoio
          "QTD PILARES",
          "PILAR DESCENTRALIZADO",
          "LARGURA PILAR",
          "COMPRIMENTO PILARES",
          "ALTURA DO APOIO",
          "TIPO DE APARELHO DE APOIO",
          "TIPO DE TRAVESSA",
          "ALTURA TRAVESSA",
          "TIPO DE ENCAMISAMENTO",
          "TIPO DE BLOCO OU SAPATA",
          "ALTURA BLOCO OU SAPATA",
          "LARGURA BLOCO OU SAPATA",
          "VIGA DE CONTRAVENTAMENTO DE PILAR",
          "VIGA DE LIGAÇÃO DE FUNDAÇÕES",

          // Elementos Complementares
          "BARREIRA ESQUERDA",
          "LARGURA BARREIRA ESQUERDA",
          "BARREIRA DIREITA",
          "LARGURA BARREIRA DIREITA",
          "CALÇADA ESQUERDA",
          "LARGURA CALÇADA ESQUERDA",
          "CALÇADA DIREITA",
          "LARGURA CALÇADA DIREITA",
          "GUARDA RODAS ESQUERDA",
          "LARGURA GUARDA RODAS ESQUERDA",
          "GUARDA RODAS DIREITA",
          "LARGURA GUARDA RODAS DIREITA",
          "PAVIMENTO",
          "QTD BUZINOTES",
        ];
      }


function showExportLoteModal() {
  try {
    if (!db) {
      alert("Banco de dados não está disponível.");
      return;
    }

    // Limpar e preencher o select com os lotes disponíveis
    const loteSelect = document.getElementById("export-lote-select");
    loteSelect.innerHTML = '<option value="">Carregando lotes...</option>';

    const transaction = db.transaction(["obras"], "readonly");
    const objectStore = transaction.objectStore("obras");
    const index = objectStore.index("LOTE");
    const request = index.openCursor(null, "nextunique");

    const lotes = new Set();

    request.onsuccess = function(event) {
      const cursor = event.target.result;
      
      if (cursor) {
        // Adicionar lote ao conjunto se existir
        if (cursor.key) {
          lotes.add(cursor.key);
        }
        cursor.continue();
      } else {
        // Todos os lotes foram coletados, preencher o select
        loteSelect.innerHTML = '';
        
        if (lotes.size === 0) {
          loteSelect.innerHTML = '<option value="">Nenhum lote encontrado</option>';
        } else {
          // Ordenar os lotes
          const lotesOrdenados = Array.from(lotes).sort();
          
          // Adicionar opção para cada lote
          lotesOrdenados.forEach(lote => {
            const option = document.createElement('option');
            option.value = lote;
            option.textContent = lote;
            loteSelect.appendChild(option);
          });
        }
      }
    };

    request.onerror = function(event) {
      console.error("Erro ao carregar lotes:", event.target.error);
      loteSelect.innerHTML = '<option value="">Erro ao carregar lotes</option>';
    };

    // Mostrar o modal
    document.getElementById("export-lote-modal").style.display = "block";
  } catch (error) {
    console.error("Erro ao exibir modal de exportação por lote:", error);
    alert("Erro ao exibir modal de exportação por lote: " + error.message);
  }
}

function closeExportLoteModal() {
  document.getElementById("export-lote-modal").style.display = "none";
}

function exportLoteWorks() {
  try {
    const loteSelect = document.getElementById("export-lote-select");
    const lote = loteSelect.value;
    
    if (!lote) {
      alert("Por favor, selecione um lote para exportar.");
      return;
    }

    if (!db) {
      alert("Banco de dados não está disponível.");
      return;
    }

    const transaction = db.transaction(["obras"], "readonly");
    const objectStore = transaction.objectStore("obras");
    const index = objectStore.index("LOTE");
    const request = index.getAll(lote);

    request.onsuccess = function(event) {
      const works = event.target.result;

      if (works.length === 0) {
        alert(`Não há obras no lote "${lote}" para exportar.`);
        return;
      }

      // Obter colunas definidas
      const csvColumns = getCsvColumns();

      // Verificar campos personalizados em todas as obras
      works.forEach((work) => {
        Object.keys(work).forEach((field) => {
          if (!csvColumns.includes(field)) {
            csvColumns.push(field);
          }
        });
      });

      // Construir o conteúdo do CSV (usando TAB como separador)
      let csvContent = csvColumns.join("\t") + "\n";

      works.forEach((work) => {
        const row = csvColumns.map((column) => {
          const value = work[column] || "";
          // Valores com tabs devem ser envolvidos em aspas duplas
          return value && value.includes("\t") ? `"${value}"` : value;
        });

        csvContent += row.join("\t") + "\n";
      });

      // Criar e baixar o arquivo CSV
      const blob = new Blob([csvContent], {
        type: "text/csv;charset=utf-8;",
      });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute(
        "download",
        `OAEs_Lote_${lote.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split("T")[0]}.csv`
      );
      link.style.display = "none";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // Fechar o modal após exportação
      closeExportLoteModal();
    };

    request.onerror = function(event) {
      console.error(`Erro ao exportar obras do lote "${lote}":`, event.target.error);
      alert(`Erro ao exportar obras do lote "${lote}": ${event.target.error}`);
    };
  } catch (error) {
    console.error("Erro ao exportar obras por lote:", error);
    alert("Erro ao exportar obras por lote: " + error.message);
  }
}


// Função para importar CSV de pontes para o IndexedDB
function importPontesCSV() {
  try {
    // Criar um input de arquivo oculto
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.csv';
    fileInput.style.display = 'none';
    document.body.appendChild(fileInput);
    
    fileInput.addEventListener('change', function() {
      if (this.files && this.files[0]) {
        const file = this.files[0];
        const reader = new FileReader();
        
        reader.onload = function(event) {
          const csvData = event.target.result;
          processPontesCSV(csvData);
        };
        
        reader.onerror = function() {
          alert("Erro ao ler o arquivo.");
        };
        
        reader.readAsText(file);
      }
      
      // Remover o input após uso
      document.body.removeChild(fileInput);
    });
    
    // Acionar o clique para abrir o seletor de arquivos
    fileInput.click();
  } catch (error) {
    console.error("Erro ao importar CSV de pontes:", error);
    alert("Erro ao importar CSV de pontes: " + error.message);
  }
}

// Função para processar o conteúdo do CSV de pontes
function processPontesCSV(csvData) {
  try {
    // Dividir as linhas do CSV
    const lines = csvData.split('\n');
    if (lines.length < 2) {
      alert("O arquivo CSV não contém dados válidos.");
      return;
    }
    
    // Verificar o separador correto (pode ser ; ou ,)
    const separator = lines[0].includes(';') ? ';' : ',';
    
    // Obter os cabeçalhos (primeira linha)
    const headers = lines[0].split(separator).map(header => header.trim());
    
    // Verificar se os cabeçalhos esperados existem
    const requiredHeaders = ["Id", "CodigoSgo", "Identificacao", "Uf", "Br", "Km"];
    const missingHeaders = requiredHeaders.filter(header => !headers.includes(header));
    
    if (missingHeaders.length > 0) {
      alert("O arquivo CSV não contém os cabeçalhos esperados: " + missingHeaders.join(", "));
      return;
    }
    
    // Array para armazenar as obras convertidas
    const obras = [];
    
    // Processar cada linha de dados (exceto a primeira que são os cabeçalhos)
    for (let i = 1; i < lines.length; i++) {
      if (lines[i].trim() === "") continue; // Pular linhas vazias
      
      const values = lines[i].split(separator);
      if (values.length !== headers.length) {
        console.warn(`Linha ${i + 1} tem número incorreto de campos. Tentando processar mesmo assim.`);
      }
      
      // Criar um objeto para mapear os valores para os índices de cabeçalho
      const rowData = {};
      headers.forEach((header, index) => {
        if (index < values.length) {
          rowData[header] = values[index].trim();
        }
      });
      
      // Mapear os dados da ponte para o formato OAE
      const obra = {
        CODIGO: rowData.CodigoSgo || "",
        NOME: rowData.Identificacao || "",
        UF: rowData.Uf || "",
        RODOVIA: rowData.Br ? `BR-${rowData.Br}` : "",
        KM: parseFloat(rowData.Km) || 0,
        LOTE: `BR-${rowData.Br || "000"}`, // Criar um lote baseado na BR
        MODELADO: "FALSE",
        GPS: "FALSE",
        "FOTOS SUPERIORES": "0",
        "FOTOS INFERIORES": "0",
        COMPRIMENTO: "0",
        LARGURA: "0",
        ALTURA: "0",
        "QTD TRAMOS": "1",
        "COMPRIMENTO TRAMOS": "0.5",
        "CORTINA ALTURA": "0",
        "ALTURA LONGARINA": "0",
        "DESLOCAMENTO ESQUERDO": "0",
        "DESLOCAMENTO DIREITO": "0",
        "QTD LONGARINAS": "0",
        "ESPESSURA LONGARINA": "0",
        "ESPESSURA LAJE": "0",
        "QTD PILARES": "0",
        PAVIMENTO: "PAVIMENTO ASFÁLTICO"
      };
      
      // Se houver um código válido, adicionar à lista
      if (obra.CODIGO && obra.CODIGO.trim() !== "") {
        obras.push(obra);
      }
    }
    
    if (obras.length > 0) {
      // Perguntar ao usuário se deseja salvar todas as pontes no banco de dados
      if (confirm(`O arquivo contém ${obras.length} pontes. Deseja importar todas para o banco de dados?`)) {
        saveMultipleWorks(obras);
      }
    } else {
      alert("Nenhuma ponte válida encontrada no arquivo CSV.");
    }
  } catch (error) {
    console.error("Erro ao processar arquivo CSV de pontes:", error);
    alert("Erro ao processar arquivo CSV de pontes: " + error.message);
  }
}



// Função para importar CSV de pontes de referência (mantendo nome original)
function importPontesReferenceCSV() {
  try {
    // Criar um input de arquivo oculto
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.csv';
    fileInput.style.display = 'none';
    document.body.appendChild(fileInput);
    
    fileInput.addEventListener('change', function() {
      if (this.files && this.files[0]) {
        const file = this.files[0];
        const reader = new FileReader();
        
        reader.onload = function(event) {
          const csvData = event.target.result;
          processPontesCSV(csvData);
        };
        
        reader.onerror = function() {
          alert("Erro ao ler o arquivo.");
        };
        
        reader.readAsText(file);
      }
      
      // Remover o input após uso
      document.body.removeChild(fileInput);
    });
    
    // Acionar o clique para abrir o seletor de arquivos
    fileInput.click();
  } catch (error) {
    console.error("Erro ao importar CSV de pontes:", error);
    alert("Erro ao importar CSV de pontes: " + error.message);
  }
}

// Função para processar o conteúdo do CSV de pontes
function processPontesCSV(csvData) {
  try {
    // Dividir as linhas do CSV
    const lines = csvData.split('\n');
    if (lines.length < 2) {
      alert("O arquivo CSV não contém dados válidos.");
      return;
    }
    
    // Detectar o separador
    const headerLine = lines[0];
    let separator = ',';
    if (headerLine.includes(';')) separator = ';';
    if (headerLine.includes('\t')) separator = '\t';
    
    // Obter os cabeçalhos
    const headers = headerLine.split(separator).map(header => header.trim());
    
    // Array para armazenar as pontes
    const pontes = [];
    
    // Processar cada linha de dados
    for (let i = 1; i < lines.length; i++) {
      const line = lines[i].trim();
      if (!line) continue; // Pular linhas vazias
      
      // Processar linha respeitando aspas
      const values = parseCSVLine(line, separator);
      
      if (values.length < 5) continue; // Ignorar linhas muito curtas
      
      // Mapear cabeçalhos para índices
      const headerMap = {};
      headers.forEach((header, index) => {
        const normalizedHeader = header.toLowerCase().replace(/[\s"']/g, '');
        headerMap[normalizedHeader] = index;
      });
      
      // Extrair dados com base nos índices
      const ponte = {
        Id: values[headerMap['id'] || 0] || '',
        CodigoSgo: values[headerMap['codigosgo'] || headerMap['códigosgo'] || 1] || '',
        Identificacao: values[headerMap['identificacao'] || headerMap['identificação'] || 2] || '',
        Municipio: values[headerMap['municipio'] || headerMap['município'] || 3] || '',
        Uf: values[headerMap['uf'] || 4] || '',
        Br: values[headerMap['rodovia'] || 6] || '',
        Km: parseFloat((values[headerMap['km'] || 7] || '0').toString().replace(',', '.')) || 0,
        Comprimento: parseFloat((values[headerMap['comprimento'] || 9] || '0').toString().replace(',', '.')) || 0,
        Largura: parseFloat((values[headerMap['largura'] || 10] || '0').toString().replace(',', '.')) || 0,
        AnoConstrucao: values[headerMap['ano'] || 11] || '',
        Latitude: parseFloat((values[headerMap['latitude'] || 12] || '0').toString().replace(',', '.')) || 0,
        Longitude: parseFloat((values[headerMap['longitude'] || 13] || '0').toString().replace(',', '.')) || 0
      };
      
      // Verificar se o objeto tem dados mínimos
      if (ponte.Id && ponte.CodigoSgo) {
        pontes.push(ponte);
      }
    }
    
    if (pontes.length > 0) {
      // Salvar as pontes no banco de dados
      savePontesReference(pontes);
      alert(`Importação concluída: ${pontes.length} pontes de referência importadas.`);
    } else {
      alert("Nenhuma ponte válida encontrada no arquivo CSV.");
    }
  } catch (error) {
    console.error("Erro ao processar arquivo CSV de pontes:", error);
    alert("Erro ao processar arquivo CSV de pontes: " + error.message);
  }
}




    </script>
  </body>
</html>