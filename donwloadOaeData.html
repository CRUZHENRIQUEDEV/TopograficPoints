<!-- Vers√£o: 5.0 - Console Script com CSV Completo -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNIT OAE Manager - Console</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .content {
            padding: 40px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.6em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .step {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 5px solid #667eea;
        }

        .step-number {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            text-align: center;
            line-height: 35px;
            font-weight: bold;
            margin-right: 15px;
        }

        .code-box {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 20px 0;
            max-height: 500px;
            overflow-y: auto;
            line-height: 1.6;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 35px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .success {
            background: #d4edda;
            border-left: 5px solid #28a745;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .info {
            background: #d1ecf1;
            border-left: 5px solid #17a2b8;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        ul {
            margin-left: 20px;
            line-height: 1.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèóÔ∏è DNIT OAE Manager</h1>
            <p>Extrator Completo via Console</p>
        </div>

        <div class="content">
            <div class="section">
                <h2>üìã Instru√ß√µes</h2>

                <div class="step">
                    <span class="step-number">1</span>
                    <strong>Acesse o DNIT e fa√ßa login:</strong><br>
                    <code>https://servicos.dnit.gov.br/sgplan/prd/sge/</code>
                </div>

                <div class="step">
                    <span class="step-number">2</span>
                    <strong>Abra o Console:</strong><br>
                    Pressione <code>F12</code> ou <code>Ctrl+Shift+J</code>
                </div>

                <div class="step">
                    <span class="step-number">3</span>
                    <strong>Copie e cole o c√≥digo abaixo</strong> no console
                </div>

                <div class="step">
                    <span class="step-number">4</span>
                    <strong>Aguarde a coleta autom√°tica</strong> de todos os dados
                </div>

               <div class="step">
    <span class="step-number">5</span>
    <strong>Exporte os dados:</strong><br>
    Digite <code>downloadTodosCSV()</code> para baixar ambos os arquivos CSV simultaneamente
</div>
            </div>

            <div class="section">
                <button class="btn" onclick="copiarCodigo()">
                    üìã Copiar C√≥digo Completo
                </button>

                <div class="code-box" id="codigoScript">// Vers√£o: 5.0 - DNIT OAE Extractor - CSV Simplificado (12 campos essenciais)
</div>
            </div>

            <div class="section">
                <h2>‚ú® Campos do CSV (12 colunas essenciais)</h2>
                <div class="success">
                    <strong>CSV simplificado com os campos mais importantes:</strong>
                    <ul style="margin-top: 10px;">
                        <li><strong>ID OAE</strong> - Identificador √∫nico (GUID)</li>
                        <li><strong>Identifica√ß√£o</strong> - Nome da obra</li>
                        <li><strong>Natureza Estrutura</strong> - Tipo da estrutura</li>
                        <li><strong>ID Natureza Estrutura</strong> - ID do tipo</li>
                        <li><strong>C√≥digo SGO</strong> - C√≥digo no sistema SGO</li>
                        <li><strong>BR</strong> - Rodovia</li>
                        <li><strong>UF</strong> - Estado</li>
                        <li><strong>Status</strong> - Status da inspe√ß√£o</li>
                        <li><strong>KM</strong> - Quilometragem</li>
                        <li><strong>Nome Inspetor</strong> - Respons√°vel pela inspe√ß√£o</li>
                        <li><strong>Nome Avaliador</strong> - Respons√°vel pela avalia√ß√£o</li>
                        <li><strong>Localizado</strong> - Localiza√ß√£o completa (BR/UF km)</li>
                    </ul>
                </div>
            </div>

        <div class="section">
    <h2>üéØ Funcionalidades</h2>
    <div class="info">
        <ul>
            <li>‚≠ê <strong>NOVO:</strong> Download simult√¢neo de CSV Cadastral e Rotineira</li>
            <li>‚≠ê <strong>NOVO:</strong> Nome de arquivo padronizado (OBRAS_APROVADAS_XXX_DATA_HORA)</li>
            <li>‚úÖ Detecta token automaticamente</li>
            <li>‚úÖ Coleta TODAS as p√°ginas automaticamente</li>
            <li>‚úÖ Exporta dados completos em CSV e JSON</li>
            <li>‚úÖ UTF-8 com BOM para compatibilidade com Excel</li>
            <li>‚úÖ Estat√≠sticas detalhadas no console</li>
            <li>‚úÖ Sem problemas de CORS</li>
        </ul>
    </div>
</div>
        </div>
    </div>

    <script>
// Vers√£o: 6.0 - DNIT OAE Extractor - Cadastro e Inspe√ß√µes Rotineiras
(async function() {
    console.log('üöÄ DNIT OAE Extractor v6.0 - Cadastro e Inspe√ß√µes Rotineiras');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

    // URLs da API
    const API_BASE_URL_OAE = 'https://servicos.dnit.gov.br/sgplan/prd/sge/api/v1/CadastroOae/obterListaManterOaes';
    const API_BASE_URL_INSPECAO = 'https://servicos.dnit.gov.br/sgplan/prd/sge/api/v1/InspecaoOae';

    // IDs dos respons√°veis
    const RESPONSAVEIS = [
        '36228eff-525f-4629-b406-f308ebe605da',
        '21484127-2d2f-4a72-9382-83e21bd03dc6',
        '5c2a0c7d-6308-4b79-82ec-9e7a2cbd1af5',
        'c2536023-a24c-4d2d-8dd1-541fc559d3b9',
        '3d0448dd-c9d1-4da1-92c3-f05fd9b2351a',
        '2ece7b1c-4550-488c-a9fc-aa49fd0e0f3f',
        '598d003e-cd89-46e3-ba26-e0a880ce743f',
        '570a3aef-92fc-4ef2-b660-eccd8fcc2ec7',
        'b6988556-b011-4f6e-a119-70d29727bb08',
        '2c42ab19-c634-412e-92a6-382979ad3ca2',
        'b6988556-b011-4f6e-a119-70d29727bb08'
    ];

    // Tipo de inspe√ß√£o (para endpoint de inspe√ß√µes)
    const TIPO_INSPECAO_ROTINEIRA = 1;

    // Armazenamento dos dados
    let dadosCadastrais = [];  // Dados de OAEs (cadastrais)
    let dadosInspecoes = [];   // Dados de inspe√ß√µes rotineiras
    let bearerToken = null;    // Token de autentica√ß√£o

    /**
     * Obt√©m o token de autentica√ß√£o do sessionStorage
     * @returns {string|null} Token de autentica√ß√£o ou null se n√£o encontrado
     */
    function obterBearerToken() {
        console.log('üîë Buscando Bearer Token...');
        
        try {
            const oidcKey = Object.keys(sessionStorage).find(key => 
                key.includes('oidc-user') && key.includes('dnit.gov.br')
            );
            
            if (oidcKey) {
                const oidcData = JSON.parse(sessionStorage.getItem(oidcKey));
                if (oidcData && oidcData.access_token) {
                    console.log('‚úÖ Token encontrado no sessionStorage');
                    return oidcData.access_token;
                }
            }
        } catch (e) {
            console.log('‚ö†Ô∏è Erro ao buscar token:', e.message);
        }

        console.log('‚ö†Ô∏è Token n√£o encontrado');
        return null;
    }

    /**
     * Constr√≥i a URL para o endpoint de cadastro OAE
     * @param {number} pageIndex - √çndice da p√°gina (come√ßa em 0)
     * @returns {string} URL formatada
     */
    function construirURLCadastral(pageIndex = 0) {
        const params = [];
        params.push('pageSize=15');
        params.push('status=5');
        
        RESPONSAVEIS.forEach(id => {
            params.push(`responsaveis=${id}`);
        });
        
        if (pageIndex > 0) {
            params.push(`pageIndex=${pageIndex}`);
        }
        
        return `${API_BASE_URL_OAE}?${params.join('&')}`;
    }

    /**
     * Constr√≥i a URL para o endpoint de inspe√ß√µes rotineiras
     * @param {number} pageIndex - √çndice da p√°gina (come√ßa em 0)
     * @returns {string} URL formatada
     */
    function construirURLInspecao(pageIndex = 0) {
        const params = [];
        params.push('pageSize=15');
        params.push('status=5');
        params.push(`tipoInspecao=${TIPO_INSPECAO_ROTINEIRA}`);
        
        RESPONSAVEIS.forEach(id => {
            params.push(`responsaveis=${id}`);
        });
        
        if (pageIndex > 0) {
            params.push(`pageIndex=${pageIndex}`);
        }
        
        return `${API_BASE_URL_INSPECAO}?${params.join('&')}`;
    }

    /**
     * Realiza uma requisi√ß√£o HTTP GET
     * @param {string} url - URL da requisi√ß√£o
     * @param {string} token - Bearer token para autentica√ß√£o
     * @returns {Promise<Response>} Resposta da requisi√ß√£o
     */
    async function fazerRequisicao(url, token) {
        const headers = {
            'Accept': 'application/json, text/plain, */*',
            'Authorization': `Bearer ${token}`
        };

        const response = await fetch(url, {
            method: 'GET',
            headers: headers,
            credentials: 'include'
        });

        return response;
    }

    /**
     * Extrai dados cadastrais de OAEs
     * @param {string} token - Bearer token para autentica√ß√£o
     */
    async function extrairDadosCadastrais(token) {
        console.log('\nüìä Iniciando extra√ß√£o de dados CADASTRAIS...\n');
        
        try {
            let pageIndex = 0;
            let hasNextPage = true;
            let totalCount = 0;

            while (hasNextPage) {
                console.log(`üìÑ Buscando p√°gina ${pageIndex + 1} (Cadastral)...`);
                
                const url = construirURLCadastral(pageIndex);
                const response = await fazerRequisicao(url, token);

                if (!response.ok) {
                    throw new Error(`Erro HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                dadosCadastrais.push(...data.items);
                totalCount = data.totalCount;
                hasNextPage = data.hasNextPage;
                pageIndex++;

                console.log(`   ‚úÖ ${data.items.length} OAEs coletadas`);
                console.log(`   üìä Progresso: ${dadosCadastrais.length}/${totalCount}`);
            }

            console.log('\nüéâ EXTRA√á√ÉO DE DADOS CADASTRAIS CONCLU√çDA!\n');
            exibirEstatisticasCadastrais();
            
        } catch (error) {
            console.error('\n‚ùå ERRO AO EXTRAIR DADOS CADASTRAIS:', error.message);
        }
    }

    /**
     * Extrai dados de inspe√ß√µes rotineiras
     * @param {string} token - Bearer token para autentica√ß√£o
     */
    async function extrairDadosInspecoes(token) {
        console.log('\nüìä Iniciando extra√ß√£o de INSPE√á√ïES ROTINEIRAS...\n');
        
        try {
            let pageIndex = 0;
            let hasNextPage = true;
            let totalCount = 0;

            while (hasNextPage) {
                console.log(`üìÑ Buscando p√°gina ${pageIndex + 1} (Inspe√ß√µes)...`);
                
                const url = construirURLInspecao(pageIndex);
                const response = await fazerRequisicao(url, token);

                if (!response.ok) {
                    throw new Error(`Erro HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                dadosInspecoes.push(...data.items);
                totalCount = data.totalCount;
                hasNextPage = data.hasNextPage;
                pageIndex++;

                console.log(`   ‚úÖ ${data.items.length} inspe√ß√µes coletadas`);
                console.log(`   üìä Progresso: ${dadosInspecoes.length}/${totalCount}`);
            }

            console.log('\nüéâ EXTRA√á√ÉO DE INSPE√á√ïES ROTINEIRAS CONCLU√çDA!\n');
            exibirEstatisticasInspecoes();
            
        } catch (error) {
            console.error('\n‚ùå ERRO AO EXTRAIR INSPE√á√ïES:', error.message);
        }
    }

    /**
     * Exibe estat√≠sticas dos dados cadastrais coletados
     */
    function exibirEstatisticasCadastrais() {
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üìä ESTAT√çSTICAS - DADOS CADASTRAIS:');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log(`   Total de OAEs: ${dadosCadastrais.length}`);
        
        if (dadosCadastrais.length > 0) {
            console.log(`   BRs √∫nicas: ${[...new Set(dadosCadastrais.map(item => item.br))].length}`);
            console.log(`   Estados: ${[...new Set(dadosCadastrais.map(item => item.uf))].length}`);
            
            const porStatus = dadosCadastrais.reduce((acc, item) => {
                acc[item.status] = (acc[item.status] || 0) + 1;
                return acc;
            }, {});
            
            console.log('\n   Status:');
            Object.entries(porStatus).forEach(([status, count]) => {
                console.log(`     - ${status}: ${count}`);
            });
        }
        
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
    }

    /**
     * Exibe estat√≠sticas das inspe√ß√µes rotineiras coletadas
     */
    function exibirEstatisticasInspecoes() {
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üìä ESTAT√çSTICAS - INSPE√á√ïES ROTINEIRAS:');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log(`   Total de Inspe√ß√µes: ${dadosInspecoes.length}`);
        
        if (dadosInspecoes.length > 0) {
            console.log(`   BRs √∫nicas: ${[...new Set(dadosInspecoes.map(item => item.br))].length}`);
            console.log(`   Estados: ${[...new Set(dadosInspecoes.map(item => item.uf))].length}`);
            
            const porStatus = dadosInspecoes.reduce((acc, item) => {
                acc[item.status] = (acc[item.status] || 0) + 1;
                return acc;
            }, {});
            
            console.log('\n   Status:');
            Object.entries(porStatus).forEach(([status, count]) => {
                console.log(`     - ${status}: ${count}`);
            });
        }
        
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
    }

   




    /**
     * Inicia a extra√ß√£o de ambos os conjuntos de dados
     */
    async function iniciarExtracao() {
        try {
            console.log('üîÑ Iniciando extra√ß√£o de todos os dados...');
            
            // Dados cadastrais
            await extrairDadosCadastrais(bearerToken);
            
            // Inspe√ß√µes rotineiras
            await extrairDadosInspecoes(bearerToken);
            
            // Configura exporta√ß√£o ap√≥s concluir ambas as extra√ß√µes
            configurarExportacao();
            console.log('\n‚úÖ EXTRA√á√ÉO COMPLETA! Use os comandos de exporta√ß√£o para baixar os dados.\n');
        } catch (error) {
            console.error('\n‚ùå ERRO NA EXTRA√á√ÉO:', error.message);
        }
    }


    /**
 * Configura fun√ß√µes de exporta√ß√£o e torna os dados acess√≠veis globalmente
 */
function configurarExportacao() {
    // Torna os dados acess√≠veis globalmente
    window.dadosCadastrais = dadosCadastrais;
    window.dadosInspecoes = dadosInspecoes;
    
    // Exporta√ß√£o JSON
    window.downloadJSONCadastral = function() {
        const dataHora = gerarDataHoraFormatada();
        const dataStr = JSON.stringify(dadosCadastrais, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `OBRAS_APROVADAS_CADASTRAL_${dataHora}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        console.log('‚úÖ Arquivo JSON CADASTRAL baixado!');
    };
    
    window.downloadJSONInspecoes = function() {
        const dataHora = gerarDataHoraFormatada();
        const dataStr = JSON.stringify(dadosInspecoes, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `OBRAS_APROVADAS_ROTINEIRA_${dataHora}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        console.log('‚úÖ Arquivo JSON INSPE√á√ïES baixado!');
    };

   
    // Exporta√ß√£o CSV para inspe√ß√µes rotineiras
    window.downloadCSVInspecoes = function() {
        const dataHora = gerarDataHoraFormatada();
        const headers = [
            'ID OAE',
            'ID Inspe√ß√£o',
            'Identifica√ß√£o',
            'BR',
            'UF',
            'KM',
            'Status',
            'Natureza Estrutura',
            'Nome Inspetor',
            'Nome Avaliador',
            'Data Inspe√ß√£o',
            'Data √öltima Atualiza√ß√£o'
        ];
        
        const rows = dadosInspecoes.map(item => [
            item.idOae || '',
            item.idInspecao || '',
            item.identificacaoObra || '',
            item.br || '',
            item.uf || '',
            item.km || '',
            item.status || '',
            item.naturezaEstrutura || '',
            item.nomeInspetor || '',
            item.nomeAvaliador || '',
            item.dataInspecaoFormatada || '',
            item.dataUltimaAtualizacaoFormatada || ''
        ]);
        
        const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(';')).join('\n');
        const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `OBRAS_APROVADAS_ROTINEIRA_${dataHora}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        console.log('‚úÖ Arquivo CSV INSPE√á√ïES baixado!');
    };

    // Download simult√¢neo de ambos os CSVs
    window.downloadTodosCSV = function() {
        const dataHora = gerarDataHoraFormatada();
        console.log('üì¶ Iniciando download simult√¢neo dos arquivos CSV...');
        
        // Preparar CSV Cadastral
        const headersCadastral = [
            'ID OAE',
            'Identifica√ß√£o',
            'Natureza Estrutura',
            'ID Natureza Estrutura',
            'C√≥digo SGO',
            'BR',
            'UF',
            'Status',
            'KM',
            'Nome Inspetor',
            'Nome Avaliador',
            'Data √öltima Atualiza√ß√£o'
        ];
        
        const rowsCadastral = dadosCadastrais.map(item => [
            item.idOae || '',
            item.identificacaoObra || '',
            item.naturezaEstrutura || '',
            item.idNaturezaEstrutura || '',
            item.codigoEstrutura || '',
            item.br || '',
            item.uf || '',
            item.status || '',
            item.km || '',
            item.nomeInspetor || '',
            item.nomeAvaliador || '',
            item.dataUltimaAtualizacaoFormatada || ''
        ]);
        
        // Preparar CSV Inspe√ß√µes
        const headersInspecoes = [
            'ID OAE',
            'ID Inspe√ß√£o',
            'Identifica√ß√£o',
            'BR',
            'UF',
            'KM',
            'Status',
            'Natureza Estrutura',
            'Nome Inspetor',
            'Nome Avaliador',
            'Data Inspe√ß√£o',
            'Data √öltima Atualiza√ß√£o'
        ];
        
        const rowsInspecoes = dadosInspecoes.map(item => [
            item.idOae || '',
            item.idInspecao || '',
            item.identificacaoObra || '',
            item.br || '',
            item.uf || '',
            item.km || '',
            item.status || '',
            item.naturezaEstrutura || '',
            item.nomeInspetor || '',
            item.nomeAvaliador || '',
            item.dataInspecaoFormatada || '',
            item.dataUltimaAtualizacaoFormatada || ''
        ]);
        
        // Criar e baixar CSV Cadastral
        const csvCadastral = [headersCadastral, ...rowsCadastral].map(row => row.map(cell => `"${cell}"`).join(';')).join('\n');
        const blobCadastral = new Blob(['\uFEFF' + csvCadastral], { type: 'text/csv;charset=utf-8;' });
        const urlCadastral = URL.createObjectURL(blobCadastral);
        const linkCadastral = document.createElement('a');
        linkCadastral.href = urlCadastral;
        linkCadastral.download = `OBRAS_APROVADAS_CADASTRAL_${dataHora}.csv`;
        document.body.appendChild(linkCadastral);
        
        // Criar e baixar CSV Inspe√ß√µes
        const csvInspecoes = [headersInspecoes, ...rowsInspecoes].map(row => row.map(cell => `"${cell}"`).join(';')).join('\n');
        const blobInspecoes = new Blob(['\uFEFF' + csvInspecoes], { type: 'text/csv;charset=utf-8;' });
        const urlInspecoes = URL.createObjectURL(blobInspecoes);
        const linkInspecoes = document.createElement('a');
        linkInspecoes.href = urlInspecoes;
        linkInspecoes.download = `OBRAS_APROVADAS_ROTINEIRA_${dataHora}.csv`;
        document.body.appendChild(linkInspecoes);
        
        // Executar os downloads em sequ√™ncia (com pequeno atraso para evitar problemas)
        setTimeout(() => {
            linkCadastral.click();
            setTimeout(() => {
                linkInspecoes.click();
                
                // Limpar recursos
                setTimeout(() => {
                    document.body.removeChild(linkCadastral);
                    document.body.removeChild(linkInspecoes);
                    URL.revokeObjectURL(urlCadastral);
                    URL.revokeObjectURL(urlInspecoes);
                }, 100);
                
                console.log('‚úÖ Ambos os arquivos CSV baixados com sucesso!');
            }, 500);
        }, 100);
    };

    // Exibir instru√ß√µes de exporta√ß√£o
    console.log('üíæ COMANDOS DE EXPORTA√á√ÉO:');
    console.log('   ‚Ä¢ downloadTodosCSV()        - ‚≠ê BAIXAR AMBOS OS CSVs AO MESMO TEMPO');
    console.log('   ‚Ä¢ downloadCSVCadastral()    - Baixar CSV com dados cadastrais');
    console.log('   ‚Ä¢ downloadCSVInspecoes()    - Baixar CSV com inspe√ß√µes rotineiras');
    console.log('   ‚Ä¢ downloadJSONCadastral()   - Baixar JSON de dados cadastrais');
    console.log('   ‚Ä¢ downloadJSONInspecoes()   - Baixar JSON de inspe√ß√µes rotineiras');
    console.log('   ‚Ä¢ dadosCadastrais           - Ver dados cadastrais no console');
    console.log('   ‚Ä¢ dadosInspecoes            - Ver inspe√ß√µes no console\n');
}



    /**
     * Fun√ß√£o global para extrair dados com um token fornecido manualmente
     * @param {string} token - Bearer token para autentica√ß√£o
     */
    window.extrairComToken = async function(token) {
        dadosCadastrais = [];
        dadosInspecoes = [];
        bearerToken = token.replace('Bearer ', '');
        await iniciarExtracao();
    };

    // Inicia o processo
    bearerToken = obterBearerToken();
    
    if (bearerToken) {
        console.log('üéØ Token encontrado! Iniciando...\n');
        await iniciarExtracao();
    } else {
        console.log('‚ö†Ô∏è Token n√£o encontrado automaticamente\n');
        console.log('üìã Execute: extrairComToken("SEU_TOKEN")');
    }

})();



/**
 * Realiza o download simult√¢neo dos arquivos CSV de dados cadastrais e inspe√ß√µes rotineiras
 * Utiliza os formatos de nome de arquivo OBRAS_APROVADAS_CADASTRAL_DATA_HORA.csv 
 * e OBRAS_APROVADAS_ROTINEIRA_DATA_HORA.csv
 */
window.downloadTodosCSV = function() {
    const dataHora = gerarDataHoraFormatada();
    console.log('üì¶ Iniciando download simult√¢neo dos arquivos CSV...');
    
    // Preparar CSV Cadastral
    const headersCadastral = [
        'ID OAE',
        'Identifica√ß√£o',
        'Natureza Estrutura',
        'ID Natureza Estrutura',
        'C√≥digo SGO',
        'BR',
        'UF',
        'Status',
        'KM',
        'Nome Inspetor',
        'Nome Avaliador',
        'Data √öltima Atualiza√ß√£o'
    ];
    
    const rowsCadastral = dadosCadastrais.map(item => [
        item.idOae || '',
        item.identificacaoObra || '',
        item.naturezaEstrutura || '',
        item.idNaturezaEstrutura || '',
        item.codigoEstrutura || '',
        item.br || '',
        item.uf || '',
        item.status || '',
        item.km || '',
        item.nomeInspetor || '',
        item.nomeAvaliador || '',
        item.dataUltimaAtualizacaoFormatada || ''
    ]);
    
    // Preparar CSV Inspe√ß√µes
    const headersInspecoes = [
        'ID OAE',
        'ID Inspe√ß√£o',
        'Identifica√ß√£o',
        'BR',
        'UF',
        'KM',
        'Status',
        'Natureza Estrutura',
        'Nome Inspetor',
        'Nome Avaliador',
        'Data Inspe√ß√£o',
        'Data √öltima Atualiza√ß√£o'
    ];
    
    const rowsInspecoes = dadosInspecoes.map(item => [
        item.idOae || '',
        item.idInspecao || '',
        item.identificacaoObra || '',
        item.br || '',
        item.uf || '',
        item.km || '',
        item.status || '',
        item.naturezaEstrutura || '',
        item.nomeInspetor || '',
        item.nomeAvaliador || '',
        item.dataInspecaoFormatada || '',
        item.dataUltimaAtualizacaoFormatada || ''
    ]);
    
    // Criar e baixar CSV Cadastral
    const csvCadastral = [headersCadastral, ...rowsCadastral].map(row => row.map(cell => `"${cell}"`).join(';')).join('\n');
    const blobCadastral = new Blob(['\uFEFF' + csvCadastral], { type: 'text/csv;charset=utf-8;' });
    const urlCadastral = URL.createObjectURL(blobCadastral);
    const linkCadastral = document.createElement('a');
    linkCadastral.href = urlCadastral;
    linkCadastral.download = `OBRAS_APROVADAS_CADASTRAL_${dataHora}.csv`;
    document.body.appendChild(linkCadastral);
    
    // Criar e baixar CSV Inspe√ß√µes
    const csvInspecoes = [headersInspecoes, ...rowsInspecoes].map(row => row.map(cell => `"${cell}"`).join(';')).join('\n');
    const blobInspecoes = new Blob(['\uFEFF' + csvInspecoes], { type: 'text/csv;charset=utf-8;' });
    const urlInspecoes = URL.createObjectURL(blobInspecoes);
    const linkInspecoes = document.createElement('a');
    linkInspecoes.href = urlInspecoes;
    linkInspecoes.download = `OBRAS_APROVADAS_ROTINEIRA_${dataHora}.csv`;
    document.body.appendChild(linkInspecoes);
    
    // Executar os downloads em sequ√™ncia (com pequeno atraso para evitar problemas)
    setTimeout(() => {
        linkCadastral.click();
        setTimeout(() => {
            linkInspecoes.click();
            
            // Limpar recursos
            setTimeout(() => {
                document.body.removeChild(linkCadastral);
                document.body.removeChild(linkInspecoes);
                URL.revokeObjectURL(urlCadastral);
                URL.revokeObjectURL(urlInspecoes);
            }, 100);
            
            console.log('‚úÖ Ambos os arquivos CSV baixados com sucesso!');
        }, 500);
    }, 100);
};



/**
 * Exporta os dados de inspe√ß√µes rotineiras para um arquivo CSV
 * Utiliza o formato de nome de arquivo OBRAS_APROVADAS_ROTINEIRA_DATA_HORA.csv
 */
window.downloadCSVInspecoes = function() {
    const dataHora = gerarDataHoraFormatada();
    const headers = [
        'ID OAE',
        'ID Inspe√ß√£o',
        'Identifica√ß√£o',
        'BR',
        'UF',
        'KM',
        'Status',
        'Natureza Estrutura',
        'Nome Inspetor',
        'Nome Avaliador',
        'Data Inspe√ß√£o',
        'Data √öltima Atualiza√ß√£o'
    ];
    
    const rows = dadosInspecoes.map(item => [
        item.idOae || '',
        item.idInspecao || '',
        item.identificacaoObra || '',
        item.br || '',
        item.uf || '',
        item.km || '',
        item.status || '',
        item.naturezaEstrutura || '',
        item.nomeInspetor || '',
        item.nomeAvaliador || '',
        item.dataInspecaoFormatada || '',
        item.dataUltimaAtualizacaoFormatada || ''
    ]);
    
    const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(';')).join('\n');
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `OBRAS_APROVADAS_ROTINEIRA_${dataHora}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    console.log('‚úÖ Arquivo CSV INSPE√á√ïES baixado!');
};




// Vers√£o: 1.0
/**
 * Gera string de data e hora formatada para uso nos nomes de arquivos
 * @returns {string} Data e hora no formato AAAA-MM-DD_HH-MM-SS
 */
function gerarDataHoraFormatada() {
    const agora = new Date();
    
    const ano = agora.getFullYear();
    const mes = String(agora.getMonth() + 1).padStart(2, '0');
    const dia = String(agora.getDate()).padStart(2, '0');
    const horas = String(agora.getHours()).padStart(2, '0');
    const minutos = String(agora.getMinutes()).padStart(2, '0');
    const segundos = String(agora.getSeconds()).padStart(2, '0');
    
    return `${ano}-${mes}-${dia}_${horas}-${minutos}-${segundos}`;
}


// Fun√ß√£o para copiar o c√≥digo
function copiarCodigo() {
    const codigo = document.getElementById('codigoScript').textContent;
    navigator.clipboard.writeText(codigo)
        .then(() => {
            alert('C√≥digo copiado para a √°rea de transfer√™ncia! Cole no console do navegador.');
        })
        .catch(err => {
            console.error('Erro ao copiar c√≥digo:', err);
            alert('N√£o foi poss√≠vel copiar automaticamente. Selecione o c√≥digo manualmente e use Ctrl+C.');
        });
}









// O script que deve aparecer na div #codigoScript:
document.getElementById('codigoScript').textContent =
 `// Vers√£o: 7.0 - DNIT OAE Extractor - Download Simult√¢neo Cadastral e Rotineira
(async function() {
    console.log('üöÄ DNIT OAE Extractor v7.0 - Cadastro e Inspe√ß√µes Rotineiras');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\\n');
    // URLs da API
    const API_BASE_URL_OAE = 'https://servicos.dnit.gov.br/sgplan/prd/sge/api/v1/CadastroOae/obterListaManterOaes';
    const API_BASE_URL_INSPECAO = 'https://servicos.dnit.gov.br/sgplan/prd/sge/api/v1/InspecaoOae';
    // IDs dos respons√°veis
    const RESPONSAVEIS = [
        '36228eff-525f-4629-b406-f308ebe605da',
        '21484127-2d2f-4a72-9382-83e21bd03dc6',
        '5c2a0c7d-6308-4b79-82ec-9e7a2cbd1af5',
        'c2536023-a24c-4d2d-8dd1-541fc559d3b9',
        '3d0448dd-c9d1-4da1-92c3-f05fd9b2351a',
        '2ece7b1c-4550-488c-a9fc-aa49fd0e0f3f',
        '598d003e-cd89-46e3-ba26-e0a880ce743f',
        '570a3aef-92fc-4ef2-b660-eccd8fcc2ec7',
        'b6988556-b011-4f6e-a119-70d29727bb08',
        '2c42ab19-c634-412e-92a6-382979ad3ca2',
        'b6988556-b011-4f6e-a119-70d29727bb08'
    ];
    // Tipo de inspe√ß√£o (para endpoint de inspe√ß√µes)
    const TIPO_INSPECAO_ROTINEIRA = 1;
    // Armazenamento dos dados
    let dadosCadastrais = [];  // Dados de OAEs (cadastrais)
    let dadosInspecoes = [];   // Dados de inspe√ß√µes rotineiras
    let bearerToken = null;    // Token de autentica√ß√£o
    /**
     * Gera string de data e hora formatada para uso nos nomes de arquivos
     * @returns {string} Data e hora no formato AAAA-MM-DD_HH-MM-SS
     */
    function gerarDataHoraFormatada() {
        const agora = new Date();
        
        const ano = agora.getFullYear();
        const mes = String(agora.getMonth() + 1).padStart(2, '0');
        const dia = String(agora.getDate()).padStart(2, '0');
        const horas = String(agora.getHours()).padStart(2, '0');
        const minutos = String(agora.getMinutes()).padStart(2, '0');
        const segundos = String(agora.getSeconds()).padStart(2, '0');
        
        return \`\${ano}-\${mes}-\${dia}_\${horas}-\${minutos}-\${segundos}\`;
    }
    /**
     * Obt√©m o token de autentica√ß√£o do sessionStorage
     * @returns {string|null} Token de autentica√ß√£o ou null se n√£o encontrado
     */
    function obterBearerToken() {
        console.log('üîë Buscando Bearer Token...');
        
        try {
            const oidcKey = Object.keys(sessionStorage).find(key => 
                key.includes('oidc-user') && key.includes('dnit.gov.br')
            );
            
            if (oidcKey) {
                const oidcData = JSON.parse(sessionStorage.getItem(oidcKey));
                if (oidcData && oidcData.access_token) {
                    console.log('‚úÖ Token encontrado no sessionStorage');
                    return oidcData.access_token;
                }
            }
        } catch (e) {
            console.log('‚ö†Ô∏è Erro ao buscar token:', e.message);
        }
        console.log('‚ö†Ô∏è Token n√£o encontrado');
        return null;
    }
    /**
     * Constr√≥i a URL para o endpoint de cadastro OAE
     * @param {number} pageIndex - √çndice da p√°gina (come√ßa em 0)
     * @returns {string} URL formatada
     */
    function construirURLCadastral(pageIndex = 0) {
        const params = [];
        params.push('pageSize=15');
        params.push('status=5');
        
        RESPONSAVEIS.forEach(id => {
            params.push(\`responsaveis=\${id}\`);
        });
        
        if (pageIndex > 0) {
            params.push(\`pageIndex=\${pageIndex}\`);
        }
        
        return \`\${API_BASE_URL_OAE}?\${params.join('&')}\`;
    }
    /**
     * Constr√≥i a URL para o endpoint de inspe√ß√µes rotineiras
     * @param {number} pageIndex - √çndice da p√°gina (come√ßa em 0)
     * @returns {string} URL formatada
     */
    function construirURLInspecao(pageIndex = 0) {
        const params = [];
        params.push('pageSize=15');
        params.push('status=5');
        params.push(\`tipoInspecao=\${TIPO_INSPECAO_ROTINEIRA}\`);
        
        RESPONSAVEIS.forEach(id => {
            params.push(\`responsaveis=\${id}\`);
        });
        
        if (pageIndex > 0) {
            params.push(\`pageIndex=\${pageIndex}\`);
        }
        
        return \`\${API_BASE_URL_INSPECAO}?\${params.join('&')}\`;
    }
    /**
     * Realiza uma requisi√ß√£o HTTP GET
     * @param {string} url - URL da requisi√ß√£o
     * @param {string} token - Bearer token para autentica√ß√£o
     * @returns {Promise<Response>} Resposta da requisi√ß√£o
     */
    async function fazerRequisicao(url, token) {
        const headers = {
            'Accept': 'application/json, text/plain, */*',
            'Authorization': \`Bearer \${token}\`
        };
        const response = await fetch(url, {
            method: 'GET',
            headers: headers,
            credentials: 'include'
        });
        return response;
    }
    /**
     * Extrai dados cadastrais de OAEs
     * @param {string} token - Bearer token para autentica√ß√£o
     */
    async function extrairDadosCadastrais(token) {
        console.log('\\nüìä Iniciando extra√ß√£o de dados CADASTRAIS...\\n');
        
        try {
            let pageIndex = 0;
            let hasNextPage = true;
            let totalCount = 0;
            while (hasNextPage) {
                console.log(\`üìÑ Buscando p√°gina \${pageIndex + 1} (Cadastral)...\`);
                
                const url = construirURLCadastral(pageIndex);
                const response = await fazerRequisicao(url, token);
                if (!response.ok) {
                    throw new Error(\`Erro HTTP \${response.status}: \${response.statusText}\`);
                }
                const data = await response.json();
                dadosCadastrais.push(...data.items);
                totalCount = data.totalCount;
                hasNextPage = data.hasNextPage;
                pageIndex++;
                console.log(\`   ‚úÖ \${data.items.length} OAEs coletadas\`);
                console.log(\`   üìä Progresso: \${dadosCadastrais.length}/\${totalCount}\`);
            }
            console.log('\\nüéâ EXTRA√á√ÉO DE DADOS CADASTRAIS CONCLU√çDA!\\n');
            exibirEstatisticasCadastrais();
            
        } catch (error) {
            console.error('\\n‚ùå ERRO AO EXTRAIR DADOS CADASTRAIS:', error.message);
        }
    }
    /**
     * Extrai dados de inspe√ß√µes rotineiras
     * @param {string} token - Bearer token para autentica√ß√£o
     */
    async function extrairDadosInspecoes(token) {
        console.log('\\nüìä Iniciando extra√ß√£o de INSPE√á√ïES ROTINEIRAS...\\n');
        
        try {
            let pageIndex = 0;
            let hasNextPage = true;
            let totalCount = 0;
            while (hasNextPage) {
                console.log(\`üìÑ Buscando p√°gina \${pageIndex + 1} (Inspe√ß√µes)...\`);
                
                const url = construirURLInspecao(pageIndex);
                const response = await fazerRequisicao(url, token);
                if (!response.ok) {
                    throw new Error(\`Erro HTTP \${response.status}: \${response.statusText}\`);
                }
                const data = await response.json();
                dadosInspecoes.push(...data.items);
                totalCount = data.totalCount;
                hasNextPage = data.hasNextPage;
                pageIndex++;
                console.log(\`   ‚úÖ \${data.items.length} inspe√ß√µes coletadas\`);
                console.log(\`   üìä Progresso: \${dadosInspecoes.length}/\${totalCount}\`);
            }
            console.log('\\nüéâ EXTRA√á√ÉO DE INSPE√á√ïES ROTINEIRAS CONCLU√çDA!\\n');
            exibirEstatisticasInspecoes();
            
        } catch (error) {
            console.error('\\n‚ùå ERRO AO EXTRAIR INSPE√á√ïES:', error.message);
        }
    }
    /**
     * Exibe estat√≠sticas dos dados cadastrais coletados
     */
    function exibirEstatisticasCadastrais() {
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üìä ESTAT√çSTICAS - DADOS CADASTRAIS:');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log(\`   Total de OAEs: \${dadosCadastrais.length}\`);
        
        if (dadosCadastrais.length > 0) {
            console.log(\`   BRs √∫nicas: \${[...new Set(dadosCadastrais.map(item => item.br))].length}\`);
            console.log(\`   Estados: \${[...new Set(dadosCadastrais.map(item => item.uf))].length}\`);
            
            const porStatus = dadosCadastrais.reduce((acc, item) => {
                acc[item.status] = (acc[item.status] || 0) + 1;
                return acc;
            }, {});
            
            console.log('\\n   Status:');
            Object.entries(porStatus).forEach(([status, count]) => {
                console.log(\`     - \${status}: \${count}\`);
            });
        }
        
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\\n');
    }
    /**
     * Exibe estat√≠sticas das inspe√ß√µes rotineiras coletadas
     */
    function exibirEstatisticasInspecoes() {
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üìä ESTAT√çSTICAS - INSPE√á√ïES ROTINEIRAS:');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log(\`   Total de Inspe√ß√µes: \${dadosInspecoes.length}\`);
        
        if (dadosInspecoes.length > 0) {
            console.log(\`   BRs √∫nicas: \${[...new Set(dadosInspecoes.map(item => item.br))].length}\`);
            console.log(\`   Estados: \${[...new Set(dadosInspecoes.map(item => item.uf))].length}\`);
            
            const porStatus = dadosInspecoes.reduce((acc, item) => {
                acc[item.status] = (acc[item.status] || 0) + 1;
                return acc;
            }, {});
            
            console.log('\\n   Status:');
            Object.entries(porStatus).forEach(([status, count]) => {
                console.log(\`     - \${status}: \${count}\`);
            });
        }
        
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\\n');
    }
    /**
     * Configura fun√ß√µes de exporta√ß√£o e torna os dados acess√≠veis globalmente
     */
    function configurarExportacao() {
        // Torna os dados acess√≠veis globalmente
        window.dadosCadastrais = dadosCadastrais;
        window.dadosInspecoes = dadosInspecoes;
        
        // Exporta√ß√£o JSON
        window.downloadJSONCadastral = function() {
            const dataHora = gerarDataHoraFormatada();
            const dataStr = JSON.stringify(dadosCadastrais, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = \`OBRAS_APROVADAS_CADASTRAL_\${dataHora}.json\`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            console.log('‚úÖ Arquivo JSON CADASTRAL baixado!');
        };
        
        window.downloadJSONInspecoes = function() {
            const dataHora = gerarDataHoraFormatada();
            const dataStr = JSON.stringify(dadosInspecoes, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = \`OBRAS_APROVADAS_ROTINEIRA_\${dataHora}.json\`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            console.log('‚úÖ Arquivo JSON INSPE√á√ïES baixado!');
        };
        // Exporta√ß√£o CSV Individual
        window.downloadCSVCadastral = function() {
            const dataHora = gerarDataHoraFormatada();
            const headers = [
                'ID OAE',
                'Identifica√ß√£o',
                'Natureza Estrutura',
                'ID Natureza Estrutura',
                'CODIGO ESTRUTURA',
                'BR',
                'UF',
                'Status',
                'KM',
                'Nome Inspetor',
                'Nome Avaliador',
                'Data √öltima Atualiza√ß√£o'
            ];
            
            const rows = dadosCadastrais.map(item => [
                item.idOae || '',
                item.identificacaoObra || '',
                item.naturezaEstrutura || '',
                item.idNaturezaEstrutura || '',
                item.codigoSgo || '',
                item.br || '',
                item.uf || '',
                item.status || '',
                item.km || '',
                item.nomeInspetor || '',
                item.nomeAvaliador || '',
                item.dataUltimaAtualizacaoFormatada || ''
            ]);
            
            const csv = [headers, ...rows].map(row => row.map(cell => \`"\${cell}"\`).join(';')).join('\\n');
            const blob = new Blob(['\\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = \`OBRAS_APROVADAS_CADASTRAL_\${dataHora}.csv\`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            console.log('‚úÖ Arquivo CSV CADASTRAL baixado!');
        };
        window.downloadCSVInspecoes = function() {
            const dataHora = gerarDataHoraFormatada();
            const headers = [
                'ID OAE',
                'ID Inspe√ß√£o',
                'CODIGO ESTRUTURA',
                'Identifica√ß√£o',
                'BR',
                'UF',
                'KM',
                'Status',
                'Natureza Estrutura',
                'Nome Inspetor',
                'Nome Avaliador',
                'Data Inspe√ß√£o',
                'Data √öltima Atualiza√ß√£o'
            ];
            
            const rows = dadosInspecoes.map(item => [
                item.idOae || '',
                item.idInspecao || '',
                item.codigoEstrutura || '',
                item.identificacaoObra || '',
                item.br || '',
                item.uf || '',
                item.km || '',
                item.status || '',
                item.naturezaEstrutura || '',
                item.nomeInspetor || '',
                item.nomeAvaliador || '',
                item.dataInspecaoFormatada || '',
                item.dataUltimaAtualizacaoFormatada || ''
            ]);
            
            const csv = [headers, ...rows].map(row => row.map(cell => \`"\${cell}"\`).join(';')).join('\\n');
            const blob = new Blob(['\\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = \`OBRAS_APROVADAS_ROTINEIRA_\${dataHora}.csv\`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            console.log('‚úÖ Arquivo CSV INSPE√á√ïES baixado!');
        };
        // Download simult√¢neo de ambos os CSVs
        window.downloadTodosCSV = function() {
            const dataHora = gerarDataHoraFormatada();
            console.log('üì¶ Iniciando download simult√¢neo dos arquivos CSV...');
            
            // Preparar CSV Cadastral
            const headersCadastral = [
                'ID OAE',
                'Identifica√ß√£o',
                'Natureza Estrutura',
                'ID Natureza Estrutura',
                'CODIGO ESTRUTURA',
                'BR',
                'UF',
                'Status',
                'KM',
                'Nome Inspetor',
                'Nome Avaliador',
                'Data √öltima Atualiza√ß√£o'
            ];
            
            const rowsCadastral = dadosCadastrais.map(item => [
                item.idOae || '',
                item.identificacaoObra || '',
                item.naturezaEstrutura || '',
                item.idNaturezaEstrutura || '',
                item.codigoSgo || '',
                item.br || '',
                item.uf || '',
                item.status || '',
                item.km || '',
                item.nomeInspetor || '',
                item.nomeAvaliador || '',
                item.dataUltimaAtualizacaoFormatada || ''
            ]);
            
            // Preparar CSV Inspe√ß√µes
            const headersInspecoes = [
                'ID OAE',
                'ID Inspe√ß√£o',
                'CODIGO ESTRUTURA',
                'Identifica√ß√£o',
                'BR',
                'UF',
                'KM',
                'Status',
                'Natureza Estrutura',
                'Nome Inspetor',
                'Nome Avaliador',
                'Data Inspe√ß√£o',
                'Data √öltima Atualiza√ß√£o'
            ];
            
            const rowsInspecoes = dadosInspecoes.map(item => [
                item.idOae || '',
                item.idInspecao || '',
                item.codigoEstrutura || '',
                item.identificacaoObra || '',
                item.br || '',
                item.uf || '',
                item.km || '',
                item.status || '',
                item.naturezaEstrutura || '',
                item.nomeInspetor || '',
                item.nomeAvaliador || '',
                item.dataInspecaoFormatada || '',
                item.dataUltimaAtualizacaoFormatada || ''
            ]);
            
            // Criar e baixar CSV Cadastral
            const csvCadastral = [headersCadastral, ...rowsCadastral].map(row => row.map(cell => \`"\${cell}"\`).join(';')).join('\\n');
            const blobCadastral = new Blob(['\\uFEFF' + csvCadastral], { type: 'text/csv;charset=utf-8;' });
            const urlCadastral = URL.createObjectURL(blobCadastral);
            const linkCadastral = document.createElement('a');
            linkCadastral.href = urlCadastral;
            linkCadastral.download = \`OBRAS_APROVADAS_CADASTRAL_\${dataHora}.csv\`;
            document.body.appendChild(linkCadastral);
            
            // Criar e baixar CSV Inspe√ß√µes
            const csvInspecoes = [headersInspecoes, ...rowsInspecoes].map(row => row.map(cell => \`"\${cell}"\`).join(';')).join('\\n');
            const blobInspecoes = new Blob(['\\uFEFF' + csvInspecoes], { type: 'text/csv;charset=utf-8;' });
            const urlInspecoes = URL.createObjectURL(blobInspecoes);
            const linkInspecoes = document.createElement('a');
            linkInspecoes.href = urlInspecoes;
            linkInspecoes.download = \`OBRAS_APROVADAS_ROTINEIRA_\${dataHora}.csv\`;
            document.body.appendChild(linkInspecoes);
            
            // Executar os downloads em sequ√™ncia (com pequeno atraso para evitar problemas)
            setTimeout(() => {
                linkCadastral.click();
                setTimeout(() => {
                    linkInspecoes.click();
                    
                    // Limpar recursos
                    setTimeout(() => {
                        document.body.removeChild(linkCadastral);
                        document.body.removeChild(linkInspecoes);
                        URL.revokeObjectURL(urlCadastral);
                        URL.revokeObjectURL(urlInspecoes);
                    }, 100);
                    
                    console.log('‚úÖ Ambos os arquivos CSV baixados com sucesso!');
                }, 500);
            }, 100);
        };
        console.log('üíæ COMANDOS DE EXPORTA√á√ÉO:');
        console.log('   ‚Ä¢ downloadTodosCSV()        - ‚≠ê BAIXAR AMBOS OS CSVs AO MESMO TEMPO');
        console.log('   ‚Ä¢ downloadCSVCadastral()    - Baixar CSV com dados cadastrais');
        console.log('   ‚Ä¢ downloadCSVInspecoes()    - Baixar CSV com inspe√ß√µes rotineiras');
        console.log('   ‚Ä¢ downloadJSONCadastral()   - Baixar JSON de dados cadastrais');
        console.log('   ‚Ä¢ downloadJSONInspecoes()   - Baixar JSON de inspe√ß√µes rotineiras');
        console.log('   ‚Ä¢ dadosCadastrais           - Ver dados cadastrais no console');
        console.log('   ‚Ä¢ dadosInspecoes            - Ver inspe√ß√µes no console\\n');
    }
    /**
     * Inicia a extra√ß√£o de ambos os conjuntos de dados
     */
    async function iniciarExtracao() {
        try {
            console.log('üîÑ Iniciando extra√ß√£o de todos os dados...');
            
            // Dados cadastrais
            await extrairDadosCadastrais(bearerToken);
            
            // Inspe√ß√µes rotineiras
            await extrairDadosInspecoes(bearerToken);
            
            // Configura exporta√ß√£o ap√≥s concluir ambas as extra√ß√µes
            configurarExportacao();
            console.log('\\n‚úÖ EXTRA√á√ÉO COMPLETA! Use os comandos de exporta√ß√£o para baixar os dados.');
            console.log('‚≠ê DICA: Use downloadTodosCSV() para baixar ambos os arquivos CSV de uma vez!\\n');
        } catch (error) {
            console.error('\\n‚ùå ERRO NA EXTRA√á√ÉO:', error.message);
        }
    }
    /**
     * Fun√ß√£o global para extrair dados com um token fornecido manualmente
     * @param {string} token - Bearer token para autentica√ß√£o
     */
    window.extrairComToken = async function(token) {
        dadosCadastrais = [];
        dadosInspecoes = [];
        bearerToken = token.replace('Bearer ', '');
        await iniciarExtracao();
    };
    // Inicia o processo
    bearerToken = obterBearerToken();
    
    if (bearerToken) {
        console.log('üéØ Token encontrado! Iniciando...\\n');
        await iniciarExtracao();
    } else {
        console.log('‚ö†Ô∏è Token n√£o encontrado automaticamente\\n');
        console.log('üìã Execute: extrairComToken("SEU_TOKEN")');
    }
})();`;






/**
 * Exporta os dados cadastrais para um arquivo CSV
 * Utiliza o formato de nome de arquivo OBRAS_APROVADAS_CADASTRAL_DATA_HORA.csv
 */
window.downloadCSVCadastral = function() {
    const dataHora = gerarDataHoraFormatada();
    const headers = [
        'ID OAE',
        'Identifica√ß√£o',
        'Natureza Estrutura',
        'ID Natureza Estrutura',
        'C√≥digo SGO',
        'BR',
        'UF',
        'Status',
        'KM',
        'Nome Inspetor',
        'Nome Avaliador',
        'Data √öltima Atualiza√ß√£o'
    ];
    
    const rows = dadosCadastrais.map(item => [
        item.idOae || '',
        item.identificacaoObra || '',
        item.naturezaEstrutura || '',
        item.idNaturezaEstrutura || '',
        item.codigoEstrutura || '',
        item.br || '',
        item.uf || '',
        item.status || '',
        item.km || '',
        item.nomeInspetor || '',
        item.nomeAvaliador || '',
        item.dataUltimaAtualizacaoFormatada || ''
    ]);
    
    const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(';')).join('\n');
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `OBRAS_APROVADAS_CADASTRAL_${dataHora}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    console.log('‚úÖ Arquivo CSV CADASTRAL baixado!');
};



    </script>
</body>
</html>