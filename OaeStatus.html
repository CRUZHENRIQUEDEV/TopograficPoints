<!-- Vers√£o: 7.1 - Sistema completo de estat√≠sticas de reavalia√ß√£o com filtro por tipo -->
<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OAE Support</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
      /* Vers√£o: 7.0 - Estilo com suporte a reavalia√ß√µes */
      :root {
        --bg-color: #1e3d59;
        --text-color: #ffffff;
        --card-bg: rgba(255, 255, 255, 0.1);
        --highlight: #3498db;
        --success: #27ae60;
        --warning: #f39c12;
        --danger: #e74c3c;
        --info: #3498db;
        --purple: #9b59b6;
        --orange: #e67e22;
        --teal: #1abc9c;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: Arial, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        line-height: 1.6;
        padding: 20px;
      }

      .summary-container {
        margin-bottom: 20px;
      }

      .summary-content {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
      }

      .summary-section {
        flex: 1 0 200px;
      }

      .summary-section ul {
        list-style-type: none;
        padding-left: 10px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      header {
        text-align: center;
        margin-bottom: 30px;
      }

      h1 {
        font-size: 2rem;
        margin-bottom: 5px;
      }

      h2 {
        font-size: 1.5rem;
        margin-bottom: 15px;
      }

      h3 {
        font-size: 1.2rem;
        margin-bottom: 10px;
      }

      .card {
        background-color: var(--card-bg);
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      textarea {
        width: 100%;
        height: 200px;
        padding: 10px;
        background-color: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--text-color);
        border-radius: 4px;
        margin-bottom: 15px;
      }

      button {
        background-color: var(--highlight);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      }

      button:hover {
        opacity: 0.9;
      }

      button#exportBtn {
        background-color: var(--success);
      }

      button:disabled {
        background-color: #95a5a6;
        cursor: not-allowed;
      }

      .button-group {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .tabs {
        display: flex;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 2px;
      }

      .tab {
        padding: 10px 20px;
        background-color: rgba(255, 255, 255, 0.1);
        cursor: pointer;
        border-radius: 4px 4px 0 0;
      }

      .tab.active {
        background-color: rgba(255, 255, 255, 0.2);
        font-weight: bold;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }

      th,
      td {
        padding: 12px;
        text-align: left;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      th {
        background-color: rgba(255, 255, 255, 0.1);
        font-weight: bold;
      }

      tr:nth-child(even) {
        background-color: rgba(255, 255, 255, 0.03);
      }

      /* Status colors */
      .status-avaliacao {
        background-color: rgba(243, 156, 18, 0.2);
      }
      .status-aprovada {
        background-color: rgba(39, 174, 96, 0.2);
      }
      .status-reprovada {
        background-color: rgba(231, 76, 60, 0.2);
      }
      .status-reavaliacao {
        background-color: rgba(52, 152, 219, 0.2);
      }

      .filter-container {
        margin-bottom: 15px;
      }

      .filter-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 10px;
        align-items: center;
      }

      select,
      input[type="text"],
      input[type="date"] {
        padding: 10px;
        background-color: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--text-color);
        border-radius: 4px;
      }

      select {
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 16px;
        padding-right: 30px;
      }

      select option {
        background-color: var(--bg-color);
        color: var(--text-color);
      }

      .status-invalida {
        background-color: rgba(158, 20, 20, 0.3);
        position: relative;
      }

      .invalid-badge {
        background-color: #c0392b;
        color: white;
        padding: 2px 5px;
        border-radius: 3px;
        font-size: 0.8em;
        font-weight: bold;
      }

      .invalid-approval-warning {
        background-color: rgba(231, 76, 60, 0.2);
        padding: 10px;
        border-left: 4px solid #e74c3c;
        margin-bottom: 15px;
      }

      .invalid-approval {
        color: #e74c3c;
        font-weight: bold;
      }

      .charts-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 20px;
      }

      .chart-box {
        flex: 1 0 300px;
        background-color: rgba(255, 255, 255, 0.05);
        padding: 15px;
        border-radius: 8px;
        height: 300px;
        position: relative;
      }

      .chart-box.large {
        flex: 1 0 400px;
        height: 350px;
      }

      .chart-title {
        text-align: center;
        margin-bottom: 10px;
        font-weight: bold;
      }

      canvas {
        width: 100% !important;
        height: 220px !important;
        max-height: 220px !important;
      }

      .chart-box.large canvas {
        height: 270px !important;
        max-height: 270px !important;
      }

      .message-card {
        background-color: rgba(255, 255, 255, 0.05);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border-left: 3px solid var(--highlight);
      }

      .message-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-weight: bold;
      }

      .message-content {
        white-space: pre-wrap;
        margin-left: 15px;
        color: rgba(255, 255, 255, 0.8);
      }

      .missing-fields {
        background-color: rgba(231, 76, 60, 0.2);
        padding: 5px;
        border-radius: 4px;
        font-size: 0.9em;
      }

      /* Cards de estat√≠sticas */
      .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        border: 1px solid rgba(255,255,255,0.1);
      }

      .stat-card .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .stat-card .stat-label {
        font-size: 0.9rem;
        opacity: 0.8;
      }

      .stat-card.highlight-success .stat-value {
        color: var(--success);
      }

      .stat-card.highlight-warning .stat-value {
        color: var(--warning);
      }

      .stat-card.highlight-danger .stat-value {
        color: var(--danger);
      }

      .stat-card.highlight-info .stat-value {
        color: var(--info);
      }

      .stat-card.highlight-purple .stat-value {
        color: var(--purple);
      }

      /* Tabela de reavalia√ß√µes */
      .reav-table {
        font-size: 0.9rem;
      }

      .reav-table th {
        position: sticky;
        top: 0;
        background-color: #2c5282;
        z-index: 10;
      }

      .reav-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: bold;
        margin: 2px;
      }

      .reav-badge-1 { background-color: rgba(52, 152, 219, 0.3); }
      .reav-badge-2 { background-color: rgba(243, 156, 18, 0.3); }
      .reav-badge-3 { background-color: rgba(230, 126, 34, 0.3); }
      .reav-badge-4 { background-color: rgba(231, 76, 60, 0.3); }
      .reav-badge-5 { background-color: rgba(155, 89, 182, 0.3); }
      .reav-badge-6 { background-color: rgba(192, 57, 43, 0.4); }

      .status-final-aprovada {
        color: var(--success);
        font-weight: bold;
      }

      .status-final-reprovada {
        color: var(--danger);
        font-weight: bold;
      }

      .status-final-andamento {
        color: var(--warning);
        font-weight: bold;
      }

      /* Filtros de per√≠odo */
      .period-filter {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
      }

      .period-btn {
        padding: 8px 12px;
        background-color: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        color: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
      }

      .period-btn:hover {
        background-color: rgba(255,255,255,0.2);
      }

      .period-btn.active {
        background-color: var(--highlight);
        border-color: var(--highlight);
      }

      /* Modal */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.7);
      }

      .modal-content {
        background-color: var(--bg-color);
        margin: 5% auto;
        padding: 20px;
        border: 1px solid var(--highlight);
        border-radius: 8px;
        width: 90%;
        max-width: 900px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      }

      .close-modal {
        color: var(--text-color);
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close-modal:hover {
        color: var(--highlight);
      }

      .history-timeline {
        position: relative;
        padding-left: 30px;
        margin-top: 20px;
      }

      .history-timeline::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to bottom, var(--highlight), var(--purple));
      }

      .timeline-item {
        position: relative;
        padding: 15px;
        margin-bottom: 15px;
        background-color: rgba(255,255,255,0.05);
        border-radius: 8px;
        border-left: 3px solid var(--highlight);
      }

      .timeline-item::before {
        content: '';
        position: absolute;
        left: -24px;
        top: 20px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: var(--highlight);
        border: 2px solid var(--bg-color);
      }

      .timeline-item.status-aprovada-item::before {
        background-color: var(--success);
      }

      .timeline-item.status-reprovada-item::before {
        background-color: var(--danger);
      }

      .timeline-item.status-reavaliacao-item::before {
        background-color: var(--warning);
      }

      .timeline-date {
        font-size: 0.85rem;
        opacity: 0.7;
        margin-bottom: 5px;
      }

      .timeline-status {
        font-weight: bold;
        font-size: 1.1rem;
      }

      .timeline-sender {
        font-size: 0.9rem;
        opacity: 0.8;
      }

      /* Scrollable table container */
      .table-container {
        max-height: 500px;
        overflow-y: auto;
        border-radius: 8px;
      }

      @media (max-width: 768px) {
        .filter-row {
          flex-direction: column;
        }

        .chart-box {
          flex: 1 0 100%;
        }

        .stats-cards {
          grid-template-columns: repeat(2, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>OAE Support</h1>
        <p>Ferramenta de gera√ß√£o de estat√≠sticas de avalia√ß√£o de OAEs</p>
      </header>

      <div class="card">
        <div class="format-selector" style="margin-bottom: 15px;">
          <label for="dateFormatSelect">Formato de Data:</label>
          <select id="dateFormatSelect">
            <option value="auto">Detec√ß√£o Autom√°tica</option>
            <option value="DD/MM/YYYY">Dia/M√™s/Ano (DD/MM/YYYY)</option>
            <option value="MM/DD/YYYY">M√™s/Dia/Ano (MM/DD/YYYY)</option>
          </select>
          <span id="detectedFormat"></span>
        </div>

        <textarea
          id="whatsappText"
          placeholder="Cole aqui as mensagens exportadas do WhatsApp..."
        ></textarea>
        <div class="button-group">
          <button id="processBtn">Processar Mensagens</button>
          <button id="exportBtn" disabled>Exportar para CSV</button>
          <button id="exportReavBtn" disabled style="background-color: var(--purple);">Exportar Reavalia√ß√µes</button>
        </div>
      </div>

      <div class="tabs">
        <div class="tab active" data-tab="dados">Dados</div>
        <div class="tab" data-tab="estatisticas">Estat√≠sticas</div>
        <div class="tab" data-tab="reavaliacoes">Reavalia√ß√µes</div>
        <div class="tab" data-tab="despadronizadas">Despadronizadas</div>
      </div>

      <!-- Tab: Dados -->
      <div id="dados-tab" class="tab-content active">
        <div class="card">
          <div class="filter-container">
            <div class="filter-row">
              <select id="filterLote">
                <option value="">Todos os Lotes</option>
              </select>
              <select id="filterStatus">
                <option value="">Todos os Status</option>
              </select>
              <select id="filterTipo">
                <option value="">Todos os Tipos</option>
              </select>
              <input type="text" id="filterCodigo" placeholder="Filtrar por C√≥digo" />
            </div>

            <div class="filter-row">
              <label for="startDate">Data inicial:</label>
              <input type="text" id="startDate" placeholder="DD/MM/AAAA" />
              <label for="endDate">Data final:</label>
              <input type="text" id="endDate" placeholder="DD/MM/AAAA" />
              <button id="applyFiltersBtn">Aplicar Filtros</button>
              <button id="clearFiltersBtn">Limpar Filtros</button>
            </div>
          </div>

          <div class="summary-container">
            <h3>Sum√°rio dos Dados</h3>
            <div id="dataSummary" class="summary-content"></div>
          </div>

          <table id="resultTable">
            <thead>
              <tr>
                <th>Data</th>
                <th>Remetente</th>
                <th>Lote</th>
                <th>C√≥digo OAE</th>
                <th>Tipo de Inspe√ß√£o</th>
                <th>Data de Entrega/Envio</th>
                <th>Data de Recebimento</th>
                <th>Data de Devolu√ß√£o/Retorno</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="9" style="text-align: center">
                  Nenhum dado processado. Cole as mensagens e clique em "Processar".
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Tab: Estat√≠sticas -->
      <div id="estatisticas-tab" class="tab-content">
        <div class="card">
          <div class="filter-container stats-filter">
            <div class="filter-row">
              <select id="statsTipoFilter">
                <option value="">Todos os Tipos de Inspe√ß√£o</option>
                <option value="CADASTRAL">CADASTRAL</option>
                <option value="ROTINEIRA">ROTINEIRA</option>
                <option value="CORRE√á√ÉO DE CADASTRO">CORRE√á√ÉO DE CADASTRO</option>
              </select>
              <select id="statsLoteFilter">
                <option value="">Todos os Lotes</option>
              </select>
              <button id="applyStatsFiltersBtn">Aplicar Filtros</button>
              <button id="clearStatsFiltersBtn">Limpar Filtros</button>
            </div>
          </div>
          
          <div id="statsFilterInfo"><h3>Estat√≠sticas</h3></div>
          
          <div class="charts-container">
            <div class="chart-box">
              <div class="chart-title">Quantidade por Status</div>
              <canvas id="statusChart"></canvas>
            </div>
            <div class="chart-box">
              <div class="chart-title">Reprova√ß√µes por C√≥digo OAE</div>
              <canvas id="reprovacaoChart"></canvas>
            </div>
          </div>
          <div class="charts-container">
            <div class="chart-box">
              <div class="chart-title">Quem mais Aprova</div>
              <canvas id="aprovadorChart"></canvas>
            </div>
            <div class="chart-box">
              <div class="chart-title">Quem mais Reprova</div>
              <canvas id="reprovadorChart"></canvas>
            </div>
          </div>
          <div class="charts-container">
            <div class="chart-box">
              <div class="chart-title">Tempo M√©dio de Avalia√ß√£o (Dias)</div>
              <canvas id="tempoChart"></canvas>
            </div>
            <div class="chart-box">
              <div class="chart-title">Tipo de Inspe√ß√£o</div>
              <canvas id="tipoChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab: Reavalia√ß√µes (NOVA) -->
      <div id="reavaliacoes-tab" class="tab-content">
        <div class="card">
          <h2>üìä Dashboard de Reavalia√ß√µes</h2>
          
          <!-- Filtros de per√≠odo -->
          <div class="filter-container">
            <div class="filter-row">
              <span style="margin-right: 10px;">Per√≠odo:</span>
              <div class="period-filter">
                <button class="period-btn active" data-period="all">Todos</button>
                <button class="period-btn" data-period="week">√öltima Semana</button>
                <button class="period-btn" data-period="month">√öltimo M√™s</button>
                <button class="period-btn" data-period="quarter">√öltimo Trimestre</button>
                <button class="period-btn" data-period="year">√öltimo Ano</button>
              </div>
            </div>
            <div class="filter-row">
              <label>De:</label>
              <input type="text" id="reavStartDate" placeholder="DD/MM/AAAA" />
              <label>At√©:</label>
              <input type="text" id="reavEndDate" placeholder="DD/MM/AAAA" />
              <select id="reavTipoFilter">
                <option value="">Todos os Tipos</option>
                <option value="CADASTRAL">CADASTRAL</option>
                <option value="ROTINEIRA">ROTINEIRA</option>
                <option value="CORRE√á√ÉO DE CADASTRO">CORRE√á√ÉO DE CADASTRO</option>
              </select>
              <select id="reavLoteFilter">
                <option value="">Todos os Lotes</option>
              </select>
              <button id="applyReavFiltersBtn">Aplicar</button>
              <button id="clearReavFiltersBtn">Limpar</button>
            </div>
          </div>

          <!-- Cards de estat√≠sticas -->
          <div class="stats-cards" id="reavStatsCards">
            <div class="stat-card highlight-info">
              <div class="stat-value" id="totalObrasAvaliadas">0</div>
              <div class="stat-label">Obras Avaliadas</div>
            </div>
            <div class="stat-card highlight-warning">
              <div class="stat-value" id="totalObrasReavaliadas">0</div>
              <div class="stat-label">Obras Reavaliadas</div>
            </div>
            <div class="stat-card highlight-danger">
              <div class="stat-value" id="totalReavaliacoes">0</div>
              <div class="stat-label">Total de Reavalia√ß√µes</div>
            </div>
            <div class="stat-card highlight-purple">
              <div class="stat-value" id="mediaReavPorObra">0</div>
              <div class="stat-label">M√©dia Reav/Obra</div>
            </div>
            <div class="stat-card highlight-success">
              <div class="stat-value" id="taxaAprovacaoFinal">0%</div>
              <div class="stat-label">Taxa Aprova√ß√£o Final</div>
            </div>
          </div>

          <!-- Gr√°ficos de reavalia√ß√£o -->
          <div class="charts-container">
            <div class="chart-box large">
              <div class="chart-title">Distribui√ß√£o: Obras por N√∫mero de Reavalia√ß√µes</div>
              <canvas id="distribuicaoReavChart"></canvas>
            </div>
            <div class="chart-box large">
              <div class="chart-title">Funil de Reavalia√ß√£o</div>
              <canvas id="funilReavChart"></canvas>
            </div>
          </div>

          <div class="charts-container">
            <div class="chart-box">
              <div class="chart-title">Top 10 Obras Mais Reavaliadas</div>
              <canvas id="topObrasReavChart"></canvas>
            </div>
            <div class="chart-box">
              <div class="chart-title">Taxa de Aprova√ß√£o por Ciclo</div>
              <canvas id="taxaAprovacaoCicloChart"></canvas>
            </div>
          </div>

          <div class="charts-container">
            <div class="chart-box large">
              <div class="chart-title">Evolu√ß√£o de Reavalia√ß√µes por M√™s</div>
              <canvas id="evolucaoReavChart"></canvas>
            </div>
            <div class="chart-box">
              <div class="chart-title">Reavalia√ß√µes por Lote</div>
              <canvas id="reavPorLoteChart"></canvas>
            </div>
          </div>

          <div class="charts-container">
            <div class="chart-box large">
              <div class="chart-title">Reavalia√ß√µes por Tipo de Inspe√ß√£o</div>
              <canvas id="reavPorTipoChart"></canvas>
            </div>
            <div class="chart-box">
              <div class="chart-title">Distribui√ß√£o por Tipo (com Reavalia√ß√£o)</div>
              <canvas id="distribuicaoTipoReavChart"></canvas>
            </div>
          </div>

          <!-- Tabela detalhada -->
          <h3 style="margin-top: 30px; margin-bottom: 15px;">üìã Detalhamento por Obra</h3>
          <div class="table-container">
            <table class="reav-table" id="reavTable">
              <thead>
                <tr>
                  <th>C√≥digo OAE</th>
                  <th>Lote</th>
                  <th>Tipo</th>
                  <th>Total Registros</th>
                  <th>N¬∫ Reavalia√ß√µes</th>
                  <th>Status Final</th>
                  <th>Primeira Data</th>
                  <th>√öltima Data</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="9" style="text-align: center">Nenhum dado processado.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Tab: Despadronizadas -->
      <div id="despadronizadas-tab" class="tab-content">
        <div class="card">
          <h2>Mensagens com Formato Irregular</h2>
          <p>Abaixo est√£o listadas mensagens que n√£o seguem completamente o padr√£o esperado:</p>
          <div id="irregularMessages">
            <p>Nenhuma mensagem irregular encontrada.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para hist√≥rico da OAE -->
    <div id="oaeHistoryModal" class="modal">
      <div class="modal-content">
        <span class="close-modal" id="closeHistoryModal">&times;</span>
        <h2 id="modalOAETitle">Hist√≥rico da OAE</h2>
        <div id="modalOAEInfo" style="margin-bottom: 20px;"></div>
        <div id="modalOAEHistory" class="history-timeline"></div>
      </div>
    </div>

    <script>
      // Vers√£o: 7.1 - Script completo com sistema de reavalia√ß√µes e filtro por tipo

      // Vari√°veis globais
      let processedData = [];
      let irregularData = [];
      let oaeGroupedData = {}; // Dados agrupados por c√≥digo OAE
      let detectedDateFormat = "DD/MM/YYYY";
      let userSelectedFormat = "auto";

      // Carregar configura√ß√£o salva
      if (localStorage.getItem("oaePreferredDateFormat")) {
        userSelectedFormat = localStorage.getItem("oaePreferredDateFormat");
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Definir formato salvo
        document.getElementById("dateFormatSelect").value = userSelectedFormat;

        // Event listeners principais
        document.getElementById("dateFormatSelect").addEventListener("change", function() {
          userSelectedFormat = this.value;
          localStorage.setItem("oaePreferredDateFormat", userSelectedFormat);
          if (processedData.length > 0) {
            updateTable();
          }
        });

        document.getElementById("processBtn").addEventListener("click", processMessages);
        document.getElementById("exportBtn").addEventListener("click", exportToCSV);
        document.getElementById("exportReavBtn").addEventListener("click", exportReavaliacoesToCSV);
        document.getElementById("applyFiltersBtn").addEventListener("click", applyFilters);
        document.getElementById("clearFiltersBtn").addEventListener("click", clearFilters);
        document.getElementById("applyStatsFiltersBtn").addEventListener("click", applyStatsFilters);
        document.getElementById("clearStatsFiltersBtn").addEventListener("click", clearStatsFilters);
        document.getElementById("applyReavFiltersBtn").addEventListener("click", applyReavFilters);
        document.getElementById("clearReavFiltersBtn").addEventListener("click", clearReavFilters);

        // Tabs
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.addEventListener("click", () => {
            document.querySelectorAll(".tab").forEach((t) => t.classList.remove("active"));
            document.querySelectorAll(".tab-content").forEach((t) => t.classList.remove("active"));
            tab.classList.add("active");
            document.getElementById(tab.dataset.tab + "-tab").classList.add("active");

            if (tab.dataset.tab === "estatisticas" && processedData.length > 0) {
              updateCharts();
            }
            if (tab.dataset.tab === "reavaliacoes" && processedData.length > 0) {
              updateReavaliacoesTab();
            }
          });
        });

        // Bot√µes de per√≠odo
        document.querySelectorAll(".period-btn").forEach((btn) => {
          btn.addEventListener("click", function() {
            document.querySelectorAll(".period-btn").forEach((b) => b.classList.remove("active"));
            this.classList.add("active");
            applyPeriodFilter(this.dataset.period);
          });
        });

        // Modal
        document.getElementById("closeHistoryModal").addEventListener("click", function() {
          document.getElementById("oaeHistoryModal").style.display = "none";
        });

        window.addEventListener("click", function(event) {
          const modal = document.getElementById("oaeHistoryModal");
          if (event.target === modal) {
            modal.style.display = "none";
          }
        });
      });

      // ==========================================
      // FUN√á√ïES DE NORMALIZA√á√ÉO (MELHORADAS)
      // ==========================================

      function normalizeText(text) {
        if (!text) return "";
        return text
          .toString()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .toLowerCase()
          .trim();
      }

      function normalizeLote(lote) {
        if (!lote) return "";
        const trimmedLote = lote.trim();
        if (/^\d+$/.test(trimmedLote)) {
          return parseInt(trimmedLote, 10).toString();
        }
        return trimmedLote;
      }

      function normalizeTipoInspecao(tipo) {
        if (!tipo) return "";
        const normalized = normalizeText(tipo);

        if (normalized.includes("cadastral") || normalized.includes("cadstral") || 
            normalized.includes("cdastral") || normalized.includes("cadatral") ||
            normalized.includes("cadastrais")) {
          return "CADASTRAL";
        }

        if (normalized.includes("rotineira") || normalized.includes("rotinera") || 
            normalized.includes("rotineirra") || normalized.includes("rotinieira")) {
          return "ROTINEIRA";
        }

        if (normalized.includes("correcao") || normalized.includes("corre√ß√£o") || 
            normalized.includes("retificacao") || normalized.includes("retifica√ß√£o")) {
          return "CORRE√á√ÉO DE CADASTRO";
        }

        return tipo.toUpperCase();
      }

      // FUN√á√ÉO MELHORADA: Normaliza√ß√£o de status com detec√ß√£o ampliada de reavalia√ß√µes
      function normalizeStatus(status) {
        if (!status) return "";

        // Remover caracteres especiais e normalizar
        let normalized = normalizeText(status).replace(/\s+/g, " ").trim();
        let original = status.trim().toUpperCase();

        // Tratar strings truncadas
        if (status.endsWith("AVALIAC") || status.endsWith("AVALIAC√É") || status.endsWith("AVALIACA")) {
          return "AVALIA√á√ÉO";
        }

        // ========================================
        // DETEC√á√ÉO AMPLIADA DE REAVALIA√á√ÉO
        // ========================================

        // Padr√£o 1: N√∫meros seguidos de "reavalia√ß√£o" ou varia√ß√µes
        // Ex: "1¬™ reavalia√ß√£o", "2a reavaliacao", "3¬∞ reavalia√ßao", "4 reavalia√ß√£o"
        const reavaliacaoNumeroMatch = normalized.match(
          /^(\d+)[¬™¬∫a¬∞]?\s*r?e?[-\s]?a?v?a?l?i?a?[c√ß]?[a√£]?o?$/i
        );
        if (reavaliacaoNumeroMatch) {
          return `${reavaliacaoNumeroMatch[1]}¬™ REAVALIA√á√ÉO`;
        }

        // Padr√£o 2: Apenas n√∫mero (1, 2, 3...) que representa reavalia√ß√£o
        if (/^[1-9]$/.test(normalized)) {
          return `${normalized}¬™ REAVALIA√á√ÉO`;
        }

        // Padr√£o 3: "reavalia√ß√£o" com n√∫mero no final
        // Ex: "reavalia√ß√£o 1", "reav 2", "re-avalia√ß√£o 3"
        const reavaliacaoFinalMatch = normalized.match(
          /^r?e?[-\s]?a?v?a?l?i?a?[c√ß]?[a√£]?o?\s*(\d+)$/i
        );
        if (reavaliacaoFinalMatch) {
          return `${reavaliacaoFinalMatch[1]}¬™ REAVALIA√á√ÉO`;
        }

        // Padr√£o 4: N√∫meros por extenso
        const numerosExtenso = {
          'primeira': '1', 'primeiro': '1', 'um': '1', 'uma': '1',
          'segunda': '2', 'segundo': '2', 'dois': '2', 'duas': '2',
          'terceira': '3', 'terceiro': '3', 'tres': '3', 'tr√™s': '3',
          'quarta': '4', 'quarto': '4', 'quatro': '4',
          'quinta': '5', 'quinto': '5', 'cinco': '5',
          'sexta': '6', 'sexto': '6', 'seis': '6',
          'setima': '7', 'setimo': '7', 'sete': '7',
          'oitava': '8', 'oitavo': '8', 'oito': '8',
          'nona': '9', 'nono': '9', 'nove': '9',
          'decima': '10', 'decimo': '10', 'dez': '10'
        };

        for (const [extenso, numero] of Object.entries(numerosExtenso)) {
          if (normalized.includes(extenso) && 
              (normalized.includes('reav') || normalized.includes('avalia'))) {
            return `${numero}¬™ REAVALIA√á√ÉO`;
          }
        }

        // Padr√£o 5: Varia√ß√µes de digita√ß√£o de "reavalia√ß√£o" sem n√∫mero (considera como 1¬™)
        const variacoesReavaliacao = [
          'reavaliacao', 'reavalia√ßao', 'reavaliac√£o', 'reavalia√ß√£o',
          're-avaliacao', 're-avalia√ß√£o', 're avaliacao', 're avalia√ß√£o',
          'reav', 'reavalia', 'reaval', 'reavali',
          'reavalia√ßa', 'reavalia√ß', 'reavaliaca',
          'reavlia√ßao', 'reaavalia√ßao', 'reavallia√ßao', 'reavalia√ß√£oo',
          'reavali√ßao', 'reavaliaco', 'revalia√ßao', 'reava√ßao',
          'reavliacoa', 'reavalizacao', 'reavalidacao'
        ];

        for (const variacao of variacoesReavaliacao) {
          if (normalized.includes(variacao)) {
            // Verificar se tem n√∫mero antes ou depois
            const matchNum = normalized.match(/(\d+)/);
            if (matchNum) {
              return `${matchNum[1]}¬™ REAVALIA√á√ÉO`;
            }
            return "REAVALIA√á√ÉO";
          }
        }

        // ========================================
        // OUTROS STATUS
        // ========================================

        // Padr√µes para cada tipo de status
        const statusPatterns = {
          APROVADA: ["aprovad", "aprovacao", "aprova√ß√£o", "liberada", "aceita"],
          REPROVADA: ["reprovad", "reprovacao", "rejeitad", "desaprovad", "nao aprovad", "n√£o aprovad"],
          AVALIA√á√ÉO: ["avaliaca", "avaliac", "avalia√ß√£o", "analise", "an√°lise", "em analise", "em an√°lise"],
          "OBRA AGUARDANDO DRONE": ["aguardando", "drone", "fotos"],
          "CORRE√á√ÉO CADASTRAL": ["correcao cadastr", "corre√ß√£o cadastr", "retifica"]
        };

        for (const [padrao, variantes] of Object.entries(statusPatterns)) {
          for (const variante of variantes) {
            if (normalized.includes(variante)) {
              return padrao;
            }
          }
        }

        return status.toUpperCase();
      }

      // Fun√ß√£o para verificar se um status √© reavalia√ß√£o
      function isReavaliacao(status) {
        if (!status) return false;
        const normalized = normalizeStatus(status);
        return normalized.includes("REAVALIA√á√ÉO");
      }

      // Fun√ß√£o para extrair n√∫mero da reavalia√ß√£o
      function extractNumeroReavaliacao(status) {
        if (!status) return 0;
        const normalized = normalizeStatus(status);
        const match = normalized.match(/(\d+)¬™?\s*REAVALIA√á√ÉO/i);
        if (match) {
          return parseInt(match[1], 10);
        }
        if (normalized === "REAVALIA√á√ÉO") {
          return 1;
        }
        return 0;
      }

      // ==========================================
      // FUN√á√ïES DE DATA
      // ==========================================

      function detectDateFormat(messages) {
        if (userSelectedFormat !== "auto") {
          return userSelectedFormat;
        }

        for (const message of messages) {
          if (message.data) {
            const bracketMatch = message.data.match(/\[(\d{1,2})\/(\d{1,2})\/(\d{2,4})/);
            if (bracketMatch) {
              const firstNumber = parseInt(bracketMatch[1], 10);
              const secondNumber = parseInt(bracketMatch[2], 10);
              if (firstNumber > 12 && secondNumber <= 12) return "DD/MM/YYYY";
              if (secondNumber > 12 && firstNumber <= 12) return "MM/DD/YYYY";
            }

            const datePart = message.data.split(" ")[0];
            if (datePart.includes("/")) {
              const parts = datePart.split("/");
              if (parts.length === 3) {
                const firstNumber = parseInt(parts[0], 10);
                const secondNumber = parseInt(parts[1], 10);
                if (firstNumber > 12 && secondNumber <= 12) return "DD/MM/YYYY";
                if (secondNumber > 12 && firstNumber <= 12) return "MM/DD/YYYY";
              }
            }
          }
        }
        return "DD/MM/YYYY";
      }

      function parseComplexDate(dateStr) {
        if (!dateStr) return null;
        dateStr = dateStr.trim();

        const dmyMatch = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
        if (dmyMatch) {
          const day = parseInt(dmyMatch[1], 10);
          const month = parseInt(dmyMatch[2], 10) - 1;
          const year = parseInt(dmyMatch[3], 10);
          if (detectedDateFormat === "MM/DD/YYYY") {
            return new Date(year, day - 1, month + 1);
          }
          return new Date(year, month, day);
        }

        const dmyShortMatch = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2})$/);
        if (dmyShortMatch) {
          const day = parseInt(dmyShortMatch[1], 10);
          const month = parseInt(dmyShortMatch[2], 10) - 1;
          let year = parseInt(dmyShortMatch[3], 10);
          year = year < 50 ? 2000 + year : 1900 + year;
          if (detectedDateFormat === "MM/DD/YYYY") {
            return new Date(year, day - 1, month + 1);
          }
          return new Date(year, month, day);
        }

        const isoMatch = dateStr.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
        if (isoMatch) {
          return new Date(parseInt(isoMatch[1], 10), parseInt(isoMatch[2], 10) - 1, parseInt(isoMatch[3], 10));
        }

        return null;
      }

      function extractDateFromMessage(dateString) {
        if (!dateString) return null;

        let datePart = null;
        const bracketMatch = dateString.match(/\[(\d{1,2}\/\d{1,2}\/\d{2,4}),/);
        if (bracketMatch) {
          datePart = bracketMatch[1];
        } else if (dateString.includes("/")) {
          datePart = dateString.split(" ")[0];
        }

        if (datePart) {
          return parseComplexDate(datePart);
        }
        return null;
      }

      function formatDateBR(dateStr) {
        if (!dateStr) return "";
        if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) return dateStr;
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
          const parts = dateStr.split("-");
          return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }
        return dateStr;
      }

      function formatDateBrazilian(dateObj) {
        if (!dateObj || !(dateObj instanceof Date) || isNaN(dateObj.getTime())) return "";
        const day = String(dateObj.getDate()).padStart(2, "0");
        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
        const year = dateObj.getFullYear();
        return `${day}/${month}/${year}`;
      }

      function formatMessageDateBrazilian(dateString) {
        if (!dateString) return "";

        let datePart = "";
        let timePart = "";

        const bracketMatch = dateString.match(/\[(\d{1,2}\/\d{1,2}\/\d{2,4}),\s*(\d{1,2}:\d{2}(?::\d{2})?)\]/);
        if (bracketMatch) {
          datePart = bracketMatch[1];
          timePart = bracketMatch[2];
        } else if (dateString.includes("/")) {
          const parts = dateString.split(" ");
          datePart = parts[0];
          timePart = parts.length > 1 ? parts[1] : "";
        }

        if (datePart) {
          const parts = datePart.split("/");
          if (parts.length === 3) {
            if (detectedDateFormat === "MM/DD/YYYY") {
              const month = parts[0];
              const day = parts[1];
              const year = parts[2].length === 2 
                ? (parseInt(parts[2]) < 50 ? "20" + parts[2] : "19" + parts[2]) 
                : parts[2];
              return `${day}/${month}/${year}${timePart ? " " + timePart : ""}`;
            }
          }
        }
        return dateString;
      }

      function sortMessagesByDate(messages) {
        return messages.sort((a, b) => {
          const dateA = extractDateFromMessage(a.data);
          const dateB = extractDateFromMessage(b.data);
          if (dateA && dateB) return dateB - dateA;
          return (b.data || "").localeCompare(a.data || "");
        });
      }

      // ==========================================
      // PROCESSAMENTO DE MENSAGENS
      // ==========================================

      function processMessages() {
        const text = document.getElementById("whatsappText").value.trim();
        if (!text) {
          alert("Por favor, cole o texto das conversas do WhatsApp.");
          return;
        }

        processedData = [];
        irregularData = [];
        oaeGroupedData = {};

        document.querySelector("#resultTable tbody").innerHTML =
          '<tr><td colspan="9" style="text-align: center;">Processando...</td></tr>';

        const lines = text.split("\n");
        let currentMessage = null;
        let currentText = "";
        let isProcessingMessage = false;

        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line || isSystemMessage(line)) continue;

          const bracketDateMatch = line.match(
            /^\[(\d{1,2}\/\d{1,2}\/\d{2,4}),\s*(\d{1,2}:\d{2}(?::\d{2})?)\]\s*(.+?):\s*(.*)$/
          );

          const standardDateMatch = line.match(
            /^(\d{1,2}\/\d{1,2}\/\d{4})\s+(\d{1,2}:\d{2}(?::\d{2})?)\s*-\s*(.+?):\s*(.*)$/
          );

          if (bracketDateMatch || standardDateMatch) {
            if (isProcessingMessage && currentMessage) {
              checkAndSaveMessage(currentMessage, currentText);
            }

            const match = bracketDateMatch || standardDateMatch;
            currentMessage = {
              data: `${match[1]} ${match[2]}`,
              remetente: match[3],
              lote: "",
              codigoOAE: "",
              tipoInspecao: "",
              dataEntrega: "",
              dataRecebimento: "",
              dataDevolucao: "",
              status: "",
            };

            currentText = match[4];
            isProcessingMessage = true;
            extractData(match[4], currentMessage);
          } else if (isProcessingMessage && currentMessage) {
            currentText += "\n" + line;
            extractData(line, currentMessage);
          }
        }

        if (isProcessingMessage && currentMessage) {
          checkAndSaveMessage(currentMessage, currentText);
        }

        detectedDateFormat = detectDateFormat(processedData);
        processedData = sortMessagesByDate(processedData);

        // Agrupar dados por OAE
        groupDataByOAE();

        // Atualizar interface
        updateTable();
        updateFilterOptions();
        updateIrregularMessages();
        initializeDateFilters();
        initializeStatsFilters();
        initializeReavFilters();

        // Habilitar bot√µes de exporta√ß√£o
        document.getElementById("exportBtn").disabled = processedData.length === 0;
        document.getElementById("exportReavBtn").disabled = processedData.length === 0;

        console.log(`Processadas: ${processedData.length}, Irregulares: ${irregularData.length}, OAEs: ${Object.keys(oaeGroupedData).length}`);
      }

      function isSystemMessage(line) {
        return (
          line.includes("As mensagens e liga√ß√µes s√£o protegidas") ||
          line.includes("criou o grupo") ||
          line.includes("adicionou voc√™") ||
          line.includes("mudou a descri√ß√£o do grupo") ||
          line.includes("mudou o assunto") ||
          line.match(/^‚Äé/) !== null
        );
      }

      function extractData(text, message) {
        extractLote(text, message);
        extractCodigoOAE(text, message);
        extractTipoInspecao(text, message);
        extractDatas(text, message);
        extractStatus(text, message);
      }

      function extractLote(text, message) {
        const loteMatch = text.match(/Lote:?\s*(\d+)/i) || text.match(/Lote\s*(\d+)/i);
        if (loteMatch) {
          message.lote = normalizeLote(loteMatch[1]);
        }
      }

      function extractCodigoOAE(text, message) {
        const codigoMatch =
          text.match(/C√≥digo OAE:?\s*([0-9\/]+)/i) ||
          text.match(/C√≥digo\s*(?:da)?\s*OAE:?\s*([0-9\/]+)/i) ||
          text.match(/OAE:?\s*([0-9\/]+)/i);
        if (codigoMatch) {
          message.codigoOAE = codigoMatch[1].trim();
        }
      }

      function extractTipoInspecao(text, message) {
        const tipoMatch =
          text.match(/Tipo de Inspe√ß√£o:?\s*([A-Za-z√Ä-√∫\s]+)/i) ||
          text.match(/Tipo\s*(?:de)?\s*Inspe√ß√£o:?\s*([A-Za-z√Ä-√∫\s]+)/i);

        if (tipoMatch) {
          message.tipoInspecao = normalizeTipoInspecao(tipoMatch[1].trim());
        } else if (text.includes("Cadastral") || text.includes("CADASTRAL") || text.includes("Cdastral")) {
          message.tipoInspecao = "CADASTRAL";
        } else if (text.includes("Rotineira") || text.includes("ROTINEIRA")) {
          message.tipoInspecao = "ROTINEIRA";
        } else if (text.includes("Corre√ß√£o de Cadastro") || text.includes("CORRE√á√ÉO DE CADASTRO")) {
          message.tipoInspecao = "CORRE√á√ÉO DE CADASTRO";
        }
      }

      function extractDatas(text, message) {
        const dataEntregaMatch =
          text.match(/Data de [Ee]ntrega:?\s*(\d{2}\/\d{2}\/\d{4})/) ||
          text.match(/Data de [Ee]nvio:?\s*(\d{2}\/\d{2}\/\d{4})/);
        if (dataEntregaMatch) message.dataEntrega = dataEntregaMatch[1];

        const dataRecebimentoMatch = text.match(/Data de [Rr]ecebimento:?\s*(\d{2}\/\d{2}\/\d{4})/);
        if (dataRecebimentoMatch) message.dataRecebimento = dataRecebimentoMatch[1];

        const dataDevolucaoMatch =
          text.match(/Data de [Dd]evolu√ß√£o:?\s*(\d{2}\/\d{2}\/\d{4})/) ||
          text.match(/Data de [Rr]etorno:?\s*(\d{2}\/\d{2}\/\d{4})/);
        if (dataDevolucaoMatch) message.dataDevolucao = dataDevolucaoMatch[1];
      }

      function extractStatus(text, message) {
        const statusMatch = text.match(/Status:?\s*([A-Za-z√Ä-√∫\s0-9¬™¬∞<>-]+)(?:<|$)/i);

        if (statusMatch) {
          message.status = normalizeStatus(statusMatch[1].trim());
        } else if (text.toUpperCase().includes("APROVADA")) {
          message.status = "APROVADA";
        } else if (text.toUpperCase().includes("REPROVADA")) {
          message.status = "REPROVADA";
        } else if (text.toUpperCase().includes("AVALIA√á√ÉO") || text.includes("Avalia√ß√£o")) {
          message.status = "AVALIA√á√ÉO";
        } else if (text.toUpperCase().includes("REAVALIA√á√ÉO") || text.includes("Reavalia√ß√£o")) {
          message.status = normalizeStatus(text);
        } else if (text.match(/(\d+)[¬™a¬∞]?\s*[re]*avalia[c√ß][a√£]o/i)) {
          message.status = normalizeStatus(text);
        }
      }

      function checkAndSaveMessage(message, text) {
        message.textoOriginal = text;

        const missingFields = [];
        let fieldsCount = 0;

        if (message.lote) fieldsCount++; else missingFields.push("Lote");
        if (message.codigoOAE) fieldsCount++; else missingFields.push("C√≥digo OAE");
        if (message.tipoInspecao) fieldsCount++; else missingFields.push("Tipo de Inspe√ß√£o");
        if (message.status) fieldsCount++; else missingFields.push("Status");

        if (fieldsCount >= 3) {
          processedData.push(message);
        }

        if (fieldsCount < 3) {
          irregularData.push({
            data: message.data,
            remetente: message.remetente,
            texto: text,
            camposFaltantes: missingFields.join(", "),
          });
        }
      }

      // ==========================================
      // AGRUPAMENTO POR OAE
      // ==========================================

      function groupDataByOAE() {
        oaeGroupedData = {};

        processedData.forEach((message) => {
          if (!message.codigoOAE) return;

          const codigo = message.codigoOAE.trim();

          if (!oaeGroupedData[codigo]) {
            oaeGroupedData[codigo] = {
              codigoOAE: codigo,
              lote: message.lote || "",
              tipoInspecao: message.tipoInspecao || "",
              historico: [],
              totalReavaliacoes: 0,
              statusFinal: "",
              primeiraData: null,
              ultimaData: null
            };
          }

          // Adicionar ao hist√≥rico
          const dateObj = extractDateFromMessage(message.data);
          oaeGroupedData[codigo].historico.push({
            data: message.data,
            dateObj: dateObj,
            status: message.status,
            remetente: message.remetente,
            tipoInspecao: message.tipoInspecao
          });

          // Atualizar lote e tipo se n√£o tiver
          if (!oaeGroupedData[codigo].lote && message.lote) {
            oaeGroupedData[codigo].lote = message.lote;
          }
          if (!oaeGroupedData[codigo].tipoInspecao && message.tipoInspecao) {
            oaeGroupedData[codigo].tipoInspecao = message.tipoInspecao;
          }
        });

        // Ordenar hist√≥rico e calcular estat√≠sticas para cada OAE
        Object.values(oaeGroupedData).forEach((oae) => {
          // Ordenar hist√≥rico por data (mais antiga primeiro)
          oae.historico.sort((a, b) => {
            if (a.dateObj && b.dateObj) return a.dateObj - b.dateObj;
            return 0;
          });

          // Calcular total de reavalia√ß√µes
          oae.totalReavaliacoes = oae.historico.filter((h) => isReavaliacao(h.status)).length;

          // Tamb√©m contar o maior n√∫mero de reavalia√ß√£o encontrado
          let maxReav = 0;
          oae.historico.forEach((h) => {
            const num = extractNumeroReavaliacao(h.status);
            if (num > maxReav) maxReav = num;
          });
          oae.maiorReavaliacao = maxReav;

          // Determinar status final (√∫ltima entrada)
          if (oae.historico.length > 0) {
            oae.statusFinal = oae.historico[oae.historico.length - 1].status;
            oae.primeiraData = oae.historico[0].data;
            oae.ultimaData = oae.historico[oae.historico.length - 1].data;
          }
        });
      }

      // ==========================================
      // ATUALIZA√á√ÉO DA INTERFACE
      // ==========================================

      function updateTable(dataToShow = processedData) {
        const tbody = document.querySelector("#resultTable tbody");
        tbody.innerHTML = "";

        if (dataToShow.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Nenhum dado encontrado.</td></tr>';
          document.getElementById("dataSummary").innerHTML = "";
          return;
        }

        const summary = calculateSummary(dataToShow);
        updateSummaryDisplay(summary);

        const sortedData = sortMessagesByDate([...dataToShow]);

        sortedData.forEach((message) => {
          const row = document.createElement("tr");

          const isAprovacaoInvalida = normalizeLote(message.lote) === "1" && 
            normalizeStatus(message.status || "").includes("APROVADA");

          const statusLower = (message.status || "").toLowerCase();
          if (isAprovacaoInvalida) {
            row.classList.add("status-invalida");
          } else if (statusLower.includes("avalia√ß√£o") || statusLower.includes("avaliacao")) {
            row.classList.add("status-avaliacao");
          } else if (statusLower.includes("aprovada")) {
            row.classList.add("status-aprovada");
          } else if (statusLower.includes("reprovada")) {
            row.classList.add("status-reprovada");
          } else if (statusLower.includes("reavalia√ß√£o") || statusLower.includes("reavaliacao")) {
            row.classList.add("status-reavaliacao");
          }

          const formattedMessageDate = formatMessageDateBrazilian(message.data);
          const tipoInspecao = normalizeTipoInspecao(message.tipoInspecao || "");

          let statusDisplay = message.status || "";
          if (isAprovacaoInvalida) {
            statusDisplay += ' <span class="invalid-badge">INV√ÅLIDA</span>';
          }

          row.innerHTML = `
            <td>${formattedMessageDate || ""}</td>
            <td>${message.remetente || ""}</td>
            <td>${message.lote || ""}</td>
            <td>${message.codigoOAE || ""}</td>
            <td>${tipoInspecao || ""}</td>
            <td>${formatDateBR(message.dataEntrega) || ""}</td>
            <td>${formatDateBR(message.dataRecebimento) || ""}</td>
            <td>${formatDateBR(message.dataDevolucao) || ""}</td>
            <td>${statusDisplay}</td>
          `;

          tbody.appendChild(row);
        });
      }

      function calculateSummary(dataToShow) {
        const summary = {
          total: dataToShow.length,
          porStatus: {},
          porTipo: {},
          porLote: {},
          aprovacaoInvalida: 0,
        };

        dataToShow.forEach((message) => {
          const isAprovacaoInvalida = normalizeLote(message.lote) === "1" && 
            normalizeStatus(message.status || "").includes("APROVADA");

          if (isAprovacaoInvalida) summary.aprovacaoInvalida++;

          if (message.status) {
            if (isAprovacaoInvalida) {
              const invalidStatus = "APROVA√á√ÉO INV√ÅLIDA (LOTE 1)";
              summary.porStatus[invalidStatus] = (summary.porStatus[invalidStatus] || 0) + 1;
            } else {
              const status = normalizeStatus(message.status);
              summary.porStatus[status] = (summary.porStatus[status] || 0) + 1;
            }
          }

          if (message.tipoInspecao) {
            const tipo = normalizeTipoInspecao(message.tipoInspecao);
            summary.porTipo[tipo] = (summary.porTipo[tipo] || 0) + 1;
          }

          if (message.lote) {
            const normalizedLote = normalizeLote(message.lote);
            summary.porLote[normalizedLote] = (summary.porLote[normalizedLote] || 0) + 1;
          }
        });

        return summary;
      }

      function updateSummaryDisplay(summary) {
        const summaryContainer = document.getElementById("dataSummary");

        let html = `<p><strong>Total de Registros:</strong> ${summary.total}</p>`;

        if (summary.aprovacaoInvalida > 0) {
          html += `<p class="invalid-approval-warning"><strong>Aten√ß√£o:</strong> ${summary.aprovacaoInvalida} aprova√ß√µes inv√°lidas do Lote 1</p>`;
        }

        if (Object.keys(summary.porStatus).length > 0) {
          html += '<div class="summary-section"><strong>Por Status:</strong><ul>';
          Object.entries(summary.porStatus).forEach(([status, count]) => {
            if (status === "APROVA√á√ÉO INV√ÅLIDA (LOTE 1)") {
              html += `<li class="invalid-approval">${status}: ${count}</li>`;
            } else {
              html += `<li>${status}: ${count}</li>`;
            }
          });
          html += "</ul></div>";
        }

        if (Object.keys(summary.porTipo).length > 0) {
          html += '<div class="summary-section"><strong>Por Tipo de Inspe√ß√£o:</strong><ul>';
          Object.entries(summary.porTipo).forEach(([tipo, count]) => {
            html += `<li>${tipo}: ${count}</li>`;
          });
          html += "</ul></div>";
        }

        if (Object.keys(summary.porLote).length > 0) {
          html += '<div class="summary-section"><strong>Por Lote:</strong><ul>';
          const lotesOrdenados = Object.entries(summary.porLote).sort(([a], [b]) => parseInt(a, 10) - parseInt(b, 10));
          lotesOrdenados.forEach(([lote, count]) => {
            html += `<li>Lote ${lote}: ${count}</li>`;
          });
          html += "</ul></div>";
        }

        summaryContainer.innerHTML = html;
      }

      function updateFilterOptions() {
        const filterLote = document.getElementById("filterLote");
        const filterStatus = document.getElementById("filterStatus");
        const filterTipo = document.getElementById("filterTipo");

        filterLote.innerHTML = '<option value="">Todos os Lotes</option>';
        filterStatus.innerHTML = '<option value="">Todos os Status</option>';
        filterTipo.innerHTML = '<option value="">Todos os Tipos</option>';

        const lotesMap = new Map();
        const status = new Set();
        const tipos = new Set();

        processedData.forEach((message) => {
          if (message.lote) {
            const normalizedLote = normalizeLote(message.lote);
            if (!lotesMap.has(normalizedLote)) {
              lotesMap.set(normalizedLote, message.lote);
            }
          }
          if (message.status) status.add(normalizeStatus(message.status));
          if (message.tipoInspecao) tipos.add(normalizeTipoInspecao(message.tipoInspecao));
        });

        Array.from(lotesMap.keys())
          .sort((a, b) => parseInt(a, 10) - parseInt(b, 10))
          .forEach((lote) => {
            const option = document.createElement("option");
            option.value = lote;
            option.textContent = `Lote ${lote}`;
            filterLote.appendChild(option);
          });

        const statusOrdem = ["APROVADA", "REPROVADA", "AVALIA√á√ÉO", "REAVALIA√á√ÉO", 
          "1¬™ REAVALIA√á√ÉO", "2¬™ REAVALIA√á√ÉO", "3¬™ REAVALIA√á√ÉO", "4¬™ REAVALIA√á√ÉO", 
          "5¬™ REAVALIA√á√ÉO", "6¬™ REAVALIA√á√ÉO"];
        
        statusOrdem.forEach((st) => {
          if (status.has(st)) {
            const option = document.createElement("option");
            option.value = st;
            option.textContent = st;
            filterStatus.appendChild(option);
            status.delete(st);
          }
        });

        status.forEach((st) => {
          const option = document.createElement("option");
          option.value = st;
          option.textContent = st;
          filterStatus.appendChild(option);
        });

        const tiposOrdem = ["CADASTRAL", "ROTINEIRA", "CORRE√á√ÉO DE CADASTRO"];
        tiposOrdem.forEach((tipo) => {
          if (tipos.has(tipo)) {
            const option = document.createElement("option");
            option.value = tipo;
            option.textContent = tipo;
            filterTipo.appendChild(option);
            tipos.delete(tipo);
          }
        });

        tipos.forEach((tipo) => {
          const option = document.createElement("option");
          option.value = tipo;
          option.textContent = tipo;
          filterTipo.appendChild(option);
        });
      }

      function updateIrregularMessages() {
        const container = document.getElementById("irregularMessages");
        container.innerHTML = "";

        if (irregularData.length === 0) {
          container.innerHTML = "<p>Nenhuma mensagem irregular encontrada.</p>";
          return;
        }

        irregularData.forEach((message) => {
          const messageElement = document.createElement("div");
          messageElement.className = "message-card";
          messageElement.innerHTML = `
            <div class="message-header">
              <span>${message.data} - ${message.remetente}</span>
              <span class="missing-fields">Campos faltantes: ${message.camposFaltantes}</span>
            </div>
            <div class="message-content">${message.texto}</div>
          `;
          container.appendChild(messageElement);
        });
      }

      function initializeDateFilters() {
        if (processedData.length === 0) return;

        let earliestDate = new Date();
        let latestDate = new Date(0);

        processedData.forEach((message) => {
          if (message.data) {
            const messageDate = extractDateFromMessage(message.data);
            if (messageDate) {
              if (messageDate < earliestDate) earliestDate = messageDate;
              if (messageDate > latestDate) latestDate = messageDate;
            }
          }
        });

        document.getElementById("startDate").value = formatDateBrazilian(earliestDate);
        document.getElementById("endDate").value = formatDateBrazilian(latestDate);
      }

      function initializeStatsFilters() {
        const statsLoteFilter = document.getElementById("statsLoteFilter");
        if (statsLoteFilter) {
          statsLoteFilter.innerHTML = '<option value="">Todos os Lotes</option>';
          const lotesMap = new Map();
          processedData.forEach((message) => {
            if (message.lote) {
              const normalizedLote = normalizeLote(message.lote);
              if (!lotesMap.has(normalizedLote)) {
                lotesMap.set(normalizedLote, message.lote);
              }
            }
          });

          Array.from(lotesMap.keys())
            .sort((a, b) => parseInt(a, 10) - parseInt(b, 10))
            .forEach((lote) => {
              const option = document.createElement("option");
              option.value = lote;
              option.textContent = `Lote ${lote}`;
              statsLoteFilter.appendChild(option);
            });
        }
      }

      function initializeReavFilters() {
        const reavLoteFilter = document.getElementById("reavLoteFilter");
        if (reavLoteFilter) {
          reavLoteFilter.innerHTML = '<option value="">Todos os Lotes</option>';
          const lotesMap = new Map();
          processedData.forEach((message) => {
            if (message.lote) {
              const normalizedLote = normalizeLote(message.lote);
              if (!lotesMap.has(normalizedLote)) {
                lotesMap.set(normalizedLote, message.lote);
              }
            }
          });

          Array.from(lotesMap.keys())
            .sort((a, b) => parseInt(a, 10) - parseInt(b, 10))
            .forEach((lote) => {
              const option = document.createElement("option");
              option.value = lote;
              option.textContent = `Lote ${lote}`;
              reavLoteFilter.appendChild(option);
            });
        }
      }

      // ==========================================
      // FILTROS
      // ==========================================

      function applyFilters() {
        const loteFilter = normalizeLote(document.getElementById("filterLote").value);
        const statusFilter = document.getElementById("filterStatus").value;
        const tipoFilter = document.getElementById("filterTipo").value;
        const codigoFilter = document.getElementById("filterCodigo").value.toLowerCase();
        const startDateStr = document.getElementById("startDate").value;
        const endDateStr = document.getElementById("endDate").value;

        let startDateValue = startDateStr ? parseComplexDate(startDateStr) : null;
        let endDateValue = endDateStr ? parseComplexDate(endDateStr) : null;

        if (endDateValue) {
          endDateValue.setHours(23, 59, 59, 999);
        }

        const filteredData = processedData.filter((message) => {
          const matchesText =
            (loteFilter === "" || normalizeLote(message.lote) === loteFilter) &&
            (statusFilter === "" || normalizeStatus(message.status) === statusFilter) &&
            (tipoFilter === "" || normalizeTipoInspecao(message.tipoInspecao) === tipoFilter) &&
            (codigoFilter === "" || (message.codigoOAE && message.codigoOAE.toLowerCase().includes(codigoFilter)));

          let matchesDate = true;
          if (startDateValue || endDateValue) {
            const messageDate = extractDateFromMessage(message.data);
            if (messageDate) {
              if (startDateValue && messageDate < startDateValue) matchesDate = false;
              if (endDateValue && messageDate > endDateValue) matchesDate = false;
            } else {
              matchesDate = false;
            }
          }

          return matchesText && matchesDate;
        });

        updateTable(filteredData);
      }

      function clearFilters() {
        document.getElementById("filterLote").value = "";
        document.getElementById("filterStatus").value = "";
        document.getElementById("filterTipo").value = "";
        document.getElementById("filterCodigo").value = "";
        document.getElementById("startDate").value = "";
        document.getElementById("endDate").value = "";
        updateTable(processedData);
      }

      function applyStatsFilters() {
        const tipoFilter = document.getElementById("statsTipoFilter").value;
        const loteFilter = normalizeLote(document.getElementById("statsLoteFilter").value);

        const filteredData = processedData.filter((message) => {
          return (
            (tipoFilter === "" || normalizeTipoInspecao(message.tipoInspecao) === tipoFilter) &&
            (loteFilter === "" || normalizeLote(message.lote) === loteFilter)
          );
        });

        updateCharts(filteredData);
      }

      function clearStatsFilters() {
        document.getElementById("statsTipoFilter").value = "";
        document.getElementById("statsLoteFilter").value = "";
        updateCharts(processedData);
      }

      function applyReavFilters() {
        updateReavaliacoesTab();
      }

      function clearReavFilters() {
        document.getElementById("reavStartDate").value = "";
        document.getElementById("reavEndDate").value = "";
        document.getElementById("reavLoteFilter").value = "";
        document.getElementById("reavTipoFilter").value = "";
        document.querySelectorAll(".period-btn").forEach((b) => b.classList.remove("active"));
        document.querySelector('.period-btn[data-period="all"]').classList.add("active");
        updateReavaliacoesTab();
      }

      function applyPeriodFilter(period) {
        const now = new Date();
        let startDate = null;

        switch (period) {
          case "week":
            startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            break;
          case "month":
            startDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
            break;
          case "quarter":
            startDate = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate());
            break;
          case "year":
            startDate = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
            break;
          default:
            startDate = null;
        }

        if (startDate) {
          document.getElementById("reavStartDate").value = formatDateBrazilian(startDate);
          document.getElementById("reavEndDate").value = formatDateBrazilian(now);
        } else {
          document.getElementById("reavStartDate").value = "";
          document.getElementById("reavEndDate").value = "";
        }

        updateReavaliacoesTab();
      }

      // ==========================================
      // TAB REAVALIA√á√ïES
      // ==========================================

      function updateReavaliacoesTab() {
        if (Object.keys(oaeGroupedData).length === 0) return;

        // Aplicar filtros
        const startDateStr = document.getElementById("reavStartDate").value;
        const endDateStr = document.getElementById("reavEndDate").value;
        const loteFilter = normalizeLote(document.getElementById("reavLoteFilter").value);
        const tipoFilter = document.getElementById("reavTipoFilter").value;

        let startDateValue = startDateStr ? parseComplexDate(startDateStr) : null;
        let endDateValue = endDateStr ? parseComplexDate(endDateStr) : null;

        if (endDateValue) {
          endDateValue.setHours(23, 59, 59, 999);
        }

        // Filtrar dados agrupados
        const filteredOAEs = Object.values(oaeGroupedData).filter((oae) => {
          // Filtro de lote
          if (loteFilter && normalizeLote(oae.lote) !== loteFilter) return false;

          // Filtro de tipo de inspe√ß√£o
          if (tipoFilter && normalizeTipoInspecao(oae.tipoInspecao) !== tipoFilter) return false;

          // Filtro de data (baseado na √∫ltima data do hist√≥rico)
          if (startDateValue || endDateValue) {
            const lastDate = oae.historico.length > 0 ? oae.historico[oae.historico.length - 1].dateObj : null;
            if (lastDate) {
              if (startDateValue && lastDate < startDateValue) return false;
              if (endDateValue && lastDate > endDateValue) return false;
            }
          }

          return true;
        });

        // Calcular estat√≠sticas
        const stats = calculateReavaliacaoStats(filteredOAEs);

        // Atualizar cards
        document.getElementById("totalObrasAvaliadas").textContent = stats.totalObras;
        document.getElementById("totalObrasReavaliadas").textContent = stats.obrasComReavaliacao;
        document.getElementById("totalReavaliacoes").textContent = stats.totalReavaliacoes;
        document.getElementById("mediaReavPorObra").textContent = stats.mediaReavPorObra.toFixed(2);
        document.getElementById("taxaAprovacaoFinal").textContent = stats.taxaAprovacaoFinal.toFixed(1) + "%";

        // Atualizar gr√°ficos
        updateReavaliacaoCharts(filteredOAEs, stats);

        // Atualizar tabela
        updateReavaliacaoTable(filteredOAEs);
      }

      function calculateReavaliacaoStats(oaes) {
        const stats = {
          totalObras: oaes.length,
          obrasComReavaliacao: 0,
          totalReavaliacoes: 0,
          distribuicaoReavaliacoes: {0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, '6+': 0},
          aprovadosPorCiclo: {},
          totalPorCiclo: {},
          reavPorLote: {},
          reavPorMes: {},
          reavPorTipo: {},
          obrasPorTipo: {},
          obrasComReavPorTipo: {},
          mediaReavPorObra: 0,
          taxaAprovacaoFinal: 0,
          obrasAprovadas: 0
        };

        oaes.forEach((oae) => {
          // Contar reavalia√ß√µes (usando o maior n√∫mero encontrado)
          const numReav = oae.maiorReavaliacao || oae.totalReavaliacoes;
          const tipo = normalizeTipoInspecao(oae.tipoInspecao) || "N√ÉO INFORMADO";
          
          // Contagem por tipo
          if (!stats.obrasPorTipo[tipo]) {
            stats.obrasPorTipo[tipo] = 0;
            stats.obrasComReavPorTipo[tipo] = 0;
            stats.reavPorTipo[tipo] = 0;
          }
          stats.obrasPorTipo[tipo]++;
          
          if (numReav > 0) {
            stats.obrasComReavaliacao++;
            stats.totalReavaliacoes += numReav;
            stats.obrasComReavPorTipo[tipo]++;
            stats.reavPorTipo[tipo] += numReav;
          }

          // Distribui√ß√£o
          if (numReav >= 6) {
            stats.distribuicaoReavaliacoes['6+']++;
          } else {
            stats.distribuicaoReavaliacoes[numReav]++;
          }

          // Por lote
          if (oae.lote) {
            const lote = normalizeLote(oae.lote);
            if (!stats.reavPorLote[lote]) stats.reavPorLote[lote] = 0;
            stats.reavPorLote[lote] += numReav;
          }

          // Por m√™s (baseado na √∫ltima data)
          if (oae.historico.length > 0) {
            const lastEntry = oae.historico[oae.historico.length - 1];
            if (lastEntry.dateObj) {
              const monthKey = `${lastEntry.dateObj.getFullYear()}-${String(lastEntry.dateObj.getMonth() + 1).padStart(2, '0')}`;
              if (!stats.reavPorMes[monthKey]) stats.reavPorMes[monthKey] = 0;
              stats.reavPorMes[monthKey] += numReav;
            }
          }

          // Status final
          const statusFinal = normalizeStatus(oae.statusFinal);
          if (statusFinal.includes("APROVADA")) {
            stats.obrasAprovadas++;
          }

          // Taxa de aprova√ß√£o por ciclo
          oae.historico.forEach((h) => {
            const numCiclo = extractNumeroReavaliacao(h.status);
            if (numCiclo > 0) {
              if (!stats.totalPorCiclo[numCiclo]) {
                stats.totalPorCiclo[numCiclo] = 0;
                stats.aprovadosPorCiclo[numCiclo] = 0;
              }
              stats.totalPorCiclo[numCiclo]++;
            }
          });
        });

        // Calcular m√©dias
        stats.mediaReavPorObra = stats.obrasComReavaliacao > 0 
          ? stats.totalReavaliacoes / stats.obrasComReavaliacao 
          : 0;
        
        stats.taxaAprovacaoFinal = stats.totalObras > 0 
          ? (stats.obrasAprovadas / stats.totalObras) * 100 
          : 0;

        return stats;
      }

      function updateReavaliacaoCharts(oaes, stats) {
        // 1. Gr√°fico de distribui√ß√£o
        createDistribuicaoReavChart(stats.distribuicaoReavaliacoes);

        // 2. Gr√°fico de funil
        createFunilReavChart(stats.distribuicaoReavaliacoes);

        // 3. Top obras mais reavaliadas
        createTopObrasReavChart(oaes);

        // 4. Taxa de aprova√ß√£o por ciclo
        createTaxaAprovacaoCicloChart(oaes);

        // 5. Evolu√ß√£o por m√™s
        createEvolucaoReavChart(stats.reavPorMes);

        // 6. Reavalia√ß√µes por lote
        createReavPorLoteChart(stats.reavPorLote);

        // 7. Reavalia√ß√µes por tipo de inspe√ß√£o (NOVO)
        createReavPorTipoChart(stats.reavPorTipo, stats.obrasPorTipo, stats.obrasComReavPorTipo);

        // 8. Distribui√ß√£o por tipo com reavalia√ß√£o (NOVO)
        createDistribuicaoTipoReavChart(stats.obrasComReavPorTipo);
      }

      function createDistribuicaoReavChart(distribuicao) {
        const canvas = document.getElementById("distribuicaoReavChart");
        if (!canvas) return;

        const existingChart = Chart.getChart(canvas);
        if (existingChart) existingChart.destroy();

        const labels = ["Sem Reav", "1 Reav", "2 Reav", "3 Reav", "4 Reav", "5 Reav", "6+ Reav"];
        const data = [
          distribuicao[0] || 0,
          distribuicao[1] || 0,
          distribuicao[2] || 0,
          distribuicao[3] || 0,
          distribuicao[4] || 0,
          distribuicao[5] || 0,
          distribuicao['6+'] || 0
        ];

        const colors = [
          'rgba(39, 174, 96, 0.7)',   // Verde - sem reav
          'rgba(52, 152, 219, 0.7)',   // Azul claro
          'rgba(243, 156, 18, 0.7)',   // Amarelo
          'rgba(230, 126, 34, 0.7)',   // Laranja
          'rgba(231, 76, 60, 0.7)',    // Vermelho claro
          'rgba(155, 89, 182, 0.7)',   // Roxo
          'rgba(192, 57, 43, 0.7)'     // Vermelho escuro
        ];

        new Chart(canvas, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Quantidade de Obras',
              data: data,
              backgroundColor: colors,
              borderColor: colors.map(c => c.replace('0.7', '1')),
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (ctx) => `${ctx.raw} obras`
                }
              }
            },
            scales: {
              x: { ticks: { color: '#ffffff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
              y: { 
                beginAtZero: true,
                ticks: { color: '#ffffff', stepSize: 1 }, 
                grid: { color: 'rgba(255,255,255,0.1)' } 
              }
            }
          }
        });
      }

      function createFunilReavChart(distribuicao) {
        const canvas = document.getElementById("funilReavChart");
        if (!canvas) return;

        const existingChart = Chart.getChart(canvas);
        if (existingChart) existingChart.destroy();

        // Calcular acumulados (quantas obras passaram por cada etapa)
        const total = Object.values(distribuicao).reduce((a, b) => a + b, 0);
        const comReav = total - (distribuicao[0] || 0);
        const com2Reav = comReav - (distribuicao[1] || 0);
        const com3Reav = com2Reav - (distribuicao[2] || 0);
        const com4Reav = com3Reav - (distribuicao[3] || 0);
        const com5Reav = com4Reav - (distribuicao[4] || 0);
        const com6Reav = com5Reav - (distribuicao[5] || 0);

        const labels = ["Total Obras", "Com 1+ Reav", "Com 2+ Reav", "Com 3+ Reav", "Com 4+ Reav", "Com 5+ Reav", "Com 6+ Reav"];
        const data = [total, comReav, com2Reav, com3Reav, com4Reav, com5Reav, com6Reav];

        new Chart(canvas, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Obras',
              data: data,
              backgroundColor: 'rgba(155, 89, 182, 0.7)',
              borderColor: 'rgba(155, 89, 182, 1)',
              borderWidth: 1
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (ctx) => {
                    const pct = total > 0 ? ((ctx.raw / total) * 100).toFixed(1) : 0;
                    return `${ctx.raw} obras (${pct}%)`;
                  }
                }
              }
            },
            scales: {
              x: { 
                beginAtZero: true,
                ticks: { color: '#ffffff' }, 
                grid: { color: 'rgba(255,255,255,0.1)' } 
              },
              y: { ticks: { color: '#ffffff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
            }
          }
        });
      }

      function createTopObrasReavChart(oaes) {
        const canvas = document.getElementById("topObrasReavChart");
        if (!canvas) return;

        const existingChart = Chart.getChart(canvas);
        if (existingChart) existingChart.destroy();

        // Top 10 obras com mais reavalia√ß√µes
        const topObras = [...oaes]
          .filter(o => (o.maiorReavaliacao || o.totalReavaliacoes) > 0)
          .sort((a, b) => (b.maiorReavaliacao || b.totalReavaliacoes) - (a.maiorReavaliacao || a.totalReavaliacoes))
          .slice(0, 10);

        const labels = topObras.map(o => o.codigoOAE.substring(0, 15));
        const data = topObras.map(o => o.maiorReavaliacao || o.totalReavaliacoes);

        new Chart(canvas, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Reavalia√ß√µes',
              data: data,
              backgroundColor: 'rgba(231, 76, 60, 0.7)',
              borderColor: 'rgba(231, 76, 60, 1)',
              borderWidth: 1
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              x: { 
                beginAtZero: true,
                ticks: { color: '#ffffff', stepSize: 1 }, 
                grid: { color: 'rgba(255,255,255,0.1)' } 
              },
              y: { ticks: { color: '#ffffff', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.1)' } }
            }
          }
        });
      }

      function createTaxaAprovacaoCicloChart(oaes) {
        const canvas = document.getElementById("taxaAprovacaoCicloChart");
        if (!canvas) return;

        const existingChart = Chart.getChart(canvas);
        if (existingChart) existingChart.destroy();

        // Calcular taxa de aprova√ß√£o ap√≥s cada ciclo
        const aprovacaoPorCiclo = {};
        const totalPorCiclo = {};

        oaes.forEach(oae => {
          const numReav = oae.maiorReavaliacao || oae.totalReavaliacoes;
          const statusFinal = normalizeStatus(oae.statusFinal);
          const foiAprovada = statusFinal.includes("APROVADA");

          if (numReav > 0) {
            if (!totalPorCiclo[numReav]) {
              totalPorCiclo[numReav] = 0;
              aprovacaoPorCiclo[numReav] = 0;
            }
            totalPorCiclo[numReav]++;
            if (foiAprovada) {
              aprovacaoPorCiclo[numReav]++;
            }
          }
        });

        const labels = Object.keys(totalPorCiclo).sort((a, b) => a - b).map(n => `Ap√≥s ${n}¬™ Reav`);
        const data = Object.keys(totalPorCiclo).sort((a, b) => a - b).map(n => {
          return totalPorCiclo[n] > 0 ? (aprovacaoPorCiclo[n] / totalPorCiclo[n]) * 100 : 0;
        });

        new Chart(canvas, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Taxa de Aprova√ß√£o (%)',
              data: data,
              borderColor: 'rgba(39, 174, 96, 1)',
              backgroundColor: 'rgba(39, 174, 96, 0.2)',
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (ctx) => `${ctx.raw.toFixed(1)}%`
                }
              }
            },
            scales: {
              x: { ticks: { color: '#ffffff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
              y: { 
                beginAtZero: true,
                max: 100,
                ticks: { color: '#ffffff', callback: (v) => v + '%' }, 
                grid: { color: 'rgba(255,255,255,0.1)' } 
              }
            }
          }
        });
      }

      function createEvolucaoReavChart(reavPorMes) {
        const canvas = document.getElementById("evolucaoReavChart");
        if (!canvas) return;

        const existingChart = Chart.getChart(canvas);
        if (existingChart) existingChart.destroy();

        const sortedMonths = Object.keys(reavPorMes).sort();
        const labels = sortedMonths.map(m => {
          const [year, month] = m.split('-');
          return `${month}/${year}`;
        });
        const data = sortedMonths.map(m => reavPorMes[m]);

        new Chart(canvas, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Reavalia√ß√µes',
              data: data,
              borderColor: 'rgba(52, 152, 219, 1)',
              backgroundColor: 'rgba(52, 152, 219, 0.2)',
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              x: { ticks: { color: '#ffffff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
              y: { 
                beginAtZero: true,
                ticks: { color: '#ffffff', stepSize: 1 }, 
                grid: { color: 'rgba(255,255,255,0.1)' } 
              }
            }
          }
        });
      }

      function createReavPorLoteChart(reavPorLote) {
        const canvas = document.getElementById("reavPorLoteChart");
        if (!canvas) return;

        const existingChart = Chart.getChart(canvas);
        if (existingChart) existingChart.destroy();

        const sortedLotes = Object.keys(reavPorLote).sort((a, b) => parseInt(a) - parseInt(b));
        const labels = sortedLotes.map(l => `Lote ${l}`);
        const data = sortedLotes.map(l => reavPorLote[l]);

        const colors = sortedLotes.map((_, i) => {
          const hue = (i * 137.5) % 360;
          return `hsla(${hue}, 70%, 50%, 0.7)`;
        });

        new Chart(canvas, {
          type: 'doughnut',
          data: {
            labels: labels,
            datasets: [{
              data: data,
              backgroundColor: colors,
              borderColor: colors.map(c => c.replace('0.7', '1')),
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'bottom',
                labels: { color: '#ffffff', boxWidth: 12, padding: 8 }
              },
              tooltip: {
                callbacks: {
                  label: (ctx) => {
                    const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                    const pct = total > 0 ? ((ctx.raw / total) * 100).toFixed(1) : 0;
                    return `${ctx.label}: ${ctx.raw} reav (${pct}%)`;
                  }
                }
              }
            }
          }
        });
      }

      // Gr√°fico de reavalia√ß√µes por tipo de inspe√ß√£o (barras agrupadas)
      function createReavPorTipoChart(reavPorTipo, obrasPorTipo, obrasComReavPorTipo) {
        const canvas = document.getElementById("reavPorTipoChart");
        if (!canvas) return;

        const existingChart = Chart.getChart(canvas);
        if (existingChart) existingChart.destroy();

        const tipos = Object.keys(obrasPorTipo).filter(t => t !== "N√ÉO INFORMADO");
        if (tipos.length === 0) return;

        const labels = tipos;
        const totalObrasData = tipos.map(t => obrasPorTipo[t] || 0);
        const obrasComReavData = tipos.map(t => obrasComReavPorTipo[t] || 0);
        const totalReavData = tipos.map(t => reavPorTipo[t] || 0);

        new Chart(canvas, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Total de Obras',
                data: totalObrasData,
                backgroundColor: 'rgba(52, 152, 219, 0.7)',
                borderColor: 'rgba(52, 152, 219, 1)',
                borderWidth: 1
              },
              {
                label: 'Obras com Reavalia√ß√£o',
                data: obrasComReavData,
                backgroundColor: 'rgba(243, 156, 18, 0.7)',
                borderColor: 'rgba(243, 156, 18, 1)',
                borderWidth: 1
              },
              {
                label: 'Total de Reavalia√ß√µes',
                data: totalReavData,
                backgroundColor: 'rgba(231, 76, 60, 0.7)',
                borderColor: 'rgba(231, 76, 60, 1)',
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: { color: '#ffffff', boxWidth: 12, padding: 10 }
              }
            },
            scales: {
              x: { ticks: { color: '#ffffff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
              y: { 
                beginAtZero: true,
                ticks: { color: '#ffffff', stepSize: 1 }, 
                grid: { color: 'rgba(255,255,255,0.1)' } 
              }
            }
          }
        });
      }

      // Gr√°fico de distribui√ß√£o por tipo (apenas obras com reavalia√ß√£o)
      function createDistribuicaoTipoReavChart(obrasComReavPorTipo) {
        const canvas = document.getElementById("distribuicaoTipoReavChart");
        if (!canvas) return;

        const existingChart = Chart.getChart(canvas);
        if (existingChart) existingChart.destroy();

        const tipos = Object.keys(obrasComReavPorTipo).filter(t => t !== "N√ÉO INFORMADO" && obrasComReavPorTipo[t] > 0);
        if (tipos.length === 0) {
          // Mostrar mensagem se n√£o houver dados
          const ctx = canvas.getContext('2d');
          ctx.fillStyle = '#ffffff';
          ctx.font = '14px Arial';
          ctx.textAlign = 'center';
          ctx.fillText('Sem dados de reavalia√ß√£o', canvas.width / 2, canvas.height / 2);
          return;
        }

        const labels = tipos;
        const data = tipos.map(t => obrasComReavPorTipo[t]);

        const colors = {
          'CADASTRAL': 'rgba(52, 152, 219, 0.7)',
          'ROTINEIRA': 'rgba(46, 204, 113, 0.7)',
          'CORRE√á√ÉO DE CADASTRO': 'rgba(155, 89, 182, 0.7)'
        };

        const backgroundColors = tipos.map(t => colors[t] || 'rgba(149, 165, 166, 0.7)');

        new Chart(canvas, {
          type: 'pie',
          data: {
            labels: labels,
            datasets: [{
              data: data,
              backgroundColor: backgroundColors,
              borderColor: backgroundColors.map(c => c.replace('0.7', '1')),
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'bottom',
                labels: { color: '#ffffff', boxWidth: 12, padding: 8 }
              },
              tooltip: {
                callbacks: {
                  label: (ctx) => {
                    const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                    const pct = total > 0 ? ((ctx.raw / total) * 100).toFixed(1) : 0;
                    return `${ctx.label}: ${ctx.raw} obras (${pct}%)`;
                  }
                }
              }
            }
          }
        });
      }

      function updateReavaliacaoTable(oaes) {
        const tbody = document.querySelector("#reavTable tbody");
        tbody.innerHTML = "";

        if (oaes.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Nenhum dado encontrado.</td></tr>';
          return;
        }

        // Ordenar por n√∫mero de reavalia√ß√µes (decrescente)
        const sortedOAEs = [...oaes].sort((a, b) => {
          const reavsA = a.maiorReavaliacao || a.totalReavaliacoes;
          const reavsB = b.maiorReavaliacao || b.totalReavaliacoes;
          return reavsB - reavsA;
        });

        sortedOAEs.forEach((oae) => {
          const row = document.createElement("tr");

          const numReav = oae.maiorReavaliacao || oae.totalReavaliacoes;
          const statusFinal = normalizeStatus(oae.statusFinal);

          let statusClass = "status-final-andamento";
          if (statusFinal.includes("APROVADA")) statusClass = "status-final-aprovada";
          else if (statusFinal.includes("REPROVADA")) statusClass = "status-final-reprovada";

          // Badge de reavalia√ß√£o
          let badgeClass = "reav-badge-1";
          if (numReav >= 6) badgeClass = "reav-badge-6";
          else if (numReav >= 5) badgeClass = "reav-badge-5";
          else if (numReav >= 4) badgeClass = "reav-badge-4";
          else if (numReav >= 3) badgeClass = "reav-badge-3";
          else if (numReav >= 2) badgeClass = "reav-badge-2";

          const primeiraDataFormatted = oae.primeiraData ? formatMessageDateBrazilian(oae.primeiraData).split(' ')[0] : "-";
          const ultimaDataFormatted = oae.ultimaData ? formatMessageDateBrazilian(oae.ultimaData).split(' ')[0] : "-";

          row.innerHTML = `
            <td><strong>${oae.codigoOAE}</strong></td>
            <td>${oae.lote || "-"}</td>
            <td>${oae.tipoInspecao || "-"}</td>
            <td>${oae.historico.length}</td>
            <td><span class="reav-badge ${badgeClass}">${numReav}</span></td>
            <td class="${statusClass}">${statusFinal || "-"}</td>
            <td>${primeiraDataFormatted}</td>
            <td>${ultimaDataFormatted}</td>
            <td>
              <button onclick="showOAEHistory('${oae.codigoOAE}')" style="padding: 5px 10px; font-size: 12px;">
                Ver Hist√≥rico
              </button>
            </td>
          `;

          tbody.appendChild(row);
        });
      }

      // Fun√ß√£o global para mostrar hist√≥rico da OAE
      window.showOAEHistory = function(codigoOAE) {
        const oae = oaeGroupedData[codigoOAE];
        if (!oae) return;

        const modal = document.getElementById("oaeHistoryModal");
        const title = document.getElementById("modalOAETitle");
        const info = document.getElementById("modalOAEInfo");
        const history = document.getElementById("modalOAEHistory");

        title.textContent = `Hist√≥rico: ${oae.codigoOAE}`;

        const numReav = oae.maiorReavaliacao || oae.totalReavaliacoes;
        const statusFinal = normalizeStatus(oae.statusFinal);

        info.innerHTML = `
          <p><strong>Lote:</strong> ${oae.lote || "-"}</p>
          <p><strong>Tipo:</strong> ${oae.tipoInspecao || "-"}</p>
          <p><strong>Total de Registros:</strong> ${oae.historico.length}</p>
          <p><strong>N√∫mero de Reavalia√ß√µes:</strong> ${numReav}</p>
          <p><strong>Status Final:</strong> <span style="color: ${statusFinal.includes('APROVADA') ? 'var(--success)' : statusFinal.includes('REPROVADA') ? 'var(--danger)' : 'var(--warning)'}">${statusFinal}</span></p>
        `;

        history.innerHTML = "";

        oae.historico.forEach((h, index) => {
          const item = document.createElement("div");
          item.className = "timeline-item";

          const status = normalizeStatus(h.status);
          if (status.includes("APROVADA")) item.classList.add("status-aprovada-item");
          else if (status.includes("REPROVADA")) item.classList.add("status-reprovada-item");
          else if (status.includes("REAVALIA√á√ÉO")) item.classList.add("status-reavaliacao-item");

          const dateFormatted = formatMessageDateBrazilian(h.data);

          item.innerHTML = `
            <div class="timeline-date">${dateFormatted}</div>
            <div class="timeline-status">${status}</div>
            <div class="timeline-sender">Por: ${h.remetente || "-"}</div>
          `;

          history.appendChild(item);
        });

        modal.style.display = "block";
      };

      // ==========================================
      // GR√ÅFICOS DA ABA ESTAT√çSTICAS
      // ==========================================

      function updateCharts(dataToShow = processedData) {
        if (dataToShow.length === 0) return;

        const statusCounts = {};
        dataToShow.forEach((item) => {
          if (item.status) {
            const status = normalizeStatus(item.status);
            statusCounts[status] = (statusCounts[status] || 0) + 1;
          }
        });

        const reprovacoesPorCodigo = {};
        dataToShow.forEach((item) => {
          if (normalizeStatus(item.status) === "REPROVADA" && item.codigoOAE) {
            reprovacoesPorCodigo[item.codigoOAE] = (reprovacoesPorCodigo[item.codigoOAE] || 0) + 1;
          }
        });

        const topReprovados = Object.fromEntries(
          Object.entries(reprovacoesPorCodigo).sort(([, a], [, b]) => b - a).slice(0, 10)
        );

        const aprovadoresPorRemetente = {};
        dataToShow.forEach((item) => {
          if (normalizeStatus(item.status) === "APROVADA" && item.remetente) {
            aprovadoresPorRemetente[item.remetente] = (aprovadoresPorRemetente[item.remetente] || 0) + 1;
          }
        });

        const topAprovadores = Object.fromEntries(
          Object.entries(aprovadoresPorRemetente).sort(([, a], [, b]) => b - a).slice(0, 10)
        );

        const reprovadoresPorRemetente = {};
        dataToShow.forEach((item) => {
          if (normalizeStatus(item.status) === "REPROVADA" && item.remetente) {
            reprovadoresPorRemetente[item.remetente] = (reprovadoresPorRemetente[item.remetente] || 0) + 1;
          }
        });

        const topReprovadores = Object.fromEntries(
          Object.entries(reprovadoresPorRemetente).sort(([, a], [, b]) => b - a).slice(0, 10)
        );

        const diasPorTipo = { CADASTRAL: [], ROTINEIRA: [], "CORRE√á√ÉO DE CADASTRO": [] };
        dataToShow.forEach((item) => {
          if (item.tipoInspecao && item.dataEntrega && (item.dataDevolucao || item.dataRecebimento)) {
            const tipo = normalizeTipoInspecao(item.tipoInspecao);
            const dataInicio = parseComplexDate(item.dataEntrega);
            const dataFim = parseComplexDate(item.dataDevolucao || item.dataRecebimento);
            if (dataInicio && dataFim && diasPorTipo[tipo]) {
              const dias = Math.round((dataFim - dataInicio) / (1000 * 60 * 60 * 24));
              if (dias >= 0) diasPorTipo[tipo].push(dias);
            }
          }
        });

        const mediaDiasPorTipo = {};
        Object.entries(diasPorTipo).forEach(([tipo, dias]) => {
          mediaDiasPorTipo[tipo] = dias.length > 0 ? dias.reduce((sum, val) => sum + val, 0) / dias.length : 0;
        });

        const tipoInspecaoCounts = {};
        dataToShow.forEach((item) => {
          if (item.tipoInspecao) {
            const tipo = normalizeTipoInspecao(item.tipoInspecao);
            tipoInspecaoCounts[tipo] = (tipoInspecaoCounts[tipo] || 0) + 1;
          }
        });

        createStatusChart(statusCounts);
        createReprovacaoChart(topReprovados);
        createAprovadorChart(topAprovadores);
        createReprovadorChart(topReprovadores);
        createTempoChart(mediaDiasPorTipo);
        createTipoChart(tipoInspecaoCounts);

        updateStatsFilterInfo(dataToShow.length);
      }

      function updateStatsFilterInfo(filteredCount) {
        const tipoFilter = document.getElementById("statsTipoFilter").value;
        const loteFilter = document.getElementById("statsLoteFilter").value;

        let filterInfo = `<h3>Estat√≠sticas`;
        if (tipoFilter || loteFilter) {
          filterInfo += ` - Filtro: `;
          if (tipoFilter) filterInfo += `Tipo ${tipoFilter}`;
          if (tipoFilter && loteFilter) filterInfo += ` / `;
          if (loteFilter) filterInfo += `Lote ${loteFilter}`;
        }
        filterInfo += ` (${filteredCount} registros)</h3>`;

        document.getElementById("statsFilterInfo").innerHTML = filterInfo;
      }

      function createStatusChart(data) {
        createChart("statusChart", data, "bar", {
          backgroundColor: (ctx) => {
            const label = ctx.chart.data.labels[ctx.dataIndex].toLowerCase();
            if (label.includes("aprovada")) return "rgba(39, 174, 96, 0.7)";
            if (label.includes("reprovada")) return "rgba(231, 76, 60, 0.7)";
            if (label.includes("avalia√ß√£o") && !label.includes("reav")) return "rgba(243, 156, 18, 0.7)";
            if (label.includes("reavalia√ß√£o")) return "rgba(52, 152, 219, 0.7)";
            return "rgba(149, 165, 166, 0.7)";
          },
        });
      }

      function createReprovacaoChart(data) {
        createChart("reprovacaoChart", data, "bar", {
          indexAxis: "y",
          backgroundColor: "rgba(231, 76, 60, 0.7)",
          borderColor: "rgba(231, 76, 60, 1)",
        });
      }

      function createAprovadorChart(data) {
        createChart("aprovadorChart", data, "bar", {
          indexAxis: "y",
          backgroundColor: "rgba(39, 174, 96, 0.7)",
          borderColor: "rgba(39, 174, 96, 1)",
        });
      }

      function createReprovadorChart(data) {
        createChart("reprovadorChart", data, "bar", {
          indexAxis: "y",
          backgroundColor: "rgba(231, 76, 60, 0.7)",
          borderColor: "rgba(231, 76, 60, 1)",
        });
      }

      function createTempoChart(data) {
        createChart("tempoChart", data, "bar", {
          backgroundColor: "rgba(52, 152, 219, 0.7)",
          borderColor: "rgba(52, 152, 219, 1)",
          formatter: (value) => `${value.toFixed(1)} dias`,
        });
      }

      function createTipoChart(data) {
        const colors = [
          "rgba(52, 152, 219, 0.7)",
          "rgba(46, 204, 113, 0.7)",
          "rgba(155, 89, 182, 0.7)",
          "rgba(241, 196, 15, 0.7)",
          "rgba(230, 126, 34, 0.7)",
        ];

        createChart("tipoChart", data, "doughnut", {
          backgroundColor: Object.keys(data).map((_, i) => colors[i % colors.length]),
          borderColor: Object.keys(data).map((_, i) => colors[i % colors.length].replace("0.7", "1")),
        });
      }

      function createChart(canvasId, data, type, options = {}) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        const existingChart = Chart.getChart(canvas);
        if (existingChart) existingChart.destroy();

        const labels = Object.keys(data);
        const values = Object.values(data);

        const chartOptions = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: type === "doughnut",
              position: "bottom",
              labels: { color: "#ffffff", boxWidth: 12, padding: 10 },
            },
            tooltip: { callbacks: {} },
          },
          scales: {},
        };

        if (options.formatter) {
          chartOptions.plugins.tooltip.callbacks.label = function (context) {
            return options.formatter(context.raw, context);
          };
        }

        if (type === "bar") {
          chartOptions.indexAxis = options.indexAxis || "x";
          chartOptions.scales = {
            x: {
              beginAtZero: true,
              ticks: { color: "#ffffff" },
              grid: { color: "rgba(255, 255, 255, 0.1)" },
            },
            y: {
              ticks: { color: "#ffffff" },
              grid: { color: "rgba(255, 255, 255, 0.1)" },
            },
          };
        }

        if (type === "bar" && options.indexAxis === "y") {
          chartOptions.scales.y.ticks.autoSkip = true;
          chartOptions.scales.y.ticks.maxTicksLimit = 8;
        }

        new Chart(canvas, {
          type: type,
          data: {
            labels: labels,
            datasets: [{
              label: options.label || "Quantidade",
              data: values,
              backgroundColor: options.backgroundColor || "rgba(52, 152, 219, 0.7)",
              borderColor: options.borderColor || "rgba(52, 152, 219, 1)",
              borderWidth: 1,
            }],
          },
          options: chartOptions,
        });
      }

      // ==========================================
      // EXPORTA√á√ÉO
      // ==========================================

      function exportToCSV() {
        if (processedData.length === 0) {
          alert("N√£o h√° dados para exportar.");
          return;
        }

        const now = new Date();
        const fileName = `HISTORICO_MENSAGENS_${formatDateFileName(now)}`;

        const headers = [
          "Data", "Remetente", "Lote", "C√≥digo OAE", "Tipo de Inspe√ß√£o",
          "Data de Entrega/Envio", "Data de Recebimento", "Data de Devolu√ß√£o/Retorno", "Status"
        ];

        const rows = processedData.map((message) => [
          message.data || "",
          message.remetente || "",
          message.lote || "",
          message.codigoOAE || "",
          message.tipoInspecao || "",
          message.dataEntrega || "",
          message.dataRecebimento || "",
          message.dataDevolucao || "",
          message.status || "",
        ]);

        downloadCSV(headers, rows, fileName);
      }

      function exportReavaliacoesToCSV() {
        if (Object.keys(oaeGroupedData).length === 0) {
          alert("N√£o h√° dados de reavalia√ß√£o para exportar.");
          return;
        }

        const now = new Date();
        const fileName = `REAVALIACOES_OAE_${formatDateFileName(now)}`;

        const headers = [
          "C√≥digo OAE", "Lote", "Tipo de Inspe√ß√£o", "Total Registros",
          "N√∫mero de Reavalia√ß√µes", "Status Final", "Primeira Data", "√öltima Data"
        ];

        const rows = Object.values(oaeGroupedData).map((oae) => [
          oae.codigoOAE,
          oae.lote || "",
          oae.tipoInspecao || "",
          oae.historico.length,
          oae.maiorReavaliacao || oae.totalReavaliacoes,
          oae.statusFinal || "",
          oae.primeiraData ? formatMessageDateBrazilian(oae.primeiraData).split(' ')[0] : "",
          oae.ultimaData ? formatMessageDateBrazilian(oae.ultimaData).split(' ')[0] : "",
        ]);

        downloadCSV(headers, rows, fileName);
      }

      function formatDateFileName(date) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${day}${month}${year}_${hours}${minutes}`;
      }

      function downloadCSV(headers, rows, fileName) {
        const csvContent = [
          headers.join(","),
          ...rows.map((row) => row.map((cell) => `"${(cell || "").toString().replace(/"/g, '""')}"`).join(","))
        ].join("\n");

        const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", `${fileName}.csv`);
        link.style.display = "none";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    </script>
  </body>
</html>