<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <!-- Vers√£o: 1.3 -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>An√°lise de Zonas de Drone para Pontes</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%);
      min-height: 100vh;
      color: #ffffff;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 2rem;
    }

    h1, h2, h3 {
      color: #ffffff;
      font-weight: 700;
      margin-bottom: 1.5rem;
      background: linear-gradient(45deg, #ffffff, #e3f2fd);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    h1 {
      font-size: 2rem;
      text-align: center;
    }

    h2 {
      font-size: 1.5rem;
    }

    h3 {
      font-size: 1.2rem;
    }

    .upload-section {
      text-align: center;
      padding: 2rem;
      border: 2px dashed #3498db;
      border-radius: 15px;
      background: rgba(52, 152, 219, 0.1);
      margin-bottom: 2rem;
    }

    button {
      background: linear-gradient(45deg, #3498db, #2ecc71);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 15px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      margin: 10px 5px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
    }

    button:disabled {
      background: linear-gradient(45deg, #95a5a6, #7f8c8d);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-clear {
      background: linear-gradient(45deg, #e74c3c, #c0392b);
    }

    .btn-clear:hover {
      background: linear-gradient(45deg, #c0392b, #a93226);
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.1);
      padding: 1rem;
      border-radius: 10px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #64b5f6;
    }

    .stat-label {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.8);
      margin-top: 0.5rem;
    }

    .progress-bar {
      width: 100%;
      background: rgba(255, 255, 255, 0.2);
      padding: 3px;
      border-radius: 15px;
      margin: 20px 0;
      display: none;
    }

    .progress-bar.active {
      display: block;
    }

    .progress {
      background: linear-gradient(45deg, #3498db, #2ecc71);
      height: 25px;
      border-radius: 12px;
      transition: width 0.3s ease;
      text-align: center;
      line-height: 25px;
      color: white;
      font-weight: 600;
    }

    /* Debug log */
    .debug-log {
      background: rgba(0, 0, 0, 0.3);
      padding: 1rem;
      border-radius: 10px;
      margin: 1rem 0;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .debug-log-title {
      font-weight: 600;
      color: #64b5f6;
      margin-bottom: 0.5rem;
    }

    .debug-line {
      margin: 2px 0;
      color: rgba(255, 255, 255, 0.8);
    }

    .debug-line.error {
      color: #e74c3c;
    }

    .debug-line.success {
      color: #2ecc71;
    }

    .debug-line.warning {
      color: #f39c12;
    }

    /* Se√ß√£o de Filtros */
    .filter-section {
      background: rgba(255, 255, 255, 0.08);
      padding: 1.5rem;
      border-radius: 15px;
      margin-bottom: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .filter-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #64b5f6;
    }

    .filter-controls {
      display: grid;
      grid-template-columns: 1fr 1fr auto auto;
      gap: 1rem;
      align-items: end;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .filter-group label {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.9);
      font-weight: 500;
    }

    .filter-group input,
    .filter-group select {
      padding: 10px 15px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .filter-group input:focus,
    .filter-group select:focus {
      outline: none;
      border-color: #3498db;
      background: rgba(255, 255, 255, 0.15);
    }

    .filter-group input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .filter-group select option {
      background: #2c3e50;
      color: white;
    }

    .filter-results {
      margin-top: 1rem;
      padding: 0.8rem;
      background: rgba(52, 152, 219, 0.2);
      border-radius: 10px;
      text-align: center;
      font-weight: 600;
      color: #64b5f6;
    }

    .no-results {
      text-align: center;
      padding: 2rem;
      color: #e74c3c;
      font-size: 1.1rem;
      font-weight: 600;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      overflow: hidden;
      font-size: 13px;
    }

    th, td {
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 10px;
      text-align: left;
    }

    th {
      background: rgba(52, 152, 219, 0.3);
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    td {
      background: rgba(255, 255, 255, 0.05);
    }

    tbody tr:hover td {
      background: rgba(255, 255, 255, 0.1);
    }

    tbody tr.hidden {
      display: none;
    }

    .zone-prohibited {
      background: rgba(231, 76, 60, 0.3) !important;
      color: #fff;
      font-weight: bold;
    }

    .zone-restricted {
      background: rgba(241, 196, 15, 0.3) !important;
      color: #fff;
      font-weight: bold;
    }

    .zone-permitted {
      background: rgba(46, 204, 113, 0.3) !important;
      color: #fff;
      font-weight: bold;
    }

    .zone-badge {
      padding: 4px 8px;
      border-radius: 5px;
      font-size: 11px;
      font-weight: bold;
      display: inline-block;
    }

    .badge-prohibited {
      background: #e74c3c;
    }

    .badge-restricted {
      background: #f39c12;
    }

    .badge-permitted {
      background: #27ae60;
    }

    .legend {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin: 1rem 0;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 5px;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .table-container {
      max-height: 600px;
      overflow-y: auto;
      border-radius: 15px;
    }

    .footer {
      text-align: center;
      padding: 1rem;
      margin-top: 2rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .note {
      background: rgba(255, 235, 59, 0.2);
      padding: 15px;
      border-left: 4px solid #ffd600;
      margin: 15px 0;
      border-radius: 10px;
    }

    .info-box {
      background: rgba(52, 152, 219, 0.2);
      padding: 20px;
      border-left: 4px solid #3498db;
      margin: 20px 0;
      border-radius: 10px;
    }

    .info-box h3 {
      margin-bottom: 1rem;
      font-size: 1.3rem;
    }

    .info-box p {
      margin-bottom: 0.8rem;
      line-height: 1.6;
    }

    .info-box ul {
      margin-left: 20px;
      margin-top: 10px;
    }

    .info-box li {
      margin-bottom: 8px;
      line-height: 1.5;
    }

    .criteria-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .criteria-card {
      background: rgba(255, 255, 255, 0.05);
      padding: 1.2rem;
      border-radius: 10px;
      border: 2px solid;
    }

    .criteria-card.prohibited {
      border-color: #e74c3c;
    }

    .criteria-card.restricted {
      border-color: #f39c12;
    }

    .criteria-card.permitted {
      border-color: #27ae60;
    }

    .criteria-card h4 {
      font-size: 1.1rem;
      margin-bottom: 0.8rem;
      color: #fff;
    }

    .criteria-card p {
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }

    .criteria-card .distance {
      font-size: 1.3rem;
      font-weight: bold;
      color: #64b5f6;
      margin: 0.5rem 0;
    }

    input[type="file"] {
      display: none;
    }

    /* Responsividade para filtros */
    @media (max-width: 768px) {
      .filter-controls {
        grid-template-columns: 1fr;
      }
      
      .criteria-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÅ An√°lise de Zonas de Drone para Pontes</h1>

    <div class="info-box">
      <h3>üìã Crit√©rios de Classifica√ß√£o das Zonas</h3>
      <p><strong>Este sistema utiliza os crit√©rios estabelecidos pela legisla√ß√£o brasileira de avia√ß√£o civil:</strong></p>
      
      <div class="criteria-grid">
        <div class="criteria-card prohibited">
          <h4>üö´ ZONA PROIBIDA</h4>
          <div class="distance">0 a 5 km</div>
          <p><strong>Dist√¢ncia do aeroporto/heliponto:</strong> 0 a 5 quil√¥metros</p>
          <p><strong>Classifica√ß√£o:</strong> CTR (Zona de Tr√°fego do Aer√≥dromo)</p>
          <p><strong>Restri√ß√£o:</strong> Voo de drone <strong>PROIBIDO</strong> sem autoriza√ß√£o especial do DECEA</p>
        </div>

        <div class="criteria-card restricted">
          <h4>‚ö†Ô∏è ZONA RESTRITA</h4>
          <div class="distance">5 a 10 km</div>
          <p><strong>Dist√¢ncia do aeroporto/heliponto:</strong> 5 a 10 quil√¥metros</p>
          <p><strong>Classifica√ß√£o:</strong> √Årea de Transi√ß√£o</p>
          <p><strong>Restri√ß√£o:</strong> Voo de drone <strong>REQUER AUTORIZA√á√ÉO PR√âVIA</strong> do DECEA/ANAC</p>
        </div>

        <div class="criteria-card permitted">
          <h4>‚úÖ ZONA PERMITIDA</h4>
          <div class="distance">> 10 km</div>
          <p><strong>Dist√¢ncia do aeroporto/heliponto:</strong> Mais de 10 quil√¥metros</p>
          <p><strong>Classifica√ß√£o:</strong> √Årea Livre</p>
          <p><strong>Restri√ß√£o:</strong> Voo de drone <strong>PERMITIDO</strong> seguindo regras gerais da ANAC</p>
        </div>
      </div>

      <p style="margin-top: 1.5rem;"><strong>üìñ Base Legal:</strong></p>
      <ul>
        <li><strong>RBAC-E n¬∫ 94/2017</strong> - Regulamento Brasileiro de Avia√ß√£o Civil Especial (ANAC)</li>
        <li><strong>AIC-N 21/17</strong> - Aeronautical Information Circular (DECEA)</li>
        <li><strong>Portaria DECEA n¬∫ 415/DGCEA</strong> - Procedimentos para voo de RPAS (drones)</li>
        <li><strong>ICA 100-40</strong> - Sistemas de Aeronaves Remotamente Pilotadas</li>
      </ul>

      <p style="margin-top: 1rem; font-size: 0.9rem; color: rgba(255, 255, 255, 0.8);">
        <strong>‚ö†Ô∏è Importante:</strong> Esta ferramenta fornece uma an√°lise preliminar baseada nas dist√¢ncias regulamentares. 
        Para opera√ß√µes reais com drones, sempre consulte o DECEA (Departamento de Controle do Espa√ßo A√©reo) e a ANAC 
        (Ag√™ncia Nacional de Avia√ß√£o Civil) para obter autoriza√ß√µes espec√≠ficas.
      </p>
    </div>

    <div class="note">
      <p><strong>üìã Como usar:</strong></p>
      <p>1. Fa√ßa upload do CSV com dados das pontes (incluindo colunas: Latitude e Longitude)</p>
      <p>2. O sistema consultar√° aeroportos pr√≥ximos automaticamente via OpenStreetMap</p>
      <p>3. Visualize o relat√≥rio com zonas de restri√ß√£o para drones baseadas na legisla√ß√£o</p>
      <p>4. Use os filtros para localizar obras espec√≠ficas</p>
      <p>5. Exporte o resultado completo em CSV</p>
    </div>

    <div class="upload-section">
      <h3>üìÅ Upload do CSV</h3>
      <input type="file" id="csvInput" accept=".csv" />
      <button onclick="document.getElementById('csvInput').click()">
        Selecionar CSV
      </button>
      <p id="fileName" style="margin-top: 1rem; color: #64b5f6;"></p>
    </div>

    <!-- Debug Log -->
    <div id="debugSection" style="display: none;">
      <div class="debug-log">
        <div class="debug-log-title">üìä Log de Importa√ß√£o</div>
        <div id="debugLog"></div>
      </div>
    </div>

    <div class="progress-bar" id="progressBar">
      <div class="progress" id="progress">0%</div>
    </div>

    <div id="statsSection" style="display: none;">
      <h2>üìä Estat√≠sticas</h2>
      <div class="stats">
        <div class="stat-card">
          <div class="stat-value" id="totalPontes">0</div>
          <div class="stat-label">Total de Pontes</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="pontesProibidas">0</div>
          <div class="stat-label">üö´ Zona Proibida</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="pontesRestritas">0</div>
          <div class="stat-label">‚ö†Ô∏è Zona Restrita</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="pontesPermitidas">0</div>
          <div class="stat-label">‚úÖ Zona Permitida</div>
        </div>
      </div>

      <div class="legend">
        <div class="legend-item">
          <div class="legend-color" style="background: rgba(231, 76, 60, 0.7);"></div>
          <span>üö´ Proibido (0-5km)</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: rgba(241, 196, 15, 0.7);"></div>
          <span>‚ö†Ô∏è Restrito (5-10km)</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: rgba(46, 204, 113, 0.7);"></div>
          <span>‚úÖ Permitido (>10km)</span>
        </div>
      </div>

      <button id="exportBtn" onclick="exportarCSV()" style="background: linear-gradient(45deg, #9b59b6, #8e44ad);">
        üì• Exportar Relat√≥rio CSV
      </button>
    </div>

    <div id="resultsSection" style="display: none;">
      <h2>üóÇÔ∏è Resultados da An√°lise</h2>
      
      <!-- Se√ß√£o de Filtros -->
      <div class="filter-section">
        <div class="filter-title">üîç Filtrar Obras</div>
        <div class="filter-controls">
          <div class="filter-group">
            <label for="filterCodigo">C√≥digo</label>
            <input 
              type="text" 
              id="filterCodigo" 
              placeholder="Digite o c√≥digo..."
              oninput="aplicarFiltros()"
            />
          </div>
          
          <div class="filter-group">
            <label for="filterUF">Estado (UF)</label>
            <select id="filterUF" onchange="aplicarFiltros()">
              <option value="">Todos os estados</option>
            </select>
          </div>

          <div class="filter-group">
            <label for="filterZona">Zona</label>
            <select id="filterZona" onchange="aplicarFiltros()">
              <option value="">Todas as zonas</option>
              <option value="prohibited">üö´ Proibido</option>
              <option value="restricted">‚ö†Ô∏è Restrito</option>
              <option value="permitted">‚úÖ Permitido</option>
            </select>
          </div>
          
          <button class="btn-clear" onclick="limparFiltros()">
            üóëÔ∏è Limpar
          </button>
        </div>
        
        <div class="filter-results" id="filterResults">
          Mostrando 0 de 0 obras
        </div>
      </div>

      <div class="table-container">
        <table id="resultsTable">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Identifica√ß√£o</th>
              <th>Munic√≠pio</th>
              <th>UF</th>
              <th>Rodovia</th>
              <th>Km</th>
              <th>Latitude</th>
              <th>Longitude</th>
              <th>Zona</th>
              <th>Dist√¢ncia (km)</th>
              <th>Aeroporto Pr√≥ximo</th>
            </tr>
          </thead>
          <tbody id="resultsBody">
          </tbody>
        </table>
        <div id="noResults" class="no-results" style="display: none;">
          ‚ùå Nenhuma obra encontrada com os filtros aplicados
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <p><strong>ZenithSolutions</strong> - An√°lise de Zonas de Drone</p>
    <p>&copy; 2025 Ferramentas Profissionais</p>
  </div>

  <script>
    // Vers√£o: 1.3
    
    // Vari√°veis globais
    let pontesData = [];
    let aeroportosCache = new Map();
    let resultadosAnalise = [];
    let debugMessages = [];

    // Fun√ß√£o para adicionar mensagens de debug
    function addDebugLog(message, type = 'info') {
      const debugLog = document.getElementById('debugLog');
      const debugSection = document.getElementById('debugSection');
      
      debugSection.style.display = 'block';
      
      const line = document.createElement('div');
      line.className = `debug-line ${type}`;
      line.textContent = message;
      
      debugLog.appendChild(line);
      debugLog.scrollTop = debugLog.scrollHeight;
      
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    // Event listener para upload de CSV
    document.getElementById('csvInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      document.getElementById('fileName').textContent = `Arquivo: ${file.name}`;
      
      // Limpar debug log anterior
      document.getElementById('debugLog').innerHTML = '';
      debugMessages = [];
      
      const reader = new FileReader();
      reader.onload = function(event) {
        const csvContent = event.target.result;
        parseCSV(csvContent);
      };
      reader.readAsText(file, 'UTF-8');
    });

    // Parser CSV robusto que respeita campos com aspas
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        const nextChar = line[i + 1];
        
        if (char === '"') {
          if (inQuotes && nextChar === '"') {
            // Aspas escapadas ""
            current += '"';
            i++; // Pular pr√≥ximo caractere
          } else {
            // Alternar estado de aspas
            inQuotes = !inQuotes;
          }
        } else if (char === ',' && !inQuotes) {
          // V√≠rgula fora de aspas = separador
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      
      // Adicionar √∫ltimo campo
      result.push(current.trim());
      
      return result;
    }

    // Parse do CSV com parser robusto
    function parseCSV(csvContent) {
      addDebugLog('Iniciando parse do CSV...', 'info');
      
      const lines = csvContent.split('\n');
      addDebugLog(`Total de linhas no arquivo: ${lines.length}`, 'info');
      
      if (lines.length === 0) {
        addDebugLog('Arquivo CSV vazio!', 'error');
        alert('Arquivo CSV vazio!');
        return;
      }
      
      // Parse da primeira linha (cabe√ßalho)
      const headerLine = lines[0].trim();
      const headers = parseCSVLine(headerLine);
      
      addDebugLog(`Cabe√ßalhos encontrados: ${headers.join(', ')}`, 'success');
      
      // Verificar se tem colunas Latitude e Longitude
      const hasLatitude = headers.some(h => h.toLowerCase().includes('latitude'));
      const hasLongitude = headers.some(h => h.toLowerCase().includes('longitude'));
      
      if (!hasLatitude || !hasLongitude) {
        addDebugLog('ERRO: CSV n√£o cont√©m colunas Latitude e Longitude!', 'error');
        alert('Erro: O CSV precisa ter colunas "Latitude" e "Longitude"');
        return;
      }
      
      pontesData = [];
      let linhasProcessadas = 0;
      let linhasComErro = 0;
      let linhasValidas = 0;
      let linhasSemCoordenadas = 0;
      
      // Processar cada linha de dados
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        
        // Pular linhas vazias
        if (!line) continue;
        
        linhasProcessadas++;
        
        try {
          const values = parseCSVLine(line);
          
          // Criar objeto da ponte
          const ponte = {};
          headers.forEach((header, index) => {
            ponte[header] = values[index] || '';
          });
          
          // Validar coordenadas
          const lat = parseFloat(ponte.Latitude);
          const lng = parseFloat(ponte.Longitude);
          
          if (isNaN(lat) || isNaN(lng)) {
            linhasSemCoordenadas++;
            if (linhasSemCoordenadas <= 5) {
              addDebugLog(`Linha ${i + 1}: Coordenadas inv√°lidas (Lat: ${ponte.Latitude}, Lng: ${ponte.Longitude})`, 'warning');
            }
            continue;
          }
          
          if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
            linhasSemCoordenadas++;
            if (linhasSemCoordenadas <= 5) {
              addDebugLog(`Linha ${i + 1}: Coordenadas fora do range (Lat: ${lat}, Lng: ${lng})`, 'warning');
            }
            continue;
          }
          
          // Adicionar coordenadas num√©ricas
          ponte.LatitudeNum = lat;
          ponte.LongitudeNum = lng;
          
          pontesData.push(ponte);
          linhasValidas++;
          
        } catch (error) {
          linhasComErro++;
          if (linhasComErro <= 5) {
            addDebugLog(`Linha ${i + 1}: Erro ao processar - ${error.message}`, 'error');
          }
        }
      }
      
      // Resumo do parse
      addDebugLog('=== RESUMO DO PARSE ===', 'info');
      addDebugLog(`Total de linhas processadas: ${linhasProcessadas}`, 'info');
      addDebugLog(`Linhas v√°lidas importadas: ${linhasValidas}`, 'success');
      addDebugLog(`Linhas sem coordenadas v√°lidas: ${linhasSemCoordenadas}`, 'warning');
      addDebugLog(`Linhas com erro: ${linhasComErro}`, linhasComErro > 0 ? 'error' : 'info');
      
      if (pontesData.length > 0) {
        addDebugLog(`‚úì ${pontesData.length} pontes prontas para an√°lise!`, 'success');
        iniciarAnalise();
      } else {
        addDebugLog('‚úó Nenhuma ponte v√°lida encontrada!', 'error');
        alert('Nenhuma ponte v√°lida encontrada no CSV. Verifique:\n\n' +
              '1. Se as colunas Latitude e Longitude existem\n' +
              '2. Se os valores s√£o num√©ricos\n' +
              '3. Se as coordenadas est√£o no formato correto (decimal)');
      }
    }

    // Iniciar an√°lise
    async function iniciarAnalise() {
      document.getElementById('progressBar').classList.add('active');
      document.getElementById('statsSection').style.display = 'none';
      document.getElementById('resultsSection').style.display = 'none';
      
      resultadosAnalise = [];
      
      addDebugLog('Iniciando an√°lise de zonas de drone...', 'info');
      
      // Calcular bbox global para todas as pontes
      let minLat = Infinity, maxLat = -Infinity;
      let minLng = Infinity, maxLng = -Infinity;
      
      pontesData.forEach(ponte => {
        minLat = Math.min(minLat, ponte.LatitudeNum);
        maxLat = Math.max(maxLat, ponte.LatitudeNum);
        minLng = Math.min(minLng, ponte.LongitudeNum);
        maxLng = Math.max(maxLng, ponte.LongitudeNum);
      });
      
      // Expandir bbox em 20km (~0.2 graus)
      const margem = 0.2;
      const bbox = `${minLat - margem},${minLng - margem},${maxLat + margem},${maxLng + margem}`;
      
      addDebugLog(`Bbox calculado: ${bbox}`, 'info');
      
      // Consultar aeroportos
      updateProgress(10, 'Consultando aeroportos...');
      const aeroportos = await consultarAeroportosOverpass(bbox);
      
      addDebugLog(`${aeroportos.length} aeroportos encontrados na regi√£o`, aeroportos.length > 0 ? 'success' : 'warning');
      
      if (aeroportos.length === 0) {
        addDebugLog('‚ö†Ô∏è Nenhum aeroporto encontrado - todas as pontes ser√£o marcadas como "Permitido"', 'warning');
      }
      
      // Processar cada ponte
      addDebugLog(`Analisando ${pontesData.length} pontes...`, 'info');
      
      for (let i = 0; i < pontesData.length; i++) {
        const ponte = pontesData[i];
        const progresso = 10 + ((i + 1) / pontesData.length) * 90;
        updateProgress(progresso, `Analisando ponte ${i + 1}/${pontesData.length}...`);
        
        const analise = analisarPonte(ponte, aeroportos);
        resultadosAnalise.push(analise);
        
        // Pequena pausa para n√£o travar a UI
        if (i % 50 === 0) {
          await new Promise(resolve => setTimeout(resolve, 10));
        }
      }
      
      updateProgress(100, 'An√°lise conclu√≠da!');
      addDebugLog(`‚úì An√°lise conclu√≠da com sucesso!`, 'success');
      
      exibirResultados();
    }

    // Consultar aeroportos via Overpass API
    async function consultarAeroportosOverpass(bbox) {
      const query = `
        [out:json][timeout:30];
        (
          node["aeroway"="aerodrome"](${bbox});
          node["aeroway"="helipad"](${bbox});
          node["aeroway"="heliport"](${bbox});
          way["aeroway"="aerodrome"](${bbox});
          relation["aeroway"="aerodrome"](${bbox});
        );
        out center;
      `;

      try {
        const response = await fetch('https://overpass-api.de/api/interpreter', {
          method: 'POST',
          body: query,
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          }
        });

        if (!response.ok) {
          throw new Error(`Erro na API Overpass: ${response.status}`);
        }

        const data = await response.json();
        return processarAeroportos(data.elements);
      } catch (error) {
        addDebugLog(`Erro ao consultar aeroportos: ${error.message}`, 'error');
        return [];
      }
    }

    // Processar dados de aeroportos
    function processarAeroportos(elements) {
      const aeroportos = [];
      
      elements.forEach(element => {
        let lat, lng, name, type;
        
        if (element.type === 'node') {
          lat = element.lat;
          lng = element.lon;
        } else if (element.center) {
          lat = element.center.lat;
          lng = element.center.lon;
        } else {
          return;
        }

        name = element.tags?.name || element.tags?.ref || 'Sem nome';
        type = element.tags?.aeroway || 'aerodrome';
        
        aeroportos.push({
          lat,
          lng,
          name,
          type,
          icao: element.tags?.icao || '',
          iata: element.tags?.iata || ''
        });
      });

      return aeroportos;
    }

    // Analisar uma ponte
    function analisarPonte(ponte, aeroportos) {
      let menorDistancia = Infinity;
      let aeroportoMaisProximo = null;

      aeroportos.forEach(aeroporto => {
        const distancia = calcularDistanciaHaversine(
          ponte.LatitudeNum, 
          ponte.LongitudeNum, 
          aeroporto.lat, 
          aeroporto.lng
        );
        
        if (distancia < menorDistancia) {
          menorDistancia = distancia;
          aeroportoMaisProximo = aeroporto;
        }
      });

      let zona, descricao;
      if (menorDistancia <= 5) {
        zona = 'prohibited';
        descricao = 'üö´ Proibido';
      } else if (menorDistancia <= 10) {
        zona = 'restricted';
        descricao = '‚ö†Ô∏è Restrito';
      } else {
        zona = 'permitted';
        descricao = '‚úÖ Permitido';
      }

      return {
        ...ponte,
        zona,
        descricao,
        distanciaAeroporto: menorDistancia === Infinity ? null : menorDistancia,
        aeroportoProximo: aeroportoMaisProximo ? aeroportoMaisProximo.name : 'N/A'
      };
    }

    // Calcular dist√¢ncia Haversine em km
    function calcularDistanciaHaversine(lat1, lng1, lat2, lng2) {
      const R = 6371; // Raio da Terra em km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Atualizar barra de progresso
    function updateProgress(percent, message) {
      const progress = document.getElementById('progress');
      progress.style.width = percent + '%';
      progress.textContent = message || `${Math.round(percent)}%`;
    }

    // Exibir resultados
    function exibirResultados() {
      // Calcular estat√≠sticas
      const total = resultadosAnalise.length;
      const proibidas = resultadosAnalise.filter(r => r.zona === 'prohibited').length;
      const restritas = resultadosAnalise.filter(r => r.zona === 'restricted').length;
      const permitidas = resultadosAnalise.filter(r => r.zona === 'permitted').length;

      document.getElementById('totalPontes').textContent = total;
      document.getElementById('pontesProibidas').textContent = proibidas;
      document.getElementById('pontesRestritas').textContent = restritas;
      document.getElementById('pontesPermitidas').textContent = permitidas;

      addDebugLog(`Estat√≠sticas: ${total} total | ${proibidas} proibidas | ${restritas} restritas | ${permitidas} permitidas`, 'success');

      // Preencher tabela
      const tbody = document.getElementById('resultsBody');
      tbody.innerHTML = '';

      resultadosAnalise.forEach((resultado, index) => {
        const row = tbody.insertRow();
        row.className = `zone-${resultado.zona}`;
        row.dataset.index = index;
        row.dataset.codigo = resultado['C√≥digo SGO'] || '';
        row.dataset.uf = resultado['UF'] || '';
        row.dataset.zona = resultado.zona || '';

        row.insertCell(0).textContent = resultado['C√≥digo SGO'] || '-';
        row.insertCell(1).textContent = resultado['Identifica√ß√£o'] || '-';
        row.insertCell(2).textContent = resultado['Munic√≠pio'] || '-';
        row.insertCell(3).textContent = resultado['UF'] || '-';
        row.insertCell(4).textContent = resultado['Rodovia'] || '-';
        row.insertCell(5).textContent = resultado['Km'] || '-';
        row.insertCell(6).textContent = resultado.Latitude || '-';
        row.insertCell(7).textContent = resultado.Longitude || '-';
        
        const zonaCell = row.insertCell(8);
        zonaCell.innerHTML = `<span class="zone-badge badge-${resultado.zona}">${resultado.descricao}</span>`;
        
        const distanciaCell = row.insertCell(9);
        distanciaCell.textContent = resultado.distanciaAeroporto !== null 
          ? resultado.distanciaAeroporto.toFixed(2) 
          : 'N/A';
        
        row.insertCell(10).textContent = resultado.aeroportoProximo || 'N/A';
      });

      // Popular dropdown de UFs
      popularDropdownUFs();

      // Mostrar se√ß√µes
      document.getElementById('statsSection').style.display = 'block';
      document.getElementById('resultsSection').style.display = 'block';
      
      // Atualizar contador de filtros
      atualizarContadorFiltros();
      
      // Esconder progress bar
      setTimeout(() => {
        document.getElementById('progressBar').classList.remove('active');
      }, 1000);
    }

    // Popular dropdown de UFs com valores √∫nicos
    function popularDropdownUFs() {
      const ufsUnicas = [...new Set(resultadosAnalise.map(r => r.UF).filter(uf => uf))].sort();
      const selectUF = document.getElementById('filterUF');
      
      // Limpar options existentes (exceto o primeiro)
      selectUF.innerHTML = '<option value="">Todos os estados</option>';
      
      ufsUnicas.forEach(uf => {
        const option = document.createElement('option');
        option.value = uf;
        option.textContent = uf;
        selectUF.appendChild(option);
      });
    }

    // Aplicar filtros
    function aplicarFiltros() {
      const filterCodigo = document.getElementById('filterCodigo').value.toLowerCase().trim();
      const filterUF = document.getElementById('filterUF').value;
      const filterZona = document.getElementById('filterZona').value;
      
      const tbody = document.getElementById('resultsBody');
      const rows = tbody.getElementsByTagName('tr');
      let visibleCount = 0;

      for (let row of rows) {
        const codigo = row.dataset.codigo.toLowerCase();
        const uf = row.dataset.uf;
        const zona = row.dataset.zona;
        
        // Verificar se passa nos filtros
        const codigoMatch = !filterCodigo || codigo.includes(filterCodigo);
        const ufMatch = !filterUF || uf === filterUF;
        const zonaMatch = !filterZona || zona === filterZona;
        
        if (codigoMatch && ufMatch && zonaMatch) {
          row.classList.remove('hidden');
          visibleCount++;
        } else {
          row.classList.add('hidden');
        }
      }

      // Atualizar contador
      atualizarContadorFiltros(visibleCount);
      
      // Mostrar/ocultar mensagem de "sem resultados"
      const noResults = document.getElementById('noResults');
      if (visibleCount === 0) {
        noResults.style.display = 'block';
      } else {
        noResults.style.display = 'none';
      }
    }

    // Atualizar contador de filtros
    function atualizarContadorFiltros(visible) {
      const total = resultadosAnalise.length;
      const visibleCount = visible !== undefined ? visible : total;
      
      const filterResults = document.getElementById('filterResults');
      filterResults.textContent = `Mostrando ${visibleCount} de ${total} obras`;
      
      if (visibleCount < total) {
        filterResults.style.background = 'rgba(241, 196, 15, 0.3)';
      } else {
        filterResults.style.background = 'rgba(52, 152, 219, 0.2)';
      }
    }

    // Limpar filtros
    function limparFiltros() {
      document.getElementById('filterCodigo').value = '';
      document.getElementById('filterUF').value = '';
      document.getElementById('filterZona').value = '';
      aplicarFiltros();
    }

    // Exportar CSV
    function exportarCSV() {
      if (resultadosAnalise.length === 0) return;

      // Cabe√ßalhos
      const headers = [
        'ID', 'C√≥digo SGO', 'Identifica√ß√£o', 'Munic√≠pio', 'UF', 'Regi√£o', 
        'Rodovia', 'Km', 'Natureza', 'Comprimento', 'Largura', 'Ano', 
        'Latitude', 'Longitude', 'Zona_Drone', 'Descri√ß√£o_Zona', 
        'Dist√¢ncia_Aeroporto_km', 'Aeroporto_Pr√≥ximo'
      ];

      let csvContent = headers.join(',') + '\n';

      resultadosAnalise.forEach(resultado => {
        const row = [
          resultado.ID || '',
          resultado['C√≥digo SGO'] || '',
          `"${(resultado['Identifica√ß√£o'] || '').replace(/"/g, '""')}"`,
          resultado['Munic√≠pio'] || '',
          resultado['UF'] || '',
          resultado['Regi√£o'] || '',
          resultado['Rodovia'] || '',
          resultado['Km'] || '',
          resultado['Natureza'] || '',
          resultado['Comprimento'] || '',
          resultado['Largura'] || '',
          resultado['Ano'] || '',
          resultado.Latitude || '',
          resultado.Longitude || '',
          resultado.zona || '',
          `"${resultado.descricao || ''}"`,
          resultado.distanciaAeroporto !== null ? resultado.distanciaAeroporto.toFixed(2) : '',
          `"${(resultado.aeroportoProximo || '').replace(/"/g, '""')}"`
        ];

        csvContent += row.join(',') + '\n';
      });

      // Download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', 'relatorio_zonas_drone_pontes.csv');
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      addDebugLog('‚úì CSV exportado com sucesso!', 'success');
    }
  </script>
</body>
</html>