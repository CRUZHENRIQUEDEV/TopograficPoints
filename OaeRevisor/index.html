<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SGO Revisor - Auditoria de OAE</title>
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="css/peerjs-styles.css" />
    <link rel="stylesheet" href="css/auth-styles.css" />
    <style>
      /* Extra fonts */
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap");
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- Main Panel -->
      <main class="main-content">
        <header class="header">
          <div class="header-top">
            <div class="header-title-section">
              <h1>
                üîç OAE Revisor V3.1
                <span
                  id="workTitle"
                  style="
                    color: var(--text-muted);
                    font-size: 0.9rem;
                    font-weight: normal;
                  "
                ></span>
              </h1>
            </div>
            <div class="header-controls">
              <button
                class="theme-toggle"
                onclick="toggleTheme()"
                title="Alternar Modo Claro/Escuro"
              >
                <span id="themeIcon">üåô</span>
              </button>

              <!-- Network Status Indicator -->
              <div class="logged-in-only" style="display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: var(--bg-secondary); border-radius: 8px; margin-right: 10px;">
                <div id="headerNetworkIndicator" style="width: 10px; height: 10px; border-radius: 50%; background: var(--danger); cursor: pointer;" title="Status da rede P2P - Clique para conectar" onclick="UI.showQuickConnectModal()"></div>
                <span id="headerPeersCount" style="font-size: 0.85rem; font-weight: 600; color: var(--text-color); cursor: pointer;" onclick="UI.showQuickConnectModal()">0 online</span>
                <button
                  class="btn btn-info"
                  onclick="UI.showQuickConnectModal()"
                  title="Conectar com outros usu√°rios"
                  style="padding: 4px 8px; font-size: 0.75rem; height: 24px; margin-left: 4px;"
                >
                  üîó Conectar
                </button>
                <button
                  class="btn btn-secondary"
                  onclick="UI.forceSyncNow()"
                  title="For√ßar sincroniza√ß√£o agora"
                  style="padding: 4px 8px; font-size: 0.75rem; height: 24px;"
                >
                  üîÑ Sync
                </button>
              </div>

              <!-- Lote Toggle (Admin e Avaliadores) -->
              <div id="loteToggle" style="display: none; margin-right: 10px; align-items: center;">
                <label style="color: var(--text-color); margin-right: 5px; font-size: 0.9rem;">Filtrar por:</label>
                <select id="loteFilter" onchange="UI.handleLoteFilterChange()" style="padding: 5px 10px; border-radius: 4px; background: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color);">
                  <option value="">Todos os Lotes</option>
                  <option value="Lote 01">Lote 01</option>
                  <option value="Lote 02">Lote 02</option>
                  <option value="Lote 03">Lote 03</option>
                </select>
              </div>
              <button
                class="btn btn-warning admin-only"
                onclick="UserManager.showUserManagementModal()"
                title="Gerenciar usu√°rios (apenas admin)"
              >
                üë• Gerenciar Usu√°rios
              </button>
              <div class="role-switcher logged-in-only">
                <!-- <button class="btn role-btn" data-role="avaliador">
                  Avaliador
                </button>
                <button class="btn role-btn" data-role="inspetor">
                  Inspetor
                </button> -->
              </div>
              <button
                class="btn btn-secondary logged-in-only"
                onclick="UI.showWorksModal()"
                title="Ver obras salvas no banco"
              >
                üìÇ Gerenciar Obras
              </button>
              <button
                class="btn btn-info logged-in-only"
                onclick="UI.showEditHistoryModal()"
                title="Ver hist√≥rico de edi√ß√µes desta obra"
              >
                üìú Hist√≥rico
              </button>
              <button
                class="btn btn-success logged-in-only"
                onclick="UI.saveToDatabase()"
                title="Salvar obra no banco de dados"
              >
                üíæ Salvar DB
              </button>
              <button
                class="btn btn-warning logged-in-only"
                onclick="UI.publicarObra()"
                title="Publicar/Enviar obra para pr√≥xima etapa"
                style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);"
              >
                üì® Publicar
              </button>
              <button
                class="btn btn-primary logged-in-only"
                onclick="UI.showExportModal()"
              >
                üì§ Exportar
              </button>
              <button
                class="btn btn-danger logged-in-only"
                onclick="UI.generateFormattedPDF()"
                title="Gerar PDF formatado"
              >
                üìÑ Gerar PDF
              </button>
            </div>
          </div>

          <div class="tabs-container">
            <button class="tab-btn active" data-tab="ident">
              Identifica√ß√£o
            </button>
            <button class="tab-btn" data-tab="carac">
              Caracter√≠sticas Funcionais
            </button>
            <button class="tab-btn" data-tab="elem">
              Elementos Componentes
            </button>
            <button class="tab-btn" data-tab="aspect">
              Aspectos Especiais
            </button>
            <button class="tab-btn" data-tab="defic">
              Defici√™ncias Funcionais
            </button>
            <button class="tab-btn" data-tab="rotas">Rotas Alternativas</button>
            <button class="tab-btn" data-tab="obs">Observa√ß√µes</button>
            <button class="tab-btn" data-tab="anexos">Arquivos Anexos</button>
            <button class="tab-btn" data-tab="msgs">Mensagens</button>
          </div>
        </header>

        <div class="tab-content">
          <!-- IDENTIFICA√á√ÉO -->
          <div class="tab-panel active" id="ident">
            <div class="section">
              <div class="section-title">üë§ Revisor</div>
              <div class="form-grid-3">
                <div class="form-field">
                  <label class="form-label" for="avaliadorNome"
                    >Nome do Avaliador</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="avaliadorNome"
                      data-sync="avaliador"
                      placeholder="Seu nome..."
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('avaliador', 'Nome do Avaliador')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="obraNome">Obra (Nome)</label>
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="obraNome"
                      data-sync="nome"
                      placeholder="Nome da OAE"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('nome', 'Obra (Nome)')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="obraCodigo"
                    >C√≥digo (Ex: OAE-123)</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="obraCodigo"
                      data-sync="codigo"
                      placeholder="000.000"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('codigo', 'C√≥digo OAE')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="section">
              <div class="section-title">ÔøΩ Dados B√°sicos</div>
              <div class="form-grid-6">
                <div class="form-field">
                  <label class="form-label" for="f_ident_orig"
                    >Identifica√ß√£o</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_ident_orig"
                      data-field="ident_orig"
                      placeholder="Ponte sobre..."
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('ident_orig', 'Identifica√ß√£o')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_comprimento"
                    >Comprimento (m)</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_comprimento"
                      data-field="comprimento"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('comprimento', 'Comprimento (m)')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_largura">Largura (m)</label>
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_largura"
                      data-field="largura"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('largura', 'Largura (m)')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_trem_tipo">Trem-Tipo</label>
                  <div class="field-wrapper">
                    <select
                      class="form-input no-btn"
                      id="f_trem_tipo"
                      data-field="trem_tipo"
                    >
                      <option value="">Selecione</option>
                      <option value="Classe 24">Classe 24</option>
                      <option value="Classe 30">Classe 30</option>
                      <option value="Classe 45">Classe 45</option>
                    </select>
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('trem_tipo', 'Trem-Tipo')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_ano"
                    >Ano de Constru√ß√£o</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_ano"
                      data-field="ano"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('ano', 'Ano de Constru√ß√£o')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_natureza"
                    >Natureza da Estrutura</label
                  >
                  <div class="field-wrapper">
                    <select
                      class="form-input no-btn"
                      id="f_natureza"
                      data-field="natureza"
                    >
                      <option value="">Selecione</option>
                      <option value="Ponte">Ponte</option>
                      <option value="Viaduto">Viaduto</option>
                      <option value="Passarela">Passarela</option>
                      <option value="Ponte M√≥vel">Ponte M√≥vel</option>
                    </select>
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('natureza', 'Natureza da Estrutura')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="section">
              <div class="section-title">üìç Localiza√ß√£o</div>
              <div class="form-grid-4">
                <div class="form-field">
                  <label class="form-label" for="f_uf">UF *</label>
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_uf"
                      data-field="uf"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('uf', 'UF')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_via">Via *</label>
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_via"
                      data-field="via"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('via', 'Via')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_local_via"
                    >Local na Via (km) *</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_local_via"
                      data-field="local_via"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('local_via', 'Local na Via (km)')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_cidade"
                    >Cidade mais pr√≥xima *</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_cidade"
                      data-field="cidade"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('cidade', 'Cidade mais pr√≥xima')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="section">
              <div class="section-title">
                üåç Coordenadas Geogr√°ficas SIRCAS 2000
              </div>
              <div class="form-grid-3">
                <div class="form-field">
                  <label class="form-label" for="f_latitude">Latitude *</label>
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_latitude"
                      data-field="latitude"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('latitude', 'Latitude')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_longitude"
                    >Longitude *</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_longitude"
                      data-field="longitude"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('longitude', 'Longitude')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_altitude"
                    >Altitude Geom√©trica (m) *</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_altitude"
                      data-field="altitude"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('altitude', 'Altitude')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="section">
              <div class="section-title">üî¢ SNV</div>
              <div class="form-grid-2">
                <div class="form-field">
                  <label class="form-label" for="f_snv_codigo">C√≥digo *</label>
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_snv_codigo"
                      data-field="snv_codigo"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('snv_codigo', 'C√≥digo SNV')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_snv_versao">Vers√£o *</label>
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_snv_versao"
                      data-field="snv_versao"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('snv_versao', 'Vers√£o SNV')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="section">
              <div class="section-title">üè¢ Respons√°veis e Gest√£o</div>
              <div class="form-grid-3">
                <div class="form-field">
                  <label class="form-label" for="f_superintendencia"
                    >Superintend√™ncia Regional *</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_superintendencia"
                      data-field="superintendencia"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('superintendencia', 'Superintend√™ncia')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_unidade_local"
                    >Unidade Local *</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_unidade_local"
                      data-field="unidade_local"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('unidade_local', 'Unidade Local')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_adm_dnit"
                    >Administra√ß√£o DNIT? *</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_adm_dnit"
                      data-field="adm_dnit"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('adm_dnit', 'Adm DNIT?')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_administrador"
                    >Administrador *</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_administrador"
                      data-field="administrador"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('administrador', 'Administrador')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_projetista"
                    >Projetista *</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_projetista"
                      data-field="projetista"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('projetista', 'Projetista')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_construtor"
                    >Construtor *</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_construtor"
                      data-field="construtor"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('construtor', 'Construtor')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_loc_projeto"
                    >Localiza√ß√£o do projeto</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_loc_projeto"
                      data-field="loc_projeto"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('loc_projeto', 'Loc. Projeto')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_loc_docs_constr"
                    >Loc. de documentos de Constru√ß√£o</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_loc_docs_constr"
                      data-field="loc_docs_constr"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('loc_docs_constr', 'Loc. Docs Constr.')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_loc_docs_diversos"
                    >Loc. de documentos diversos</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_loc_docs_diversos"
                      data-field="loc_docs_diversos"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('loc_docs_diversos', 'Loc. Docs Diversos')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- CARACTER√çSTICAS FUNCIONAIS -->
          <div class="tab-panel" id="carac">
            <div class="section">
              <div class="section-title">üö¶ Caracter√≠sticas e Tr√°fego</div>
              <div class="form-grid-8">
                <div class="form-field">
                  <label class="form-label" for="f_atend_snv"
                    >Atendimento ao SNV *</label
                  >
                  <div class="field-wrapper">
                    <select
                      class="form-input no-btn"
                      id="f_atend_snv"
                      data-field="atend_snv"
                    >
                      <option value="">Selecione</option>
                      <option value="Em servi√ßo">Em servi√ßo</option>
                      <option value="Demolida">Demolida</option>
                      <option value="Inconclusa">Inconclusa</option>
                      <option value="Inserv√≠vel">Inserv√≠vel</option>
                    </select>
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('atend_snv', 'Atendimento SNV')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_tipo_regiao"
                    >Tipo de Regi√£o *</label
                  >
                  <div class="field-wrapper">
                    <select
                      class="form-input no-btn"
                      id="f_tipo_regiao"
                      data-field="tipo_regiao"
                    >
                      <option value="">Selecione</option>
                      <option value="Plana">Plana</option>
                      <option value="Ondulada">Ondulada</option>
                      <option value="Montanhosa">Montanhosa</option>
                      <option value="N√£o Informado">N√£o Informado</option>
                    </select>
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('tipo_regiao', 'Tipo de Regi√£o')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_tipo_tracado"
                    >Tipo de Tra√ßado *</label
                  >
                  <div class="field-wrapper">
                    <select
                      class="form-input no-btn"
                      id="f_tipo_tracado"
                      data-field="tipo_tracado"
                    >
                      <option value="">Selecione</option>
                      <option value="Tangente">Tangente</option>
                      <option value="Curva">Curva</option>
                      <option value="N√£o Informado">N√£o Informado</option>
                    </select>
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('tipo_tracado', 'Tipo de Tra√ßado')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_rampa"
                    >Rampa M√°xima (%)</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_rampa"
                      data-field="rampa"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('rampa', 'Rampa M√°xima')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_raio"
                    >Raio da Curva (m)</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_raio"
                      data-field="raio"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('raio', 'Raio da Curva')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_vmda">VMDa *</label>
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_vmda"
                      data-field="vmda"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('vmda', 'VMDa')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_vmdc">VMDc *</label>
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_vmdc"
                      data-field="vmdc"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('vmdc', 'VMDc')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div
                  class="form-field"
                  style="justify-content: flex-end; padding-bottom: 2px"
                >
                
                </div>
              </div>
            </div>

            <div class="section">
              <div class="section-title">üìè Dimens√µes</div>
              <div class="form-grid-10">
                <div class="form-field">
                  <label class="form-label" for="f_faixas"
                    >N√∫mero de Faixas *</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_faixas"
                      data-field="faixas"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('faixas', 'Num. Faixas')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_larg_faixa"
                    >Largura da Faixa (m) *</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_larg_faixa"
                      data-field="larg_faixa"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('larg_faixa', 'Larg. Faixa')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_acost_dir"
                    >Acostamento Dir. (m) *</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_acost_dir"
                      data-field="acost_dir"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('acost_dir', 'Acost. Direito')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_acost_esq"
                    >Acostamento Esq. (m) *</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_acost_esq"
                      data-field="acost_esq"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('acost_esq', 'Acost. Esquerdo')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_calc_dir"
                    >Cal√ßada Dir. (m) *</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_calc_dir"
                      data-field="calc_dir"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('calc_dir', 'Cal√ßada Direita')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_calc_esq"
                    >Cal√ßada Esq. (m) *</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_calc_esq"
                      data-field="calc_esq"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('calc_esq', 'Cal√ßada Esquerda')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_gab_hor"
                    >Gabarito Horiz. (m)</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_gab_hor"
                      data-field="gab_hor"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('gab_hor', 'Gabarito Horiz.')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_gab_ver"
                    >Gabarito Vert. (m)</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_gab_ver"
                      data-field="gab_ver"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('gab_ver', 'Gabarito Vert.')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_larg_pista_antes"
                    >Larg. pista antes (m) *</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_larg_pista_antes"
                      data-field="larg_pista_antes"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('larg_pista_antes', 'Larg. Pista Antes')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_larg_pista_depois"
                    >Larg. pista depois (m) *</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_larg_pista_depois"
                      data-field="larg_pista_depois"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('larg_pista_depois', 'Larg. Pista Depois')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="section">
              <div class="section-title">üß± Tramos da OAE</div>
              <div
                style="
                  display: flex;
                  gap: 15px;
                  align-items: center;
                  margin-bottom: 20px;
                  background: var(--bg-tertiary);
                  padding: 15px;
                  border-radius: var(--radius-md);
                "
              >
                <label
                  style="font-weight: 700; color: var(--primary)"
                  for="numTramosGlobal"
                  >N√∫mero de Tramos:</label
                >
                <div class="field-wrapper" style="width: auto">
                  <input
                    type="number"
                    id="numTramosGlobal"
                    min="1"
                    max="50"
                    value="1"
                    style="
                      width: 70px;
                      padding: 5px;
                      border-radius: 4px;
                      border: 1px solid var(--border);
                    "
                    data-sync="numTramos"
                  />
                  <button
                    class="error-btn"
                    onclick="UI.openErrorModal('numTramos', 'N√∫mero de Tramos')"
                  >
                    ‚ö†
                  </button>
                </div>
                <span style="font-size: 0.8rem; color: var(--text-muted)"
                  >+ Tramo Complementar (C)</span
                >
              </div>
              <div id="tramosCaracContainer"></div>
            </div>
          </div>

          <!-- ELEMENTOS COMPONENTES -->
          <div class="tab-panel" id="elem">
            <div class="section evaluator-only">
              <div class="section-title">
                ‚ûï Adicionar Inconsist√™ncia em Elemento
              </div>
              <div class="form-grid">
                <div class="form-field">
                  <label class="form-label">Tramo</label>
                  <select class="form-input no-btn" id="bulkTramo"></select>
                </div>
                <div class="form-field">
                  <label class="form-label">Filtrar por Regi√£o</label>
                  <select
                    class="form-input no-btn"
                    id="bulkRegiaoFiltro"
                    onchange="UI.filterElementsByRegion()"
                  >
                    <option value="">Todas as Regi√µes</option>
                    <option value="Apoio">Apoio</option>
                    <option value="Superestrutura">Superestrutura</option>
                    <option value="Transi√ß√£o">Transi√ß√£o</option>
                  </select>
                </div>
                <div class="form-field">
                  <label class="form-label">Fam√≠lia de Elemento</label>
                  <select
                    class="form-input no-btn"
                    id="bulkFamilia"
                    style="max-height: 200px"
                  ></select>
                </div>
                <div class="form-field">
                  <label class="form-label">Inconsist√™ncia</label>
                  <select class="form-input no-btn" id="bulkErro"></select>
                </div>
                <div class="form-field" style="grid-column: span 2">
                  <label class="form-label">Observa√ß√£o / Nota</label>
                  <textarea
                    class="form-input no-btn"
                    id="bulkObs"
                    style="height: 100px"
                  ></textarea>
                </div>
              </div>
              <button class="btn btn-primary" onclick="UI.addBulkElements()">
                Apontar Elemento(s)
              </button>
            </div>

            <div id="elementsContainer"></div>
          </div>

          <!-- ASPECTOS ESPECIAIS -->
          <div class="tab-panel" id="aspect">
            <div class="section">
              <div class="section-title">üíé Aspectos Especiais</div>
              <div class="evaluator-only" style="margin-bottom: 15px">
                <button class="btn btn-primary" onclick="UI.openAspectModal()">
                  ‚ûï Adicionar Aspecto Especial
                </button>
              </div>
              <div id="aspectosContainer">
                <!-- List will be rendered here -->
              </div>
            </div>
          </div>

          <!-- DEFICI√äNCIAS FUNCIONAIS -->
          <div class="tab-panel" id="defic">
            <div class="section">
              <div class="section-title">‚ö†Ô∏è Defici√™ncias Funcionais</div>
              <div class="evaluator-only" style="margin-bottom: 15px">
                <button class="btn btn-primary" onclick="UI.openDeficModal()">
                  ‚ûï Adicionar Defici√™ncia Funcional
                </button>
              </div>
              <div id="deficienciasContainer">
                <!-- Table will be rendered here -->
              </div>
            </div>
          </div>

          <!-- ROTAS ALTERNATIVAS -->
          <div class="tab-panel" id="rotas">
            <div class="section">
              <div class="section-title">üîÑ Rotas Alternativas</div>
              <div class="form-grid">
                <div class="form-field" style="grid-column: span 2">
                  <label class="form-label" for="f_rota">Rota Sugerida</label>
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_rota"
                      data-field="rota"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('rota', 'Rota Alternativa')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
                <div class="form-field">
                  <label class="form-label" for="f_rota_km"
                    >Acr√©scimo de KM</label
                  >
                  <div class="field-wrapper">
                    <input
                      type="text"
                      class="form-input"
                      id="f_rota_km"
                      data-field="rota_km"
                    />
                    <button
                      class="error-btn"
                      onclick="UI.openErrorModal('rota_km', 'Acr√©scimo KM')"
                    >
                      ‚ö†
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- OBSERVA√á√ïES -->
          <div class="tab-panel" id="obs">
            <div class="section">
              <div class="section-title">üìù Observa√ß√µes Gerais</div>
              <div class="form-field">
                <label class="form-label" for="f_observacoes"
                  >Texto das Observa√ß√µes</label
                >
                <div class="field-wrapper">
                  <textarea
                    class="form-input"
                    id="f_observacoes"
                    data-field="observacoes"
                    style="height: 300px"
                  ></textarea>
                  <button
                    class="error-btn"
                    onclick="UI.openErrorModal('observacoes', 'Observa√ß√µes')"
                  >
                    ‚ö†
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- ARQUIVOS ANEXOS -->
          <div class="tab-panel" id="anexos">
            <div class="section evaluator-only">
              <div class="section-title">üìé Apontar Erro em Anexo / Foto</div>
              <div class="form-grid">
                <div class="form-field">
                  <label class="form-label" for="anexoNome"
                    >Nome do Arquivo (Ex: F-01)</label
                  >
                  <input type="text" class="form-input no-btn" id="anexoNome" />
                </div>
                <div class="form-field">
                  <label class="form-label" for="anexoTipo"
                    >Tipo de Arquivo</label
                  >
                  <select class="form-input no-btn" id="anexoTipo">
                    <option>Foto</option>
                    <option>PDF (Relat√≥rio/Croqui)</option>
                    <option>DWG</option>
                    <option>KML</option>
                    <option>Outro</option>
                  </select>
                </div>
                <div class="form-field">
                  <label class="form-label" for="anexoTipoErro"
                    >Tipo de Inconsist√™ncia</label
                  >
                  <select class="form-input no-btn" id="anexoTipoErro">
                    <option>Legenda divergente do conte√∫do</option>
                    <option>Qualidade insuficiente</option>
                    <option>Foto duplicada</option>
                    <option>N√£o corresponde ao local</option>
                    <option>Falta arquivo obrigat√≥rio</option>
                  </select>
                </div>
                <div class="form-field">
                  <label class="form-label" for="anexoObs">Observa√ß√£o</label>
                  <input type="text" class="form-input no-btn" id="anexoObs" />
                </div>
              </div>
              <button class="btn btn-primary" onclick="UI.addAnexoError()">
                Adicionar Erro de Anexo
              </button>
            </div>
            <div id="attachmentsContainer" style="margin-top: 20px"></div>
          </div>

          <!-- MENSAGENS -->
          <div class="tab-panel" id="msgs">
            <!-- Multi-Peer Network Status -->
            <div class="section">
              <div class="section-title">üåê Rede Multi-usu√°rio</div>

              <!-- User Identity -->
              <div
                style="
                  margin-bottom: 15px;
                  padding: 10px;
                  background: var(--bg-tertiary);
                  border-radius: 6px;
                "
              >
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                  "
                >
                  <div>
                    <div style="font-size: 0.8rem; color: var(--text-muted)">
                      Sua Identidade
                    </div>
                    <div id="userIdentity" style="font-weight: 600">
                      N√£o configurado
                    </div>
                  </div>
                  <button
                    class="btn btn-secondary"
                    onclick="UI.showUserSetupModal()"
                    style="height: 28px; font-size: 0.75rem"
                  >
                    üë§ Configurar
                  </button>
                </div>
              </div>

              <!-- Network Overview -->
              <div
                style="
                  display: flex;
                  gap: 15px;
                  align-items: center;
                  margin-bottom: 15px;
                "
              >
                <div
                  id="networkStatus"
                  class="connection-status disconnected"
                  style="
                    width: 12px;
                    height: 12px;
                    border-radius: 50%;
                    background: var(--danger);
                  "
                ></div>
                <span
                  id="networkStatusText"
                  style="font-size: 0.9rem; color: var(--text-muted)"
                  >Rede offline</span
                >
                <div style="flex: 1"></div>
                <button
                  class="btn btn-secondary"
                  onclick="UI.showNetworkModal()"
                  style="height: 32px; font-size: 0.8rem"
                >
                  üîó Gerenciar Rede
                </button>
              </div>

              <!-- Network Stats -->
              <div
                id="networkStats"
                style="
                  display: grid;
                  grid-template-columns: repeat(3, 1fr);
                  gap: 10px;
                  margin-bottom: 15px;
                "
              >
                <div
                  style="
                    text-align: center;
                    padding: 8px;
                    background: var(--bg-secondary);
                    border-radius: 4px;
                  "
                >
                  <div
                    id="totalPeersCount"
                    style="
                      font-size: 1.2rem;
                      font-weight: 700;
                      color: var(--primary);
                    "
                  >
                    0
                  </div>
                  <div style="font-size: 0.7rem; color: var(--text-muted)">
                    Total de Usu√°rios
                  </div>
                </div>
                <div
                  style="
                    text-align: center;
                    padding: 8px;
                    background: var(--bg-secondary);
                    border-radius: 4px;
                  "
                >
                  <div
                    id="connectedPeersCount"
                    style="
                      font-size: 1.2rem;
                      font-weight: 700;
                      color: var(--success);
                    "
                  >
                    0
                  </div>
                  <div style="font-size: 0.7rem; color: var(--text-muted)">
                    Conectados
                  </div>
                </div>
                <div
                  style="
                    text-align: center;
                    padding: 8px;
                    background: var(--bg-secondary);
                    border-radius: 4px;
                  "
                >
                  <div
                    id="syncStatus"
                    style="
                      font-size: 1.2rem;
                      font-weight: 700;
                      color: var(--warning);
                    "
                  >
                    ‚è∏
                  </div>
                  <div style="font-size: 0.7rem; color: var(--text-muted)">
                    Sincroniza√ß√£o
                  </div>
                </div>
              </div>

              <!-- Connected Peers List -->
              <div id="connectedPeersList" style="display: none">
                <div
                  style="
                    font-size: 0.8rem;
                    font-weight: 600;
                    margin-bottom: 8px;
                    color: var(--text-muted);
                  "
                >
                  Usu√°rios Conectados:
                </div>
                <div
                  id="peersList"
                  style="display: flex; flex-direction: column; gap: 5px"
                ></div>
              </div>

              <div
                id="remoteTypingIndicator"
                style="
                  display: none;
                  margin-bottom: 10px;
                  padding: 8px;
                  background: var(--bg-secondary);
                  border-radius: 4px;
                  font-size: 0.85rem;
                  color: var(--primary);
                  font-style: italic;
                "
              >
                > Algu√©m est√° digitando...
              </div>
            </div>

            <!-- Status Bar -->
            <div
              style="
                display: flex;
                gap: 15px;
                margin-bottom: 20px;
                padding: 15px;
                background: var(--bg-secondary);
                border-radius: 8px;
              "
            >
              <div style="flex: 1; text-align: center">
                <div
                  style="
                    font-size: 0.75rem;
                    color: var(--text-muted);
                    font-weight: 600;
                  "
                >
                  TOTAL DE INCONSIST√äNCIAS
                </div>
                <div
                  id="msgsTotalCount"
                  style="
                    font-size: 1.5rem;
                    font-weight: 700;
                    color: var(--primary);
                  "
                >
                  0
                </div>
              </div>
              <div style="flex: 1; text-align: center">
                <div
                  style="
                    font-size: 0.75rem;
                    color: var(--text-muted);
                    font-weight: 600;
                  "
                >
                  PENDENTES
                </div>
                <div
                  id="msgsPendingCount"
                  style="
                    font-size: 1.5rem;
                    font-weight: 700;
                    color: var(--warning);
                  "
                >
                  0
                </div>
              </div>
              <div style="flex: 1; text-align: center">
                <div
                  style="
                    font-size: 0.75rem;
                    color: var(--text-muted);
                    font-weight: 600;
                  "
                >
                  CORRIGIDAS
                </div>
                <div
                  id="msgsCompletedCount"
                  style="
                    font-size: 1.5rem;
                    font-weight: 700;
                    color: var(--success);
                  "
                >
                  0
                </div>
              </div>
            </div>

            <div class="section">
              <div class="section-title">üí¨ Canal de Comunica√ß√£o</div>
              <div class="evaluator-only">
                <div class="form-field" style="margin-bottom: 20px">
                  <label class="form-label">Escrever Mensagem</label>
                  <textarea
                    class="form-input no-btn"
                    id="novaMensagem"
                    style="height: 100px"
                    placeholder="D√∫vida ou esclarecimento sobre a auditoria..."
                    oninput="UI.handleTyping()"
                  ></textarea>
                </div>
                <button class="btn btn-primary" onclick="UI.addMensagem()">
                  Enviar Mensagem
                </button>
              </div>

              <div id="mensagensContainer" style="margin-top: 30px"></div>
            </div>
          </div>
        </div>
      </main>

      <!-- Sidebar Report -->
      <aside class="sidebar-report">
        <div class="sidebar-header">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <span style="font-weight: 700; font-size: 0.9rem"
              >Relat√≥rio em Tempo Real</span
            >
            <span
              id="totalErrorBadge"
              style="
                background: var(--danger);
                color: white;
                padding: 2px 8px;
                border-radius: 10px;
                font-size: 0.75rem;
                font-weight: 700;
              "
              >0</span
            >
          </div>
        </div>
        <textarea id="reportText" class="report-textarea" readonly></textarea>
        <div
          style="
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 10px;
          "
        >
          <button
            class="btn btn-primary"
            style="justify-content: center"
            onclick="UI.copyReport()"
          >
            üìã Copiar Relat√≥rio
          </button>
          <button
            class="btn btn-secondary"
            style="justify-content: center"
            onclick="UI.clearAll()"
          >
            üóëÔ∏è Limpar Tudo
          </button>
        </div>
      </aside>
    </div>

    <!-- Error Modal -->
    <div class="modal-backdrop" id="errorModal">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">Apontar Inconsist√™ncia</h3>
          <button class="modal-close" onclick="UI.closeErrorModal()">
            &times;
          </button>
        </div>
        <div class="modal-body" id="modalBody">
          <!-- Dynamic Content -->
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-danger"
            id="btnRemoveError"
            onclick="UI.clearFieldError()"
          >
            Limpar Erro
          </button>
          <button class="btn btn-secondary" onclick="UI.closeErrorModal()">
            Cancelar
          </button>
          <button class="btn btn-primary" onclick="UI.applyError()">
            Aplicar
          </button>
        </div>
      </div>
    </div>

    <!-- Deficiencia Modal -->
    <div class="modal-backdrop" id="deficModal">
      <div class="modal" style="max-width: 500px">
        <div class="modal-header">
          <h3 class="modal-title">Adicionar Defici√™ncia Funcional</h3>
          <button class="modal-close" onclick="UI.closeDeficModal()">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <div class="form-field">
            <label class="form-label">Selecione a Defici√™ncia</label>
            <select class="form-input no-btn" id="modalDeficSelect">
              <option value="">Selecione</option>
              <!-- List populated via JS -->
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="UI.closeDeficModal()">
            Cancelar
          </button>
          <button class="btn btn-primary" onclick="UI.addDeficFromModal()">
            Adicionar
          </button>
        </div>
      </div>
    </div>

    <!-- Aspecto Especial Modal -->
    <div class="modal-backdrop" id="aspectModal">
      <div class="modal" style="max-width: 500px">
        <div class="modal-header">
          <h3 class="modal-title">Adicionar Aspecto Especial</h3>
          <button class="modal-close" onclick="UI.closeAspectModal()">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <div class="form-field">
            <label class="form-label">Selecione o Aspecto</label>
            <select class="form-input no-btn" id="modalAspectSelect">
              <option value="">Selecione</option>
              <!-- List populated via JS -->
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="UI.closeAspectModal()">
            Cancelar
          </button>
          <button class="btn btn-primary" onclick="UI.addAspectFromModal()">
            Adicionar
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Anexo Modal -->
    <div class="modal-backdrop" id="editAnexoModal">
      <div class="modal" style="max-width: 500px">
        <div class="modal-header">
          <h3 class="modal-title">Editar Erro em Anexo</h3>
          <button class="modal-close" onclick="UI.closeEditAnexoModal()">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editAnexoId" />
          <div class="form-grid">
            <div class="form-field">
              <label class="form-label">Nome do Arquivo</label>
              <input type="text" class="form-input no-btn" id="editAnexoNome" />
            </div>
            <div class="form-field">
              <label class="form-label">Inconsist√™ncia</label>
              <select class="form-input no-btn" id="editAnexoTipoErro">
                <option>Legenda divergente do conte√∫do</option>
                <option>Qualidade insuficiente</option>
                <option>Foto duplicada</option>
                <option>N√£o corresponde ao local</option>
                <option>Falta arquivo obrigat√≥rio</option>
              </select>
            </div>
            <div class="form-field" style="grid-column: span 2">
              <label class="form-label">Observa√ß√£o</label>
              <textarea
                class="form-input no-btn"
                id="editAnexoObs"
                style="height: 80px"
              ></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="UI.closeEditAnexoModal()">
            Cancelar
          </button>
          <button class="btn btn-primary" onclick="UI.saveAnexoEdit()">
            Salvar Altera√ß√µes
          </button>
        </div>
      </div>
    </div>

    <!-- User Setup Modal -->
    <div class="modal-backdrop" id="userSetupModal">
      <div class="modal" style="max-width: 500px">
        <div class="modal-header">
          <h3 class="modal-title">üë§ Configurar Identidade</h3>
          <button class="modal-close" onclick="UI.closeUserSetupModal()">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <div class="form-field">
            <label class="form-label">Seu Email</label>
            <input
              type="email"
              class="form-input"
              id="userEmail"
              placeholder="seu.email@empresa.com"
            />
            <small style="color: var(--text-muted)"
              >Ser√° usado como identifica√ß√£o √∫nica</small
            >
          </div>
          <div class="form-field">
            <label class="form-label">Seu Nome</label>
            <input
              type="text"
              class="form-input"
              id="userName"
              placeholder="Seu nome"
            />
            <small style="color: var(--text-muted)"
              >Como outros usu√°rios ver√£o voc√™</small
            >
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="UI.closeUserSetupModal()">
            Cancelar
          </button>
          <button class="btn btn-primary" onclick="UI.saveUserSetup()">
            üíæ Salvar
          </button>
        </div>
      </div>
    </div>

    <!-- Network Management Modal -->
    <div class="modal-backdrop" id="networkModal">
      <div class="modal" style="max-width: 600px">
        <div class="modal-header">
          <h3 class="modal-title">üîó Gerenciar Rede</h3>
          <button class="modal-close" onclick="UI.closeNetworkModal()">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <!-- Add Peer Section -->
          <div class="section">
            <div class="section-title">‚ûï Adicionar Usu√°rio</div>
            <div class="form-field">
              <label class="form-label">Email do Usu√°rio</label>
              <input
                type="email"
                class="form-input"
                id="newPeerEmail"
                placeholder="email@outraempresa.com"
              />
              <small style="color: var(--text-muted)"
                >Digite o email para gerar o ID de conex√£o</small
              >
            </div>
            <button class="btn btn-primary" onclick="UI.addPeerByEmail()">
              üîó Adicionar Usu√°rio
            </button>
          </div>

          <!-- Known Peers List -->
          <div class="section" style="margin-top: 20px">
            <div class="section-title">üë• Usu√°rios Conhecidos</div>
            <div
              id="knownPeersList"
              style="max-height: 200px; overflow-y: auto"
            >
              <p style="color: var(--text-muted); text-align: center">
                Nenhum usu√°rio adicionado
              </p>
            </div>
          </div>

          <!-- Network Stats -->
          <div class="section" style="margin-top: 20px">
            <div class="section-title">üìä Estat√≠sticas da Rede</div>
            <div
              id="networkStatsModal"
              style="
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
              "
            >
              <div
                style="
                  text-align: center;
                  padding: 10px;
                  background: var(--bg-secondary);
                  border-radius: 4px;
                "
              >
                <div
                  id="modalTotalPeers"
                  style="font-size: 1.5rem; font-weight: 700"
                >
                  0
                </div>
                <div style="font-size: 0.8rem; color: var(--text-muted)">
                  Total
                </div>
              </div>
              <div
                style="
                  text-align: center;
                  padding: 10px;
                  background: var(--bg-secondary);
                  border-radius: 4px;
                "
              >
                <div
                  id="modalConnectedPeers"
                  style="font-size: 1.5rem; font-weight: 700"
                >
                  0
                </div>
                <div style="font-size: 0.8rem; color: var(--text-muted)">
                  Conectados
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="UI.closeNetworkModal()">
            Fechar
          </button>
          <button class="btn btn-warning" onclick="UI.disconnectAll()">
            üîå Desconectar Todos
          </button>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast">Mensagem salva com sucesso!</div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <h2>üîê Login - OAE Revisor V3.1</h2>
        </div>
        <div class="modal-body">
          <div class="form-field">
            <label class="form-label" for="loginEmail">Email</label>
            <input
              type="email"
              class="form-input"
              id="loginEmail"
              placeholder="seu@email.com"
              autocomplete="off"
            />
          </div>
          <div class="form-field">
            <label class="form-label" for="loginPassword">Senha</label>
            <div class="password-field-wrapper">
              <input
                type="password"
                class="form-input"
                id="loginPassword"
                placeholder="Digite sua senha"
                autocomplete="new-password"
              />
              <button
                type="button"
                class="password-toggle-btn"
                onclick="togglePasswordVisibility('loginPassword')"
                title="Mostrar/Ocultar senha"
              >
                üëÅÔ∏è
              </button>
            </div>
          </div>
          <div id="loginError"></div>
          <button class="btn btn-primary" onclick="AuthSystem.loginFromForm()">
            üîê Entrar
          </button>

          <!-- Op√ß√µes de Sincroniza√ß√£o -->
          <div style="margin-top: 15px;">
            <button
              class="btn btn-primary"
              onclick="AuthSystem.showSyncOptionsModal()"
              style="width: 100%; justify-content: center; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);"
            >
              üîÑ Op√ß√µes de Sincroniza√ß√£o
            </button>
          </div>

          <div style="margin-top: 15px; text-align: center">
            <button
              class="btn btn-link"
              onclick="AuthSystem.showChangePasswordModal()"
              style="
                background: none;
                border: none;
                color: var(--primary);
                text-decoration: underline;
                cursor: pointer;
              "
            >
              üîë Esqueci minha senha
            </button>
          </div>
          <div style="margin-top: 10px; text-align: center; font-size: 0.75rem; color: var(--text-muted)">
            Problemas? <a href="#" onclick="debugUsers(); return false;" style="color: var(--primary)">Verificar usu√°rios</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal-backdrop" style="display: none">
      <div class="modal">
        <div class="modal-header">
          <h2>üîë Alterar Senha</h2>
        </div>
        <div class="modal-body">
          <div class="form-field">
            <label class="form-label" for="changeEmail">Email</label>
            <input
              type="email"
              class="form-input"
              id="changeEmail"
              placeholder="seu@email.com"
            />
          </div>
          <div class="form-field">
            <label class="form-label" for="currentPassword">Senha Atual</label>
            <div class="password-field-wrapper">
              <input
                type="password"
                class="form-input"
                id="currentPassword"
                placeholder="Senha atual"
              />
              <button
                type="button"
                class="password-toggle-btn"
                onclick="togglePasswordVisibility('currentPassword')"
                title="Mostrar/Ocultar senha"
              >
                üëÅÔ∏è
              </button>
            </div>
          </div>
          <div class="form-field">
            <label class="form-label" for="newPassword">Nova Senha</label>
            <div class="password-field-wrapper">
              <input
                type="password"
                class="form-input"
                id="newPassword"
                placeholder="Nova senha"
              />
              <button
                type="button"
                class="password-toggle-btn"
                onclick="togglePasswordVisibility('newPassword')"
                title="Mostrar/Ocultar senha"
              >
                üëÅÔ∏è
              </button>
            </div>
          </div>
          <div class="form-field">
            <label class="form-label" for="confirmPassword"
              >Confirmar Nova Senha</label
            >
            <div class="password-field-wrapper">
              <input
                type="password"
                class="form-input"
                id="confirmPassword"
                placeholder="Confirme a nova senha"
              />
              <button
                type="button"
                class="password-toggle-btn"
                onclick="togglePasswordVisibility('confirmPassword')"
                title="Mostrar/Ocultar senha"
              >
                üëÅÔ∏è
              </button>
            </div>
          </div>
          <div id="changePasswordError"></div>
          <button
            class="btn btn-primary"
            onclick="AuthSystem.changePasswordFromForm()"
          >
            üîë Alterar Senha
          </button>
          <button
            class="btn btn-secondary"
            onclick="AuthSystem.hideChangePasswordModal()"
            style="margin-left: 10px"
          >
            Cancelar
          </button>
        </div>
      </div>
    </div>

    <!-- Modal: Op√ß√µes de Sincroniza√ß√£o -->
    <div id="syncOptionsModal" class="modal-backdrop" style="display: none">
      <div class="modal" style="max-width: 600px;">
        <div class="modal-header">
          <h2>üîÑ Op√ß√µes de Sincroniza√ß√£o</h2>
          <button class="btn-close" onclick="AuthSystem.hideSyncOptionsModal()">√ó</button>
        </div>
        <div class="modal-body">
          <p style="margin-bottom: 20px; color: var(--text-secondary);">
            Escolha um m√©todo para sincronizar usu√°rios entre dispositivos:
          </p>

          <!-- Op√ß√£o 1: PeerJS -->
          <div class="sync-option" onclick="AuthSystem.hideSyncOptionsModal(); document.getElementById('peerSyncModal').classList.add('show');">
            <div class="sync-option-icon">üåê</div>
            <div class="sync-option-content">
              <h3>PeerJS (Tempo Real)</h3>
              <p>Conecte diretamente com outro dispositivo online via P2P</p>
            </div>
            <div class="sync-option-arrow">‚Üí</div>
          </div>

          <!-- Op√ß√£o 2: QR Code -->
          <div class="sync-option" onclick="AuthSystem.hideSyncOptionsModal(); SyncMethods.showImportQRModal();">
            <div class="sync-option-icon">üì±</div>
            <div class="sync-option-content">
              <h3>QR Code</h3>
              <p>Escaneie ou cole um c√≥digo QR para importar usu√°rios</p>
            </div>
            <div class="sync-option-arrow">‚Üí</div>
          </div>

          <!-- Op√ß√£o 3: Link de Convite -->
          <div class="sync-option" onclick="AuthSystem.hideSyncOptionsModal(); alert('Abra o link de convite que voc√™ recebeu');">
            <div class="sync-option-icon">üîó</div>
            <div class="sync-option-content">
              <h3>Link de Convite</h3>
              <p>Abra o link compartilhado para sincronizar automaticamente</p>
            </div>
            <div class="sync-option-arrow">‚Üí</div>
          </div>

          <!-- Op√ß√£o 4: C√≥digo de 6 D√≠gitos -->
          <div class="sync-option" onclick="AuthSystem.hideSyncOptionsModal(); SyncMethods.showEnterCodeModal();">
            <div class="sync-option-icon">üî¢</div>
            <div class="sync-option-content">
              <h3>C√≥digo de 6 D√≠gitos</h3>
              <p>Digite o c√≥digo compartilhado pelo administrador</p>
            </div>
            <div class="sync-option-arrow">‚Üí</div>
          </div>

          <button
            class="btn btn-secondary"
            onclick="AuthSystem.hideSyncOptionsModal()"
            style="margin-top: 20px; width: 100%;"
          >
            Cancelar
          </button>
        </div>
      </div>
    </div>

    <!-- Modal: PeerJS Sync -->
    <div id="peerSyncModal" class="modal-backdrop" style="display: none">
      <div class="modal">
        <div class="modal-header">
          <h2>üåê Sincroniza√ß√£o PeerJS</h2>
          <button class="btn-close" onclick="document.getElementById('peerSyncModal').classList.remove('show')">√ó</button>
        </div>
        <div class="modal-body">
          <p style="margin-bottom: 15px; color: var(--text-secondary);">
            Digite o email do administrador para conectar e sincronizar usu√°rios:
          </p>
          <div class="form-field">
            <label class="form-label" for="peerIdToConnect">Email do Admin</label>
            <input
              type="email"
              class="form-input"
              id="peerIdToConnect"
              placeholder="admin@oae.com"
            />
          </div>
          <div id="syncStatus" style="margin: 10px 0; color: var(--text-secondary);"></div>
          <button
            class="btn btn-primary"
            onclick="AuthSystem.connectAndSyncUsers()"
            style="width: 100%;"
          >
            üîÑ Conectar e Sincronizar
          </button>
          <button
            class="btn btn-secondary"
            onclick="document.getElementById('peerSyncModal').classList.remove('show')"
            style="margin-top: 10px; width: 100%;"
          >
            Cancelar
          </button>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <!-- Temporarily load PeerJS from CDN for testing -->
    <script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
    <script>
      // Safety stub for SyncMethods so quick clicks don't error before the real script is parsed
      window.SyncMethods = window.SyncMethods || {
        showQRCodeModal: function(){ alert('Sincroniza√ß√£o indispon√≠vel no momento. Tente recarregar.'); },
        showInviteLinkModal: function(){ alert('Sincroniza√ß√£o indispon√≠vel no momento. Tente recarregar.'); },
        showSyncCodeModal: function(){ alert('Sincroniza√ß√£o indispon√≠vel no momento. Tente recarregar.'); }
      };
    </script>
    <script src="js/state.js"></script>
    <script src="js/db.js"></script>
    <script src="js/authSystem.js"></script>
    <script src="js/userManager.js"></script>
    <script src="js/syncMethods.js"></script>
    <script src="js/fieldChat.js"></script>
    <script src="js/auditSystem.js"></script>
    <script src="js/workManager.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/sync.js"></script>
    <script src="js/autosave.js"></script>
    <script src="js/importExport.js"></script>
    <script src="js/multiPeerSync.js"></script>

    <!-- Dev: Carrega helpers de teste quando ?runTests=1 estiver presente -->
    <script>
      if (location.search.indexOf('runTests=1') !== -1) {
        const s = document.createElement('script');
        s.src = 'js/dev/integrationTests.js';
        s.onload = () => console.log('Integration tests helper loaded. Use runIntegrationTests() from console to run.');
        document.body.appendChild(s);
      }
    </script>

    <script>
      // Fun√ß√£o para inicializar o sistema completo
      async function initializeApp() {
        await DB.init();
        await WorkManager.init();
        await AuditSystem.init();
        await FieldChat.init();
        UI.init(); // Inicializa UI e configura event listeners das abas
        Sync.setupBiBinding();
        Sync.loadState();
        UI.renderAll();
        UI.updateTabBadges();
        AutoSave.start();
      }

      // Init logic
      document.addEventListener("DOMContentLoaded", async () => {
        // Inicializa sistema de autentica√ß√£o primeiro
        await AuthSystem.init();

        // Verifica se usu√°rio est√° logado
        if (!AuthSystem.isLoggedIn) {
          AuthSystem.showLoginModal();
          return;
        }

        // Se j√° est√° logado, inicializa o app
        await initializeApp();
      });

      // Fun√ß√£o de login do formul√°rio
      async function loginFromForm() {
        const email = document.getElementById("loginEmail").value.trim();
        const password = document.getElementById("loginPassword").value;

        if (!email || !password) {
          document.getElementById("loginError").textContent =
            "Preencha todos os campos";
          return;
        }

        try {
          const result = await AuthSystem.login(email, password);
          if (result.success) {
            AuthSystem.hideLoginModal();

            // Inicializa o app ap√≥s login bem-sucedido
            await initializeApp();

            console.log("‚úÖ Login bem-sucedido e sistema inicializado!");
          } else {
            document.getElementById("loginError").textContent = result.error;
          }
        } catch (error) {
          document.getElementById("loginError").textContent =
            "Erro ao fazer login";
          console.error("Login error:", error);
        }
      }

      // Adicionar fun√ß√£o ao AuthSystem
      AuthSystem.loginFromForm = loginFromForm;

      // Theme Toggle Logic
      function toggleTheme() {
        const html = document.documentElement;
        const current = html.getAttribute("data-theme");
        const target = current === "dark" ? "light" : "dark";
        html.setAttribute("data-theme", target);
        document.getElementById("themeIcon").textContent =
          target === "dark" ? "üåô" : "‚òÄÔ∏è";
        localStorage.setItem("oae-revisor-theme", target);
      }

      // Password Visibility Toggle
      function togglePasswordVisibility(fieldId) {
        const field = document.getElementById(fieldId);
        const button = event.currentTarget;

        if (field.type === "password") {
          field.type = "text";
          button.textContent = "üôà";
        } else {
          field.type = "password";
          button.textContent = "üëÅÔ∏è";
        }
      }

      // Debug: Verificar usu√°rios no localStorage
      function debugUsers() {
        const users = JSON.parse(localStorage.getItem("oae-users") || "[]");
        console.log("=== DEBUG: Usu√°rios no Sistema ===");
        console.log("Total de usu√°rios:", users.length);
        users.forEach((user, index) => {
          console.log(`\n${index + 1}. ${user.name} (${user.email})`);
          console.log("   Senha:", user.password);
          console.log("   Role:", user.role);
          console.log("   Ativo:", user.active);
        });
        console.log("\n=================================");
        alert(`Total de usu√°rios: ${users.length}\n\nVerifique o console (F12) para detalhes.`);
      }

      // Restore theme
      const savedTheme = localStorage.getItem("oae-revisor-theme") || "dark";
      document.documentElement.setAttribute("data-theme", savedTheme);
      document.getElementById("themeIcon").textContent =
        savedTheme === "dark" ? "üåô" : "‚òÄÔ∏è";
    </script>
  </body>
</html>
